{"version":3,"file":"static/js/318.e14aa93a.chunk.js","mappings":"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","sources":["lib/draw/drawCtrl.ts","lib/draw/StateSet.ts","component/draw/touch.ts","component/draw/Draw.tsx","component/reader/ReaderUtils.tsx","component/ui/IconFont.tsx","component/reader/tools/PenPanel.tsx","component/reader/tools/DrawTools.tsx","component/reader/lib/scroll.ts","component/reader/header/Middle.tsx","component/reader/lib/array.ts","component/widgets/UserAvatar.tsx","component/reader/PageNav.tsx","component/reader/header/Right.tsx","component/reader/header/Header.tsx","component/reader/Reader.tsx","lib/network/io.ts","lib/draw/TeamState.ts","component/reader/Team.tsx","component/widgets/ColorCircle.tsx","lib/color.ts","lib/draw/DrawState.ts","lib/draw/canvas.ts","lib/network/http.ts","lib/note/archive.ts","lib/note/note.ts","lib/user.ts"],"sourcesContent":["import localforage from \"localforage\";\r\nexport interface DrawCtrl {\r\n  mode: \"draw\" | \"erase\" | \"select\" | \"text\";\r\n  finger: boolean;\r\n  lineWidth: number;\r\n  eraserWidth: number;\r\n  color: string;\r\n  highlight: boolean;\r\n  lasso: boolean;\r\n  widthList: number[];\r\n}\r\n\r\nexport const defaultWidthList = [10, 20, 30, 50];\r\nexport const defaultDrawCtrl: Readonly<DrawCtrl> = {\r\n  mode: \"draw\",\r\n  finger: true,\r\n  lineWidth: 10,\r\n  eraserWidth: 10,\r\n  color: \"#000000\",\r\n  highlight: false,\r\n  lasso: true,\r\n  widthList: defaultWidthList,\r\n};\r\n\r\nexport async function getDrawCtrl() {\r\n  let drawCtrl = await localforage.getItem<DrawCtrl>(\"DRAW_CTRL\");\r\n  if (!drawCtrl) {\r\n    drawCtrl = defaultDrawCtrl;\r\n    await localforage.setItem(\"DRAW_CTRL\", drawCtrl);\r\n  }\r\n  return drawCtrl;\r\n}\r\n\r\nexport async function saveDrawCtrl(drawCtrl: DrawCtrl) {\r\n  await localforage.setItem(\"DRAW_CTRL\", drawCtrl);\r\n}\r\n","import { DrawState, Operation, Stroke, WIDTH } from \"./DrawState\";\r\nimport { List, Map, Record } from \"immutable\";\r\nimport { NotePage } from \"../note/note\";\r\n\r\ninterface StateSetRecordType {\r\n  states: Map<string, DrawState>;\r\n  editStack: List<string>;\r\n  undoStack: List<string>;\r\n}\r\n\r\nconst defaultRecord: Readonly<StateSetRecordType> = {\r\n  states: Map(),\r\n  editStack: List(),\r\n  undoStack: List(),\r\n};\r\n\r\ntype StateSetRecord = Record<StateSetRecordType>;\r\nconst defaultFactory = Record(defaultRecord);\r\n\r\nexport type SetOperation = Operation & { pageID: string };\r\n\r\nexport class StateSet {\r\n  constructor(\r\n    private immutable: StateSetRecord,\r\n    public lastOp?: SetOperation\r\n  ) {}\r\n\r\n  static createFromPages(\r\n    pageRec: globalThis.Record<string, NotePage>,\r\n    width = WIDTH\r\n  ) {\r\n    return new StateSet(\r\n      defaultFactory().set(\r\n        \"states\",\r\n        Map(pageRec).map(({ state, ratio }) =>\r\n          DrawState.loadFromFlat(state, width, width * ratio)\r\n        )\r\n      )\r\n    );\r\n  }\r\n\r\n  getImmutable() {\r\n    return this.immutable;\r\n  }\r\n\r\n  getStates() {\r\n    return this.getImmutable().get(\"states\");\r\n  }\r\n\r\n  getOneState(pageID: string) {\r\n    return this.getStates().get(pageID);\r\n  }\r\n\r\n  getEditStack() {\r\n    return this.getImmutable().get(\"editStack\");\r\n  }\r\n\r\n  getUndoStack() {\r\n    return this.getImmutable().get(\"undoStack\");\r\n  }\r\n\r\n  setState(pageID: string, drawState: DrawState) {\r\n    const prevDS = this.getOneState(pageID);\r\n    if (!prevDS || prevDS === drawState) return this;\r\n    let currRecord = this.getImmutable()\r\n      .update(\"states\", (s) => s.set(pageID, drawState))\r\n      .update(\"editStack\", (l) => l.push(pageID))\r\n      .delete(\"undoStack\");\r\n\r\n    const { lastOp } = drawState;\r\n    const lastSetOp = lastOp && { ...lastOp, pageID };\r\n\r\n    return new StateSet(currRecord, lastSetOp);\r\n  }\r\n\r\n  // sync with mutation.\r\n  syncStrokeTime(pageID: string, stroke: Stroke) {\r\n    const prevDS = this.getOneState(pageID);\r\n    prevDS && DrawState.syncStrokeTime(prevDS, stroke);\r\n    return this;\r\n  }\r\n\r\n  addState(pageID: string, notePage: NotePage, width = WIDTH) {\r\n    const { state, ratio } = notePage;\r\n    const newDS = DrawState.loadFromFlat(state, width, width * ratio);\r\n    const currRecord = this.getImmutable().update(\"states\", (s) =>\r\n      s.set(pageID, newDS)\r\n    );\r\n    return new StateSet(currRecord);\r\n  }\r\n\r\n  deleteState(pageID: string) {\r\n    return new StateSet(\r\n      this.getImmutable().update(\"states\", (s) => s.delete(pageID))\r\n    );\r\n  }\r\n\r\n  isUndoable() {\r\n    return this.getEditStack().size > 0;\r\n  }\r\n\r\n  isRedoable() {\r\n    return this.getUndoStack().size > 0;\r\n  }\r\n\r\n  undo() {\r\n    if (!this.isUndoable()) return this;\r\n    const lastUid = this.getEditStack().last();\r\n    const prevDS = lastUid && this.getOneState(lastUid);\r\n    if (!prevDS) return this;\r\n\r\n    const newDS = DrawState.undo(prevDS);\r\n    const { lastOp } = newDS;\r\n    const lastSetOp = lastOp && { pageID: lastUid, ...lastOp };\r\n\r\n    return new StateSet(\r\n      this.getImmutable()\r\n        .update(\"editStack\", (s) => s.pop())\r\n        .update(\"undoStack\", (s) => s.push(lastUid))\r\n        .update(\"states\", (s) => s.set(lastUid, newDS)),\r\n      lastSetOp\r\n    );\r\n  }\r\n\r\n  redo() {\r\n    if (!this.isRedoable()) return this;\r\n    const lastUid = this.getUndoStack().last();\r\n    const prevDS = lastUid && this.getOneState(lastUid);\r\n    if (!prevDS) return this;\r\n\r\n    const newDS = DrawState.redo(prevDS);\r\n    const { lastOp } = newDS;\r\n    const lastSetOp = lastOp && { pageID: lastUid, ...lastOp };\r\n\r\n    return new StateSet(\r\n      this.getImmutable()\r\n        .update(\"undoStack\", (s) => s.pop())\r\n        .update(\"editStack\", (s) => s.push(lastUid))\r\n        .update(\"states\", (s) => s.set(lastUid, newDS)),\r\n      lastSetOp\r\n    );\r\n  }\r\n\r\n  getLastDS(): [string, DrawState] | undefined {\r\n    const pageID = this.lastOp?.pageID;\r\n    const ds = pageID && this.getOneState(pageID);\r\n    if (ds) return [pageID, ds];\r\n  }\r\n}\r\n","import { PointerEvent, TouchEvent, useEffect, useRef } from \"react\";\r\n\r\ntype iOSTouch = Touch & {\r\n  force?: number;\r\n  touchType?: \"stylus\" | \"direct\";\r\n};\r\n\r\nexport function isApplePencil(e: TouchEvent) {\r\n  const touch = e.touches[0] as iOSTouch;\r\n  return touch?.touchType === \"stylus\";\r\n}\r\n\r\nexport function usePreventTouch(\r\n  allowFinger: boolean\r\n): React.HTMLAttributes<HTMLDivElement> {\r\n  const isTouch = useRef(false);\r\n  const checkPoniter = (e: PointerEvent) =>\r\n    e.isPrimary && (isTouch.current = e.pointerType === \"touch\");\r\n\r\n  const isEventValid = (e: TouchEvent) =>\r\n    !isTouch.current ||\r\n    isApplePencil(e) ||\r\n    (allowFinger && e.touches.length === 1);\r\n\r\n  const preventTouch = (e: TouchEvent) =>\r\n    isEventValid(e) || e.stopPropagation();\r\n\r\n  return {\r\n    onPointerDownCapture: checkPoniter,\r\n    onPointerMoveCapture: checkPoniter,\r\n    onTouchStartCapture: preventTouch,\r\n    onTouchMoveCapture: preventTouch,\r\n  };\r\n}\r\n\r\nexport function usePreventGesture() {\r\n  useEffect(() => {\r\n    const handler = (e: Event) => e.preventDefault();\r\n    document.addEventListener(\"gesturestart\", handler);\r\n    document.addEventListener(\"gesturechange\", handler);\r\n    document.addEventListener(\"gestureend\", handler);\r\n    return () => {\r\n      document.removeEventListener(\"gesturestart\", handler);\r\n      document.removeEventListener(\"gesturechange\", handler);\r\n      document.removeEventListener(\"gestureend\", handler);\r\n    };\r\n  }, []);\r\n}\r\n","import React, {\r\n  useRef,\r\n  useMemo,\r\n  useState,\r\n  Dispatch,\r\n  useEffect,\r\n  useCallback,\r\n  useDebugValue,\r\n  SetStateAction,\r\n  useImperativeHandle,\r\n} from \"react\";\r\nimport { DrawState, Mutation, Stroke } from \"../../lib/draw/DrawState\";\r\nimport { defaultDrawCtrl, DrawCtrl } from \"../../lib/draw/drawCtrl\";\r\nimport { usePreventTouch, usePreventGesture } from \"./touch\";\r\nimport { releaseCanvas } from \"../../lib/draw/canvas\";\r\nimport { usePinch } from \"@use-gesture/react\";\r\nimport useSize from \"@react-hook/size\";\r\nimport paper from \"paper\";\r\nimport \"./draw.sass\";\r\n\r\nconst { Path, Size, Point, Group, Color, Raster, Layer } = paper;\r\n\r\nexport type ActiveToolKey = \"\" | \"select\" | \"text\";\r\nexport interface DrawRefType {\r\n  deleteSelected: () => void;\r\n  rotateSelected: (angle: number, last?: boolean) => void;\r\n  duplicateSelected: () => void;\r\n  mutateStyle: (updated: Partial<DrawCtrl>) => void;\r\n  rasterize: () => string;\r\n  submitText: (text: string, color?: string, justification?: string) => void;\r\n  cancelText: () => void;\r\n  pointText?: paper.PointText;\r\n}\r\ninterface DrawPropType {\r\n  drawState: DrawState;\r\n  otherStates?: DrawState[];\r\n  onChange?: Dispatch<SetStateAction<DrawState>>;\r\n  setActiveTool?: Dispatch<SetStateAction<ActiveToolKey>>;\r\n  drawCtrl?: DrawCtrl;\r\n  readonly?: boolean;\r\n  imgSrc?: string;\r\n}\r\n\r\nconst Draw = React.forwardRef<DrawRefType, DrawPropType>(\r\n  (\r\n    {\r\n      drawState,\r\n      otherStates,\r\n      onChange = () => {},\r\n      drawCtrl = defaultDrawCtrl,\r\n      readonly = false,\r\n      imgSrc,\r\n      setActiveTool = () => {},\r\n    },\r\n    ref\r\n  ) => {\r\n    const { width, height } = drawState;\r\n    const { mode, finger, lasso, eraserWidth } = drawCtrl;\r\n\r\n    const canvasEl = useRef<HTMLCanvasElement>(null);\r\n    const scope = useRef(new paper.PaperScope());\r\n    const [group, setGroup] = useState<paper.Item[]>([]);\r\n    const [path, setPath] = usePaperItem<paper.Path>();\r\n    const [rect, setRect] = usePaperItem<paper.Path.Rectangle>();\r\n\r\n    useEffect(() => {\r\n      const cvs = canvasEl.current;\r\n      const scp = scope.current;\r\n      if (!cvs) return;\r\n\r\n      scp.setup(cvs);\r\n      scp.settings.handleSize = 10;\r\n      scp.settings.hitTolerance = 20;\r\n      scp.project.addLayer(new Layer());\r\n      scp.project.addLayer(new Layer());\r\n      scp.project.addLayer(new Layer());\r\n      scp.project.layers[2].activate();\r\n      scp.project.layers.forEach((l) => (l.visible = false));\r\n      new scp.Tool();\r\n\r\n      return () => {\r\n        scp.remove();\r\n        releaseCanvas(cvs);\r\n      };\r\n    }, []);\r\n\r\n    useEffect(() => {\r\n      const bgRect = paintBackground(scope.current, width, height);\r\n      return () => void bgRect.remove();\r\n    }, [width, height]);\r\n\r\n    const [canvasWidth] = useSize(canvasEl);\r\n    const ratio = canvasWidth / width;\r\n    useEffect(() => {\r\n      if (!ratio) return;\r\n      const scp = scope.current;\r\n      scp.view.viewSize = new Size(width, height).multiply(ratio);\r\n      scp.view.scale(ratio, new Point(0, 0));\r\n      scp.project.layers.forEach((l) => (l.visible = true));\r\n\r\n      return () => {\r\n        scp.project?.layers.forEach((l) => (l.visible = false));\r\n        scp.view?.scale(1 / ratio, new Point(0, 0));\r\n      };\r\n    }, [width, height, ratio]);\r\n\r\n    useEffect(() => {\r\n      if (!imgSrc) return;\r\n      scope.current.activate();\r\n      const raster = new Raster(imgSrc);\r\n      raster.project.layers[0].addChild(raster);\r\n      raster.sendToBack();\r\n      raster.onLoad = () => {\r\n        // render the image in full size to prevent blurring.\r\n        requestAnimationFrame(() => {\r\n          raster.fitBounds(new paper.Rectangle(0, 0, width, height));\r\n          raster.bringToFront();\r\n        });\r\n      };\r\n\r\n      return () => void raster?.remove();\r\n    }, [imgSrc, width, height]);\r\n\r\n    const mergedStrokes = useMemo(\r\n      () =>\r\n        otherStates\r\n          ? DrawState.mergeStates(drawState, ...otherStates)\r\n          : drawState.getStrokeList(),\r\n      [drawState, otherStates]\r\n    );\r\n    useEffect(() => {\r\n      const tempGroup: paper.Item[] = [];\r\n      const layer = scope.current.project.layers[1];\r\n\r\n      scope.current.activate();\r\n      mergedStrokes.forEach((stroke) => {\r\n        const self = drawState.hasStroke(stroke.uid);\r\n        const item = paintStroke(stroke, layer, !self);\r\n        if (!item) return;\r\n        if (self) tempGroup.push(item);\r\n      });\r\n      setGroup(tempGroup);\r\n\r\n      return () => void layer.removeChildren();\r\n    }, [mergedStrokes, drawState]);\r\n\r\n    const hitRef = useRef<paper.HitResult>();\r\n    const [selected, setSelected] = useState(false);\r\n    const paperMode = mode === \"select\" && selected ? \"selected\" : mode;\r\n    const [selectedIDs, setSelectedIDs] = useState<string[]>([]);\r\n    const selectedItems = useMemo(() => {\r\n      const IDSet = new Set(selectedIDs);\r\n      return group.filter((item) => IDSet.has(item.name));\r\n    }, [group, selectedIDs]);\r\n\r\n    const resetSelect = useCallback(() => {\r\n      setSelected(false);\r\n      setPath(undefined);\r\n      setRect(undefined);\r\n    }, [setPath, setRect]);\r\n\r\n    useEffect(() => {\r\n      if (mode === \"select\") return resetSelect;\r\n    }, [mode, resetSelect]);\r\n    useEffect(() => resetSelect, [lasso, resetSelect]);\r\n\r\n    useEffect(() => {\r\n      if (!selected) return;\r\n      return () => {\r\n        setSelectedIDs([]);\r\n        setActiveTool(\"\");\r\n      };\r\n    }, [selected, setActiveTool]);\r\n\r\n    const downPath = () => setPath(startStroke(drawCtrl));\r\n    const downRect = (e: paper.MouseEvent) => setRect(startRect(e.point));\r\n\r\n    const handleDown = {\r\n      draw: downPath,\r\n      erase: downPath,\r\n      select: lasso ? downPath : downRect,\r\n      selected(e: paper.MouseEvent) {\r\n        if (lasso) {\r\n          // if the point is outside of selection, reset selection\r\n          if (path?.contains(e.point)) return;\r\n          downPath();\r\n          setSelected(false);\r\n        } else {\r\n          // check if the point hit the segment point.\r\n          const hitRes = rect?.hitTest(e.point, { segments: true });\r\n          hitRef.current = hitRes;\r\n          if (hitRes) return;\r\n          // if the point is outside of selection, reset selection\r\n          if (rect?.contains(e.point)) return;\r\n          downRect(e);\r\n          setSelected(false);\r\n        }\r\n      },\r\n      text(e: paper.MouseEvent) {\r\n        const t =\r\n          getClickedText(scope.current, e.point) ??\r\n          new paper.PointText({\r\n            point: e.point.add(new Point(0, 50)),\r\n            content: \"Insert text...\",\r\n            fontSize: 50,\r\n            justification: \"center\",\r\n            fillColor: \"#1890ff55\",\r\n          });\r\n        setPointText(t as paper.PointText);\r\n      },\r\n    }[paperMode];\r\n\r\n    const dragPath = (e: paper.MouseEvent) => {\r\n      path?.add(e.point);\r\n      path?.smooth();\r\n    };\r\n    const resizeRect = (e: paper.MouseEvent) => {\r\n      if (!rect) return;\r\n      const { x, y } = e.point;\r\n      const [, s1, s2, s3] = rect.segments;\r\n      s1.point.x = x;\r\n      s2.point = e.point;\r\n      s3.point.y = y;\r\n    };\r\n\r\n    const handleDrag = {\r\n      draw: dragPath,\r\n      erase: dragPath,\r\n      select: lasso ? dragPath : resizeRect,\r\n      selected(e: paper.MouseEvent) {\r\n        const hitRes = hitRef.current;\r\n        if (hitRes?.segment) {\r\n          // resize selected items\r\n          const moveP = hitRes.segment.point;\r\n          const baseP = hitRes.segment.next.next.point;\r\n          const diagonal = moveP.subtract(baseP);\r\n          const projection = e.point.subtract(baseP).project(diagonal);\r\n          const scale = projection.x / diagonal.x;\r\n          if (scale < 0) return;\r\n\r\n          rect?.scale(scale, baseP);\r\n          selectedItems.forEach((item) => {\r\n            item.scale(scale, baseP);\r\n            item.strokeWidth *= scale;\r\n          });\r\n        } else {\r\n          // move selected items\r\n          selectedItems.forEach((item) => item.translate(e.delta));\r\n          path?.translate(e.delta);\r\n          rect?.translate(e.delta);\r\n        }\r\n      },\r\n      text(e: paper.MouseEvent) {\r\n        if (!pointText || pointText.name) return;\r\n        const { topCenter, bottomRight } = pointText.bounds;\r\n        const diagonal = bottomRight.subtract(topCenter);\r\n        const projection = e.point.subtract(topCenter).project(diagonal);\r\n        const scale = projection.x / diagonal.x;\r\n        if (scale < 0) return;\r\n        pointText.scale(scale, topCenter);\r\n      },\r\n    }[paperMode];\r\n\r\n    useEffect(() => {\r\n      scope.current.tool.maxDistance = eraserWidth;\r\n    }, [eraserWidth]);\r\n    const erased = useRef(new Set<string>());\r\n\r\n    const handleEarserDrag =\r\n      paperMode === \"erase\"\r\n        ? (e: paper.ToolEvent) => {\r\n            const layer = scope.current.project.layers[1];\r\n            const hitRes = layer.hitTestAll(e.point, {\r\n              class: paper.Path,\r\n              stroke: true,\r\n              tolerance: eraserWidth / 2,\r\n            });\r\n\r\n            hitRes.forEach(({ item }) => {\r\n              item.opacity = 0.5;\r\n              item.guide = true;\r\n              if (item.name) erased.current.add(item.name);\r\n            });\r\n          }\r\n        : null;\r\n\r\n    const handleUp = {\r\n      draw() {\r\n        if (!path || path.isEmpty()) return;\r\n        path.simplify();\r\n        const pathData = path.exportJSON();\r\n        setPath(undefined);\r\n        onChange((prev) => DrawState.addStroke(prev, pathData));\r\n      },\r\n      erase() {\r\n        const erasedList = Array.from(erased.current);\r\n        erased.current.clear();\r\n        setPath(undefined);\r\n        onChange((prev) => DrawState.eraseStrokes(prev, erasedList));\r\n      },\r\n      select() {\r\n        let selection: string[];\r\n        if (lasso) {\r\n          if (!path || Math.abs(path.area) < 1_000) return setPath(undefined);\r\n          path.closePath();\r\n          path.simplify();\r\n          moveDash(path);\r\n          selection = checkLasso(group, path);\r\n        } else {\r\n          if (!rect || Math.abs(rect.area) < 1_000) return setRect(undefined);\r\n          selection = checkLasso(group, rect);\r\n        }\r\n        setSelectedIDs(selection);\r\n        setSelected(true);\r\n        setActiveTool(\"select\");\r\n      },\r\n      selected() {\r\n        updateMutation();\r\n      },\r\n      text() {\r\n        setActiveTool(\"text\");\r\n      },\r\n    }[paperMode];\r\n\r\n    const [cursor, setCursor] = useState(\"auto\");\r\n    useEffect(() => {\r\n      if (paperMode === \"text\" || paperMode === \"select\") {\r\n        setCursor(\"crosshair\");\r\n      } else if (paperMode === \"selected\") {\r\n        setCursor(lasso ? \"crosshair\" : \"nwse-resize\");\r\n      } else if (paperMode === \"draw\" || paperMode === \"erase\") {\r\n        setCursor(cursorStyle(drawCtrl, ratio));\r\n      }\r\n    }, [paperMode, lasso, drawCtrl, ratio]);\r\n\r\n    const handleMove = {\r\n      selected(e: paper.MouseEvent) {\r\n        const hitRes = rect?.hitTest(e.point, { segments: true });\r\n        if (hitRes?.segment) {\r\n          const moveP = hitRes.segment.point;\r\n          const baseP = hitRes.segment.next.next.point;\r\n          const diagonal = moveP.subtract(baseP);\r\n          const { x, y } = diagonal;\r\n          setCursor(x * y < 0 ? \"nesw-resize\" : \"nwse-resize\");\r\n        } else if (rect?.contains(e.point) || path?.contains(e.point)) {\r\n          setCursor(\"move\");\r\n        } else {\r\n          setCursor(\"crosshair\");\r\n        }\r\n      },\r\n      text(e: paper.MouseEvent) {\r\n        if (getClickedText(scope.current, e.point)) setCursor(\"text\");\r\n        else setCursor(\"crosshair\");\r\n      },\r\n      select: null,\r\n      draw: null,\r\n      erase: null,\r\n    }[paperMode];\r\n\r\n    const handleViewEvent = () => {\r\n      if (readonly) return;\r\n\r\n      type Handler<E> = ((e: E) => boolean | void) | null;\r\n      const activate = <E,>(handler: Handler<E>): Handler<E> => {\r\n        return (e) => {\r\n          scope.current.activate();\r\n          if (handler) return handler(e);\r\n        };\r\n      };\r\n      const { view, tool } = scope.current;\r\n      view.onMouseDown = activate(handleDown);\r\n      view.onMouseDrag = activate(handleDrag);\r\n      view.onMouseUp = activate(handleUp);\r\n      view.onMouseMove = activate(handleMove);\r\n      if (tool) tool.onMouseDrag = activate(handleEarserDrag);\r\n    };\r\n    useEffect(handleViewEvent);\r\n\r\n    const updateMutation = () => {\r\n      if (!selectedItems?.length) return;\r\n      const mutations = selectedItems.map(\r\n        (p) => [p.name, p.exportJSON()] as Mutation\r\n      );\r\n      onChange((prev) => DrawState.mutateStrokes(prev, mutations));\r\n    };\r\n\r\n    const deleteSelected = () => {\r\n      setSelectedIDs([]);\r\n      resetSelect();\r\n      if (!selectedIDs.length) return;\r\n      onChange((prev) => DrawState.eraseStrokes(prev, selectedIDs));\r\n    };\r\n\r\n    const rotateSelected = (angle: number, last = false) => {\r\n      let aniCount = last ? 10 : 1;\r\n      const dAngle = angle / aniCount;\r\n      const center = (rect || path)?.position;\r\n      const rotate = () => {\r\n        selectedItems.forEach((item) => item.rotate(dAngle, center));\r\n        rect?.rotate(dAngle, center);\r\n        path?.rotate(dAngle, center);\r\n        if (--aniCount > 0) requestAnimationFrame(rotate);\r\n        else last && updateMutation();\r\n      };\r\n      rotate();\r\n    };\r\n\r\n    const mutateStyle = (updated: Partial<DrawCtrl>) => {\r\n      scope.current.activate();\r\n      updateGroupStyle(selectedItems, updated);\r\n      updateMutation();\r\n    };\r\n\r\n    const duplicateSelected = () => {\r\n      scope.current.activate();\r\n      const size = (rect || path)?.bounds.size;\r\n      if (!size) return;\r\n      const { width, height } = size;\r\n      const transP = new Point(width, height).divide(10);\r\n      const newSG = new Group(selectedItems).clone({ insert: false });\r\n      newSG.translate(transP);\r\n      rect?.translate(transP);\r\n      path?.translate(transP);\r\n\r\n      const mutations = newSG.children.map(\r\n        (item) => [DrawState.getUid(), item.exportJSON()] as Mutation\r\n      );\r\n      onChange((prev) => DrawState.mutateStrokes(prev, mutations));\r\n      setSelectedIDs(mutations.map((m) => m[0]));\r\n    };\r\n\r\n    const rasterize = () =>\r\n      new Group(selectedItems).rasterize({ insert: false }).toDataURL();\r\n\r\n    const [pointText, setPointText] = usePaperItem<paper.PointText>();\r\n    const cancelText = useCallback(() => {\r\n      setPointText(undefined);\r\n      setActiveTool(\"\");\r\n    }, [setPointText, setActiveTool]);\r\n\r\n    useEffect(() => {\r\n      if (mode === \"text\") return cancelText;\r\n    }, [mode, cancelText]);\r\n\r\n    const submitText = (\r\n      text: string,\r\n      color = \"#000\",\r\n      justification = \"center\"\r\n    ) => {\r\n      if (!pointText) return;\r\n      pointText.content = text;\r\n      pointText.fillColor = new Color(color);\r\n      pointText.justification = justification;\r\n      const pathData = pointText.exportJSON();\r\n      const { name } = pointText;\r\n      cancelText();\r\n      if (!name) return onChange((prev) => DrawState.addStroke(prev, pathData));\r\n      onChange((prev) => DrawState.mutateStrokes(prev, [[name, pathData]]));\r\n    };\r\n\r\n    useImperativeHandle(ref, () => ({\r\n      deleteSelected,\r\n      duplicateSelected,\r\n      cancelText,\r\n      rotateSelected,\r\n      submitText,\r\n      mutateStyle,\r\n      rasterize,\r\n      pointText,\r\n    }));\r\n\r\n    usePreventGesture();\r\n    usePinch(\r\n      ({ memo, offset: [scale], first, last, origin }) => {\r\n        scope.current.activate();\r\n        const { view } = scope.current;\r\n        const originRawP = new Point(origin);\r\n\r\n        let lastScale: number;\r\n        let lastOrigin, elPos: paper.Point;\r\n        if (first || !memo) {\r\n          const { x, y } = canvasEl.current!.getBoundingClientRect();\r\n          lastScale = 1;\r\n          elPos = new Point(x, y);\r\n          lastOrigin = originRawP.subtract(elPos);\r\n        } else {\r\n          [lastScale, lastOrigin, elPos] = memo;\r\n        }\r\n\r\n        const originViewP = originRawP.subtract(elPos);\r\n        const originPorjP = view.viewToProject(originViewP);\r\n\r\n        if (Math.abs(1 - scale) < 0.05) scale = 1;\r\n        let dScale = first ? 1 : scale / lastScale;\r\n        let aniCount = last ? 10 : 1;\r\n        dScale = Math.pow(dScale, 1 / aniCount);\r\n        const scaleView = () => {\r\n          view.scale(dScale, originPorjP);\r\n          if (--aniCount > 0) requestAnimationFrame(scaleView);\r\n          else if (last) putCenterBack(view, new Size(width, height));\r\n        };\r\n        scaleView();\r\n\r\n        const deltaP = originViewP.subtract(lastOrigin);\r\n        const transP = deltaP.divide(view.zoom);\r\n        view.translate(transP);\r\n\r\n        if (!last) return [scale, originViewP, elPos];\r\n      },\r\n      {\r\n        scaleBounds: { max: 10, min: 0.3 },\r\n        rubberband: 0.5,\r\n        target: canvasEl,\r\n      }\r\n    );\r\n\r\n    const touchHandler = usePreventTouch(finger);\r\n    return (\r\n      <div\r\n        className=\"draw-wrapper\"\r\n        style={{ cursor }}\r\n        data-readonly={readonly}\r\n        {...touchHandler}\r\n      >\r\n        <canvas ref={canvasEl} className=\"draw-canvas\" />\r\n      </div>\r\n    );\r\n  }\r\n);\r\n\r\nDraw.displayName = \"Draw\";\r\nexport default React.memo(Draw);\r\n\r\nfunction usePaperItem<T extends paper.Item>() {\r\n  const tuple = useState<T | undefined>();\r\n  const [item] = tuple;\r\n  useDebugValue(item);\r\n  useEffect(\r\n    () => () => {\r\n      if (!item?.name) item?.remove();\r\n    },\r\n    [item]\r\n  );\r\n  return tuple;\r\n}\r\n\r\nconst paintStroke = (stroke: Stroke, layer: paper.Layer, readonly = false) => {\r\n  let { pathData, uid } = stroke;\r\n  try {\r\n    const item = layer.importJSON(pathData);\r\n    if (!item) return;\r\n    item.name = uid;\r\n    item.guide = readonly;\r\n    return item;\r\n  } catch (e) {\r\n    console.error(e);\r\n  }\r\n};\r\n\r\nconst paintBackground = (\r\n  scope: paper.PaperScope,\r\n  width: number,\r\n  height: number\r\n) => {\r\n  scope.activate();\r\n  const bgRect = new Path.Rectangle(new Point(0, 0), new Point(width, height));\r\n  bgRect.fillColor = new Color(\"#fff\");\r\n  scope.project.layers[0].addChild(bgRect);\r\n  return bgRect;\r\n};\r\n\r\nconst startRect = (point: paper.Point) => {\r\n  const rect = new Path.Rectangle(point, new Size(0, 0));\r\n  rect.onFrame = () => {}; // the handle size bug\r\n  rect.selected = true;\r\n  return rect;\r\n};\r\n\r\nconst startStroke = (drawCtrl: DrawCtrl) => {\r\n  let { mode, lineWidth, eraserWidth, color, highlight } = drawCtrl;\r\n  const path = new Path();\r\n  if (mode === \"erase\") {\r\n    color = \"#ccc\";\r\n    lineWidth = eraserWidth;\r\n  }\r\n  if (mode === \"select\") {\r\n    color = \"#1890ff\";\r\n    lineWidth = 5;\r\n  }\r\n  const strokeColor = new Color(color);\r\n  if (highlight || mode === \"erase\") {\r\n    strokeColor.alpha = 0.5;\r\n    path.blendMode = \"multiply\";\r\n  }\r\n  path.strokeColor = strokeColor;\r\n  path.strokeWidth = lineWidth;\r\n  path.strokeJoin = \"round\";\r\n  path.strokeCap = \"round\";\r\n  path.guide = true;\r\n  return path;\r\n};\r\n\r\nconst cursorStyle = (drawCtrl: DrawCtrl, ratio: number) => {\r\n  const { lineWidth, eraserWidth, mode } = drawCtrl;\r\n  const size = ratio * (mode === \"erase\" ? eraserWidth : lineWidth);\r\n  if (size < 5) return \"crosshair\";\r\n  const half = size / 2;\r\n  return `url('data:image/svg+xml;utf8,<svg xmlns=\"http://www.w3.org/2000/svg\" fill=\"%23FFF7\" width=\"${size}\" height=\"${size}\" viewBox=\"0 0 10 10\"><circle cx=\"5\" cy=\"5\" r=\"5\"/></svg>') ${half} ${half}, auto`;\r\n};\r\n\r\nconst moveDash = (item: paper.Item) => {\r\n  item.dashOffset = 0;\r\n  item.dashArray = [30, 20];\r\n  item.onFrame = () => (item.dashOffset += 3);\r\n};\r\n\r\nconst getCenterTranslate = (view: paper.View, projSize: paper.Size) => {\r\n  const { x, y } = view.center;\r\n  const { width: viewW, height: viewH } = view.size;\r\n  const { width: projW, height: projH } = projSize;\r\n\r\n  const [minX, minY] = [Math.min(viewW, projW) / 2, Math.min(viewH, projH) / 2];\r\n  const [maxX, maxY] = [projW - minX, projH - minY];\r\n\r\n  const deltaX = x < minX ? minX - x : x > maxX ? maxX - x : 0;\r\n  const deltaY = y < minY ? minY - y : y > maxY ? maxY - y : 0;\r\n\r\n  return [deltaX, deltaY];\r\n};\r\n\r\nconst putCenterBack = (view: paper.View, projSize: paper.Size) => {\r\n  const [deltaX, deltaY] = getCenterTranslate(view, projSize);\r\n  let aniCount = 10;\r\n  const dP = new Point(deltaX, deltaY).divide(-aniCount);\r\n  const move = () => {\r\n    view.translate(dP);\r\n    if (--aniCount > 0) requestAnimationFrame(move);\r\n  };\r\n  move();\r\n};\r\n\r\nconst checkLasso = (items: paper.Item[], selection: paper.Path) => {\r\n  const isInside = (p: paper.Path) => {\r\n    const res = p.subtract(selection, { insert: false, trace: false });\r\n    res.remove();\r\n    return !res.compare(p);\r\n  };\r\n  return items\r\n    .filter((item) => {\r\n      if (!item.name) return false;\r\n      if (!item.bounds.intersects(selection.bounds)) return false;\r\n      if (item instanceof paper.Path) {\r\n        return isInside(item);\r\n      } else {\r\n        const checkedP = new Path.Rectangle(item.bounds);\r\n        checkedP.remove();\r\n        return isInside(checkedP);\r\n      }\r\n    })\r\n    .map(({ name }) => name);\r\n};\r\n\r\nconst updateGroupStyle = (items: paper.Item[], updated: Partial<DrawCtrl>) => {\r\n  const { lineWidth, color, highlight } = updated;\r\n  items.forEach((item) => {\r\n    if (item instanceof paper.PointText && color) {\r\n      const newColor = new Color(color);\r\n      item.fillColor = newColor;\r\n    }\r\n\r\n    if (!(item instanceof paper.Path)) return;\r\n\r\n    if (color) {\r\n      const newColor = new Color(color);\r\n      if (item.blendMode === \"multiply\") newColor.alpha = 0.5;\r\n      item.strokeColor = newColor;\r\n    }\r\n\r\n    if (lineWidth) item.strokeWidth = lineWidth;\r\n\r\n    if (!item.strokeColor || highlight === undefined) return;\r\n    item.strokeColor.alpha = highlight ? 0.5 : 1;\r\n    item.blendMode = highlight ? \"multiply\" : \"normal\";\r\n  });\r\n};\r\n\r\nconst getClickedText = (scope: paper.PaperScope, point: paper.Point) => {\r\n  const hitRes = scope.project.hitTest(point, {\r\n    class: paper.PointText,\r\n    fill: true,\r\n  });\r\n  return hitRes?.item;\r\n};\r\n","import { Button, message } from \"antd\";\r\nimport React, { useContext } from \"react\";\r\nimport { ReaderMethodCtx } from \"./Reader\";\r\nimport { PlusOutlined } from \"@ant-design/icons\";\r\n\r\nexport const AddPageButton = () => {\r\n  const { addFinalPage } = useContext(ReaderMethodCtx);\r\n  return (\r\n    <div className=\"add-btn-wrapper\">\r\n      <Button\r\n        type=\"dashed\"\r\n        icon={<PlusOutlined />}\r\n        block\r\n        onClick={addFinalPage}\r\n      >\r\n        New page\r\n      </Button>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport const showPageDelMsg = (onUndo: () => void) => {\r\n  message.warning({\r\n    content: (\r\n      <>\r\n        One page was deleted.\r\n        <Button\r\n          size=\"small\"\r\n          type=\"link\"\r\n          onClick={() => {\r\n            message.destroy(\"DELETE\");\r\n            onUndo();\r\n          }}\r\n        >\r\n          Undo\r\n        </Button>\r\n      </>\r\n    ),\r\n    key: \"DELETE\",\r\n    duration: 10,\r\n  });\r\n};\r\n","import { createFromIconfontCN } from \"@ant-design/icons\";\r\n\r\nexport default createFromIconfontCN({\r\n  scriptUrl: \"//at.alicdn.com/t/font_3181679_yo844n7qgns.js\",\r\n});\r\n","import { CSSProperties, FC, useEffect, useMemo, useState } from \"react\";\r\nimport { defaultWidthList, DrawCtrl } from \"../../../lib/draw/drawCtrl\";\r\nimport { ColorCirle } from \"../../widgets/ColorCircle\";\r\nimport { WIDTH } from \"../../../lib/draw/DrawState\";\r\nimport { Popover, Segmented, Slider } from \"antd\";\r\nimport { allColors } from \"../../../lib/color\";\r\nimport { Setter } from \"../../../lib/hooks\";\r\nimport IconFont from \"../../ui/IconFont\";\r\nimport { List } from \"immutable\";\r\nimport \"./penPanel.sass\";\r\n\r\nexport const PenPanel: FC<{\r\n  updateDrawCtrl: (updated: Partial<DrawCtrl>) => void;\r\n  drawCtrl: Partial<DrawCtrl>;\r\n}> = ({ updateDrawCtrl, drawCtrl }) => {\r\n  const { highlight, color } = drawCtrl;\r\n  const [panelBlur, setPanelBlur] = useState(false);\r\n\r\n  return (\r\n    <div className=\"pen-panel\" data-blur={panelBlur} data-hi={highlight}>\r\n      <div className=\"pen-status\">\r\n        <WidthSelect\r\n          updateDrawCtrl={updateDrawCtrl}\r\n          drawCtrl={drawCtrl}\r\n          setPanelBlur={setPanelBlur}\r\n        />\r\n        <HighlightSwitch checked={highlight} updateDrawCtrl={updateDrawCtrl} />\r\n      </div>\r\n      <ColorSelect\r\n        color={color || \"\"}\r\n        setColor={(c) => updateDrawCtrl({ color: c })}\r\n      />\r\n    </div>\r\n  );\r\n};\r\n\r\nexport const WidthSelect: FC<{\r\n  updateDrawCtrl: (updated: Partial<DrawCtrl>) => void;\r\n  drawCtrl: Partial<DrawCtrl>;\r\n  setPanelBlur?: Setter<boolean>;\r\n  field?: \"lineWidth\" | \"eraserWidth\";\r\n}> = ({\r\n  updateDrawCtrl,\r\n  drawCtrl,\r\n  setPanelBlur = () => {},\r\n  field = \"lineWidth\",\r\n}) => {\r\n  const currWidth = drawCtrl[field];\r\n  const widthList = drawCtrl.widthList ?? defaultWidthList;\r\n  const color = field === \"lineWidth\" ? drawCtrl.color ?? \"#aaa\" : \"#aaa\";\r\n\r\n  const chosen = useMemo(\r\n    () => widthList.indexOf(currWidth ?? -1),\r\n    [currWidth, widthList]\r\n  );\r\n\r\n  const [popShow, setPopShow] = useState(List([false, false, false, false]));\r\n  useEffect(() => {\r\n    if (popShow.includes(true)) setPanelBlur(true);\r\n    else setPanelBlur(false);\r\n  }, [popShow, setPanelBlur]);\r\n\r\n  const realSizeStyle = (width: number) =>\r\n    ({\r\n      \"--real-size\": `calc(${100 / WIDTH}vw * ${width})`,\r\n    } as CSSProperties);\r\n\r\n  const options = [\r\n    { value: -1, label: null },\r\n    ...widthList.map((width, index) => ({\r\n      value: index,\r\n      label: (\r\n        <Popover\r\n          visible={popShow.get(index)}\r\n          onVisibleChange={(v) => setPopShow((prev) => prev.set(index, v))}\r\n          trigger={chosen === index ? [\"click\"] : []}\r\n          placement=\"bottom\"\r\n          destroyTooltipOnHide\r\n          content={\r\n            <Slider\r\n              min={5}\r\n              max={100}\r\n              className=\"ctrl-slider\"\r\n              defaultValue={width}\r\n              onAfterChange={(w) => {\r\n                if (widthList.includes(w)) {\r\n                  setPopShow((prev) => prev.set(index, false));\r\n                  return updateDrawCtrl({ [field]: w });\r\n                }\r\n                const newWL = widthList.slice();\r\n                newWL[index] = w;\r\n                updateDrawCtrl({ widthList: newWL, [field]: w });\r\n              }}\r\n            />\r\n          }\r\n        >\r\n          <div className=\"circle-wrapper\" style={realSizeStyle(width)}>\r\n            <ColorCirle className={\"width-circle \" + field} color={color} />\r\n          </div>\r\n        </Popover>\r\n      ),\r\n    })),\r\n  ];\r\n\r\n  return (\r\n    <Segmented\r\n      className=\"width-seg\"\r\n      value={chosen}\r\n      options={options}\r\n      onChange={(i) => updateDrawCtrl({ [field]: widthList[+i] ?? 10 })}\r\n    />\r\n  );\r\n};\r\n\r\nconst HighlightSwitch: FC<{\r\n  checked?: boolean;\r\n  updateDrawCtrl: (updated: Partial<DrawCtrl>) => void;\r\n}> = ({ checked = false, updateDrawCtrl }) => {\r\n  return (\r\n    <label className=\"hi-wrapper\">\r\n      <input\r\n        type=\"checkbox\"\r\n        name=\"highlight\"\r\n        checked={checked}\r\n        onChange={(e) => updateDrawCtrl({ highlight: e.target.checked })}\r\n      />\r\n      <div className=\"hi-switch\">\r\n        <IconFont type=\"icon-Highlight\" />\r\n      </div>\r\n    </label>\r\n  );\r\n};\r\n\r\nexport const ColorSelect: FC<{\r\n  color: string;\r\n  setColor: (color: string) => void;\r\n}> = ({ setColor, color }) => {\r\n  return (\r\n    <div className=\"color-select\">\r\n      {allColors.map((c) => (\r\n        <label key={c}>\r\n          <input\r\n            checked={color === c}\r\n            type=\"radio\"\r\n            name=\"color\"\r\n            onChange={(e) => e.target.checked && setColor(c)}\r\n          />\r\n          <div\r\n            data-color={c}\r\n            className=\"circle\"\r\n            style={{ backgroundColor: c, borderColor: c }}\r\n          />\r\n        </label>\r\n      ))}\r\n    </div>\r\n  );\r\n};\r\n","import { FC, RefObject, useContext, useEffect, useRef, useState } from \"react\";\r\nimport {\r\n  CopyOutlined,\r\n  DeleteOutlined,\r\n  PictureOutlined,\r\n  BgColorsOutlined,\r\n  CaretLeftOutlined,\r\n  AlignLeftOutlined,\r\n  FontColorsOutlined,\r\n  CaretRightOutlined,\r\n  AlignRightOutlined,\r\n  RotateRightOutlined,\r\n  AlignCenterOutlined,\r\n} from \"@ant-design/icons\";\r\nimport { Button, ButtonProps, Modal, Popover, Radio } from \"antd\";\r\nimport { CSSTransition } from \"react-transition-group\";\r\nimport { DrawCtrl } from \"../../../lib/draw/drawCtrl\";\r\nimport { ColorSelect, PenPanel } from \"./PenPanel\";\r\nimport TextArea from \"antd/lib/input/TextArea\";\r\nimport { DrawRefType } from \"../../draw/Draw\";\r\nimport { allColors } from \"../../../lib/color\";\r\nimport { useDrag } from \"@use-gesture/react\";\r\nimport { ReaderStateCtx } from \"../Reader\";\r\nimport { createPortal } from \"react-dom\";\r\nimport { saveAs } from \"file-saver\";\r\nimport \"./drawTools.sass\";\r\n\r\nexport const SelectTool: FC<{\r\n  drawRef: RefObject<DrawRefType>;\r\n  visible: boolean;\r\n}> = ({ drawRef, visible }) => (\r\n  <CSSTransition timeout={300} in={visible} unmountOnExit>\r\n    <SelectToolContent drawRef={drawRef} />\r\n  </CSSTransition>\r\n);\r\n\r\nexport const SelectToolContent: FC<{\r\n  drawRef: RefObject<DrawRefType>;\r\n}> = ({ drawRef }) => {\r\n  const btnProps: ButtonProps = {\r\n    type: \"text\",\r\n    shape: \"round\",\r\n    size: \"small\",\r\n  };\r\n\r\n  const [currDrawCtrl, setCurrDrawCtrl] = useState<Partial<DrawCtrl>>({});\r\n  const rotateEl = useRef<HTMLDivElement>(null);\r\n  const [dragged, setDragged] = useState(false);\r\n  const [transX, setTransX] = useState(0);\r\n  const gearStyle = { transform: `translateX(${transX}px)` };\r\n\r\n  useDrag(\r\n    ({ first, last, offset, delta }) => {\r\n      setTransX(offset[0]);\r\n      drawRef.current?.rotateSelected(delta[0] / 2, last);\r\n      first && setDragged(true);\r\n      last && setDragged(false);\r\n    },\r\n    {\r\n      target: rotateEl,\r\n      filterTaps: true,\r\n      rubberband: 0.05,\r\n      bounds: { left: -90, right: 90 },\r\n    }\r\n  );\r\n\r\n  const getRaster = () => {\r\n    if (!drawRef.current) return;\r\n    const imageData = drawRef.current.rasterize();\r\n    Modal.confirm({\r\n      title: \"Screenshot\",\r\n      content: <img className=\"raster\" src={imageData} alt=\"raster\" />,\r\n      className: \"raster-modal\",\r\n      icon: <PictureOutlined />,\r\n      okText: \"Save\",\r\n      onOk: () => saveAs(imageData, \"screenshot\"),\r\n    });\r\n  };\r\n\r\n  return createPortal(\r\n    <div className=\"select-tool\">\r\n      <Popover\r\n        trigger=\"click\"\r\n        placement=\"bottom\"\r\n        getPopupContainer={(e) => e.parentElement!}\r\n        destroyTooltipOnHide\r\n        content={\r\n          <PenPanel\r\n            updateDrawCtrl={(updated) => {\r\n              setCurrDrawCtrl((prev) => ({ ...prev, ...updated }));\r\n              drawRef.current?.mutateStyle(updated);\r\n            }}\r\n            drawCtrl={currDrawCtrl}\r\n          />\r\n        }\r\n      >\r\n        <Button icon={<BgColorsOutlined />} {...btnProps} />\r\n      </Popover>\r\n      <div className=\"rotate-wrapper\" data-dragged={dragged} ref={rotateEl}>\r\n        <Button\r\n          icon={<RotateRightOutlined />}\r\n          onClick={() => drawRef.current?.rotateSelected(90, true)}\r\n          {...btnProps}\r\n        />\r\n        <CaretLeftOutlined className=\"arrow left\" />\r\n        <CaretRightOutlined className=\"arrow right\" />\r\n        <div className=\"gear\" style={gearStyle} />\r\n      </div>\r\n      <Button\r\n        icon={<CopyOutlined />}\r\n        onClick={() => drawRef.current?.duplicateSelected()}\r\n        {...btnProps}\r\n      />\r\n      <Button icon={<PictureOutlined />} onClick={getRaster} {...btnProps} />\r\n      <Button\r\n        danger\r\n        icon={<DeleteOutlined />}\r\n        onClick={() => drawRef.current?.deleteSelected()}\r\n        {...btnProps}\r\n      />\r\n    </div>,\r\n    document.querySelector(\".reader.container > header\")!\r\n  );\r\n};\r\n\r\nexport const TextTool: FC<{\r\n  drawRef: RefObject<DrawRefType>;\r\n  visible: boolean;\r\n}> = ({ visible, drawRef }) => {\r\n  const [text, setText] = useState(\"\");\r\n  const [color, setColor] = useState(allColors[0]);\r\n  const [align, setAlign] = useState(\"center\");\r\n  const { forceLight } = useContext(ReaderStateCtx);\r\n\r\n  useEffect(() => {\r\n    const pointText = drawRef.current?.pointText;\r\n    if (!pointText || !visible) return;\r\n    const { name, content, justification, fillColor } = pointText;\r\n    setAlign(justification);\r\n    if (name) {\r\n      setText(content);\r\n      setColor(fillColor?.toCSS(true) ?? allColors[0]);\r\n    } else {\r\n      setText(\"\");\r\n      setColor(allColors[0]);\r\n    }\r\n  }, [visible, drawRef]);\r\n\r\n  const fontColorBtn = (\r\n    <Popover\r\n      content={<ColorSelect color={color} setColor={setColor} />}\r\n      overlayStyle={{ width: 200 }}\r\n      placement=\"bottom\"\r\n      getPopupContainer={(e) => e.parentElement!}\r\n    >\r\n      <Button\r\n        size=\"small\"\r\n        icon={<FontColorsOutlined className=\"font-icon\" style={{ color }} />}\r\n      />\r\n    </Popover>\r\n  );\r\n\r\n  const alignRadio = (\r\n    <Radio.Group\r\n      size=\"small\"\r\n      optionType=\"button\"\r\n      value={align}\r\n      buttonStyle=\"solid\"\r\n      onChange={(e) => setAlign(e.target.value)}\r\n      options={[\r\n        { label: <AlignLeftOutlined />, value: \"left\" },\r\n        { label: <AlignCenterOutlined />, value: \"center\" },\r\n        { label: <AlignRightOutlined />, value: \"right\" },\r\n      ]}\r\n    />\r\n  );\r\n\r\n  return (\r\n    <Modal\r\n      visible={visible}\r\n      title=\"Insert text\"\r\n      onCancel={() => drawRef.current?.cancelText()}\r\n      onOk={() => {\r\n        const content = text.trim();\r\n        if (!content) return drawRef.current?.cancelText();\r\n        drawRef.current?.submitText(content, color, align);\r\n      }}\r\n      bodyStyle={{ paddingTop: 0 }}\r\n      destroyOnClose\r\n    >\r\n      <div className=\"insert-option\" data-force-light={forceLight}>\r\n        {fontColorBtn}\r\n        {alignRadio}\r\n      </div>\r\n      <TextArea\r\n        size=\"large\"\r\n        rows={3}\r\n        autoFocus\r\n        value={text}\r\n        onChange={(e) => setText(e.target.value)}\r\n      />\r\n    </Modal>\r\n  );\r\n};\r\n","import { useDebugValue, useEffect, useMemo, useRef, useState } from \"react\";\nimport localforage from \"localforage\";\nimport { Map } from \"immutable\";\n\nexport function useScrollPage(noteID: string, pageOrder = [] as string[]) {\n  const [refMap, setRefMap] = useState(Map<string, HTMLElement>());\n  const scrolled = useRef(false);\n  const [prevPageID, setPrevPageID] = useState(\"\");\n  const [inviewRatios, setInviewRatios] = useState(Map<string, number>());\n  const currPageID = useMemo(\n    () => largestKey(inviewRatios, pageOrder),\n    [inviewRatios, pageOrder]\n  );\n  useDebugValue(currPageID);\n\n  useEffect(() => {\n    const loadPrevPageID = async () => {\n      const stored = await localforage.getItem<string>(`SCROLL_${noteID}`);\n      if (!stored) return (scrolled.current = true);\n      setPrevPageID(stored);\n    };\n    loadPrevPageID();\n  }, [noteID]);\n\n  useEffect(() => {\n    if (scrolled.current || !refMap.has(prevPageID)) return;\n    requestAnimationFrame(() => {\n      refMap.get(prevPageID)?.scrollIntoView();\n      scrolled.current = true;\n    });\n  }, [prevPageID, refMap]);\n\n  useEffect(() => {\n    if (!scrolled.current) return;\n    localforage.setItem(`SCROLL_${noteID}`, currPageID);\n  }, [currPageID, noteID]);\n\n  const setRef = (pageID: string, el: HTMLElement | null) => {\n    if (!el) return;\n    setRefMap((prev) => prev.set(pageID, el));\n  };\n\n  const scrollPage = (pageID: string) => {\n    refMap.get(pageID)?.scrollIntoView();\n  };\n\n  return { scrollPage, setInviewRatios, setRef, currPageID };\n}\n\nconst largestKey = (map: Map<string, number>, order: string[]) => {\n  let result = \"\";\n  let maxRatio = 0;\n  for (let key of order) {\n    const ratio = map.get(key);\n    if (!ratio) continue;\n    if (ratio === 1) return key;\n    if (ratio > maxRatio) {\n      result = key;\n      maxRatio = ratio;\n    }\n  }\n  return result;\n};\n","import { FC, useContext } from \"react\";\r\nimport { Button, message, Popover, ButtonProps } from \"antd\";\r\nimport { ReaderMethodCtx, ReaderStateCtx } from \"../Reader\";\r\nimport { DrawCtrl, saveDrawCtrl } from \"../../../lib/draw/drawCtrl\";\r\nimport {\r\n  BulbFilled,\r\n  BulbOutlined,\r\n  UndoOutlined,\r\n  RedoOutlined,\r\n  GatewayOutlined,\r\n  HighlightOutlined,\r\n} from \"@ant-design/icons\";\r\nimport IconFont from \"../../ui/IconFont\";\r\nimport { PenPanel, WidthSelect } from \"../tools/PenPanel\";\r\n\r\nexport const HeaderMiddle = () => {\r\n  const { stateSet, drawCtrl, forceLight } = useContext(ReaderStateCtx);\r\n  const { setDrawCtrl, handleUndo, handleRedo, setForceLight } =\r\n    useContext(ReaderMethodCtx);\r\n  const { mode, finger } = drawCtrl;\r\n\r\n  const updateDrawCtrl = (updated: Partial<DrawCtrl>) => {\r\n    setDrawCtrl((prev) => {\r\n      const newCtrl = { ...prev, ...updated };\r\n      saveDrawCtrl(newCtrl);\r\n      return newCtrl;\r\n    });\r\n  };\r\n\r\n  return (\r\n    <div className=\"middle\">\r\n      <Button\r\n        type=\"text\"\r\n        shape=\"circle\"\r\n        icon={<UndoOutlined />}\r\n        onClick={handleUndo}\r\n        disabled={!stateSet?.isUndoable()}\r\n      />\r\n      <Button\r\n        type=\"text\"\r\n        shape=\"circle\"\r\n        icon={<RedoOutlined />}\r\n        onClick={handleRedo}\r\n        disabled={!stateSet?.isRedoable()}\r\n      />\r\n      <Button\r\n        type={finger ? \"default\" : \"text\"}\r\n        shape=\"circle\"\r\n        onClick={() => {\r\n          updateDrawCtrl({ finger: !finger });\r\n          message.destroy(\"FINGER\");\r\n          message.open({\r\n            content: finger ? \"Pencil only\" : \"Draw with finger\",\r\n            key: \"FINGER\",\r\n          });\r\n        }}\r\n        icon={<IconFont type=\"icon-finger\" />}\r\n      />\r\n      <Button\r\n        className=\"force-light-btn\"\r\n        type=\"text\"\r\n        shape=\"circle\"\r\n        icon={forceLight ? <BulbFilled /> : <BulbOutlined />}\r\n        onClick={() => setForceLight((prev) => !prev)}\r\n      />\r\n      <PenButton updateDrawCtrl={updateDrawCtrl} />\r\n      <EraserButton updateDrawCtrl={updateDrawCtrl} />\r\n      <Button\r\n        type={mode === \"text\" ? \"default\" : \"text\"}\r\n        shape=\"circle\"\r\n        onClick={() => updateDrawCtrl({ mode: \"text\" })}\r\n        icon={<IconFont type=\"icon-text1\" />}\r\n      />\r\n      <SelectButton updateDrawCtrl={updateDrawCtrl} />\r\n    </div>\r\n  );\r\n};\r\n\r\nconst PenButton: FC<{\r\n  updateDrawCtrl: (updated: Partial<DrawCtrl>) => void;\r\n}> = ({ updateDrawCtrl }) => {\r\n  const { drawCtrl } = useContext(ReaderStateCtx);\r\n  const { mode } = drawCtrl;\r\n\r\n  const btnProps: ButtonProps = {\r\n    shape: \"circle\",\r\n    icon: <HighlightOutlined />,\r\n  };\r\n  return mode === \"draw\" ? (\r\n    <Popover\r\n      content={<PenPanel updateDrawCtrl={updateDrawCtrl} drawCtrl={drawCtrl} />}\r\n      trigger=\"click\"\r\n      placement=\"bottom\"\r\n      getPopupContainer={(e) => e.parentElement!}\r\n      destroyTooltipOnHide\r\n    >\r\n      <Button type=\"default\" {...btnProps} />\r\n    </Popover>\r\n  ) : (\r\n    <Button\r\n      type=\"text\"\r\n      onClick={() => updateDrawCtrl({ mode: \"draw\" })}\r\n      {...btnProps}\r\n    />\r\n  );\r\n};\r\n\r\nconst EraserButton: FC<{\r\n  updateDrawCtrl: (updated: Partial<DrawCtrl>) => void;\r\n}> = ({ updateDrawCtrl }) => {\r\n  const { drawCtrl } = useContext(ReaderStateCtx);\r\n\r\n  const btnProps: ButtonProps = {\r\n    shape: \"circle\",\r\n    icon: <IconFont type=\"icon-eraser\" />,\r\n  };\r\n\r\n  return drawCtrl.mode === \"erase\" ? (\r\n    <Popover\r\n      content={\r\n        <div className=\"width-seg-wrapper\">\r\n          <WidthSelect\r\n            drawCtrl={drawCtrl}\r\n            updateDrawCtrl={updateDrawCtrl}\r\n            field=\"eraserWidth\"\r\n          />\r\n        </div>\r\n      }\r\n      trigger=\"click\"\r\n      placement=\"bottom\"\r\n      getPopupContainer={(e) => e.parentElement!}\r\n      destroyTooltipOnHide\r\n    >\r\n      <Button type=\"default\" {...btnProps} />\r\n    </Popover>\r\n  ) : (\r\n    <Button\r\n      type=\"text\"\r\n      onClick={() => updateDrawCtrl({ mode: \"erase\" })}\r\n      {...btnProps}\r\n    />\r\n  );\r\n};\r\n\r\nconst SelectButton: FC<{\r\n  updateDrawCtrl: (updated: Partial<DrawCtrl>) => void;\r\n}> = ({ updateDrawCtrl }) => {\r\n  const {\r\n    drawCtrl: { lasso, mode },\r\n  } = useContext(ReaderStateCtx);\r\n\r\n  const icon = lasso ? <IconFont type=\"icon-lasso1\" /> : <GatewayOutlined />;\r\n\r\n  return mode === \"select\" ? (\r\n    <Button\r\n      type=\"default\"\r\n      shape=\"circle\"\r\n      icon={icon}\r\n      onClick={() => updateDrawCtrl({ lasso: !lasso })}\r\n    />\r\n  ) : (\r\n    <Button\r\n      type=\"text\"\r\n      shape=\"circle\"\r\n      icon={icon}\r\n      onClick={() => updateDrawCtrl({ mode: \"select\" })}\r\n    />\r\n  );\r\n};\r\n","export function exchange<T>(list: T[], fromIndex: number, toIndex: number) {\r\n  const result = list.slice();\r\n  const [removed] = result.splice(fromIndex, 1);\r\n  result.splice(toIndex, 0, removed);\r\n  return result;\r\n}\r\n\r\nexport function insertAfter<T>(list: T[], prevItem: T, newItem: T) {\r\n  const prevIndex = list.indexOf(prevItem);\r\n  const curr = list.slice();\r\n  if (prevIndex === -1) return curr;\r\n  curr.splice(prevIndex + 1, 0, newItem);\r\n  return curr;\r\n}\r\n","import { Avatar } from \"antd\";\nimport { AvatarSize } from \"antd/lib/avatar/SizeContext\";\nimport { FC, useContext, useMemo } from \"react\";\nimport { getHashedColor } from \"../../lib/color\";\nimport { TeamCtx } from \"../reader/Team\";\n\nexport const UserAvatar: FC<{\n  userID: string;\n  size?: AvatarSize;\n  onClick?: () => void;\n  chosen?: boolean;\n  className?: string;\n}> = ({\n  userID,\n  size = \"default\",\n  onClick = () => {},\n  chosen = false,\n  className,\n}) => {\n  const { userRec } = useContext(TeamCtx);\n  const color = useMemo(() => getHashedColor(userID), [userID]);\n  const userInfo = userRec[userID];\n  if (!userInfo) return null;\n  const { userName } = userInfo;\n\n  return (\n    <Avatar\n      className={className}\n      data-chosen={chosen}\n      size={size}\n      style={{ backgroundColor: color }}\n    >\n      <div className=\"avatar-wrapper\" onClick={onClick}>\n        {userName?.slice(0, 3)}\n      </div>\n    </Avatar>\n  );\n};\n","import React, {\r\n  FC,\r\n  useRef,\r\n  useMemo,\r\n  useState,\r\n  useEffect,\r\n  useContext,\r\n} from \"react\";\r\nimport {\r\n  MoreOutlined,\r\n  PlusOutlined,\r\n  CopyOutlined,\r\n  DeleteOutlined,\r\n  MenuFoldOutlined,\r\n  MenuUnfoldOutlined,\r\n} from \"@ant-design/icons\";\r\nimport {\r\n  Draggable,\r\n  Droppable,\r\n  DropResult,\r\n  DragDropContext,\r\n} from \"react-beautiful-dnd\";\r\nimport { PageWrapper, ReaderMethodCtx, ReaderStateCtx } from \"./Reader\";\r\nimport { Avatar, Button, Drawer, Menu, Popover, Tabs } from \"antd\";\r\nimport { AddPageButton } from \"./ReaderUtils\";\r\nimport { exchange } from \"./lib/array\";\r\nimport { Setter } from \"../../lib/hooks\";\r\nimport IconFont from \"../ui/IconFont\";\r\nimport { TeamCtx } from \"./Team\";\r\nimport \"./preview.sass\";\r\nimport { UserAvatar } from \"../widgets/UserAvatar\";\r\nimport classNames from \"classnames\";\r\n\r\nconst PreviewCtx = React.createContext({\r\n  activeKey: \"ALL\",\r\n  setActiveKey: (() => {}) as Setter<string>,\r\n});\r\n\r\nconst PageNavContent = () => {\r\n  const { pageOrder, currPageID, forceLight } = useContext(ReaderStateCtx);\r\n  const { scrollPage, saveReorder } = useContext(ReaderMethodCtx);\r\n  const { activeKey } = useContext(PreviewCtx);\r\n  const refRec = useRef<Record<string, HTMLElement>>({});\r\n\r\n  const onDragEnd = ({ source, destination }: DropResult) => {\r\n    if (!destination || !pageOrder) return;\r\n    const { index: fromIndex } = source;\r\n    const { index: toIndex } = destination;\r\n    if (fromIndex === toIndex) return;\r\n    const pageID = pageOrder[fromIndex];\r\n    const newOrder = exchange(pageOrder, fromIndex, toIndex);\r\n    saveReorder(newOrder, true);\r\n    requestAnimationFrame(() => scrollPage(pageID));\r\n  };\r\n\r\n  // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  useEffect(() => refRec.current[currPageID]?.scrollIntoView(), []);\r\n\r\n  return (\r\n    <div className=\"preview-container\" data-force-light={forceLight}>\r\n      <PreviewTabs />\r\n      <DragDropContext onDragEnd={onDragEnd}>\r\n        <Droppable droppableId=\"preview-list\">\r\n          {({ droppableProps, innerRef, placeholder }) => (\r\n            <div className=\"page-list\" ref={innerRef} {...droppableProps}>\r\n              {pageOrder?.map((uid, index) => (\r\n                <PagePreview\r\n                  key={uid}\r\n                  uid={uid}\r\n                  pageIndex={index}\r\n                  refRec={refRec.current}\r\n                />\r\n              ))}\r\n              {placeholder}\r\n              {activeKey === \"ALL\" && <AddPageButton />}\r\n            </div>\r\n          )}\r\n        </Droppable>\r\n      </DragDropContext>\r\n    </div>\r\n  );\r\n};\r\n\r\nconst PagePreview: FC<{\r\n  uid: string;\r\n  pageIndex: number;\r\n  refRec: Record<string, HTMLElement>;\r\n}> = ({ uid, pageIndex, refRec }) => {\r\n  const { stateSet, teamState, pageRec, currPageID } =\r\n    useContext(ReaderStateCtx);\r\n  const { scrollPage } = useContext(ReaderMethodCtx);\r\n  const { activeKey } = useContext(PreviewCtx);\r\n  const [chosen, setChosen] = useState(\"\");\r\n\r\n  const page = pageRec?.get(uid);\r\n  const drawState = stateSet?.getOneState(uid);\r\n  const teamStateMap = teamState?.getOnePageStateMap(uid);\r\n\r\n  if (!page || !drawState) return null;\r\n  const { image, marked } = page;\r\n\r\n  if (\r\n    activeKey === \"WRITTEN\" &&\r\n    drawState.isEmpty() &&\r\n    (!teamStateMap || teamStateMap.every((ds) => ds.isEmpty()))\r\n  ) {\r\n    return null;\r\n  }\r\n  if (activeKey === \"MARKED\" && !marked) return null;\r\n  const curr = currPageID === uid;\r\n\r\n  return (\r\n    <Draggable\r\n      draggableId={uid}\r\n      index={pageIndex}\r\n      isDragDisabled={activeKey !== \"ALL\"}\r\n    >\r\n      {(\r\n        { innerRef, draggableProps, dragHandleProps },\r\n        { isDragging: dragged }\r\n      ) => (\r\n        <div\r\n          ref={(e) => {\r\n            innerRef(e);\r\n            if (e) refRec[uid] = e;\r\n          }}\r\n          className=\"page\"\r\n          data-curr={curr}\r\n          data-dragged={dragged}\r\n          onClick={() => scrollPage(uid)}\r\n          {...draggableProps}\r\n          {...dragHandleProps}\r\n        >\r\n          <PageWrapper\r\n            uid={uid}\r\n            drawState={teamStateMap?.get(chosen) || drawState}\r\n            teamStateMap={chosen ? undefined : teamStateMap}\r\n            thumbnail={image}\r\n            preview\r\n          />\r\n          <PreviewTools\r\n            uid={uid}\r\n            index={pageIndex}\r\n            chosen={chosen}\r\n            setChosen={setChosen}\r\n          />\r\n        </div>\r\n      )}\r\n    </Draggable>\r\n  );\r\n};\r\n\r\nconst PreviewTools: FC<{\r\n  uid: string;\r\n  index: number;\r\n  chosen: string;\r\n  setChosen: Setter<string>;\r\n}> = ({ uid, index, chosen, setChosen }) => {\r\n  const { switchPageMarked } = useContext(ReaderMethodCtx);\r\n  const { teamState, pageRec } = useContext(ReaderStateCtx);\r\n  const { ignores } = useContext(TeamCtx);\r\n  const userIDs = useMemo(\r\n    () =>\r\n      teamState\r\n        ?.getPageValidUsers(uid)\r\n        .filter((userID) => !ignores.has(userID)) || [],\r\n    [teamState, ignores, uid]\r\n  );\r\n  const page = pageRec?.get(uid);\r\n  if (!page) return null;\r\n  const { marked } = page;\r\n\r\n  return (\r\n    <div className=\"tools\" onClick={(e) => e.stopPropagation()}>\r\n      <span\r\n        className=\"bookmark\"\r\n        data-marked={marked}\r\n        onClick={() => switchPageMarked(uid)}\r\n      />\r\n      <span className=\"index\">{index + 1}</span>\r\n      <PreviewOption uid={uid} />\r\n      <TeamAvatars userIDs={userIDs} chosen={chosen} setChosen={setChosen} />\r\n    </div>\r\n  );\r\n};\r\n\r\nconst TeamAvatars: FC<{\r\n  userIDs: string[];\r\n  chosen: string;\r\n  setChosen: Setter<string>;\r\n}> = ({ userIDs, chosen, setChosen }) => {\r\n  return (\r\n    <Avatar.Group\r\n      maxCount={2}\r\n      size=\"default\"\r\n      className={classNames(\"team-group\", { chosen })}\r\n      maxPopoverPlacement=\"bottom\"\r\n    >\r\n      {userIDs.map((userID) => (\r\n        <UserAvatar\r\n          key={userID}\r\n          size=\"default\"\r\n          userID={userID}\r\n          className=\"preview-avatar\"\r\n          chosen={chosen === userID}\r\n          onClick={() => setChosen((prev) => (prev === userID ? \"\" : userID))}\r\n        />\r\n      ))}\r\n    </Avatar.Group>\r\n  );\r\n};\r\n\r\nconst PreviewOption = ({ uid }: { uid: string }) => {\r\n  const { addPage, deletePage } = useContext(ReaderMethodCtx);\r\n\r\n  const menu = (\r\n    <Menu\r\n      onClick={({ key }) => {\r\n        if (key === \"ADD\") {\r\n          addPage(uid);\r\n        } else if (key === \"COPY\") {\r\n          addPage(uid, true);\r\n        } else if (key === \"DELETE\") {\r\n          deletePage(uid);\r\n        }\r\n      }}\r\n      items={[\r\n        { key: \"ADD\", icon: <PlusOutlined />, label: \"Add page\" },\r\n        { key: \"COPY\", icon: <CopyOutlined />, label: \"Duplicate\" },\r\n        {\r\n          key: \"DELETE\",\r\n          icon: <DeleteOutlined />,\r\n          label: \"Delete\",\r\n          danger: true,\r\n        },\r\n      ]}\r\n    ></Menu>\r\n  );\r\n  return (\r\n    <Popover\r\n      content={menu}\r\n      trigger=\"click\"\r\n      placement=\"left\"\r\n      destroyTooltipOnHide\r\n    >\r\n      <span className=\"option\">\r\n        <MoreOutlined />\r\n      </span>\r\n    </Popover>\r\n  );\r\n};\r\n\r\nconst PreviewTabs = () => {\r\n  const { activeKey, setActiveKey } = useContext(PreviewCtx);\r\n  const { TabPane } = Tabs;\r\n  return (\r\n    <Tabs\r\n      className=\"tabs\"\r\n      activeKey={activeKey}\r\n      onChange={setActiveKey}\r\n      tabBarGutter={10}\r\n      size=\"small\"\r\n      centered\r\n    >\r\n      <TabPane tab={<IconFont type=\"icon-uf_paper\" />} key=\"ALL\" />\r\n      <TabPane tab={<IconFont type=\"icon-bookmark2\" />} key=\"MARKED\" />\r\n      <TabPane tab={<IconFont type=\"icon-write\" />} key=\"WRITTEN\" />\r\n    </Tabs>\r\n  );\r\n};\r\n\r\nexport default function PageNav() {\r\n  const [navOn, setNavOn] = useState(false);\r\n  const [activeKey, setActiveKey] = useState<string>(\"ALL\");\r\n  const title = {\r\n    ALL: \"All Pages\",\r\n    MARKED: \"Bookmarks\",\r\n    WRITTEN: \"Notes\",\r\n  }[activeKey];\r\n\r\n  return (\r\n    <PreviewCtx.Provider value={{ activeKey, setActiveKey }}>\r\n      <Button\r\n        type=\"text\"\r\n        icon={navOn ? <MenuUnfoldOutlined /> : <MenuFoldOutlined />}\r\n        onClick={() => setNavOn((prev) => !prev)}\r\n      />\r\n      <Drawer\r\n        visible={navOn}\r\n        onClose={() => setNavOn(false)}\r\n        width={200}\r\n        title={title}\r\n        closable={false}\r\n        zIndex={800}\r\n        className=\"preview-drawer\"\r\n        bodyStyle={{ padding: 0, overflow: \"hidden\" }}\r\n        headerStyle={{ textAlign: \"center\" }}\r\n        destroyOnClose\r\n      >\r\n        <PageNavContent />\r\n      </Drawer>\r\n    </PreviewCtx.Provider>\r\n  );\r\n}\r\n","import { FC, useMemo, useState, useEffect, useContext } from \"react\";\r\nimport { Badge, Alert, Modal, Button, Divider, message, Popover } from \"antd\";\r\nimport Search from \"antd/lib/input/Search\";\r\nimport { useNavigate } from \"react-router-dom\";\r\nimport { PasscodeInput } from \"antd-mobile\";\r\nimport { ReaderMethodCtx, ReaderStateCtx } from \"../Reader\";\r\nimport { TeamCtx } from \"../Team\";\r\nimport { getUserID, saveUserName } from \"../../../lib/user\";\r\nimport PageNav from \"../PageNav\";\r\nimport {\r\n  EyeOutlined,\r\n  FormOutlined,\r\n  TeamOutlined,\r\n  CopyOutlined,\r\n  CheckOutlined,\r\n  ReloadOutlined,\r\n  ShareAltOutlined,\r\n  DisconnectOutlined,\r\n  EyeInvisibleOutlined,\r\n  UsergroupAddOutlined,\r\n} from \"@ant-design/icons\";\r\nimport { editNoteData } from \"../../../lib/note/archive\";\r\nimport { UserAvatar } from \"../../widgets/UserAvatar\";\r\nimport { putNote } from \"../../../lib/network/http\";\r\nimport copy from \"clipboard-copy\";\r\n\r\nexport const HeaderRight = () => {\r\n  const { teamOn } = useContext(TeamCtx);\r\n  return (\r\n    <div className=\"right\">\r\n      {teamOn ? <RoomInfo /> : <JoinRoom />}\r\n      <PageNav />\r\n    </div>\r\n  );\r\n};\r\n\r\nconst UserCard: FC<{ userID: string }> = ({ userID }) => {\r\n  const [renaming, setRenaming] = useState(false);\r\n  const { ignores, setIgnores, resetIO, userRec } = useContext(TeamCtx);\r\n  const userInfo = userRec[userID];\r\n  useEffect(() => setRenaming(false), [userInfo]);\r\n  if (!userInfo) return null;\r\n\r\n  const { userName, online } = userInfo;\r\n  const self = userID === getUserID();\r\n  const ignored = ignores.has(userID) && !self;\r\n\r\n  const switchIgnore = () => {\r\n    setIgnores((prev) => {\r\n      if (prev.has(userID)) return prev.delete(userID);\r\n      return prev.add(userID);\r\n    });\r\n  };\r\n\r\n  const submitRename = (value: string) => {\r\n    const name = value.trim();\r\n    if (!name || name === userName) return setRenaming(false);\r\n    saveUserName(name);\r\n    resetIO();\r\n  };\r\n\r\n  return (\r\n    <div className=\"user-item\" data-online={online}>\r\n      <UserAvatar userID={userID} size=\"small\" className=\"room-avatar\" />\r\n      {renaming || <span className=\"user-name\">{userName}</span>}\r\n      {renaming && (\r\n        <Search\r\n          autoFocus\r\n          className=\"rename-input\"\r\n          defaultValue={userName}\r\n          onSearch={submitRename}\r\n          enterButton={<Button icon={<CheckOutlined />} />}\r\n        />\r\n      )}\r\n      {self ? (\r\n        renaming || (\r\n          <Button\r\n            type=\"text\"\r\n            icon={<FormOutlined />}\r\n            onClick={() => setRenaming(true)}\r\n          />\r\n        )\r\n      ) : (\r\n        <Button\r\n          type=\"text\"\r\n          icon={ignored ? <EyeInvisibleOutlined /> : <EyeOutlined />}\r\n          onClick={switchIgnore}\r\n        />\r\n      )}\r\n    </div>\r\n  );\r\n};\r\n\r\nconst RoomInfo: FC = () => {\r\n  const { code, userRec, connected, loadInfo, loadState, resetIO } =\r\n    useContext(TeamCtx);\r\n  const { noteInfo } = useContext(ReaderStateCtx);\r\n  const link = window.location.href;\r\n  const share = async () => {\r\n    const selfName = userRec[getUserID()]?.userName;\r\n    try {\r\n      if (!noteInfo) return;\r\n      await copy(`${noteInfo.name} - ${selfName} - Multibility\\n${link}`);\r\n      message.destroy(\"copy\");\r\n      message.success({\r\n        content: \"Link copied!\",\r\n        icon: <CopyOutlined />,\r\n        key: \"copy\",\r\n      });\r\n    } catch (e) {\r\n      console.log(e);\r\n    }\r\n  };\r\n\r\n  const userList = useMemo(() => {\r\n    const selfID = getUserID();\r\n    const { [selfID]: selfInfo, ...otherUsers } = userRec;\r\n    const list = selfInfo ? [selfInfo] : [];\r\n    const values = Object.values(otherUsers);\r\n    list.push(\r\n      ...values.filter(({ online }) => online),\r\n      ...values.filter(({ online }) => !online)\r\n    );\r\n    return list;\r\n  }, [userRec]);\r\n\r\n  const onlineNum = useMemo(\r\n    () => userList.filter(({ online }) => online).length,\r\n    [userList]\r\n  );\r\n\r\n  const teamPop = (\r\n    <div className=\"team-popover\">\r\n      {connected || (\r\n        <Alert\r\n          className=\"disconn-alert\"\r\n          message=\"Network failed.\"\r\n          icon={<DisconnectOutlined />}\r\n          type=\"error\"\r\n          showIcon\r\n          banner\r\n        />\r\n      )}\r\n      <PasscodeInput\r\n        className=\"code-display\"\r\n        value={String(code)}\r\n        length={4}\r\n        plain\r\n      />\r\n      <Button\r\n        icon={<ShareAltOutlined />}\r\n        className=\"share-btn\"\r\n        onClick={share}\r\n        block\r\n      >\r\n        Share\r\n      </Button>\r\n      <Divider />\r\n      <div className=\"user-list\">\r\n        {userList.map((u) => (\r\n          <UserCard key={u.userID} userID={u.userID} />\r\n        ))}\r\n      </div>\r\n    </div>\r\n  );\r\n\r\n  const [reloading, setReloading] = useState(false);\r\n  const title = (\r\n    <div className=\"team-title\">\r\n      <span>Team info</span>\r\n      <Button\r\n        shape=\"circle\"\r\n        type=\"text\"\r\n        size=\"small\"\r\n        loading={reloading}\r\n        icon={<ReloadOutlined />}\r\n        onClick={async () => {\r\n          setReloading(true);\r\n          await loadInfo();\r\n          await loadState();\r\n          setReloading(false);\r\n          resetIO();\r\n        }}\r\n      />\r\n    </div>\r\n  );\r\n\r\n  return (\r\n    <Popover\r\n      content={teamPop}\r\n      trigger=\"click\"\r\n      placement=\"bottomRight\"\r\n      title={title}\r\n      getPopupContainer={(e) => e.parentElement!}\r\n    >\r\n      <Button\r\n        type=\"text\"\r\n        icon={\r\n          <Badge\r\n            status={connected ? \"success\" : \"error\"}\r\n            count={connected ? onlineNum : \"!\"}\r\n            size=\"small\"\r\n          >\r\n            <TeamOutlined />\r\n          </Badge>\r\n        }\r\n      />\r\n    </Popover>\r\n  );\r\n};\r\n\r\nconst JoinRoom = () => {\r\n  const { noteID } = useContext(ReaderStateCtx);\r\n  const { instantSave } = useContext(ReaderMethodCtx);\r\n  const nav = useNavigate();\r\n\r\n  const createRoom = async () => {\r\n    await instantSave();\r\n    const res = await putNote(noteID);\r\n    if (!res) return message.error(\"Can't create room.\");\r\n    await editNoteData(noteID, { team: true });\r\n    nav(\"/team/\" + noteID);\r\n  };\r\n\r\n  return (\r\n    <Button\r\n      type=\"text\"\r\n      icon={<UsergroupAddOutlined />}\r\n      onClick={() => {\r\n        Modal.confirm({\r\n          title: \"Enable team editing\",\r\n          content: \"This will make your note public.\",\r\n          icon: <TeamOutlined style={{ color: \"#555\" }} />,\r\n          onOk: createRoom,\r\n        });\r\n      }}\r\n    />\r\n  );\r\n};\r\n","import { useContext } from \"react\";\r\nimport { Button } from \"antd\";\r\nimport { useNavigate } from \"react-router-dom\";\r\nimport { ReaderMethodCtx, ReaderStateCtx } from \"../Reader\";\r\nimport { HomeFilled, SaveOutlined } from \"@ant-design/icons\";\r\nimport { HeaderMiddle } from \"./Middle\";\r\nimport { HeaderRight } from \"./Right\";\r\nimport \"./header.sass\";\r\n\r\nexport default function ReaderHeader() {\r\n  return (\r\n    <header>\r\n      <HeaderLeft />\r\n      <HeaderMiddle />\r\n      <HeaderRight />\r\n    </header>\r\n  );\r\n}\r\n\r\nconst HeaderLeft = () => {\r\n  const { saved } = useContext(ReaderStateCtx);\r\n  const { instantSave } = useContext(ReaderMethodCtx);\r\n  const nav = useNavigate();\r\n\r\n  return (\r\n    <div className=\"left\">\r\n      <Button\r\n        type=\"text\"\r\n        onClick={async () => {\r\n          await instantSave();\r\n          nav(\"/\");\r\n        }}\r\n        icon={<HomeFilled style={{ opacity: 0.8 }} />}\r\n      />\r\n      <Button\r\n        type=\"text\"\r\n        className=\"save\"\r\n        onClick={instantSave}\r\n        disabled={saved}\r\n        icon={<SaveOutlined />}\r\n      />\r\n    </div>\r\n  );\r\n};\r\n","import {\r\n  FC,\r\n  useRef,\r\n  useMemo,\r\n  useState,\r\n  useEffect,\r\n  useContext,\r\n  useCallback,\r\n  createContext,\r\n} from \"react\";\r\nimport {\r\n  DrawCtrl,\r\n  getDrawCtrl,\r\n  defaultDrawCtrl,\r\n} from \"../../lib/draw/drawCtrl\";\r\nimport {\r\n  NoteInfo,\r\n  NotePage,\r\n  createPage,\r\n  defaultNotePage,\r\n} from \"../../lib/note/note\";\r\nimport { NewPageInfo, ReorderInfo, SyncInfo } from \"../../lib/network/io\";\r\nimport { useMemoizedFn as useEvent, useSafeState } from \"ahooks\";\r\nimport { SetOperation, StateSet } from \"../../lib/draw/StateSet\";\r\nimport Draw, { ActiveToolKey, DrawRefType } from \"../draw/Draw\";\r\nimport { loadNote, editNoteData } from \"../../lib/note/archive\";\r\nimport { AddPageButton, showPageDelMsg } from \"./ReaderUtils\";\r\nimport { useParams, useNavigate } from \"react-router-dom\";\r\nimport { SelectTool, TextTool } from \"./tools/DrawTools\";\r\nimport { debounce, last, once, range } from \"lodash-es\";\r\nimport { useInView } from \"react-intersection-observer\";\r\nimport { DrawState } from \"../../lib/draw/DrawState\";\r\nimport { TeamState } from \"../../lib/draw/TeamState\";\r\nimport { useScrollPage } from \"./lib/scroll\";\r\nimport ReaderHeader from \"./header/Header\";\r\nimport { insertAfter } from \"./lib/array\";\r\nimport { Setter } from \"../../lib/hooks\";\r\nimport { TeamCtx } from \"./Team\";\r\nimport { Map } from \"immutable\";\r\nimport { message } from \"antd\";\r\nimport \"./reader.sass\";\r\n\r\nexport const ReaderStateCtx = createContext({\r\n  noteID: \"\",\r\n  noteInfo: undefined as NoteInfo | undefined,\r\n  stateSet: undefined as StateSet | undefined,\r\n  teamState: undefined as TeamState | undefined,\r\n  pageRec: undefined as Map<string, NotePage> | undefined,\r\n  pageOrder: undefined as string[] | undefined,\r\n  saved: true,\r\n  currPageID: \"\",\r\n  drawCtrl: defaultDrawCtrl,\r\n  forceLight: false,\r\n});\r\n\r\nexport const ReaderMethodCtx = createContext({\r\n  scrollPage: (pageID: string) => {},\r\n  switchPageMarked: (pageID: string) => {},\r\n  updateStateSet: (cb: (prevSS: StateSet) => StateSet) => {},\r\n  addPage: (prevPageID: string, copy?: boolean) => {},\r\n  addFinalPage: () => {},\r\n  deletePage: (pageID: string) => {},\r\n  saveReorder: async (order: string[], push: boolean) => {},\r\n  setInviewRatios: (() => {}) as Setter<Map<string, number>>,\r\n  setDrawCtrl: (() => {}) as Setter<DrawCtrl>,\r\n  instantSave: (() => {}) as () => Promise<void> | undefined,\r\n  handleUndo: () => {},\r\n  handleRedo: () => {},\r\n  setForceLight: (() => {}) as Setter<boolean>,\r\n});\r\n\r\nexport default function Reader() {\r\n  const noteID = useParams().noteID ?? \"\";\r\n  const nav = useNavigate();\r\n\r\n  const [pageRec, setPageRec] = useState<Map<string, NotePage>>();\r\n  const [noteInfo, setNoteInfo] = useState<NoteInfo>();\r\n  const [stateSet, setStateSet] = useState<StateSet>();\r\n  const [drawCtrl, setDrawCtrl] = useState(defaultDrawCtrl);\r\n  const [pageOrder, setPageOrder] = useState<string[]>();\r\n  const [saved, setSaved] = useSafeState(true);\r\n  const [forceLight, setForceLight] = useState(false);\r\n\r\n  const { io, teamOn, teamState, addTeamStatePage } = useContext(TeamCtx);\r\n  const { setInviewRatios, scrollPage, setRef, currPageID } = useScrollPage(\r\n    noteID,\r\n    pageOrder\r\n  );\r\n\r\n  useEffect(() => {\r\n    (async () => {\r\n      const storedNote = await loadNote(noteID);\r\n      if (!storedNote) {\r\n        message.error(\"Note not found\");\r\n        return nav(\"/\");\r\n      }\r\n      const { pageRec, pdf, pageOrder, ...noteInfo } = storedNote;\r\n      setPageRec(Map(pageRec));\r\n      setPageOrder(pageOrder);\r\n      setNoteInfo(noteInfo);\r\n      setStateSet(StateSet.createFromPages(pageRec));\r\n      setDrawCtrl(await getDrawCtrl());\r\n    })();\r\n  }, [nav, noteID, teamOn]);\r\n\r\n  useEffect(() => {\r\n    if (!noteInfo) return;\r\n    document.title = noteInfo.name + \" - Multibility\";\r\n  }, [noteInfo]);\r\n\r\n  const saver = useEvent(async () => {\r\n    const pr = pageRec?.toObject();\r\n    await editNoteData(noteID, { pageRec: pr });\r\n    setSaved(true);\r\n  });\r\n\r\n  // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  const debouncedSave = useCallback(debounce(saver, 2000), [saver]);\r\n  const instantSave = debouncedSave.flush;\r\n\r\n  const savePageRec = (pageID: string, cb: (prev: NotePage) => NotePage) => {\r\n    setPageRec((prev) => prev?.update(pageID, defaultNotePage, cb));\r\n    setSaved(false);\r\n    debouncedSave();\r\n  };\r\n\r\n  const saveReorder = async (pageOrder: string[], push = false) => {\r\n    setPageOrder(pageOrder);\r\n    await editNoteData(noteID, { pageOrder });\r\n    await instantSave();\r\n    push && pushReorder(pageOrder);\r\n  };\r\n\r\n  const pushReorder = (pageOrder: string[]) =>\r\n    io?.emit(\"reorder\", { pageOrder });\r\n\r\n  const handleReorder = useEvent(\r\n    ({ deleted, pageOrder, prevOrder }: ReorderInfo) => {\r\n      saveReorder(pageOrder);\r\n      if (!deleted) return;\r\n      showPageDelMsg(() => saveReorder(prevOrder, true));\r\n    }\r\n  );\r\n\r\n  const handleNewPage = useEvent(\r\n    ({ pageOrder, pageID, newPage }: NewPageInfo) => {\r\n      saveReorder(pageOrder);\r\n      savePageRec(pageID, () => newPage);\r\n      setStateSet((prev) => prev?.addState(pageID, newPage));\r\n    }\r\n  );\r\n\r\n  useEffect(() => {\r\n    io?.on(\"reorder\", handleReorder);\r\n    io?.on(\"newPage\", handleNewPage);\r\n    return () => void io?.removeAllListeners();\r\n  }, [io, handleReorder, handleNewPage]);\r\n\r\n  const pushOperation = (operation: SetOperation) => {\r\n    const handleSync = ({ pageID, stroke }: SyncInfo) =>\r\n      setStateSet((prev) => prev?.syncStrokeTime(pageID, stroke));\r\n\r\n    io?.emit(\"push\", { operation }, handleSync);\r\n  };\r\n\r\n  const pushNewPage = (\r\n    pageOrder: string[],\r\n    pageID: string,\r\n    newPage: NotePage\r\n  ) => {\r\n    const { image, marked, ...newTeamPage } = newPage;\r\n    io?.emit(\"newPage\", { pageOrder, pageID, newPage: newTeamPage });\r\n    addTeamStatePage(pageID, newPage);\r\n  };\r\n\r\n  const updatePageRec = (pageID: string, ds: DrawState) => {\r\n    const state = DrawState.flaten(ds);\r\n    savePageRec(pageID, (prev) => ({ ...prev, state }));\r\n  };\r\n\r\n  const updateStateSet = (cb: (prevSS: StateSet) => StateSet) => {\r\n    if (!stateSet) return;\r\n    const newSS = cb(stateSet);\r\n    setStateSet(newSS);\r\n    const lastDS = newSS.getLastDS();\r\n    const lastOp = newSS.lastOp;\r\n    if (!lastDS || !lastOp) return;\r\n    updatePageRec(...lastDS);\r\n    pushOperation(lastOp);\r\n  };\r\n\r\n  const switchPageMarked = (pageID: string) =>\r\n    savePageRec(pageID, (prev) => ({ ...prev, marked: !prev.marked }));\r\n\r\n  const addPage = (prevPageID: string, copy = false) => {\r\n    if (!pageOrder) return;\r\n    const prevPage = copy ? pageRec?.get(prevPageID) : undefined;\r\n    const [pageID, newPage] = createPage(prevPage);\r\n    const newOrder = insertAfter(pageOrder, prevPageID, pageID);\r\n    pushNewPage(newOrder, pageID, newPage);\r\n    saveReorder(newOrder);\r\n    savePageRec(pageID, () => newPage);\r\n    setStateSet((prev) => prev?.addState(pageID, newPage));\r\n  };\r\n\r\n  const addFinalPage = () => {\r\n    const lastPageID = last(pageOrder);\r\n    lastPageID && addPage(lastPageID);\r\n  };\r\n\r\n  const deletePage = (pageID: string) => {\r\n    const newOrder = pageOrder?.filter((id) => id !== pageID);\r\n    newOrder?.length && saveReorder(newOrder, true);\r\n  };\r\n\r\n  const handleUndo = () => updateStateSet((prev) => prev.undo());\r\n  const handleRedo = () => updateStateSet((prev) => prev.redo());\r\n  const renderResult = (\r\n    <div className=\"reader container\" data-force-light={forceLight}>\r\n      <ReaderHeader />\r\n      <main>\r\n        {pageOrder?.map((uid) => (\r\n          <section key={uid} className=\"note-page\" ref={(e) => setRef(uid, e)}>\r\n            <PageContainer uid={uid} />\r\n          </section>\r\n        ))}\r\n        <AddPageButton />\r\n      </main>\r\n    </div>\r\n  );\r\n\r\n  return (\r\n    <ReaderStateCtx.Provider\r\n      value={{\r\n        saved,\r\n        noteID,\r\n        pageRec,\r\n        drawCtrl,\r\n        noteInfo,\r\n        stateSet,\r\n        teamState,\r\n        pageOrder,\r\n        currPageID,\r\n        forceLight,\r\n      }}\r\n    >\r\n      <ReaderMethodCtx.Provider\r\n        value={{\r\n          addPage,\r\n          scrollPage,\r\n          deletePage,\r\n          setDrawCtrl,\r\n          saveReorder,\r\n          instantSave,\r\n          addFinalPage,\r\n          handleRedo,\r\n          handleUndo,\r\n          updateStateSet,\r\n          setInviewRatios,\r\n          switchPageMarked,\r\n          setForceLight,\r\n        }}\r\n      >\r\n        {renderResult}\r\n      </ReaderMethodCtx.Provider>\r\n    </ReaderStateCtx.Provider>\r\n  );\r\n}\r\n\r\nconst PageContainer: FC<{ uid: string }> = ({ uid }) => {\r\n  const { pageRec, stateSet, teamState } = useContext(ReaderStateCtx);\r\n  const { updateStateSet } = useContext(ReaderMethodCtx);\r\n\r\n  const page = pageRec?.get(uid);\r\n  const drawState = stateSet?.getOneState(uid);\r\n  const teamStateMap = teamState?.getOnePageStateMap(uid);\r\n  const updateState = (ds: DrawState) => {\r\n    updateStateSet((prev) => prev.setState(uid, ds));\r\n  };\r\n\r\n  if (!page || !drawState) return null;\r\n  return (\r\n    <PageWrapper\r\n      drawState={drawState}\r\n      teamStateMap={teamStateMap}\r\n      updateState={updateState}\r\n      pdfIndex={page.pdfIndex}\r\n      uid={uid}\r\n    />\r\n  );\r\n};\r\n\r\nexport const PageWrapper = ({\r\n  thumbnail,\r\n  drawState,\r\n  teamStateMap,\r\n  updateState,\r\n  pdfIndex,\r\n  preview = false,\r\n  uid = \"\",\r\n}: {\r\n  drawState: DrawState;\r\n  uid?: string;\r\n  teamStateMap?: Map<string, DrawState>;\r\n  thumbnail?: string;\r\n  pdfIndex?: number;\r\n  updateState?: (ds: DrawState) => void;\r\n  preview?: boolean;\r\n}) => {\r\n  const { setInviewRatios } = useContext(ReaderMethodCtx);\r\n  const { noteID } = useContext(ReaderStateCtx);\r\n  const [fullImg, setFullImg] = useState<string>();\r\n  const [ref, visible, entry] = useInView({ threshold: range(0, 1.1, 0.1) });\r\n\r\n  useEffect(() => {\r\n    if (preview) return;\r\n    if (!entry || !visible) {\r\n      setInviewRatios((prev) => prev.delete(uid));\r\n    } else {\r\n      setInviewRatios((prev) => prev.set(uid, entry.intersectionRatio));\r\n    }\r\n  }, [visible, entry, uid, preview, setInviewRatios]);\r\n\r\n  // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  const loadImage = useCallback(\r\n    once(async () => {\r\n      if (!pdfIndex) return;\r\n      const { getNotePageImage } = await import(\"../../lib/note/pdfImage\");\r\n      setFullImg(await getNotePageImage(noteID, pdfIndex));\r\n    }),\r\n    [pdfIndex, noteID]\r\n  );\r\n\r\n  useEffect(() => {\r\n    if (!preview && visible) loadImage();\r\n  }, [visible, preview, loadImage]);\r\n\r\n  const { ignores } = useContext(TeamCtx);\r\n  const otherStates = useMemo(\r\n    () => teamStateMap?.deleteAll(ignores).toList().toArray(),\r\n    [teamStateMap, ignores]\r\n  );\r\n\r\n  const imageLoaded = Boolean(fullImg || !pdfIndex);\r\n  const drawShow = visible && imageLoaded;\r\n\r\n  const { height, width } = drawState;\r\n  const ratio = height / width;\r\n\r\n  return (\r\n    <div ref={ref} className=\"page-wrapper\">\r\n      <svg viewBox={`0 0 100 ${ratio * 100}`} />\r\n      {drawShow && (\r\n        <DrawWrapper\r\n          drawState={drawState}\r\n          otherStates={otherStates}\r\n          updateState={updateState}\r\n          imgSrc={fullImg || thumbnail}\r\n          preview={preview}\r\n        />\r\n      )}\r\n    </div>\r\n  );\r\n};\r\n\r\nconst DrawWrapper = ({\r\n  drawState,\r\n  updateState,\r\n  otherStates,\r\n  preview = false,\r\n  imgSrc,\r\n}: {\r\n  drawState: DrawState;\r\n  otherStates?: DrawState[];\r\n  updateState?: (ds: DrawState) => void;\r\n  preview?: boolean;\r\n  imgSrc?: string;\r\n}) => {\r\n  const { drawCtrl } = useContext(ReaderStateCtx);\r\n  const [activeTool, setActiveTool] = useState<ActiveToolKey>(\"\");\r\n  const drawRef = useRef<DrawRefType>(null);\r\n\r\n  const handleChange = useEvent(\r\n    (arg: ((s: DrawState) => DrawState) | DrawState) => {\r\n      if (!updateState) return;\r\n      const newDS = arg instanceof DrawState ? arg : arg(drawState);\r\n      updateState(newDS);\r\n    }\r\n  );\r\n\r\n  return preview ? (\r\n    <Draw\r\n      drawState={drawState}\r\n      otherStates={otherStates}\r\n      imgSrc={imgSrc}\r\n      readonly\r\n    />\r\n  ) : (\r\n    <>\r\n      <Draw\r\n        drawState={drawState}\r\n        otherStates={otherStates}\r\n        onChange={handleChange}\r\n        imgSrc={imgSrc}\r\n        drawCtrl={drawCtrl}\r\n        ref={drawRef}\r\n        setActiveTool={setActiveTool}\r\n      />\r\n      <SelectTool drawRef={drawRef} visible={activeTool === \"select\"} />\r\n      <TextTool drawRef={drawRef} visible={activeTool === \"text\"} />\r\n    </>\r\n  );\r\n};\r\nDrawWrapper.displayName = \"DrawWrapper\";\r\n","import { io } from \"socket.io-client\";\r\nimport { Stroke } from \"../draw/DrawState\";\r\nimport { NotePage } from \"../note/note\";\r\nimport { getUserID, getUserName } from \"../user\";\r\nimport { BASE_URL } from \"./http\";\r\n\r\nexport const IoFactory = (noteID: string) => () =>\r\n  io(BASE_URL, {\r\n    query: {\r\n      userID: getUserID(),\r\n      userName: getUserName(),\r\n      noteID,\r\n    },\r\n  });\r\n\r\nexport interface ReorderInfo {\r\n  pageOrder: string[];\r\n  prevOrder: string[];\r\n  deleted: boolean;\r\n}\r\n\r\nexport interface NewPageInfo {\r\n  pageOrder: string[];\r\n  pageID: string;\r\n  newPage: NotePage;\r\n}\r\n\r\nexport interface SyncInfo {\r\n  stroke: Stroke;\r\n  pageID: string;\r\n}\r\n","import { NotePage, TeamPage, TeamPageInfo } from \"../note/note\";\nimport { DrawState, WIDTH } from \"./DrawState\";\nimport { SetOperation } from \"./StateSet\";\nimport { Map, Record } from \"immutable\";\n\ninterface TeamStateRecordType {\n  pageStates: Map<string, Map<string, DrawState>>;\n  pageInfos: Map<string, TeamPageInfo>;\n}\n\nconst defaultRecord: Readonly<TeamStateRecordType> = {\n  pageStates: Map(),\n  pageInfos: Map(),\n};\n\ntype TeamStateRecord = Record<TeamStateRecordType>;\nconst defaultFactory = Record(defaultRecord);\n\nexport class TeamState {\n  constructor(private immutable: TeamStateRecord) {}\n\n  getImmutable() {\n    return this.immutable;\n  }\n\n  getPageStates() {\n    return this.getImmutable().get(\"pageStates\");\n  }\n\n  getPageInfos() {\n    return this.getImmutable().get(\"pageInfos\");\n  }\n\n  getOneState(pageID: string, userID: string) {\n    return this.getPageStates().get(pageID)?.get(userID);\n  }\n\n  getOnePageStateMap(pageID: string) {\n    return this.getPageStates().get(pageID);\n  }\n\n  getPageValidUsers(pageID: string) {\n    const map = this.getOnePageStateMap(pageID);\n    if (!map) return [];\n    return Array.from(map?.filter((ds) => !ds.isEmpty()).keys());\n  }\n\n  getPageRatio(pageID: string) {\n    return this.getPageInfos().get(pageID)?.ratio;\n  }\n\n  includesPage(pageID: string) {\n    return this.getPageStates().has(pageID);\n  }\n\n  setState(pageID: string, userID: string, drawState: DrawState) {\n    const pageMap = this.getPageStates().get(pageID);\n    if (!pageMap) return this;\n    return new TeamState(\n      this.getImmutable().update(\"pageStates\", (m) =>\n        m.set(pageID, pageMap.set(userID, drawState))\n      )\n    );\n  }\n\n  static createFromTeamPages(\n    teamPages: globalThis.Record<string, TeamPage>,\n    width = WIDTH\n  ) {\n    let record = defaultFactory();\n    Object.entries(teamPages).forEach(([pageID, teamPage]) => {\n      const { states, ratio } = teamPage;\n      const pageMap = Map(\n        Object.entries(states).map(([userID, flatState]) => [\n          userID,\n          DrawState.loadFromFlat(flatState, width, width * ratio),\n        ])\n      );\n      record = record\n        .update(\"pageStates\", (m) => m.set(pageID, pageMap))\n        .update(\"pageInfos\", (m) => m.set(pageID, { ratio }));\n    });\n    return new TeamState(record);\n  }\n\n  addPage(pageID: string, notePage: NotePage) {\n    const { ratio } = notePage;\n    return new TeamState(\n      this.getImmutable()\n        .update(\"pageStates\", (m) => m.set(pageID, Map()))\n        .update(\"pageInfos\", (m) => m.set(pageID, { ratio }))\n    );\n  }\n\n  pushOperation(setOp: SetOperation, userID: string, width = WIDTH) {\n    const { pageID, ...op } = setOp;\n    const ratio = this.getPageRatio(pageID);\n    if (!this.includesPage(pageID) || !ratio) return this;\n    const prevDs =\n      this.getOneState(pageID, userID) ||\n      DrawState.createEmpty(width, width * ratio);\n\n    const ds = DrawState.pushOperation(prevDs, op);\n    return this.setState(pageID, userID, ds);\n  }\n\n  resetUser(userID: string, pageRec: globalThis.Record<string, NotePage>) {\n    let newTS: TeamState = this;\n    for (let [pageID, { state, ratio }] of Object.entries(pageRec)) {\n      const prevDS = newTS.getOneState(pageID, userID);\n      if (!prevDS) continue;\n      const { width } = prevDS;\n      newTS = newTS.setState(\n        pageID,\n        userID,\n        DrawState.loadFromFlat(state, width, width * ratio)\n      );\n    }\n    return newTS;\n  }\n}\n","import { useState, useEffect, createContext, useCallback } from \"react\";\r\nimport {\r\n  getTeamNoteState,\r\n  loadTeamNoteInfo,\r\n  updatePages,\r\n} from \"../../lib/network/http\";\r\nimport { LoginOutlined, LogoutOutlined } from \"@ant-design/icons\";\r\nimport { IoFactory, NewPageInfo } from \"../../lib/network/io\";\r\nimport { useNavigate, useParams } from \"react-router-dom\";\r\nimport { TeamState } from \"../../lib/draw/TeamState\";\r\nimport { getUserID, UserInfo } from \"../../lib/user\";\r\nimport { NotePage } from \"../../lib/note/note\";\r\nimport { Socket } from \"socket.io-client\";\r\nimport { Setter } from \"../../lib/hooks\";\r\nimport { Loading } from \"../ui/Loading\";\r\nimport { message } from \"antd\";\r\nimport { Set } from \"immutable\";\r\nimport Reader from \"./Reader\";\r\n\r\nexport const TeamCtx = createContext({\r\n  io: undefined as Socket | undefined,\r\n  code: 0,\r\n  teamOn: false,\r\n  connected: false,\r\n  ignores: Set<string>(),\r\n  userRec: {} as Record<string, UserInfo>,\r\n  teamState: undefined as TeamState | undefined,\r\n  resetIO: () => {},\r\n  loadInfo: async () => false,\r\n  loadState: async () => false,\r\n  setIgnores: (() => {}) as Setter<Set<string>>,\r\n  addTeamStatePage: (pageID: string, newPage: NotePage) => {},\r\n});\r\n\r\nexport default function Team() {\r\n  const noteID = useParams().noteID ?? \"\";\r\n  const [teamState, setTeamState] = useState<TeamState>();\r\n  const [code, setCode] = useState(-2);\r\n  const [userRec, setUserRec] = useState<Record<string, UserInfo>>({});\r\n  const [ignores, setIgnores] = useState(Set<string>());\r\n  const [io, setIO] = useState(IoFactory(noteID));\r\n  const [loaded, setLoaded] = useState(false);\r\n  const [connected, setConnected] = useState(false);\r\n  const nav = useNavigate();\r\n\r\n  const loadInfo = useCallback(async () => {\r\n    const info = await loadTeamNoteInfo(noteID);\r\n    if (!info) {\r\n      message.error(\"Failed loading the team note info\");\r\n      return false;\r\n    }\r\n    setCode(info.code);\r\n    return true;\r\n  }, [noteID]);\r\n\r\n  const loadState = useCallback(async () => {\r\n    const teamNote = await getTeamNoteState(noteID);\r\n    if (!teamNote) {\r\n      message.error(\"Failed loading the team note state\");\r\n      return false;\r\n    }\r\n    setTeamState(TeamState.createFromTeamPages(teamNote));\r\n    return true;\r\n  }, [noteID]);\r\n\r\n  const updateSelfState = useCallback(() => {\r\n    updatePages(noteID);\r\n  }, [noteID]);\r\n\r\n  useEffect(() => {\r\n    const roomInit = async () => {\r\n      const infoLoaded = await loadInfo();\r\n      const stateLoaded = await loadState();\r\n      if (!infoLoaded || !stateLoaded) return nav(\"/\");\r\n      setLoaded(true);\r\n      updateSelfState();\r\n    };\r\n    roomInit();\r\n    return updateSelfState;\r\n  }, [loadInfo, loadState, nav, updateSelfState]);\r\n\r\n  useEffect(() => {\r\n    io.on(\"push\", ({ operation, userID }) => {\r\n      setTeamState((prev) => prev?.pushOperation(operation, userID));\r\n    });\r\n\r\n    io.on(\"join\", ({ joined, members }) => {\r\n      const { userID, userName } = joined;\r\n      setUserRec(members);\r\n      if (userID === getUserID()) return;\r\n      showJoinMsg(userID, userName);\r\n    });\r\n\r\n    io.on(\"leave\", ({ leaved, members }) => {\r\n      const { userID, userName } = leaved;\r\n      setUserRec(members);\r\n      if (userID === getUserID()) return io.emit(\"join\");\r\n      showLeaveMsg(userID, userName);\r\n    });\r\n\r\n    io.on(\"newPage\", (info: NewPageInfo) => {\r\n      const { pageID, newPage } = info;\r\n      setTeamState((prev) => prev?.addPage(pageID, newPage));\r\n    });\r\n\r\n    io.on(\"reset\", ({ userID, pageRec }) => {\r\n      if (userID === getUserID()) return;\r\n      setTeamState((prev) => prev?.resetUser(userID, pageRec));\r\n    });\r\n\r\n    io.on(\"connect_error\", console.error);\r\n    io.on(\"connect\", () => setConnected(true));\r\n    io.on(\"disconnect\", () => setConnected(false));\r\n\r\n    return () => {\r\n      io.removeAllListeners();\r\n      io.close();\r\n    };\r\n  }, [io]);\r\n\r\n  const addTeamStatePage = (pageID: string, newPage: NotePage) => {\r\n    setTeamState((prev) => prev?.addPage(pageID, newPage));\r\n  };\r\n\r\n  const resetIO = () => setIO(IoFactory(noteID));\r\n\r\n  return (\r\n    <Loading loading={!loaded}>\r\n      <TeamCtx.Provider\r\n        value={{\r\n          io,\r\n          code,\r\n          teamOn: true,\r\n          ignores,\r\n          userRec,\r\n          connected,\r\n          teamState,\r\n          resetIO,\r\n          loadInfo,\r\n          loadState,\r\n          setIgnores,\r\n          addTeamStatePage,\r\n        }}\r\n      >\r\n        <Reader />\r\n      </TeamCtx.Provider>\r\n    </Loading>\r\n  );\r\n}\r\n\r\nconst showJoinMsg = (userID: string, userName: string) => {\r\n  message.destroy(userID);\r\n  message.success({\r\n    content: `${userName} joined room`,\r\n    icon: <LoginOutlined />,\r\n    key: userID,\r\n  });\r\n};\r\n\r\nconst showLeaveMsg = (userID: string, userName: string) => {\r\n  message.destroy(userID);\r\n  message.warning({\r\n    content: `${userName} leaved room`,\r\n    icon: <LogoutOutlined />,\r\n    key: userID,\r\n  });\r\n};\r\n","import classNames from \"classnames\";\nimport { FC } from \"react\";\nimport './circle.sass'\n\nexport const ColorCirle: FC<{ color: string; className?: string }> = ({\n  color,\n  className,\n}) => {\n  const style = { backgroundColor: color };\n  return (\n    <div className={classNames(\"color-circle\", className)} style={style} />\n  );\n};\n","export const colors = [\r\n  \"#f97316\",\r\n  \"#eab308\",\r\n  \"#84cc16\",\r\n  \"#22c55e\",\r\n  \"#10b981\",\r\n  \"#14b8a6\",\r\n  \"#06b6d4\",\r\n  \"#0ea5e9\",\r\n  \"#3b82f6\",\r\n  \"#6366f1\",\r\n  \"#8b5cf6\",\r\n  \"#a855f7\",\r\n  \"#d946ef\",\r\n  \"#ec4899\",\r\n  \"#f43f5e\",\r\n  \"#ef4444\",\r\n];\r\n\r\nexport const grayColors = [\"#000000\", \"#9ca3af\", \"#64748b\", \"#78716c\"];\r\nexport const allColors = [...grayColors, ...colors];\r\n\r\nexport const getRandomColor = () => {\r\n  const index = Math.floor(Math.random() * colors.length);\r\n  return colors[index];\r\n};\r\n\r\nconst hashCode = (str: string) => {\r\n  let hash = 0;\r\n  if (str.length === 0) return hash;\r\n  for (let i = 0; i < str.length; i++) {\r\n    const chr = str.charCodeAt(i);\r\n    hash = (hash << 5) - hash + chr;\r\n    hash |= 0;\r\n  }\r\n  return Math.abs(hash);\r\n};\r\n\r\nexport const getHashedColor = (str: string) => {\r\n  const index = hashCode(str) % colors.length;\r\n  return colors[index];\r\n};\r\n","import { List, Record, OrderedMap } from \"immutable\";\r\nimport { v4 } from \"uuid\";\r\nimport Heap from \"heap\";\r\n\r\nexport const WIDTH = 2000;\r\n\r\nexport interface Stroke {\r\n  uid: string;\r\n  pathData: string;\r\n  timestamp: number;\r\n}\r\n\r\nexport type StrokeRecord = globalThis.Record<string, Stroke>;\r\nexport type Mutation = [string, string];\r\n\r\nexport type Operation =\r\n  | {\r\n      type: \"add\";\r\n      stroke: Stroke;\r\n    }\r\n  | {\r\n      type: \"erase\";\r\n      erased: string[];\r\n    }\r\n  | {\r\n      type: \"mutate\";\r\n      mutations: Mutation[];\r\n    }\r\n  | {\r\n      type: \"undo\";\r\n    }\r\n  | {\r\n      type: \"redo\";\r\n    };\r\n\r\ninterface DrawStateRecordType {\r\n  strokes: OrderedMap<string, Stroke>;\r\n  undoStack: List<DrawStateRecord>;\r\n  historyStack: List<DrawStateRecord>;\r\n}\r\n\r\ntype DrawStateRecord = Record<DrawStateRecordType>;\r\n\r\nconst defaultRecord: Readonly<DrawStateRecordType> = {\r\n  strokes: OrderedMap(),\r\n  undoStack: List(),\r\n  historyStack: List(),\r\n};\r\n\r\nconst defaultFactory = Record(defaultRecord);\r\n\r\nexport interface FlatState {\r\n  strokes: StrokeRecord;\r\n  operations?: Operation[];\r\n}\r\n\r\nexport const getDefaultFlatState = (): FlatState => {\r\n  return { strokes: {} };\r\n};\r\n\r\nexport class DrawState {\r\n  constructor(\r\n    private immutable: DrawStateRecord,\r\n    public readonly width: number,\r\n    public readonly height: number,\r\n    public lastOp?: Operation\r\n  ) {}\r\n\r\n  getImmutable() {\r\n    return this.immutable;\r\n  }\r\n\r\n  getUndoStack() {\r\n    return this.getImmutable().get(\"undoStack\");\r\n  }\r\n\r\n  getHistoryStack() {\r\n    return this.getImmutable().get(\"historyStack\");\r\n  }\r\n\r\n  getStrokeMap() {\r\n    return this.getImmutable().get(\"strokes\");\r\n  }\r\n\r\n  getStrokeList(): Stroke[] {\r\n    return this.getStrokeMap()\r\n      .toArray()\r\n      .map(([_, stroke]) => stroke);\r\n  }\r\n\r\n  getLastStroke() {\r\n    return this.getStrokeMap().last();\r\n  }\r\n\r\n  isEmpty() {\r\n    return this.getStrokeMap().size === 0;\r\n  }\r\n\r\n  hasStroke(uid: string) {\r\n    return this.getStrokeMap().has(uid);\r\n  }\r\n\r\n  static createEmpty(width: number, height: number) {\r\n    return new DrawState(defaultFactory(), width, height);\r\n  }\r\n\r\n  static undo(drawState: DrawState) {\r\n    const lastOp: Operation = { type: \"undo\" };\r\n    const lastRecord = drawState.getHistoryStack().last();\r\n    if (!lastRecord) return drawState;\r\n    const undoStack = drawState\r\n      .getUndoStack()\r\n      .unshift(drawState.getImmutable());\r\n    return new DrawState(\r\n      lastRecord.set(\"undoStack\", undoStack),\r\n      drawState.width,\r\n      drawState.height,\r\n      lastOp\r\n    );\r\n  }\r\n\r\n  static redo(drawState: DrawState) {\r\n    const lastOp: Operation = { type: \"redo\" };\r\n\r\n    const nextRecord = drawState.getUndoStack().first();\r\n    if (!nextRecord) return drawState;\r\n    return new DrawState(nextRecord, drawState.width, drawState.height, lastOp);\r\n  }\r\n\r\n  static addStroke(drawState: DrawState, pathData: string) {\r\n    const uid = DrawState.getUid();\r\n    const timestamp = Date.now();\r\n    const stroke = { pathData, uid, timestamp };\r\n    return DrawState.pushStroke(drawState, stroke);\r\n  }\r\n\r\n  static pushStroke(drawState: DrawState, stroke: Stroke) {\r\n    const { uid } = stroke;\r\n    const prevRecord = drawState.getImmutable();\r\n    const currRecord = prevRecord\r\n      .update(\"strokes\", (s) => s.set(uid, stroke))\r\n      .update(\"historyStack\", (s) => s.push(prevRecord))\r\n      .delete(\"undoStack\");\r\n\r\n    const lastOp: Operation = { type: \"add\", stroke };\r\n\r\n    return new DrawState(currRecord, drawState.width, drawState.height, lastOp);\r\n  }\r\n\r\n  static eraseStrokes(drawState: DrawState, erased: string[]) {\r\n    if (erased.length === 0) return drawState;\r\n    const prevRecord = drawState.getImmutable();\r\n    const currRecord = prevRecord\r\n      .update(\"strokes\", (m) => m.deleteAll(erased))\r\n      .update(\"historyStack\", (s) => s.push(prevRecord))\r\n      .delete(\"undoStack\");\r\n\r\n    const lastOp: Operation = { type: \"erase\", erased };\r\n\r\n    return new DrawState(currRecord, drawState.width, drawState.height, lastOp);\r\n  }\r\n\r\n  static mutateStrokes(drawState: DrawState, mutations: Mutation[]) {\r\n    if (mutations.length === 0) return drawState;\r\n    const prevRecord = drawState.getImmutable();\r\n    let strokes = drawState.getStrokeMap();\r\n    mutations.forEach(\r\n      ([uid, pathData]) =>\r\n        (strokes = strokes.update(\r\n          uid,\r\n          { uid, pathData, timestamp: Date.now() },\r\n          (s) => ({ ...s, pathData })\r\n        ))\r\n    );\r\n    const currRecord = prevRecord\r\n      .set(\"strokes\", strokes)\r\n      .update(\"historyStack\", (s) => s.push(prevRecord))\r\n      .delete(\"undoStack\");\r\n\r\n    const lastOp: Operation = { type: \"mutate\", mutations };\r\n\r\n    return new DrawState(currRecord, drawState.width, drawState.height, lastOp);\r\n  }\r\n\r\n  // sync with mutation.\r\n  static syncStrokeTime(drawState: DrawState, stroke: Stroke) {\r\n    const { uid, timestamp } = stroke;\r\n    const prevStroke = drawState.getStrokeMap().get(uid);\r\n    if (!prevStroke) return;\r\n    prevStroke.timestamp = timestamp;\r\n  }\r\n\r\n  static pushOperation(drawState: DrawState, op: Operation) {\r\n    switch (op.type) {\r\n      case \"add\":\r\n        return DrawState.pushStroke(drawState, op.stroke);\r\n      case \"erase\":\r\n        return DrawState.eraseStrokes(drawState, op.erased);\r\n      case \"mutate\":\r\n        return DrawState.mutateStrokes(drawState, op.mutations);\r\n      case \"undo\":\r\n        return DrawState.undo(drawState);\r\n      case \"redo\":\r\n        return DrawState.redo(drawState);\r\n    }\r\n  }\r\n\r\n  static flaten(drawState: DrawState): FlatState {\r\n    const strokes = drawState.getImmutable().get(\"strokes\").toObject();\r\n    return { strokes };\r\n  }\r\n\r\n  static loadFromFlat(\r\n    flatState: FlatState,\r\n    width: number,\r\n    height: number\r\n  ): DrawState {\r\n    const { strokes, operations } = flatState;\r\n    let ds = new DrawState(\r\n      defaultFactory().set(\"strokes\", OrderedMap(strokes)),\r\n      width,\r\n      height\r\n    );\r\n    operations?.forEach((op) => (ds = DrawState.pushOperation(ds, op)));\r\n    return ds;\r\n  }\r\n\r\n  static mergeStates(...states: DrawState[]): Stroke[] {\r\n    const iterators = states.map((ds) => ds.getStrokeMap().values());\r\n    const mergedStrokes = [];\r\n    const heap = new Heap<[Stroke, number]>(\r\n      ([s0], [s1]) => s0.timestamp - s1.timestamp\r\n    );\r\n\r\n    iterators.forEach((iter, index) => {\r\n      const { value, done } = iter.next();\r\n      done || heap.push([value, index]);\r\n    });\r\n\r\n    while (heap.size() > 0) {\r\n      const record = heap.pop();\r\n      if (!record) break;\r\n      const [stroke, index] = record;\r\n      mergedStrokes.push(stroke);\r\n\r\n      const { value, done } = iterators[index].next();\r\n      done || heap.push([value, index]);\r\n    }\r\n    return mergedStrokes;\r\n  }\r\n\r\n  static getUid() {\r\n    return v4();\r\n  }\r\n}\r\n","export function createVirtualCanvas(width: number, height: number) {\r\n  const canvas = document.createElement(\"canvas\");\r\n  const context = canvas.getContext(\"2d\");\r\n  if (!context) {\r\n    throw new Error(\"can't get virtual canvas context\");\r\n  }\r\n  canvas.width = width;\r\n  canvas.height = height;\r\n  return { canvas, context };\r\n}\r\n\r\nexport function releaseCanvas(canvas: HTMLCanvasElement) {\r\n  canvas.width = 1;\r\n  canvas.height = 1;\r\n  const ctx = canvas.getContext('2d');\r\n  ctx?.clearRect(0, 0, 1, 1);\r\n}\r\n","import axios from \"axios\";\r\nimport {\r\n  removePageTimg,\r\n  TeamNoteInfo,\r\n  TeamPage,\r\n  TeamPageInfo,\r\n} from \"../note/note\";\r\nimport { loadNote, saveTeamNote, updateTeamNote } from \"../note/archive\";\r\nimport { getUserID } from \"../user\";\r\n\r\nexport let BASE_URL = \"https://api.slotdumpling.top/paint\";\r\n// BASE_URL = \"http://192.168.1.14:8090/paint\";\r\naxios.defaults.baseURL = BASE_URL;\r\n\r\nexport async function getNoteID(roomCode: string) {\r\n  try {\r\n    const { data } = await axios.get(`code/${roomCode}`);\r\n    console.log({ data });\r\n    if (data.statusCode !== 200) return null;\r\n    return data.noteID as string;\r\n  } catch (e) {\r\n    console.error(e);\r\n    return null;\r\n  }\r\n}\r\n\r\ninterface InfoRes {\r\n  statusCode: number;\r\n  code: number;\r\n  noteInfo: TeamNoteInfo;\r\n  pageInfos: Record<string, TeamPageInfo>;\r\n}\r\n\r\nexport async function getTeamNoteInfo(noteID: string) {\r\n  try {\r\n    const { data } = await axios.get(`info/${noteID}`);\r\n    const { statusCode, ...res } = data as InfoRes;\r\n    if (statusCode !== 200) return null;\r\n    return res;\r\n  } catch (e) {\r\n    console.error(e);\r\n    return null;\r\n  }\r\n}\r\n\r\nexport async function loadTeamNoteInfo(noteID: string) {\r\n  try {\r\n    const infoRes = await getTeamNoteInfo(noteID);\r\n    if (!infoRes) return null;\r\n    const { noteInfo, pageInfos } = infoRes;\r\n\r\n    if (await updateTeamNote(noteID, noteInfo, pageInfos)) return infoRes;\r\n\r\n    if (noteInfo.withImg) {\r\n      const { data } = await axios({\r\n        method: \"GET\",\r\n        url: noteID,\r\n        responseType: \"blob\",\r\n      });\r\n      const file = new Blob([data], { type: \"application/pdf\" });\r\n      await saveTeamNote(noteID, noteInfo, pageInfos, file);\r\n    } else {\r\n      await saveTeamNote(noteID, noteInfo, pageInfos);\r\n    }\r\n    return infoRes;\r\n  } catch (e) {\r\n    console.error(e);\r\n    return null;\r\n  }\r\n}\r\n\r\nexport async function putNote(noteID: string) {\r\n  const note = await loadNote(noteID);\r\n  if (!note) return false;\r\n  const { uid, name, withImg, pdf, pageOrder, pageRec } = note;\r\n  removePageTimg(pageRec);\r\n\r\n  try {\r\n    const { data } = await axios.put(`create/${noteID}`, {\r\n      userID: getUserID(),\r\n      pageRec,\r\n      noteInfo: { uid, name, withImg, pageOrder },\r\n    });\r\n\r\n    if (pdf) {\r\n      const formData = new FormData();\r\n      const ab = await pdf.arrayBuffer();\r\n      const file = new Blob([ab]);\r\n      formData.append(\"file\", file, noteID);\r\n      await axios({\r\n        method: \"POST\",\r\n        url: \"upload\",\r\n        data: formData,\r\n        headers: { \"Content-Type\": \"multipart/form-data\" },\r\n      });\r\n    }\r\n\r\n    if (data.statusCode !== 201) return false;\r\n    return true;\r\n  } catch (e) {\r\n    console.error(e);\r\n    return false;\r\n  }\r\n}\r\n\r\nexport async function updatePages(noteID: string) {\r\n  const note = await loadNote(noteID);\r\n  if (!note) return null;\r\n  const { uid, name, withImg, pageOrder, pageRec } = note;\r\n  removePageTimg(pageRec);\r\n\r\n  try {\r\n    const { data } = await axios.put(`update/${noteID}`, {\r\n      userID: getUserID(),\r\n      pageRec,\r\n      noteInfo: { uid, name, withImg, pageOrder },\r\n    });\r\n    if (data.statusCode === 201) return true;\r\n    else return false;\r\n  } catch (e) {\r\n    console.error(e);\r\n    return false;\r\n  }\r\n}\r\n\r\nexport async function getTeamNoteState(noteID: string) {\r\n  try {\r\n    const { data } = await axios.get(`state/${noteID}`, {\r\n      params: { userID: getUserID() },\r\n    });\r\n    if (data.statusCode !== 200) return null;\r\n    const { teamPages } = data;\r\n    return teamPages as Record<string, TeamPage>;\r\n  } catch (e) {\r\n    console.error(e);\r\n    return null;\r\n  }\r\n}\r\n","import { Note, NoteInfo, NotePage, TeamNoteInfo, TeamPageInfo } from \"./note\";\r\nimport { getDefaultFlatState } from \"../draw/DrawState\";\r\nimport localforage from \"localforage\";\r\nimport { v4 as getUid } from \"uuid\";\r\nimport { pickBy } from \"lodash-es\";\r\n\r\nexport interface NoteTag {\r\n  uid: string;\r\n  name: string;\r\n  color: string;\r\n  notes: string[];\r\n}\r\n\r\nexport async function getAllNotes() {\r\n  const allNotes = await localforage.getItem<Record<string, NoteInfo>>(\r\n    \"ALL_NOTES\"\r\n  );\r\n  if (allNotes) return allNotes;\r\n  localforage.setItem(\"ALL_NOTES\", {});\r\n  return {};\r\n}\r\n\r\nexport async function getAllTags() {\r\n  const tags = await localforage.getItem<Record<string, NoteTag>>(\"ALL_TAGS\");\r\n  if (tags) return tags;\r\n  localforage.setItem(\"ALL_TAGS\", {});\r\n  return {};\r\n}\r\n\r\nexport async function addNewTag(name: string, color: string) {\r\n  const uid = getUid();\r\n  const newTag: NoteTag = {\r\n    uid,\r\n    name,\r\n    color,\r\n    notes: [],\r\n  };\r\n  const prevTags = await getAllTags();\r\n  const tags = { ...prevTags, [uid]: newTag };\r\n  await localforage.setItem(\"ALL_TAGS\", tags);\r\n\r\n  return tags;\r\n}\r\n\r\nexport async function deleteTag(uid: string) {\r\n  const prevTags = await getAllTags();\r\n  const { [uid]: _, ...tags } = prevTags;\r\n  await localforage.setItem(\"ALL_TAGS\", tags);\r\n\r\n  return tags;\r\n}\r\n\r\nexport async function editTag(tag: NoteTag) {\r\n  const prevTags = await getAllTags();\r\n  const tags = { ...prevTags, [tag.uid]: tag };\r\n  await localforage.setItem(\"ALL_TAGS\", tags);\r\n  return tags;\r\n}\r\n\r\nexport async function loadNote(uid: string) {\r\n  const note = await localforage.getItem<Note>(uid);\r\n  if (!note) return;\r\n  const pdf = await localforage.getItem<Blob>(`PDF_${uid}`);\r\n  if (pdf) return { ...note, pdf };\r\n  else return note;\r\n}\r\n\r\nexport async function editNoteData(uid: string, noteData: Partial<Note>) {\r\n  noteData = pickBy(noteData, (v) => v !== undefined);\r\n  if (\"pageRec\" in noteData) noteData.lastTime = Date.now();\r\n\r\n  const allNotes = await getAllNotes();\r\n  const { pageRec, pageOrder, ...noteInfo } = noteData;\r\n  allNotes[uid] = { ...allNotes[uid], ...noteInfo };\r\n\r\n  await localforage.setItem(\"ALL_NOTES\", allNotes);\r\n  const prevNote = await loadNote(uid);\r\n  if (!prevNote) return;\r\n  await localforage.setItem(uid, { ...prevNote, ...noteData });\r\n}\r\n\r\nexport async function saveNoteInfo(noteInfo: NoteInfo) {\r\n  const { uid, tagID } = noteInfo;\r\n  const allNotes = await getAllNotes();\r\n  allNotes[uid] = noteInfo;\r\n  await localforage.setItem(\"ALL_NOTES\", allNotes);\r\n  const tags = await getAllTags();\r\n  if (tagID in tags) {\r\n    tags[tagID].notes.push(noteInfo.uid);\r\n    await localforage.setItem(\"ALL_TAGS\", tags);\r\n  }\r\n  return { tags, allNotes };\r\n}\r\n\r\nexport async function createNewNote(noteWithPdf: Note) {\r\n  const { pdf, ...note } = noteWithPdf;\r\n  await localforage.setItem(note.uid, note);\r\n  if (pdf) await localforage.setItem(`PDF_${note.uid}`, pdf);\r\n  const { pageRec, pageOrder, ...noteInfo } = note;\r\n  return await saveNoteInfo(noteInfo);\r\n}\r\n\r\nexport async function deleteNote(uid: string) {\r\n  const note = await loadNote(uid);\r\n  const allNotes = await getAllNotes();\r\n  const tags = await getAllTags();\r\n  if (!note) return { tags, allNotes };\r\n  await localforage.removeItem(uid);\r\n  await localforage.removeItem(`PDF_${uid}`);\r\n  delete allNotes[uid];\r\n  await localforage.setItem(\"ALL_NOTES\", allNotes);\r\n\r\n  const { tagID } = note;\r\n  if (tagID in tags) {\r\n    const prevTag = tags[tagID];\r\n    prevTag.notes = prevTag.notes.filter((id) => id !== uid);\r\n    await localforage.setItem(\"ALL_TAGS\", tags);\r\n  }\r\n  return { tags, allNotes };\r\n}\r\n\r\nexport async function moveNoteTag(noteID: string, tagID: string) {\r\n  const note = await loadNote(noteID);\r\n  const allNotes = await getAllNotes();\r\n  const tags = await getAllTags();\r\n  if (!note) return { tags, allNotes };\r\n\r\n  const { tagID: prevTagId } = note;\r\n  note.tagID = tagID;\r\n  await localforage.setItem(noteID, note);\r\n  allNotes[noteID].tagID = tagID;\r\n  await localforage.setItem(\"ALL_NOTES\", allNotes);\r\n\r\n  if (prevTagId in tags) {\r\n    const prevTag = tags[prevTagId];\r\n    prevTag.notes = prevTag.notes.filter((id) => id !== noteID);\r\n  }\r\n  tags[tagID]?.notes.push(noteID);\r\n  await localforage.setItem(\"ALL_TAGS\", tags);\r\n  return { tags, allNotes };\r\n}\r\n\r\nexport async function saveTeamNote(\r\n  noteID: string,\r\n  noteInfo: TeamNoteInfo,\r\n  teamPages: Record<string, TeamPageInfo>,\r\n  file?: Blob\r\n) {\r\n  let note = await loadNote(noteID);\r\n  if (note) return;\r\n  const time = Date.now();\r\n  const pageRec: Record<string, NotePage> = {};\r\n  note = {\r\n    ...noteInfo,\r\n    tagID: \"DEFAULT\",\r\n    team: true,\r\n    pageRec,\r\n    pdf: file,\r\n    createTime: time,\r\n    lastTime: time,\r\n  };\r\n\r\n  // set empty state for each page\r\n  Object.entries(teamPages).forEach(([pageID, page]) => {\r\n    pageRec[pageID] = { ...page, state: getDefaultFlatState() };\r\n  });\r\n\r\n  // parse timg for each page\r\n  if (file) {\r\n    const { getPDFImages } = await import(\"../note/pdfImage\");\r\n    const { images } = await getPDFImages(file, 0.5);\r\n    Object.values(pageRec).forEach((page) => {\r\n      const { pdfIndex } = page;\r\n      if (!pdfIndex) return;\r\n      page.image = images[pdfIndex - 1];\r\n    });\r\n    note.thumbnail = images[0];\r\n  }\r\n\r\n  await createNewNote(note);\r\n}\r\n\r\nexport async function updateTeamNote(\r\n  noteID: string,\r\n  noteInfo: TeamNoteInfo,\r\n  pageInfos: Record<string, TeamPageInfo>\r\n) {\r\n  let note = await loadNote(noteID);\r\n  if (!note) return false;\r\n  const { pageOrder } = noteInfo;\r\n  if (pageOrder.length < note.pageOrder.length) return true;\r\n  const { pageRec, pdf } = note;\r\n  const { getOneImage } = await import(\"./pdfImage\");\r\n\r\n  // parse timgs & set empty states for new pages.\r\n  for (let [pageID, page] of Object.entries(pageInfos)) {\r\n    if (pageID in pageRec) continue;\r\n    const { pdfIndex } = page;\r\n    const state = getDefaultFlatState();\r\n    pageRec[pageID] = { ...page, state };\r\n    if (!pdf || !pdfIndex) continue;\r\n    pageRec[pageID].image = await getOneImage(pdf, pdfIndex, 0.5);\r\n  }\r\n  await editNoteData(noteID, { pageOrder, pageRec });\r\n  return true;\r\n}\r\n","import { getDefaultFlatState, FlatState } from \"../draw/DrawState\";\r\nimport { v4 as getUid } from \"uuid\";\r\nimport dayjs from \"dayjs\";\r\n\r\nexport interface NotePage {\r\n  ratio: number;\r\n  state: FlatState;\r\n  image?: string;\r\n  marked?: boolean;\r\n  pdfIndex?: number;\r\n}\r\n\r\nexport const defaultNotePage: Readonly<NotePage> = {\r\n  ratio: 1.5,\r\n  state: { strokes: {} },\r\n};\r\n\r\nexport interface TeamPageState {\r\n  states: Record<string, FlatState>;\r\n}\r\n\r\nexport interface TeamPageInfo {\r\n  ratio: number;\r\n  pdfIndex?: number;\r\n}\r\n\r\nexport type TeamPage = TeamPageInfo & TeamPageState;\r\n\r\nexport interface TeamNote {\r\n  uid: string;\r\n  pageRec: Record<string, TeamPage>;\r\n}\r\n\r\nexport interface NoteInfo {\r\n  uid: string;\r\n  name: string;\r\n  tagID: string;\r\n  team: boolean;\r\n  withImg: boolean;\r\n  createTime: number;\r\n  lastTime: number;\r\n  thumbnail?: string;\r\n}\r\n\r\nexport type Note = NoteInfo & {\r\n  pdf?: Blob;\r\n  pageRec: Record<string, NotePage>;\r\n  pageOrder: string[];\r\n};\r\n\r\nexport interface TeamNoteInfo {\r\n  uid: string;\r\n  name: string;\r\n  pageOrder: string[];\r\n  withImg: boolean;\r\n}\r\n\r\nexport function createEmptyNote(): Note {\r\n  const pageID = getUid();\r\n  const time = Date.now();\r\n  return {\r\n    uid: getUid(),\r\n    name: `Note ${dayjs(time).format(\"HH:mm, ddd MMM D\")}`,\r\n    tagID: \"DEFAULT\",\r\n    team: false,\r\n    withImg: false,\r\n    createTime: time,\r\n    lastTime: time,\r\n    pageRec: {\r\n      [pageID]: {\r\n        ratio: 1.5,\r\n        state: getDefaultFlatState(),\r\n      },\r\n    },\r\n    pageOrder: [pageID],\r\n  };\r\n}\r\n\r\nexport function createPage(page?: NotePage): [string, NotePage] {\r\n  const pageID = getUid();\r\n  const newPage = page ?? {\r\n    ratio: 1.5,\r\n    state: getDefaultFlatState(),\r\n  };\r\n  return [pageID, newPage];\r\n}\r\n\r\nexport function removePageTimg(pageRec: Record<string, NotePage>) {\r\n  Object.values(pageRec).forEach((page) => {\r\n    delete page.image;\r\n    delete page.marked;\r\n  });\r\n}\r\n","import { v4 as getUid } from \"uuid\";\r\n\r\nexport interface UserInfo {\r\n  userID: string;\r\n  userName: string;\r\n  online: boolean;\r\n}\r\n\r\nexport const getUserID = (() => {\r\n  let cached: string;\r\n  return () => {\r\n    if (cached) return cached;\r\n    let userID = localStorage.getItem(\"USER_ID\");\r\n    if (!userID) {\r\n      userID = getUid();\r\n      localStorage.setItem(\"USER_ID\", userID);\r\n    }\r\n    cached = userID;\r\n    return userID;\r\n  };\r\n})();\r\n\r\nexport const getUserName = () => {\r\n  let name = localStorage.getItem(\"USER_NAME\");\r\n  if (!name) {\r\n    name = getUid().slice(0, 8);\r\n    localStorage.setItem(\"USER_NAME\", name);\r\n  }\r\n  return name;\r\n};\r\n\r\nexport const saveUserName = (name: string) => {\r\n  name = name.trim();\r\n  if (!name) return false;\r\n  else localStorage.setItem(\"USER_NAME\", name);\r\n  return true;\r\n};\r\n"],"names":["defaultWidthList","defaultDrawCtrl","mode","finger","lineWidth","eraserWidth","color","highlight","lasso","widthList","getDrawCtrl","localforage","drawCtrl","defaultRecord","states","Map","editStack","List","undoStack","defaultFactory","Record","StateSet","immutable","lastOp","this","getImmutable","get","pageID","getStates","drawState","prevDS","getOneState","currRecord","update","s","set","l","push","delete","stroke","DrawState","notePage","width","WIDTH","state","ratio","newDS","getEditStack","size","getUndoStack","isUndoable","lastUid","last","lastSetOp","pop","isRedoable","ds","pageRec","map","usePreventTouch","allowFinger","isTouch","useRef","checkPoniter","e","isPrimary","current","pointerType","preventTouch","touch","touches","touchType","isApplePencil","length","isEventValid","stopPropagation","onPointerDownCapture","onPointerMoveCapture","onTouchStartCapture","onTouchMoveCapture","Path","paper","Size","Point","Group","Color","Raster","Layer","Draw","React","ref","otherStates","onChange","readonly","imgSrc","setActiveTool","height","canvasEl","scope","useState","group","setGroup","usePaperItem","path","setPath","rect","setRect","useEffect","cvs","scp","setup","settings","handleSize","hitTolerance","project","addLayer","layers","activate","forEach","visible","Tool","remove","releaseCanvas","bgRect","paintBackground","useSize","view","viewSize","multiply","scale","raster","addChild","sendToBack","onLoad","requestAnimationFrame","fitBounds","bringToFront","mergedStrokes","useMemo","getStrokeList","tempGroup","layer","self","hasStroke","uid","item","paintStroke","removeChildren","hitRef","selected","setSelected","paperMode","selectedIDs","setSelectedIDs","selectedItems","IDSet","Set","filter","has","name","resetSelect","useCallback","undefined","downPath","startStroke","downRect","startRect","point","handleDown","draw","erase","select","contains","hitRes","hitTest","segments","text","t","getClickedText","add","content","fontSize","justification","fillColor","setPointText","dragPath","smooth","handleDrag","x","y","s1","s2","s3","segment","moveP","baseP","next","diagonal","subtract","strokeWidth","translate","delta","pointText","bounds","topCenter","bottomRight","tool","maxDistance","erased","handleEarserDrag","hitTestAll","class","tolerance","opacity","guide","handleUp","isEmpty","simplify","pathData","exportJSON","prev","erasedList","Array","from","clear","selection","Math","abs","area","closePath","moveDash","checkLasso","updateMutation","cursor","setCursor","cursorStyle","handleMove","handler","onMouseDown","onMouseDrag","onMouseUp","onMouseMove","mutations","p","deleteSelected","rotateSelected","angle","aniCount","dAngle","center","position","rotate","mutateStyle","updated","updateGroupStyle","duplicateSelected","transP","divide","newSG","clone","insert","children","m","rasterize","toDataURL","cancelText","submitText","useImperativeHandle","preventDefault","document","addEventListener","removeEventListener","usePinch","memo","offset","first","origin","lastScale","lastOrigin","elPos","originRawP","getBoundingClientRect","originViewP","originPorjP","viewToProject","dScale","pow","scaleView","putCenterBack","zoom","scaleBounds","max","min","rubberband","target","touchHandler","className","style","displayName","tuple","useDebugValue","importJSON","console","error","Rectangle","onFrame","strokeColor","alpha","blendMode","strokeJoin","strokeCap","half","dashOffset","dashArray","projSize","viewW","viewH","projW","projH","minX","minY","maxX","maxY","getCenterTranslate","deltaX","deltaY","dP","move","items","isInside","res","trace","compare","intersects","checkedP","newColor","fill","AddPageButton","addFinalPage","useContext","ReaderMethodCtx","type","icon","PlusOutlined","block","onClick","createFromIconfontCN","scriptUrl","PenPanel","updateDrawCtrl","panelBlur","setPanelBlur","WidthSelect","HighlightSwitch","checked","ColorSelect","setColor","c","field","currWidth","chosen","indexOf","popShow","setPopShow","includes","realSizeStyle","options","value","label","index","onVisibleChange","v","trigger","placement","destroyTooltipOnHide","defaultValue","onAfterChange","w","newWL","slice","i","allColors","backgroundColor","borderColor","SelectTool","drawRef","CSSTransition","timeout","in","unmountOnExit","SelectToolContent","btnProps","shape","currDrawCtrl","setCurrDrawCtrl","rotateEl","dragged","setDragged","transX","setTransX","gearStyle","transform","useDrag","filterTaps","left","right","createPortal","getPopupContainer","parentElement","BgColorsOutlined","RotateRightOutlined","CaretLeftOutlined","CaretRightOutlined","CopyOutlined","PictureOutlined","imageData","Modal","title","src","alt","okText","onOk","saveAs","danger","DeleteOutlined","querySelector","TextTool","setText","align","setAlign","forceLight","ReaderStateCtx","toCSS","fontColorBtn","overlayStyle","FontColorsOutlined","alignRadio","optionType","buttonStyle","AlignLeftOutlined","AlignCenterOutlined","AlignRightOutlined","onCancel","trim","bodyStyle","paddingTop","destroyOnClose","TextArea","rows","autoFocus","largestKey","order","result","maxRatio","key","HeaderMiddle","stateSet","setDrawCtrl","handleUndo","handleRedo","setForceLight","newCtrl","saveDrawCtrl","UndoOutlined","disabled","RedoOutlined","message","BulbFilled","BulbOutlined","PenButton","EraserButton","SelectButton","HighlightOutlined","GatewayOutlined","insertAfter","list","prevItem","newItem","prevIndex","curr","splice","UserAvatar","userID","userRec","TeamCtx","getHashedColor","userInfo","userName","PreviewCtx","activeKey","setActiveKey","PageNavContent","pageOrder","currPageID","scrollPage","saveReorder","refRec","scrollIntoView","PreviewTabs","onDragEnd","source","destination","fromIndex","toIndex","newOrder","removed","exchange","droppableId","droppableProps","innerRef","placeholder","PagePreview","pageIndex","teamState","setChosen","page","teamStateMap","getOnePageStateMap","image","marked","every","draggableId","isDragDisabled","draggableProps","dragHandleProps","isDragging","PageWrapper","thumbnail","preview","PreviewTools","switchPageMarked","ignores","userIDs","getPageValidUsers","PreviewOption","TeamAvatars","maxCount","classNames","maxPopoverPlacement","addPage","deletePage","menu","MoreOutlined","TabPane","Tabs","tabBarGutter","centered","tab","PageNav","navOn","setNavOn","ALL","MARKED","WRITTEN","Provider","MenuUnfoldOutlined","MenuFoldOutlined","onClose","closable","zIndex","padding","overflow","headerStyle","textAlign","HeaderRight","teamOn","RoomInfo","JoinRoom","UserCard","renaming","setRenaming","setIgnores","resetIO","online","getUserID","ignored","Search","onSearch","saveUserName","enterButton","CheckOutlined","FormOutlined","EyeInvisibleOutlined","EyeOutlined","code","connected","loadInfo","loadState","noteInfo","link","window","location","href","share","selfName","copy","log","userList","selfID","selfInfo","otherUsers","values","Object","onlineNum","teamPop","DisconnectOutlined","showIcon","banner","String","plain","ShareAltOutlined","u","reloading","setReloading","loading","ReloadOutlined","status","count","TeamOutlined","noteID","instantSave","nav","useNavigate","createRoom","putNote","editNoteData","team","UsergroupAddOutlined","ReaderHeader","HeaderLeft","saved","HomeFilled","SaveOutlined","createContext","updateStateSet","cb","prevPageID","setInviewRatios","Reader","useParams","setPageRec","setNoteInfo","setStateSet","setPageOrder","useSafeState","setSaved","io","addTeamStatePage","refMap","setRefMap","scrolled","setPrevPageID","inviewRatios","loadPrevPageID","stored","setRef","el","useScrollPage","loadNote","storedNote","pdf","createFromPages","saver","useEvent","pr","toObject","debouncedSave","debounce","flush","savePageRec","defaultNotePage","pushReorder","emit","handleReorder","onUndo","deleted","prevOrder","duration","handleNewPage","newPage","addState","on","removeAllListeners","pushNewPage","newTeamPage","updatePageRec","newSS","operation","lastDS","getLastDS","syncStrokeTime","prevPage","createPage","renderResult","PageContainer","id","lastPageID","redo","undo","updateState","setState","pdfIndex","fullImg","setFullImg","useInView","threshold","range","entry","intersectionRatio","loadImage","once","getNotePageImage","deleteAll","toList","toArray","imageLoaded","Boolean","drawShow","viewBox","DrawWrapper","activeTool","handleChange","arg","IoFactory","BASE_URL","query","getUserName","pageStates","pageInfos","TeamState","getPageStates","keys","getPageInfos","pageMap","setOp","op","getPageRatio","includesPage","prevDs","newTS","entries","teamPages","record","teamPage","flatState","Team","setTeamState","setCode","setUserRec","setIO","loaded","setLoaded","setConnected","loadTeamNoteInfo","info","getTeamNoteState","teamNote","createFromTeamPages","updateSelfState","updatePages","roomInit","infoLoaded","stateLoaded","pushOperation","joined","members","showJoinMsg","leaved","showLeaveMsg","resetUser","close","Loading","LoginOutlined","LogoutOutlined","ColorCirle","colors","getRandomColor","floor","random","str","hash","charCodeAt","hashCode","strokes","OrderedMap","historyStack","getDefaultFlatState","getStrokeMap","lastRecord","getHistoryStack","unshift","nextRecord","getUid","timestamp","Date","now","pushStroke","prevRecord","prevStroke","eraseStrokes","mutateStrokes","operations","iterators","heap","Heap","s0","iter","done","v4","createVirtualCanvas","canvas","createElement","context","getContext","Error","ctx","clearRect","getNoteID","roomCode","axios","data","statusCode","getTeamNoteInfo","infoRes","updateTeamNote","withImg","method","url","responseType","file","Blob","saveTeamNote","note","removePageTimg","formData","FormData","arrayBuffer","ab","append","headers","params","getAllNotes","allNotes","getAllTags","tags","addNewTag","newTag","notes","prevTags","deleteTag","editTag","tag","noteData","pickBy","lastTime","prevNote","saveNoteInfo","tagID","createNewNote","noteWithPdf","deleteNote","prevTag","moveNoteTag","prevTagId","time","createTime","getPDFImages","images","getOneImage","createEmptyNote","dayjs","format","cached","localStorage","getItem","setItem"],"sourceRoot":""}