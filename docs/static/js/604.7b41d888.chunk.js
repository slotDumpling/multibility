(self.webpackChunkmultibility=self.webpackChunkmultibility||[]).push([[604],{74968:function(e,t,n){"use strict";n.r(t),n.d(t,{PageWrapper:function(){return nn},ReaderMethodCtx:function(){return $t},ReaderStateCtx:function(){return Xt},default:function(){return en}});var r=n(93433),a=n(1413),i=n(45987),o=n(29439),u=n(15861),s=n(87757),c=n.n(s),l=n(72791),d=n(61842),f=n.n(d),v=[10,20,30,50],p={mode:"draw",finger:!0,lineWidth:10,eraserWidth:10,color:"#000000",highlight:!1,lasso:!0,widthList:v};function m(){return h.apply(this,arguments)}function h(){return(h=(0,u.Z)(c().mark((function e(){var t;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,f().getItem("DRAW_CTRL");case 2:if(t=e.sent){e.next=7;break}return t=p,e.next=7,f().setItem("DRAW_CTRL",t);case 7:return e.abrupt("return",t);case 8:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function g(){return(g=(0,u.Z)(c().mark((function e(t){return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,f().setItem("DRAW_CTRL",t);case 2:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var x=n(92198),w=n(76807),Z=n(95099),j=n(15671),S=n(43144),y=n(82670),k=n(24124),C={states:(0,k.D5)(),editStack:(0,k.aV)(),undoStack:(0,k.aV)()},b=(0,k.WV)(C),D=function(){function e(t,n){(0,j.Z)(this,e),this.immutable=t,this.lastOp=n}return(0,S.Z)(e,[{key:"getImmutable",value:function(){return this.immutable}},{key:"getStates",value:function(){return this.getImmutable().get("states")}},{key:"getOneState",value:function(e){return this.getStates().get(e)}},{key:"getEditStack",value:function(){return this.getImmutable().get("editStack")}},{key:"getUndoStack",value:function(){return this.getImmutable().get("undoStack")}},{key:"setState",value:function(t,n){var r=this.getOneState(t);if(!r||r===n)return this;var i=this.getImmutable().update("states",(function(e){return e.set(t,n)})).update("editStack",(function(e){return e.push(t)})).delete("undoStack"),o=n.lastOp;return new e(i,o&&(0,a.Z)((0,a.Z)({},o),{},{pageID:t}))}},{key:"syncStrokeTime",value:function(e,t){var n=this.getOneState(e);return n&&y.Dw.syncStrokeTime(n,t),this}},{key:"addState",value:function(t,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:y.mF,a=n.state,i=n.ratio,o=y.Dw.loadFromFlat(a,r,r*i),u=this.getImmutable().update("states",(function(e){return e.set(t,o)}));return new e(u)}},{key:"deleteState",value:function(t){return new e(this.getImmutable().update("states",(function(e){return e.delete(t)})))}},{key:"isUndoable",value:function(){return this.getEditStack().size>0}},{key:"isRedoable",value:function(){return this.getUndoStack().size>0}},{key:"undo",value:function(){if(!this.isUndoable())return this;var t=this.getEditStack().last(),n=t&&this.getOneState(t);if(!n)return this;var r=y.Dw.undo(n),i=r.lastOp,o=i&&(0,a.Z)({pageID:t},i);return new e(this.getImmutable().update("editStack",(function(e){return e.pop()})).update("undoStack",(function(e){return e.push(t)})).update("states",(function(e){return e.set(t,r)})),o)}},{key:"redo",value:function(){if(!this.isRedoable())return this;var t=this.getUndoStack().last(),n=t&&this.getOneState(t);if(!n)return this;var r=y.Dw.redo(n),i=r.lastOp,o=i&&(0,a.Z)({pageID:t},i);return new e(this.getImmutable().update("undoStack",(function(e){return e.pop()})).update("editStack",(function(e){return e.push(t)})).update("states",(function(e){return e.set(t,r)})),o)}},{key:"getLastDS",value:function(){var e,t=null===(e=this.lastOp)||void 0===e?void 0:e.pageID,n=t&&this.getOneState(t);if(n)return[t,n]}}],[{key:"createFromPages",value:function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:y.mF;return new e(b().set("states",(0,k.D5)(t).map((function(e){var t=e.state,r=e.ratio;return y.Dw.loadFromFlat(t,n,n*r)}))))}}]),e}();function P(e){var t=(0,l.useRef)(!1),n=function(e){return e.isPrimary&&(t.current="touch"===e.pointerType)},r=function(n){return function(n){return!t.current||function(e){var t=e.touches[0];return"stylus"===(null===t||void 0===t?void 0:t.touchType)}(n)||e&&1===n.touches.length}(n)||n.stopPropagation()};return{onPointerDownCapture:n,onPointerMoveCapture:n,onTouchStartCapture:r,onTouchMoveCapture:r}}var I=n(96153),E=n(53557),N=n(1488),R=n(12262),O=n.n(R),T=n(80184),L=O().Path,M=O().Size,F=O().Point,A=O().Group,z=O().Color,W=O().Raster,U=O().Layer,V=l.forwardRef((function(e,t){var n=e.drawState,i=e.otherStates,u=e.onChange,s=void 0===u?function(){}:u,c=e.drawCtrl,d=void 0===c?p:c,f=e.readonly,v=void 0!==f&&f,m=e.imgSrc,h=e.setActiveTool,g=void 0===h?function(){}:h,x=n.width,w=n.height,Z=d.mode,j=d.finger,S=d.lasso,k=d.eraserWidth,C=(0,l.useRef)(null),b=(0,l.useRef)(new(O().PaperScope)),D=(0,l.useState)([]),R=(0,o.Z)(D,2),L=R[0],V=R[1],K=B(),ne=(0,o.Z)(K,2),re=ne[0],ae=ne[1],ie=B(),oe=(0,o.Z)(ie,2),ue=oe[0],se=oe[1];(0,l.useEffect)((function(){var e=C.current,t=b.current;if(e)return t.setup(e),t.settings.handleSize=10,t.settings.hitTolerance=20,t.project.addLayer(new U),t.project.addLayer(new U),t.project.addLayer(new U),t.project.layers[1].activate(),t.project.layers.forEach((function(e){return e.visible=!1})),new t.Tool,function(){t.remove(),(0,I.j)(e)}}),[]),(0,l.useEffect)((function(){var e=q(b.current,x,w);return function(){e.remove()}}),[x,w]);var ce=(0,N.Z)(C),le=(0,o.Z)(ce,1)[0]/x;(0,l.useEffect)((function(){if(le){var e=b.current;return e.view.viewSize=new M(x,w).multiply(le),e.view.scale(le,new F(0,0)),e.project.layers.forEach((function(e){return e.visible=!0})),function(){var t,n;null===(t=e.project)||void 0===t||t.layers.forEach((function(e){return e.visible=!1})),null===(n=e.view)||void 0===n||n.scale(1/le,new F(0,0))}}}),[x,w,le]),(0,l.useEffect)((function(){if(m){b.current.activate();var e=new W(m);return e.project.layers[0].addChild(e),e.sendToBack(),e.onLoad=function(){requestAnimationFrame((function(){e.fitBounds(new(O().Rectangle)(0,0,x,w)),e.bringToFront()}))},function(){null===e||void 0===e||e.remove()}}}),[m,x,w]);var de=(0,l.useMemo)((function(){return i?y.Dw.mergeStates.apply(y.Dw,[n].concat((0,r.Z)(i))):n.getStrokeList()}),[n,i]);(0,l.useEffect)((function(){var e=[],t=[];return de.forEach((function(r){var a=r.uid,i=_(r,b.current);i&&(n.hasStroke(a)?e.push(i):t.push(i))})),V(e),function(){e.forEach((function(e){return e.remove()})),t.forEach((function(e){return e.remove()}))}}),[de,n]);var fe=(0,l.useRef)(),ve=(0,l.useState)(!1),pe=(0,o.Z)(ve,2),me=pe[0],he=pe[1],ge="select"===Z&&me?"selected":Z,xe=(0,l.useState)([]),we=(0,o.Z)(xe,2),Ze=we[0],je=we[1],Se=(0,l.useMemo)((function(){var e=new Set(Ze);return L.filter((function(t){return e.has(t.name)}))}),[L,Ze]),ye=(0,l.useCallback)((function(){he(!1),ae(void 0),se(void 0)}),[ae,se]);(0,l.useEffect)((function(){if("select"===Z)return ye}),[Z,ye]),(0,l.useEffect)((function(){return ye}),[S,ye]),(0,l.useEffect)((function(){if(me)return function(){je([]),g("")}}),[me,g]);var ke=function(){var e=G(d);b.current.project.layers[2].addChild(e),ae(e)},Ce=function(e){var t=H(e.point);b.current.project.layers[2].addChild(t),se(t)},be={draw:ke,erase:ke,select:S?ke:Ce,selected:function(e){if(S){if(null!==re&&void 0!==re&&re.contains(e.point))return;ke(),he(!1)}else{var t=null===ue||void 0===ue?void 0:ue.hitTest(e.point,{segments:!0});if(fe.current=t,t)return;if(null!==ue&&void 0!==ue&&ue.contains(e.point))return;Ce(e),he(!1)}},text:function(e){var t=te(b.current,e.point);t||(t=new(O().PointText)({point:e.point.add(new F(0,50)),content:"Insert text...",fontSize:50,justification:"center",fillColor:"#1890ff55"}),b.current.project.layers[2].addChild(t)),qe(t)}}[ge],De=function(e){null===re||void 0===re||re.add(e.point),null===re||void 0===re||re.smooth()},Pe={draw:De,erase:De,select:S?De:function(e){if(ue){var t=e.point,n=t.x,r=t.y,a=(0,o.Z)(ue.segments,4),i=a[1],u=a[2],s=a[3];i.point.x=n,u.point=e.point,s.point.y=r}},selected:function(e){var t=fe.current;if(null!==t&&void 0!==t&&t.segment){var n=t.segment.point,r=t.segment.next.next.point,a=n.subtract(r),i=e.point.subtract(r).project(a).x/a.x;if(i<0)return;null===ue||void 0===ue||ue.scale(i,r),Se.forEach((function(e){e.scale(i,r),e.strokeWidth*=i}))}else Se.forEach((function(t){return t.translate(e.delta)})),null===re||void 0===re||re.translate(e.delta),null===ue||void 0===ue||ue.translate(e.delta)},text:function(e){if(_e&&!_e.name){var t=_e.bounds,n=t.topCenter,r=t.bottomRight.subtract(n),a=e.point.subtract(n).project(r).x/r.x;a<0||_e.scale(a,n)}}}[ge];(0,l.useEffect)((function(){b.current.tool.maxDistance=k}),[k]);var Ie=(0,l.useRef)(new Set),Ee="erase"===ge?function(e){b.current.project.layers[1].hitTestAll(e.point,{class:O().Path,stroke:!0,tolerance:k/2}).forEach((function(e){var t=e.item;t.opacity=.5,t.guide=!0,t.name&&Ie.current.add(t.name)}))}:null,Ne={draw:function(){if(re&&!re.isEmpty()){re.simplify();var e=re.exportJSON();s((function(t){return y.Dw.addStroke(t,e)})),ae(void 0)}},erase:function(){var e=Array.from(Ie.current);Ie.current.clear(),s((function(t){return y.Dw.eraseStrokes(t,e)})),ae(void 0)},select:function(){var e,t=b.current.project.layers[1];if(S){if(!re||Math.abs(re.area)<1e3)return ae(void 0);re.closePath(),re.simplify(),Q(re),e=X(t,re)}else{if(!ue||Math.abs(ue.area)<1e3)return se(void 0);e=$(t,ue)}je(e),he(!0),g("select")},selected:function(){Fe()},text:function(){g("text")}}[ge],Re=(0,l.useState)("auto"),Oe=(0,o.Z)(Re,2),Te=Oe[0],Le=Oe[1];(0,l.useEffect)((function(){"text"===ge||"select"===ge?Le("crosshair"):"selected"===ge?(console.log(1),Le(S?"crosshair":"nwse-resize")):"draw"!==ge&&"erase"!==ge||Le(J(d,le))}),[ge,S,d,le]);var Me={selected:function(e){var t=null===ue||void 0===ue?void 0:ue.hitTest(e.point,{segments:!0});if(null!==t&&void 0!==t&&t.segment){var n=t.segment.point,r=t.segment.next.next.point,a=n.subtract(r),i=a.x,o=a.y;Le(i*o<0?"nesw-resize":"nwse-resize")}else null!==ue&&void 0!==ue&&ue.contains(e.point)||null!==re&&void 0!==re&&re.contains(e.point)?Le("move"):Le("crosshair")},text:function(e){te(b.current,e.point)?Le("text"):Le("crosshair")},select:null,draw:null,erase:null}[ge];(0,l.useEffect)((function(){if(!v){var e=function(e){return function(t){if(b.current.activate(),e)return e(t)}},t=b.current,n=t.view,r=t.tool;n.onMouseDown=e(be),n.onMouseDrag=e(Pe),n.onMouseUp=e(Ne),n.onMouseMove=e(Me),r&&(r.onMouseDrag=e(Ee))}}));var Fe=function(){if(null!==Se&&void 0!==Se&&Se.length){var e=Se.map((function(e){return[e.name,e.exportJSON()]}));s((function(t){return y.Dw.mutateStrokes(t,e)}))}},Ae=function(){je([]),ye(),Ze.length&&s((function(e){return y.Dw.eraseStrokes(e,Ze)}))},ze=function(e){var t,n=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=n?10:1,a=e/r,i=null===(t=ue||re)||void 0===t?void 0:t.position,o=function e(){Se.forEach((function(e){return e.rotate(a,i)})),null===ue||void 0===ue||ue.rotate(a,i),null===re||void 0===re||re.rotate(a,i),--r>0?requestAnimationFrame(e):n&&Fe()};o()},We=function(e){b.current.activate(),ee(Se,e),Fe()},Ue=function(){var e;b.current.activate();var t=null===(e=ue||re)||void 0===e?void 0:e.bounds.size;if(t){var n=t.width,r=t.height,a=new F(n,r).divide(10),i=new A(Se).clone({insert:!1});i.translate(a),null===ue||void 0===ue||ue.translate(a),null===re||void 0===re||re.translate(a);var o=i.children.map((function(e){return[y.Dw.getUid(),e.exportJSON()]}));s((function(e){return y.Dw.mutateStrokes(e,o)})),je(o.map((function(e){return e[0]})))}},Ve=function(){return new A(Se).rasterize({insert:!1}).toDataURL()},Ke=B(),Be=(0,o.Z)(Ke,2),_e=Be[0],qe=Be[1],He=(0,l.useCallback)((function(){qe(void 0),g("")}),[qe,g]);(0,l.useEffect)((function(){if("text"===Z)return He}),[Z,He]);var Ge=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"#000",n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"center";if(_e){_e.content=e,_e.fillColor=new z(t),_e.justification=n;var r=_e.exportJSON(),a=_e.name;if(He(),!a)return s((function(e){return y.Dw.addStroke(e,r)}));s((function(e){return y.Dw.mutateStrokes(e,[[a,r]])}))}};(0,l.useImperativeHandle)(t,(function(){return{deleteSelected:Ae,duplicateSelected:Ue,cancelText:He,rotateSelected:ze,submitText:Ge,mutateStyle:We,rasterize:Ve,pointText:_e}})),(0,l.useEffect)((function(){var e=function(e){return e.preventDefault()};return document.addEventListener("gesturestart",e),document.addEventListener("gesturechange",e),document.addEventListener("gestureend",e),function(){document.removeEventListener("gesturestart",e),document.removeEventListener("gesturechange",e),document.removeEventListener("gestureend",e)}}),[]),(0,E.usePinch)((function(e){var t=e.memo,n=(0,o.Z)(e.offset,1)[0],r=e.first,a=e.last,i=e.origin;b.current.activate();var u,s,c,l=b.current.view,d=new F(i);if(r||!t){var f=C.current.getBoundingClientRect(),v=f.x,p=f.y;u=1,c=new F(v,p),s=d.subtract(c)}else{var m=(0,o.Z)(t,3);u=m[0],s=m[1],c=m[2]}var h=d.subtract(c),g=l.viewToProject(h);Math.abs(1-n)<.05&&(n=1);var Z=r?1:n/u,j=a?10:1;Z=Math.pow(Z,1/j);!function e(){l.scale(Z,g),--j>0?requestAnimationFrame(e):a&&Y(l,new M(x,w))}();var S=h.subtract(s).divide(l.zoom);if(l.translate(S),!a)return[n,h,c]}),{scaleBounds:{max:10,min:.3},rubberband:.5,target:C});var Je=P(j);return(0,T.jsx)("div",{className:"draw-wrapper",style:{cursor:Te},children:(0,T.jsx)("canvas",(0,a.Z)({ref:C,className:"draw-canvas"},Je))})}));V.displayName="Draw";var K=l.memo(V);function B(){var e=(0,l.useState)(),t=(0,o.Z)(e,1)[0];return(0,l.useDebugValue)(t),(0,l.useEffect)((function(){return function(){null!==t&&void 0!==t&&t.name||null===t||void 0===t||t.remove()}}),[t]),e}var _=function(e,t){var n=e.pathData,r=e.uid;try{t.activate();var a=t.project.layers[1].importJSON(n);if(!a)return;return a.name=r,a.guide=!1,a}catch(i){console.error(i)}},q=function(e,t,n){e.activate();var r=new L.Rectangle(new F(0,0),new F(t,n));return r.fillColor=new z("#fff"),e.project.layers[0].addChild(r),r},H=function(e){var t=new L.Rectangle(e,new M(0,0));return t.onFrame=function(){},t.selected=!0,t},G=function(e){var t=e.mode,n=e.lineWidth,r=e.eraserWidth,a=e.color,i=e.highlight,o=new L;"erase"===t&&(a="#ccc",n=r),"select"===t&&(a="#1890ff",n=5);var u=new z(a);return(i||"erase"===t)&&(u.alpha=.5,o.blendMode="multiply"),o.strokeColor=u,o.strokeWidth=n,o.strokeJoin="round",o.strokeCap="round",o.guide=!0,o},J=function(e,t){var n=e.lineWidth,r=e.eraserWidth,a=t*("erase"===e.mode?r:n),i=a/2;return'url(\'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" fill="%23EEE6" width="'.concat(a,'" height="').concat(a,'" viewBox="0 0 10 10"><circle cx="5" cy="5" r="5"/></svg>\') ').concat(i," ").concat(i,", auto")},Q=function(e){e.dashOffset=0,e.dashArray=[30,20],e.onFrame=function(){return e.dashOffset+=3}},Y=function(e,t){var n=function(e,t){var n=e.center,r=n.x,a=n.y,i=e.size,o=i.width,u=i.height,s=t.width,c=t.height,l=Math.min(o,s)/2,d=Math.min(u,c)/2,f=s-l,v=c-d;return[r<l?l-r:r>f?f-r:0,a<d?d-a:a>v?v-a:0]}(e,t),r=(0,o.Z)(n,2),a=r[0],i=r[1],u=10,s=new F(a,i).divide(-u);!function t(){e.translate(s),--u>0&&requestAnimationFrame(t)}()},X=function(e,t){var n=function(e){var n=e.subtract(t,{insert:!1,trace:!1});return n.remove(),!n.compare(e)};return[].concat((0,r.Z)(e.getItems({class:O().Path,overlapping:t.bounds,match:n})),(0,r.Z)(e.getItems({class:O().PointText,match:function(e){var t=new L.Rectangle(e.bounds);return t.remove(),n(t)}}))).map((function(e){return e.name})).filter((function(e){return e}))},$=function(e,t){var n=t.bounds;return[].concat((0,r.Z)(e.getItems({class:O().Path,overlapping:n})),(0,r.Z)(e.getItems({class:O().PointText,match:function(e){return e.bounds.intersects(n)}}))).map((function(e){return e.name})).filter((function(e){return e}))},ee=function(e,t){var n=t.lineWidth,r=t.color,a=t.highlight;e.forEach((function(e){if(e instanceof O().PointText&&r){var t=new z(r);e.fillColor=t}if(e instanceof O().Path){if(r){var i=new z(r);"multiply"===e.blendMode&&(i.alpha=.5),e.strokeColor=i}n&&(e.strokeWidth=n),e.strokeColor&&void 0!==a&&(e.strokeColor.alpha=a?.5:1,e.blendMode=a?"multiply":"normal")}}))},te=function(e,t){var n=e.project.hitTest(t,{class:O().PointText,fill:!0});return null===n||void 0===n?void 0:n.item},ne=n(75783),re=n(87309),ae=n(50419),ie=n(79286),oe=function(){var e=(0,l.useContext)($t).addFinalPage;return(0,T.jsx)("div",{className:"add-btn-wrapper",children:(0,T.jsx)(re.Z,{type:"dashed",icon:(0,T.jsx)(ie.Z,{}),block:!0,onClick:e,children:"New page"})})};function ue(e,t,n){var r=e.indexOf(t),a=e.slice();return-1===r||a.splice(r+1,0,n),a}var se=n(16871),ce=n(64239),le=n(61507),de=n(79784),fe=n(99984),ve=n(20938),pe=n(23414),me=n(82622),he=n(72785),ge=n(22925),xe=n(4720),we=n(41275),Ze=n(89267),je=n(69228),Se=n(87501),ye=n(89295),ke=n(4942),Ce=n(80202),be=n(96272),De=n(78985),Pe=n(74115),Ie=(0,n(92721).Z)({scriptUrl:"//at.alicdn.com/t/font_3181679_yo844n7qgns.js"}),Ee=function(e){var t=e.updateDrawCtrl,n=e.drawCtrl,r=n.highlight,a=n.color,i=(0,l.useState)(!1),u=(0,o.Z)(i,2),s=u[0],c=u[1];return(0,T.jsxs)("div",{className:"pen-panel","data-blur":s,"data-hi":r,children:[(0,T.jsxs)("div",{className:"pen-status",children:[(0,T.jsx)(Ne,{updateDrawCtrl:t,drawCtrl:n,setPanelBlur:c}),(0,T.jsx)(Re,{checked:r,updateDrawCtrl:t})]}),(0,T.jsx)(Oe,{color:a||"",setColor:function(e){return t({color:e})}})]})},Ne=function(e){var t,n,a=e.updateDrawCtrl,i=e.drawCtrl,u=e.setPanelBlur,s=void 0===u?function(){}:u,c=e.field,d=void 0===c?"lineWidth":c,f=i[d],p=null!==(t=i.widthList)&&void 0!==t?t:v,m="lineWidth"===d&&null!==(n=i.color)&&void 0!==n?n:"#aaa",h=(0,l.useMemo)((function(){return p.indexOf(null!==f&&void 0!==f?f:-1)}),[f,p]),g=(0,l.useState)((0,k.aV)([!1,!1,!1,!1])),x=(0,o.Z)(g,2),w=x[0],Z=x[1];(0,l.useEffect)((function(){w.includes(!0)?s(!0):s(!1)}),[w,s]);var j=function(e){return{"--real-size":"calc(".concat(100/y.mF,"vw * ").concat(e,")")}},S=[{value:-1,label:null}].concat((0,r.Z)(p.map((function(e,t){return{value:t,label:(0,T.jsx)(je.Z,{visible:w.get(t),onVisibleChange:function(e){return Z((function(n){return n.set(t,e)}))},trigger:h===t?["click"]:[],placement:"bottom",destroyTooltipOnHide:!0,content:(0,T.jsx)(be.Z,{min:5,max:100,className:"ctrl-slider",defaultValue:e,onAfterChange:function(e){if(p.includes(e))return Z((function(e){return e.set(t,!1)})),a((0,ke.Z)({},d,e));var n=p.slice();n[t]=e,a((0,ke.Z)({widthList:n},d,e))}}),children:(0,T.jsx)("div",{className:"circle-wrapper",style:j(e),children:(0,T.jsx)(Ce.W,{className:"width-circle "+d,color:m})})})}}))));return(0,T.jsx)(De.Z,{className:"width-seg",value:h,options:S,onChange:function(e){var t;return a((0,ke.Z)({},d,null!==(t=p[+e])&&void 0!==t?t:10))}})},Re=function(e){var t=e.checked,n=void 0!==t&&t,r=e.updateDrawCtrl;return(0,T.jsxs)("label",{className:"hi-wrapper",children:[(0,T.jsx)("input",{type:"checkbox",name:"highlight",checked:n,onChange:function(e){return r({highlight:e.target.checked})}}),(0,T.jsx)("div",{className:"hi-switch",children:(0,T.jsx)(Ie,{type:"icon-Highlight"})})]})},Oe=function(e){var t=e.setColor,n=e.color;return(0,T.jsx)("div",{className:"color-select",children:Pe.Qk.map((function(e){return(0,T.jsxs)("label",{children:[(0,T.jsx)("input",{checked:n===e,type:"radio",name:"color",onChange:function(n){return n.target.checked&&t(e)}}),(0,T.jsx)("div",{"data-color":e,className:"circle",style:{backgroundColor:e,borderColor:e}})]},e)}))})},Te=n(66023),Le=n(54164),Me=n(64802),Fe=function(e){var t=e.drawRef,n=e.visible;return(0,T.jsx)(ye.Z,{timeout:300,in:n,unmountOnExit:!0,children:(0,T.jsx)(Ae,{drawRef:t})})},Ae=function(e){var t=e.drawRef,n={type:"text",shape:"round",size:"small"},r=(0,l.useState)({}),i=(0,o.Z)(r,2),u=i[0],s=i[1],c=(0,l.useRef)(null),d=(0,l.useState)(!1),f=(0,o.Z)(d,2),v=f[0],p=f[1],m=(0,l.useState)(0),h=(0,o.Z)(m,2),g=h[0],x=h[1],w={transform:"translateX(".concat(g,"px)")};(0,E.useDrag)((function(e){var n,r=e.first,a=e.last,i=e.offset,o=e.delta;x(i[0]),null===(n=t.current)||void 0===n||n.rotateSelected(o[0]/2,a),r&&p(!0),a&&p(!1)}),{target:c,filterTaps:!0,rubberband:.05,bounds:{left:-90,right:90}});return(0,Le.createPortal)((0,T.jsxs)("div",{className:"select-tool",children:[(0,T.jsx)(je.Z,{trigger:"click",placement:"bottom",getPopupContainer:function(e){return e.parentElement},destroyTooltipOnHide:!0,content:(0,T.jsx)(Ee,{updateDrawCtrl:function(e){var n;s((function(t){return(0,a.Z)((0,a.Z)({},t),e)})),null===(n=t.current)||void 0===n||n.mutateStyle(e)},drawCtrl:u}),children:(0,T.jsx)(re.Z,(0,a.Z)({icon:(0,T.jsx)(le.Z,{})},n))}),(0,T.jsxs)("div",{className:"rotate-wrapper","data-dragged":v,ref:c,children:[(0,T.jsx)(re.Z,(0,a.Z)({icon:(0,T.jsx)(de.Z,{}),onClick:function(){var e;return null===(e=t.current)||void 0===e?void 0:e.rotateSelected(90,!0)}},n)),(0,T.jsx)(fe.Z,{className:"arrow left"}),(0,T.jsx)(ve.Z,{className:"arrow right"}),(0,T.jsx)("div",{className:"gear",style:w})]}),(0,T.jsx)(re.Z,(0,a.Z)({icon:(0,T.jsx)(pe.Z,{}),onClick:function(){var e;return null===(e=t.current)||void 0===e?void 0:e.duplicateSelected()}},n)),(0,T.jsx)(re.Z,(0,a.Z)({icon:(0,T.jsx)(ce.Z,{}),onClick:function(){if(t.current){var e=t.current.rasterize();Ze.Z.confirm({title:"Screenshot",content:(0,T.jsx)("img",{className:"raster",src:e,alt:"raster"}),className:"raster-modal",icon:(0,T.jsx)(ce.Z,{}),okText:"Save",onOk:function(){return(0,Me.saveAs)(e,"screenshot")}})}}},n)),(0,T.jsx)(re.Z,(0,a.Z)({danger:!0,icon:(0,T.jsx)(me.Z,{}),onClick:function(){var e;return null===(e=t.current)||void 0===e?void 0:e.deleteSelected()}},n))]}),document.querySelector(".reader.container > header"))},ze=function(e){var t=e.visible,n=e.drawRef,r=(0,l.useState)(""),a=(0,o.Z)(r,2),i=a[0],u=a[1],s=(0,l.useState)(Pe.Qk[0]),c=(0,o.Z)(s,2),d=c[0],f=c[1],v=(0,l.useState)("center"),p=(0,o.Z)(v,2),m=p[0],h=p[1],g=(0,l.useContext)(Xt).forceLight;(0,l.useEffect)((function(){var e,r=null===(e=n.current)||void 0===e?void 0:e.pointText;if(r&&t){var a,i=r.name,o=r.content,s=r.justification,c=r.fillColor;if(h(s),i)u(o),f(null!==(a=null===c||void 0===c?void 0:c.toCSS(!0))&&void 0!==a?a:Pe.Qk[0]);else u(""),f(Pe.Qk[0])}}),[t,n]);var x=(0,T.jsx)(je.Z,{content:(0,T.jsx)(Oe,{color:d,setColor:f}),overlayStyle:{width:200},placement:"bottom",getPopupContainer:function(e){return e.parentElement},children:(0,T.jsx)(re.Z,{size:"small",icon:(0,T.jsx)(he.Z,{className:"font-icon",style:{color:d}})})}),w=(0,T.jsx)(Se.ZP.Group,{size:"small",optionType:"button",value:m,buttonStyle:"solid",onChange:function(e){return h(e.target.value)},options:[{label:(0,T.jsx)(ge.Z,{}),value:"left"},{label:(0,T.jsx)(xe.Z,{}),value:"center"},{label:(0,T.jsx)(we.Z,{}),value:"right"}]});return(0,T.jsxs)(Ze.Z,{visible:t,title:"Insert text",onCancel:function(){var e;return null===(e=n.current)||void 0===e?void 0:e.cancelText()},onOk:function(){var e,t,r=i.trim();if(!r)return null===(e=n.current)||void 0===e?void 0:e.cancelText();null===(t=n.current)||void 0===t||t.submitText(r,d,m)},bodyStyle:{paddingTop:0},destroyOnClose:!0,children:[(0,T.jsxs)("div",{className:"insert-option","data-force-light":g,children:[x,w]}),(0,T.jsx)(Te.Z,{size:"large",rows:3,autoFocus:!0,value:i,onChange:function(e){return u(e.target.value)}})]})},We=n(79930),Ue=n(82898),Ve=n(85168),Ke=n(58826),Be=n(58105),_e=n(37762);var qe=function(e,t){var n,r="",a=0,i=(0,_e.Z)(t);try{for(i.s();!(n=i.n()).done;){var o=n.value,u=e.get(o);if(u){if(1===u)return o;u>a&&(r=o,a=u)}}}catch(s){i.e(s)}finally{i.f()}return r},He=n(52242),Ge=n(65323),Je=n(78030),Qe=n(50446),Ye=n(74006),Xe=n(52542),$e=n(62),et=n(14965),tt=function(){var e=(0,l.useContext)(Xt),t=e.stateSet,n=e.drawCtrl,r=e.forceLight,i=(0,l.useContext)($t),o=i.setDrawCtrl,u=i.handleUndo,s=i.handleRedo,c=i.setForceLight,d=n.mode,f=n.finger,v=function(e){o((function(t){var n=(0,a.Z)((0,a.Z)({},t),e);return function(e){g.apply(this,arguments)}(n),n}))};return(0,T.jsxs)("div",{className:"middle",children:[(0,T.jsx)(re.Z,{type:"text",shape:"circle",icon:(0,T.jsx)(Je.Z,{}),onClick:u,disabled:!(null!==t&&void 0!==t&&t.isUndoable())}),(0,T.jsx)(re.Z,{type:"text",shape:"circle",icon:(0,T.jsx)(Qe.Z,{}),onClick:s,disabled:!(null!==t&&void 0!==t&&t.isRedoable())}),(0,T.jsx)(re.Z,{type:f?"default":"text",shape:"circle",onClick:function(){v({finger:!f}),ae.ZP.destroy("FINGER"),ae.ZP.open({content:f?"Pencil only":"Draw with finger",key:"FINGER"})},icon:(0,T.jsx)(Ie,{type:"icon-finger"})}),(0,T.jsx)(re.Z,{className:"force-light-btn",type:"text",shape:"circle",icon:r?(0,T.jsx)(Ye.Z,{}):(0,T.jsx)(Xe.Z,{}),onClick:function(){return c((function(e){return!e}))}}),(0,T.jsx)(nt,{updateDrawCtrl:v}),(0,T.jsx)(rt,{updateDrawCtrl:v}),(0,T.jsx)(re.Z,{type:"text"===d?"default":"text",shape:"circle",onClick:function(){return v({mode:"text"})},icon:(0,T.jsx)(Ie,{type:"icon-text1"})}),(0,T.jsx)(at,{updateDrawCtrl:v})]})},nt=function(e){var t=e.updateDrawCtrl,n=(0,l.useContext)(Xt).drawCtrl,r=n.mode,i={shape:"circle",icon:(0,T.jsx)($e.Z,{})};return"draw"===r?(0,T.jsx)(je.Z,{content:(0,T.jsx)(Ee,{updateDrawCtrl:t,drawCtrl:n}),trigger:"click",placement:"bottom",getPopupContainer:function(e){return e.parentElement},destroyTooltipOnHide:!0,children:(0,T.jsx)(re.Z,(0,a.Z)({type:"default"},i))}):(0,T.jsx)(re.Z,(0,a.Z)({type:"text",onClick:function(){return t({mode:"draw"})}},i))},rt=function(e){var t=e.updateDrawCtrl,n=(0,l.useContext)(Xt).drawCtrl,r={shape:"circle",icon:(0,T.jsx)(Ie,{type:"icon-eraser"})};return"erase"===n.mode?(0,T.jsx)(je.Z,{content:(0,T.jsx)("div",{className:"width-seg-wrapper",children:(0,T.jsx)(Ne,{drawCtrl:n,updateDrawCtrl:t,field:"eraserWidth"})}),trigger:"click",placement:"bottom",getPopupContainer:function(e){return e.parentElement},destroyTooltipOnHide:!0,children:(0,T.jsx)(re.Z,(0,a.Z)({type:"default"},r))}):(0,T.jsx)(re.Z,(0,a.Z)({type:"text",onClick:function(){return t({mode:"erase"})}},r))},at=function(e){var t=e.updateDrawCtrl,n=(0,l.useContext)(Xt).drawCtrl,r=n.lasso,a=n.mode,i=r?(0,T.jsx)(Ie,{type:"icon-lasso1"}):(0,T.jsx)(et.Z,{});return"select"===a?(0,T.jsx)(re.Z,{type:"default",shape:"circle",icon:i,onClick:function(){return t({lasso:!r})}}):(0,T.jsx)(re.Z,{type:"text",shape:"circle",icon:i,onClick:function(){return t({mode:"select"})}})},it=n(49142),ot=n(90785),ut=n(91333),st=n(75594),ct=n(95055),lt=n(67415),dt=n(91511),ft=n(69951),vt=n(10711),pt=n(53621),mt=n(75797),ht=n(18780),gt=n(76586),xt=n(70140),wt=n(87661),Zt=n(88894),jt=function(e){var t=e.userID,n=e.size,r=void 0===n?"default":n,a=e.onClick,i=void 0===a?function(){}:a,o=e.chosen,u=void 0!==o&&o,s=e.className,c=(0,l.useContext)(dt.TeamCtx).userRec,d=(0,l.useMemo)((function(){return(0,Pe.bM)(t)}),[t]),f=c[t];if(!f)return null;var v=f.userName;return(0,T.jsx)(gt.C,{className:s,"data-chosen":u,size:r,style:{backgroundColor:d},children:(0,T.jsx)("div",{className:"avatar-wrapper",onClick:i,children:null===v||void 0===v?void 0:v.slice(0,3)})})},St=n(81694),yt=n.n(St),kt=l.createContext({activeKey:"ALL",setActiveKey:function(){}}),Ct=function(){var e=(0,l.useContext)(Xt),t=e.pageOrder,n=e.currPageID,r=e.forceLight,i=(0,l.useContext)($t),u=i.scrollPage,s=i.saveReorder,c=(0,l.useContext)(kt).activeKey,d=(0,l.useRef)({});return(0,l.useEffect)((function(){var e;return null===(e=d.current[n])||void 0===e?void 0:e.scrollIntoView()}),[]),(0,T.jsxs)("div",{className:"preview-container","data-force-light":r,children:[(0,T.jsx)(Et,{}),(0,T.jsx)(ht.Z5,{onDragEnd:function(e){var n=e.source,r=e.destination;if(r&&t){var a=n.index,i=r.index;if(a!==i){var c=t[a],l=function(e,t,n){var r=e.slice(),a=r.splice(t,1),i=(0,o.Z)(a,1)[0];return r.splice(n,0,i),r}(t,a,i);s(l,!0),requestAnimationFrame((function(){return u(c)}))}}},children:(0,T.jsx)(ht.bK,{droppableId:"preview-list",children:function(e){var n=e.droppableProps,r=e.innerRef,i=e.placeholder;return(0,T.jsxs)("div",(0,a.Z)((0,a.Z)({className:"page-list",ref:r},n),{},{children:[null===t||void 0===t?void 0:t.map((function(e,t){return(0,T.jsx)(bt,{uid:e,pageIndex:t,refRec:d.current},e)})),i,"ALL"===c&&(0,T.jsx)(oe,{})]}))}})})]})},bt=function(e){var t=e.uid,n=e.pageIndex,r=e.refRec,i=(0,l.useContext)(Xt),u=i.stateSet,s=i.teamState,c=i.pageRec,d=i.currPageID,f=(0,l.useContext)($t).scrollPage,v=(0,l.useContext)(kt).activeKey,p=(0,l.useState)(""),m=(0,o.Z)(p,2),h=m[0],g=m[1],x=null===c||void 0===c?void 0:c.get(t),w=null===u||void 0===u?void 0:u.getOneState(t),Z=null===s||void 0===s?void 0:s.getOnePageStateMap(t);if(!x||!w)return null;var j=x.image,S=x.marked;if("WRITTEN"===v&&w.isEmpty()&&(!Z||Z.every((function(e){return e.isEmpty()}))))return null;if("MARKED"===v&&!S)return null;var y=d===t;return(0,T.jsx)(ht._l,{draggableId:t,index:n,isDragDisabled:"ALL"!==v,children:function(e,i){var o=e.innerRef,u=e.draggableProps,s=e.dragHandleProps,c=i.isDragging;return(0,T.jsxs)("div",(0,a.Z)((0,a.Z)((0,a.Z)({ref:function(e){o(e),e&&(r[t]=e)},className:"page","data-curr":y,"data-dragged":c,onClick:function(){return f(t)}},u),s),{},{children:[(0,T.jsx)(nn,{uid:t,drawState:(null===Z||void 0===Z?void 0:Z.get(h))||w,teamStateMap:h?void 0:Z,thumbnail:j,preview:!0}),(0,T.jsx)(Dt,{uid:t,index:n,chosen:h,setChosen:g})]}))}})},Dt=function(e){var t=e.uid,n=e.index,r=e.chosen,a=e.setChosen,i=(0,l.useContext)($t).switchPageMarked,o=(0,l.useContext)(Xt),u=o.teamState,s=o.pageRec,c=(0,l.useContext)(dt.TeamCtx).ignores,d=(0,l.useMemo)((function(){return(null===u||void 0===u?void 0:u.getPageValidUsers(t).filter((function(e){return!c.has(e)})))||[]}),[u,c,t]),f=null===s||void 0===s?void 0:s.get(t);if(!f)return null;var v=f.marked;return(0,T.jsxs)("div",{className:"tools",onClick:function(e){return e.stopPropagation()},children:[(0,T.jsx)("span",{className:"bookmark","data-marked":v,onClick:function(){return i(t)}}),(0,T.jsx)("span",{className:"index",children:n+1}),(0,T.jsx)(It,{uid:t}),(0,T.jsx)(Pt,{userIDs:d,chosen:r,setChosen:a})]})},Pt=function(e){var t=e.userIDs,n=e.chosen,r=e.setChosen;return(0,T.jsx)(gt.C.Group,{maxCount:2,size:"default",className:yt()("team-group",{chosen:n}),maxPopoverPlacement:"bottom",children:t.map((function(e){return(0,T.jsx)(jt,{size:"default",userID:e,className:"preview-avatar",chosen:n===e,onClick:function(){return r((function(t){return t===e?"":e}))}},e)}))})},It=function(e){var t=e.uid,n=(0,l.useContext)($t),r=n.addPage,a=n.deletePage,i=(0,T.jsx)(xt.Z,{onClick:function(e){var n=e.key;"ADD"===n?r(t):"COPY"===n?r(t,!0):"DELETE"===n&&a(t)},items:[{key:"ADD",icon:(0,T.jsx)(ie.Z,{}),label:"Add page"},{key:"COPY",icon:(0,T.jsx)(pe.Z,{}),label:"Duplicate"},{key:"DELETE",icon:(0,T.jsx)(me.Z,{}),label:"Delete",danger:!0}]});return(0,T.jsx)(je.Z,{content:i,trigger:"click",placement:"left",destroyTooltipOnHide:!0,children:(0,T.jsx)("span",{className:"option",children:(0,T.jsx)(vt.Z,{})})})},Et=function(){var e=(0,l.useContext)(kt),t=e.activeKey,n=e.setActiveKey,r=wt.Z.TabPane;return(0,T.jsxs)(wt.Z,{className:"tabs",activeKey:t,onChange:n,tabBarGutter:10,size:"small",centered:!0,children:[(0,T.jsx)(r,{tab:(0,T.jsx)(Ie,{type:"icon-uf_paper"})},"ALL"),(0,T.jsx)(r,{tab:(0,T.jsx)(Ie,{type:"icon-bookmark2"})},"MARKED"),(0,T.jsx)(r,{tab:(0,T.jsx)(Ie,{type:"icon-write"})},"WRITTEN")]})};function Nt(){var e=(0,l.useState)(!1),t=(0,o.Z)(e,2),n=t[0],r=t[1],a=(0,l.useState)("ALL"),i=(0,o.Z)(a,2),u=i[0],s=i[1],c={ALL:"All Pages",MARKED:"Bookmarks",WRITTEN:"Notes"}[u];return(0,T.jsxs)(kt.Provider,{value:{activeKey:u,setActiveKey:s},children:[(0,T.jsx)(re.Z,{type:"text",icon:n?(0,T.jsx)(pt.Z,{}):(0,T.jsx)(mt.Z,{}),onClick:function(){return r((function(e){return!e}))}}),(0,T.jsx)(Zt.Z,{visible:n,onClose:function(){return r(!1)},width:200,title:c,closable:!1,zIndex:800,className:"preview-drawer",bodyStyle:{padding:0,overflow:"hidden"},headerStyle:{textAlign:"center"},destroyOnClose:!0,children:(0,T.jsx)(Ct,{})})]})}var Rt=n(67575),Ot=n(30501),Tt=n(98272),Lt=n(24215),Mt=n(17973),Ft=n(19951),At=n(23605),zt=n(56200),Wt=n(18301),Ut=n(51570),Vt=n(1829),Kt=n.n(Vt),Bt=function(){var e=(0,l.useContext)(dt.TeamCtx).teamOn;return(0,T.jsxs)("div",{className:"right",children:[e?(0,T.jsx)(qt,{}):(0,T.jsx)(Ht,{}),(0,T.jsx)(Nt,{})]})},_t=function(e){var t=e.userID,n=(0,l.useState)(!1),r=(0,o.Z)(n,2),a=r[0],i=r[1],u=(0,l.useContext)(dt.TeamCtx),s=u.ignores,c=u.setIgnores,d=u.resetIO,f=u.userRec[t];if((0,l.useEffect)((function(){return i(!1)}),[f]),!f)return null;var v=f.userName,p=f.online,m=t===(0,ft.VN)(),h=s.has(t)&&!m;return(0,T.jsxs)("div",{className:"user-item","data-online":p,children:[(0,T.jsx)(jt,{userID:t,size:"small",className:"room-avatar"}),a||(0,T.jsx)("span",{className:"user-name",children:v}),a&&(0,T.jsx)(ct.Z,{autoFocus:!0,className:"rename-input",defaultValue:v,onSearch:function(e){var t=e.trim();if(!t||t===v)return i(!1);(0,ft.lu)(t),d()},enterButton:(0,T.jsx)(re.Z,{icon:(0,T.jsx)(Rt.Z,{})})}),m?a||(0,T.jsx)(re.Z,{type:"text",icon:(0,T.jsx)(Ot.Z,{}),onClick:function(){return i(!0)}}):(0,T.jsx)(re.Z,{type:"text",icon:h?(0,T.jsx)(Tt.Z,{}):(0,T.jsx)(Lt.Z,{}),onClick:function(){c((function(e){return e.has(t)?e.delete(t):e.add(t)}))}})]})},qt=function(){var e=(0,l.useContext)(dt.TeamCtx),t=e.code,n=e.userRec,a=e.connected,s=e.loadInfo,d=e.loadState,f=e.resetIO,v=(0,l.useContext)(Xt).noteInfo,p=window.location.href,m=function(){var e=(0,u.Z)(c().mark((function e(){var t,r;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=null===(t=n[(0,ft.VN)()])||void 0===t?void 0:t.userName,e.prev=1,v){e.next=4;break}return e.abrupt("return");case 4:return e.next=6,Kt()("".concat(v.name," - ").concat(r," - Multibility\n").concat(p));case 6:ae.ZP.destroy("copy"),ae.ZP.success({content:"Link copied!",icon:(0,T.jsx)(pe.Z,{}),key:"copy"}),e.next=13;break;case 10:e.prev=10,e.t0=e.catch(1),console.log(e.t0);case 13:case"end":return e.stop()}}),e,null,[[1,10]])})));return function(){return e.apply(this,arguments)}}(),h=(0,l.useMemo)((function(){var e=(0,ft.VN)(),t=n[e],a=(0,i.Z)(n,[e].map(it.Z)),o=t?[t]:[],u=Object.values(a);return o.push.apply(o,(0,r.Z)(u.filter((function(e){return e.online}))).concat((0,r.Z)(u.filter((function(e){return!e.online}))))),o}),[n]),g=(0,l.useMemo)((function(){return h.filter((function(e){return e.online})).length}),[h]),x=(0,T.jsxs)("div",{className:"team-popover",children:[a||(0,T.jsx)(ot.Z,{className:"disconn-alert",message:"Network failed.",icon:(0,T.jsx)(Mt.Z,{}),type:"error",showIcon:!0,banner:!0}),(0,T.jsx)(lt.GD,{className:"code-display",value:String(t),length:4,plain:!0}),(0,T.jsx)(re.Z,{icon:(0,T.jsx)(Ft.Z,{}),className:"share-btn",onClick:m,block:!0,children:"Share"}),(0,T.jsx)(ut.Z,{}),(0,T.jsx)("div",{className:"user-list",children:h.map((function(e){return(0,T.jsx)(_t,{userID:e.userID},e.userID)}))})]}),w=(0,l.useState)(!1),Z=(0,o.Z)(w,2),j=Z[0],S=Z[1],y=(0,T.jsxs)("div",{className:"team-title",children:[(0,T.jsx)("span",{children:"Team info"}),(0,T.jsx)(re.Z,{shape:"circle",type:"text",size:"small",loading:j,icon:(0,T.jsx)(At.Z,{}),onClick:(0,u.Z)(c().mark((function e(){return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return S(!0),e.next=3,s();case 3:return e.next=5,d();case 5:S(!1),f();case 7:case"end":return e.stop()}}),e)})))})]});return(0,T.jsx)(je.Z,{content:x,trigger:"click",placement:"bottomRight",title:y,getPopupContainer:function(e){return e.parentElement},children:(0,T.jsx)(re.Z,{type:"text",icon:(0,T.jsx)(st.Z,{status:a?"success":"error",count:a?g:"!",size:"small",children:(0,T.jsx)(zt.Z,{})})})})},Ht=function(){var e=(0,l.useContext)(Xt).noteID,t=(0,l.useContext)($t).instantSave,n=(0,se.s0)(),r=function(){var r=(0,u.Z)(c().mark((function r(){return c().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,t();case 2:return r.next=4,(0,Ut.r8)(e);case 4:if(r.sent){r.next=7;break}return r.abrupt("return",ae.ZP.error("Can't create room."));case 7:return r.next=9,(0,ne.SP)(e,{team:!0});case 9:n("/team/"+e);case 10:case"end":return r.stop()}}),r)})));return function(){return r.apply(this,arguments)}}();return(0,T.jsx)(re.Z,{type:"text",icon:(0,T.jsx)(Wt.Z,{}),onClick:function(){Ze.Z.confirm({title:"Enable team editing",content:"This will make your note public.",icon:(0,T.jsx)(zt.Z,{style:{color:"#555"}}),onOk:r})}})};function Gt(){return(0,T.jsxs)("header",{children:[(0,T.jsx)(Jt,{}),(0,T.jsx)(tt,{}),(0,T.jsx)(Bt,{})]})}var Jt=function(){var e=(0,l.useContext)(Xt).saved,t=(0,l.useContext)($t).instantSave,n=(0,se.s0)();return(0,T.jsxs)("div",{className:"left",children:[(0,T.jsx)(re.Z,{type:"text",onClick:(0,u.Z)(c().mark((function e(){return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t();case 2:n("/");case 3:case"end":return e.stop()}}),e)}))),icon:(0,T.jsx)(He.Z,{style:{opacity:.8}})}),(0,T.jsx)(re.Z,{type:"text",className:"save",onClick:t,disabled:e,icon:(0,T.jsx)(Ge.Z,{})})]})},Qt=["pageRec","pdf","pageOrder"],Yt=["image","marked"],Xt=(0,l.createContext)({noteID:"",noteInfo:void 0,stateSet:void 0,teamState:void 0,pageRec:void 0,pageOrder:void 0,saved:!0,currPageID:"",drawCtrl:p,forceLight:!1}),$t=(0,l.createContext)({scrollPage:function(e){},switchPageMarked:function(e){},updateStateSet:function(e){},addPage:function(e,t){},addFinalPage:function(){},deletePage:function(e){},saveReorder:function(){var e=(0,u.Z)(c().mark((function e(t,n){return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}(),setInviewRatios:function(){},setDrawCtrl:function(){},instantSave:function(){},handleUndo:function(){},handleRedo:function(){},setForceLight:function(){}});function en(){var e,t=null!==(e=(0,se.UO)().noteID)&&void 0!==e?e:"",n=(0,se.s0)(),s=(0,l.useState)(),d=(0,o.Z)(s,2),v=d[0],h=d[1],g=(0,l.useState)(),j=(0,o.Z)(g,2),S=j[0],C=j[1],b=(0,l.useState)(),P=(0,o.Z)(b,2),I=P[0],E=P[1],N=(0,l.useState)(p),R=(0,o.Z)(N,2),O=R[0],L=R[1],M=(0,l.useState)(),F=(0,o.Z)(M,2),A=F[0],z=F[1],W=(0,w.Z)(!0),U=(0,o.Z)(W,2),V=U[0],K=U[1],B=(0,l.useState)(!1),_=(0,o.Z)(B,2),q=_[0],H=_[1],G=(0,l.useContext)(dt.TeamCtx),J=G.io,Q=G.teamOn,Y=G.teamState,X=G.addTeamStatePage,$=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=(0,l.useState)((0,k.D5)()),r=(0,o.Z)(n,2),a=r[0],i=r[1],s=(0,l.useRef)(!1),d=(0,l.useState)(""),v=(0,o.Z)(d,2),p=v[0],m=v[1],h=(0,l.useState)((0,k.D5)()),g=(0,o.Z)(h,2),x=g[0],w=g[1],Z=(0,l.useMemo)((function(){return qe(x,t)}),[x,t]);return(0,l.useDebugValue)(Z),(0,l.useEffect)((function(){var t=function(){var t=(0,u.Z)(c().mark((function t(){var n;return c().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,f().getItem("SCROLL_".concat(e));case 2:if(n=t.sent){t.next=5;break}return t.abrupt("return",s.current=!0);case 5:m(n);case 6:case"end":return t.stop()}}),t)})));return function(){return t.apply(this,arguments)}}();t()}),[e]),(0,l.useEffect)((function(){!s.current&&a.has(p)&&requestAnimationFrame((function(){var e;null===(e=a.get(p))||void 0===e||e.scrollIntoView(),s.current=!0}))}),[p,a]),(0,l.useEffect)((function(){s.current&&f().setItem("SCROLL_".concat(e),Z)}),[Z,e]),{scrollPage:function(e){var t;null===(t=a.get(e))||void 0===t||t.scrollIntoView()},setInviewRatios:w,setRef:function(e,t){t&&i((function(n){return n.set(e,t)}))},currPageID:Z}}(t,A),ee=$.setInviewRatios,te=$.scrollPage,ie=$.setRef,ce=$.currPageID;(0,l.useEffect)((function(){var e=function(){var e=(0,u.Z)(c().mark((function e(){var r,a,o,u;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,ne.U9)(t);case 2:if(r=e.sent){e.next=6;break}return ae.ZP.error("Note not found"),e.abrupt("return",n("/"));case 6:return a=r.pageRec,r.pdf,o=r.pageOrder,u=(0,i.Z)(r,Qt),h((0,k.D5)(a)),z(o),C(u),E(D.createFromPages(a)),e.t0=L,e.next=14,m();case 14:e.t1=e.sent,(0,e.t0)(e.t1);case 16:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}();e()}),[n,t,Q]),(0,l.useEffect)((function(){S&&(document.title=S.name+" - Multibility")}),[S]);var le=(0,Z.Z)((0,u.Z)(c().mark((function e(){var n,r,a;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=null===v||void 0===v?void 0:v.toObject(),r=document.querySelector("canvas"),a=null===r||void 0===r?void 0:r.toDataURL("image/jpeg",.1),e.next=5,(0,ne.SP)(t,{pageRec:n,thumbnail:a});case 5:K(!0);case 6:case"end":return e.stop()}}),e)})))),de=(0,l.useCallback)((0,We.Z)(le,2e3),[le]),fe=de.flush,ve=function(e,t){h((function(n){return null===n||void 0===n?void 0:n.update(e,x.BJ,t)})),K(!1),de()},pe=function(){var e=(0,u.Z)(c().mark((function e(n){var r,a=arguments;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=a.length>1&&void 0!==a[1]&&a[1],z(n),e.next=4,(0,ne.SP)(t,{pageOrder:n});case 4:return e.next=6,fe();case 6:r&&me(n);case 7:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),me=function(e){return null===J||void 0===J?void 0:J.emit("reorder",{pageOrder:e})},he=(0,Z.Z)((function(e){var t,n=e.deleted,r=e.pageOrder,a=e.prevOrder;(pe(r),n)&&(t=function(){return pe(a,!0)},ae.ZP.warning({content:(0,T.jsxs)(T.Fragment,{children:["One page was deleted.",(0,T.jsx)(re.Z,{size:"small",type:"link",onClick:function(){ae.ZP.destroy("DELETE"),t()},children:"Undo"})]}),key:"DELETE",duration:10}))})),ge=(0,Z.Z)((function(e){var t=e.pageOrder,n=e.pageID,r=e.newPage;pe(t),ve(n,(function(){return r})),E((function(e){return null===e||void 0===e?void 0:e.addState(n,r)}))}));(0,l.useEffect)((function(){return null===J||void 0===J||J.on("reorder",he),null===J||void 0===J||J.on("newPage",ge),function(){null===J||void 0===J||J.removeAllListeners()}}),[J,he,ge]);var xe=function(e,t,n){n.image,n.marked;var r=(0,i.Z)(n,Yt);null===J||void 0===J||J.emit("newPage",{pageOrder:e,pageID:t,newPage:r}),X(t,n)},we=function(e,t){var n=y.Dw.flaten(t);ve(e,(function(e){return(0,a.Z)((0,a.Z)({},e),{},{state:n})}))},Ze=function(e){if(I){var t=e(I);E(t);var n,a=t.getLastDS(),i=t.lastOp;if(a&&i)we.apply(void 0,(0,r.Z)(a)),n=i,null===J||void 0===J||J.emit("push",{operation:n},(function(e){var t=e.pageID,n=e.stroke;return E((function(e){return null===e||void 0===e?void 0:e.syncStrokeTime(t,n)}))}))}},je=function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(A){var n=t?null===v||void 0===v?void 0:v.get(e):void 0,r=(0,x.D4)(n),a=(0,o.Z)(r,2),i=a[0],u=a[1],s=ue(A,e,i);xe(s,i,u),pe(s),ve(i,(function(){return u})),E((function(e){return null===e||void 0===e?void 0:e.addState(i,u)}))}},Se=(0,T.jsxs)("div",{className:"reader container","data-force-light":q,children:[(0,T.jsx)(Gt,{}),(0,T.jsxs)("main",{children:[null===A||void 0===A?void 0:A.map((function(e){return(0,T.jsx)("section",{className:"note-page",ref:function(t){return ie(e,t)},children:(0,T.jsx)(tn,{uid:e})},e)})),(0,T.jsx)(oe,{})]})]});return(0,T.jsx)(Xt.Provider,{value:{saved:V,noteID:t,pageRec:v,drawCtrl:O,noteInfo:S,stateSet:I,teamState:Y,pageOrder:A,currPageID:ce,forceLight:q},children:(0,T.jsx)($t.Provider,{value:{addPage:je,scrollPage:te,deletePage:function(e){var t=null===A||void 0===A?void 0:A.filter((function(t){return t!==e}));(null===t||void 0===t?void 0:t.length)&&pe(t,!0)},setDrawCtrl:L,saveReorder:pe,instantSave:fe,addFinalPage:function(){var e=(0,Ue.Z)(A);e&&je(e)},handleRedo:function(){return Ze((function(e){return e.redo()}))},handleUndo:function(){return Ze((function(e){return e.undo()}))},updateStateSet:Ze,setInviewRatios:ee,switchPageMarked:function(e){return ve(e,(function(e){return(0,a.Z)((0,a.Z)({},e),{},{marked:!e.marked})}))},setForceLight:H},children:Se})})}var tn=function(e){var t=e.uid,n=(0,l.useContext)(Xt),r=n.pageRec,a=n.stateSet,i=n.teamState,o=(0,l.useContext)($t).updateStateSet,u=null===r||void 0===r?void 0:r.get(t),s=null===a||void 0===a?void 0:a.getOneState(t),c=null===i||void 0===i?void 0:i.getOnePageStateMap(t);return u&&s?(0,T.jsx)(nn,{drawState:s,teamStateMap:c,updateState:function(e){o((function(n){return n.setState(t,e)}))},pdfIndex:u.pdfIndex,uid:t}):null},nn=function(e){var t=e.thumbnail,r=e.drawState,a=e.teamStateMap,i=e.updateState,s=e.pdfIndex,d=e.preview,f=void 0!==d&&d,v=e.uid,p=(0,l.useContext)($t).setInviewRatios,m=(0,l.useContext)(Xt).noteID,h=(0,l.useState)(),g=(0,o.Z)(h,2),x=g[0],w=g[1],Z=(0,Be.YD)({threshold:(0,Ve.Z)(0,1.1,.1)}),j=(0,o.Z)(Z,3),S=j[0],y=j[1],k=j[2];(0,l.useEffect)((function(){f||p(k&&y?function(e){return e.set(v,k.intersectionRatio)}:function(e){return e.delete(v)})}),[y,k,v,f,p]);var C=(0,l.useCallback)((0,Ke.Z)((0,u.Z)(c().mark((function e(){var t,r;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(s){e.next=2;break}return e.abrupt("return");case 2:return e.next=4,Promise.all([n.e(643),n.e(138)]).then(n.bind(n,21176));case 4:return t=e.sent,r=t.getNotePageImage,e.t0=w,e.next=9,r(m,s);case 9:e.t1=e.sent,(0,e.t0)(e.t1);case 11:case"end":return e.stop()}}),e)})))),[s,m]);(0,l.useEffect)((function(){!f&&y&&C()}),[y,f,C]);var b=(0,l.useContext)(dt.TeamCtx).ignores,D=(0,l.useMemo)((function(){return null===a||void 0===a?void 0:a.deleteAll(b).toList().toArray()}),[a,b]),P=y&&(x||!s),I=Boolean(f||!P),E=r.height/r.width;return(0,T.jsxs)("div",{ref:S,className:"page-wrapper",style:{paddingTop:"".concat(100*E,"%")},children:[P&&(0,T.jsx)(rn,{drawState:r,otherStates:D,updateState:i,imgSrc:x||t,preview:f}),I&&(0,T.jsx)("div",{className:"mask"})]})},rn=function(e){var t=e.drawState,n=e.updateState,r=e.otherStates,a=e.preview,i=void 0!==a&&a,u=e.imgSrc,s=(0,l.useContext)(Xt).drawCtrl,c=(0,l.useState)(""),d=(0,o.Z)(c,2),f=d[0],v=d[1],p=(0,l.useRef)(null),m=(0,Z.Z)((function(e){if(n){var r=e instanceof y.Dw?e:e(t);n(r)}}));return i?(0,T.jsx)(K,{drawState:t,otherStates:r,imgSrc:u,readonly:!0}):(0,T.jsxs)(T.Fragment,{children:[(0,T.jsx)(K,{drawState:t,otherStates:r,onChange:m,imgSrc:u,drawCtrl:s,ref:p,setActiveTool:v}),(0,T.jsx)(Fe,{drawRef:p,visible:"select"===f}),(0,T.jsx)(ze,{drawRef:p,visible:"text"===f})]})};rn.displayName="DrawWrapper"},91511:function(e,t,n){"use strict";n.r(t),n.d(t,{TeamCtx:function(){return P},default:function(){return I}});var r=n(29439),a=n(15861),i=n(87757),o=n.n(i),u=n(72791),s=n(51570),c=n(56058),l=n(87962),d=n(78577),f=n(69951),v=function(e){return function(){return(0,d.io)(s._n,{query:{userID:(0,f.VN)(),userName:(0,f.vW)(),noteID:e}})}},p=n(16871),m=n(45987),h=n(15671),g=n(43144),x=n(82670),w=n(24124),Z=["pageID"],j={pageStates:(0,w.D5)(),pageInfos:(0,w.D5)()},S=(0,w.WV)(j),y=function(){function e(t){(0,h.Z)(this,e),this.immutable=t}return(0,g.Z)(e,[{key:"getImmutable",value:function(){return this.immutable}},{key:"getPageStates",value:function(){return this.getImmutable().get("pageStates")}},{key:"getPageInfos",value:function(){return this.getImmutable().get("pageInfos")}},{key:"getOneState",value:function(e,t){var n;return null===(n=this.getPageStates().get(e))||void 0===n?void 0:n.get(t)}},{key:"getOnePageStateMap",value:function(e){return this.getPageStates().get(e)}},{key:"getPageValidUsers",value:function(e){var t=this.getOnePageStateMap(e);return t?Array.from(null===t||void 0===t?void 0:t.filter((function(e){return!e.isEmpty()})).keys()):[]}},{key:"getPageRatio",value:function(e){var t;return null===(t=this.getPageInfos().get(e))||void 0===t?void 0:t.ratio}},{key:"includesPage",value:function(e){return this.getPageStates().has(e)}},{key:"setState",value:function(t,n,r){var a=this.getPageStates().get(t);return a?new e(this.getImmutable().update("pageStates",(function(e){return e.set(t,a.set(n,r))}))):this}},{key:"addPage",value:function(t,n){var r=n.ratio;return new e(this.getImmutable().update("pageStates",(function(e){return e.set(t,(0,w.D5)())})).update("pageInfos",(function(e){return e.set(t,{ratio:r})})))}},{key:"pushOperation",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:x.mF,r=e.pageID,a=(0,m.Z)(e,Z),i=this.getPageRatio(r);if(!this.includesPage(r)||!i)return this;var o=this.getOneState(r,t)||x.Dw.createEmpty(n,n*i),u=x.Dw.pushOperation(o,a);return this.setState(r,t,u)}},{key:"resetUser",value:function(e,t){for(var n=this,a=0,i=Object.entries(t);a<i.length;a++){var o=(0,r.Z)(i[a],2),u=o[0],s=o[1],c=s.state,l=s.ratio,d=n.getOneState(u,e);if(d){var f=d.width;n=n.setState(u,e,x.Dw.loadFromFlat(c,f,f*l))}}return n}}],[{key:"createFromTeamPages",value:function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:x.mF,a=S();return Object.entries(t).forEach((function(e){var t=(0,r.Z)(e,2),i=t[0],o=t[1],u=o.states,s=o.ratio,c=(0,w.D5)(Object.entries(u).map((function(e){var t=(0,r.Z)(e,2),a=t[0],i=t[1];return[a,x.Dw.loadFromFlat(i,n,n*s)]})));a=a.update("pageStates",(function(e){return e.set(i,c)})).update("pageInfos",(function(e){return e.set(i,{ratio:s})}))})),new e(a)}}]),e}(),k=n(65099),C=n(50419),b=n(74968),D=n(80184),P=(0,u.createContext)({io:void 0,code:0,teamOn:!1,connected:!1,ignores:(0,w.l4)(),userRec:{},teamState:void 0,resetIO:function(){},loadInfo:function(){var e=(0,a.Z)(o().mark((function e(){return o().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",!1);case 1:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),loadState:function(){var e=(0,a.Z)(o().mark((function e(){return o().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",!1);case 1:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),setIgnores:function(){},addTeamStatePage:function(e,t){}});function I(){var e,t=null!==(e=(0,p.UO)().noteID)&&void 0!==e?e:"",n=(0,u.useState)(),i=(0,r.Z)(n,2),c=i[0],l=i[1],d=(0,u.useState)(-2),m=(0,r.Z)(d,2),h=m[0],g=m[1],x=(0,u.useState)({}),Z=(0,r.Z)(x,2),j=Z[0],S=Z[1],I=(0,u.useState)((0,w.l4)()),R=(0,r.Z)(I,2),O=R[0],T=R[1],L=(0,u.useState)(v(t)),M=(0,r.Z)(L,2),F=M[0],A=M[1],z=(0,u.useState)(!1),W=(0,r.Z)(z,2),U=W[0],V=W[1],K=(0,u.useState)(!1),B=(0,r.Z)(K,2),_=B[0],q=B[1],H=(0,p.s0)(),G=(0,u.useCallback)((0,a.Z)(o().mark((function e(){var n;return o().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,s.dn)(t);case 2:if(n=e.sent){e.next=6;break}return C.ZP.error("Failed loading the team note info"),e.abrupt("return",!1);case 6:return g(n.code),e.abrupt("return",!0);case 8:case"end":return e.stop()}}),e)}))),[t]),J=(0,u.useCallback)((0,a.Z)(o().mark((function e(){var n;return o().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,s.CD)(t);case 2:if(n=e.sent){e.next=6;break}return C.ZP.error("Failed loading the team note state"),e.abrupt("return",!1);case 6:return l(y.createFromTeamPages(n)),e.abrupt("return",!0);case 8:case"end":return e.stop()}}),e)}))),[t]),Q=(0,u.useCallback)((function(){(0,s.f1)(t)}),[t]);(0,u.useEffect)((function(){var e=function(){var e=(0,a.Z)(o().mark((function e(){var t,n;return o().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,G();case 2:return t=e.sent,e.next=5,J();case 5:if(n=e.sent,t&&n){e.next=8;break}return e.abrupt("return",H("/"));case 8:V(!0),Q();case 10:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}();return e(),Q}),[G,J,H,Q]),(0,u.useEffect)((function(){return F.on("push",(function(e){var t=e.operation,n=e.userID;l((function(e){return null===e||void 0===e?void 0:e.pushOperation(t,n)}))})),F.on("join",(function(e){var t=e.joined,n=e.members,r=t.userID,a=t.userName;S(n),r!==(0,f.VN)()&&E(r,a)})),F.on("leave",(function(e){var t=e.leaved,n=e.members,r=t.userID,a=t.userName;if(S(n),r===(0,f.VN)())return F.emit("join");N(r,a)})),F.on("newPage",(function(e){var t=e.pageID,n=e.newPage;l((function(e){return null===e||void 0===e?void 0:e.addPage(t,n)}))})),F.on("reset",(function(e){var t=e.userID,n=e.pageRec;t!==(0,f.VN)()&&l((function(e){return null===e||void 0===e?void 0:e.resetUser(t,n)}))})),F.on("connect_error",console.error),F.on("connect",(function(){return q(!0)})),F.on("disconnect",(function(){return q(!1)})),function(){F.removeAllListeners(),F.close()}}),[F]);return(0,D.jsx)(k.g,{loading:!U,children:(0,D.jsx)(P.Provider,{value:{io:F,code:h,teamOn:!0,ignores:O,userRec:j,connected:_,teamState:c,resetIO:function(){return A(v(t))},loadInfo:G,loadState:J,setIgnores:T,addTeamStatePage:function(e,t){l((function(n){return null===n||void 0===n?void 0:n.addPage(e,t)}))}},children:(0,D.jsx)(b.default,{})})})}var E=function(e,t){C.ZP.destroy(e),C.ZP.success({content:"".concat(t," joined room"),icon:(0,D.jsx)(c.Z,{}),key:e})},N=function(e,t){C.ZP.destroy(e),C.ZP.warning({content:"".concat(t," leaved room"),icon:(0,D.jsx)(l.Z,{}),key:e})}},96153:function(e,t,n){"use strict";function r(e,t){var n=document.createElement("canvas"),r=n.getContext("2d");if(!r)throw new Error("can't get virtual canvas context");return n.width=e,n.height=t,{canvas:n,context:r}}function a(e){e.width=1,e.height=1;var t=e.getContext("2d");null===t||void 0===t||t.clearRect(0,0,1,1)}n.d(t,{j:function(){return a},v:function(){return r}})},90858:function(){},64158:function(){}}]);
//# sourceMappingURL=604.7b41d888.chunk.js.map