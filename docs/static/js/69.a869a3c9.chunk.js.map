{"version":3,"file":"static/js/69.a869a3c9.chunk.js","mappings":"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","sources":["component/IconFont.tsx","component/Draw/cursor/cursor.ts","component/Draw/touch.ts","component/Draw/Draw.tsx","pages/reader/tools/DrawTools.tsx","component/PageWrapper/PageWrapper.tsx","component/PageWrapper/index.tsx","lib/draw/DrawCtrl.tsx","lib/draw/canvas.ts","pages/reader/tools/PenPanel.tsx"],"sourcesContent":["import { createFromIconfontCN } from \"@ant-design/icons\";\r\n\r\nexport default createFromIconfontCN({\r\n  scriptUrl: \"//at.alicdn.com/t/font_3181679_yo844n7qgns.js\",\r\n});\r\n","import { createVirtualCanvas } from \"lib/draw/canvas\";\r\nimport { DrawCtrl } from \"lib/draw/DrawCtrl\";\r\nimport rotateImg from \"./rotate.png\";\r\n\r\nexport const getCircleCursor = (drawCtrl: DrawCtrl, ratio: number) => {\r\n  const { lineWidth, eraserWidth, mode } = drawCtrl;\r\n  const size = ratio * (mode === \"erase\" ? eraserWidth : lineWidth);\r\n  if (size < 5) return \"crosshair\";\r\n  const half = size / 2;\r\n  return `url('data:image/svg+xml;utf8,<svg xmlns=\"http://www.w3.org/2000/svg\" fill=\"%23FFF7\" width=\"${size}\" height=\"${size}\" viewBox=\"0 0 10 10\"><circle cx=\"5\" cy=\"5\" r=\"5\"/></svg>') ${half} ${half}, auto`;\r\n};\r\n\r\nconst getRotateCursorImage = (() => {\r\n  const cache = new Map<number, string>();\r\n  const { canvas, context } = createVirtualCanvas(44, 44);\r\n  const image = new Image();\r\n  image.src = rotateImg;\r\n  return (angle: number) => {\r\n    angle = Math.round(angle / 10) * 10;\r\n    const cached = cache.get(angle);\r\n    if (cached) return cached;\r\n    context.translate(22, 22);\r\n    context.rotate((angle * Math.PI) / 180);\r\n    context.drawImage(image, -22, -22);\r\n    const data = canvas.toDataURL();\r\n    context.clearRect(-22, -22, 44, 44);\r\n    context.resetTransform();\r\n    cache.set(angle, data);\r\n    return data;\r\n  };\r\n})();\r\n\r\nexport const getRotateCurcor = (angle: number) => {\r\n  return `url(${getRotateCursorImage(angle)}) 22 22, auto`;\r\n};\r\n","import { PointerEvent, TouchEvent, useEffect, useRef } from \"react\";\r\n\r\ntype iOSTouch = Touch & {\r\n  force?: number;\r\n  touchType?: \"stylus\" | \"direct\";\r\n};\r\n\r\nexport function isApplePencil(e: TouchEvent) {\r\n  const touch = e.touches[0] as iOSTouch;\r\n  return touch?.touchType === \"stylus\";\r\n}\r\n\r\nexport function usePreventTouch(\r\n  allowFinger: boolean\r\n): React.HTMLAttributes<HTMLDivElement> {\r\n  const isTouch = useRef(false);\r\n  const checkPoniter = (e: PointerEvent) =>\r\n    e.isPrimary && (isTouch.current = e.pointerType === \"touch\");\r\n\r\n  const isEventValid = (e: TouchEvent) =>\r\n    !isTouch.current ||\r\n    isApplePencil(e) ||\r\n    (allowFinger && e.touches.length === 1);\r\n\r\n  const preventTouch = (e: TouchEvent) =>\r\n    isEventValid(e) || e.stopPropagation();\r\n\r\n  return {\r\n    onPointerDownCapture: checkPoniter,\r\n    onPointerMoveCapture: checkPoniter,\r\n    onTouchStartCapture: preventTouch,\r\n    onTouchMoveCapture: preventTouch,\r\n  };\r\n}\r\n\r\nexport function usePreventGesture() {\r\n  useEffect(() => {\r\n    const handler = (e: Event) => e.preventDefault();\r\n    document.addEventListener(\"gesturestart\", handler);\r\n    document.addEventListener(\"gesturechange\", handler);\r\n    document.addEventListener(\"gestureend\", handler);\r\n    return () => {\r\n      document.removeEventListener(\"gesturestart\", handler);\r\n      document.removeEventListener(\"gesturechange\", handler);\r\n      document.removeEventListener(\"gestureend\", handler);\r\n    };\r\n  }, []);\r\n}\r\n","import React, {\r\n  useRef,\r\n  useMemo,\r\n  useState,\r\n  Dispatch,\r\n  useEffect,\r\n  useCallback,\r\n  useDebugValue,\r\n  SetStateAction,\r\n  useImperativeHandle,\r\n} from \"react\";\r\nimport paper from \"paper\";\r\nimport { usePinch } from \"@use-gesture/react\";\r\nimport useSize from \"@react-hook/size\";\r\nimport { DrawState, Mutation, Splitter, Stroke } from \"lib/draw/DrawState\";\r\nimport { defaultDrawCtrl, DrawCtrl } from \"lib/draw/DrawCtrl\";\r\nimport { releaseCanvas } from \"lib/draw/canvas\";\r\nimport { getCircleCursor, getRotateCurcor } from \"./cursor\";\r\nimport { usePreventTouch, usePreventGesture } from \"./touch\";\r\n\r\nconst { Path, Size, Point, Group, Color, Raster, Layer } = paper;\r\n\r\nexport type ActiveToolKey = \"\" | \"select\" | \"text\";\r\nexport interface DrawRefType {\r\n  deleteSelected: () => void;\r\n  duplicateSelected: () => void;\r\n  mutateStyle: (updated: Partial<DrawCtrl>) => void;\r\n  rasterize: () => string;\r\n  submitText: (text: string, color?: string, justification?: string) => void;\r\n  cancelText: () => void;\r\n  pointText?: paper.PointText;\r\n}\r\ninterface DrawPropType {\r\n  drawState: DrawState;\r\n  otherStates?: DrawState[];\r\n  onChange?: Dispatch<SetStateAction<DrawState>>;\r\n  setActiveTool?: Dispatch<SetStateAction<ActiveToolKey>>;\r\n  drawCtrl?: DrawCtrl;\r\n  readonly?: boolean;\r\n  imgSrc?: string;\r\n}\r\n\r\nconst HIT_TOLERANCE = 20;\r\n\r\nconst DrawRaw = React.forwardRef<DrawRefType, DrawPropType>(\r\n  (\r\n    {\r\n      drawState,\r\n      otherStates,\r\n      onChange = () => {},\r\n      drawCtrl = defaultDrawCtrl,\r\n      readonly = false,\r\n      imgSrc,\r\n      setActiveTool = () => {},\r\n    },\r\n    ref\r\n  ) => {\r\n    const { width, height } = drawState;\r\n    const { mode, finger, lasso, eraserWidth } = drawCtrl;\r\n\r\n    const canvasEl = useRef<HTMLCanvasElement>(null);\r\n    const scope = useRef(new paper.PaperScope());\r\n    const [group, setGroup] = useState<paper.Item[]>([]);\r\n    const [path, setPath] = usePaperItem<paper.Path>();\r\n    const [rect, setRect] = usePaperItem<paper.Path.Rectangle>();\r\n    const [rotateHandle, setRotateHandle] = usePaperItem<paper.Path>();\r\n\r\n    useEffect(() => {\r\n      const cvs = canvasEl.current;\r\n      const scp = scope.current;\r\n      if (!cvs) return;\r\n\r\n      scp.setup(cvs);\r\n      scp.settings.handleSize = 10;\r\n      scp.settings.hitTolerance = HIT_TOLERANCE;\r\n      [0, 1, 2].forEach(() => scp.project.addLayer(new Layer()));\r\n      scp.project.layers.forEach((l) => (l.visible = false));\r\n      scp.project.layers[2]?.activate();\r\n      new scp.Tool();\r\n\r\n      return () => {\r\n        scp.remove();\r\n        releaseCanvas(cvs);\r\n      };\r\n    }, []);\r\n\r\n    useEffect(() => {\r\n      const bgRect = paintBackground(scope.current, width, height);\r\n      return () => void bgRect.remove();\r\n    }, [width, height]);\r\n\r\n    const [canvasWidth] = useSize(canvasEl);\r\n    const ratio = canvasWidth / width;\r\n    useEffect(() => {\r\n      if (!ratio) return;\r\n      const scp = scope.current;\r\n      const zero = new Point(0, 0);\r\n      scp.view.viewSize = new Size(width, height).multiply(ratio);\r\n      scp.view.scale(ratio, zero);\r\n      scp.project.layers.forEach((l) => (l.visible = true));\r\n      scp.view.update();\r\n\r\n      return () => scp.view?.scale(1 / ratio, zero);\r\n    }, [width, height, ratio]);\r\n\r\n    useEffect(() => {\r\n      if (!imgSrc) return;\r\n      scope.current.activate();\r\n      const raster = new Raster(imgSrc);\r\n      raster.project.layers[0]?.addChild(raster);\r\n      raster.sendToBack();\r\n      raster.onLoad = () => {\r\n        raster.view.update();\r\n        raster.fitBounds(new paper.Rectangle(0, 0, width, height));\r\n        raster.bringToFront();\r\n      };\r\n\r\n      return () => void raster?.remove();\r\n    }, [imgSrc, width, height]);\r\n\r\n    const mergedStrokes = useMemo(\r\n      () =>\r\n        otherStates\r\n          ? DrawState.mergeStates(drawState, ...otherStates)\r\n          : drawState.getStrokeList(),\r\n      [drawState, otherStates]\r\n    );\r\n    useEffect(() => {\r\n      const tempGroup: paper.Item[] = [];\r\n      const layer = scope.current.project.layers[1];\r\n      if (!layer) return;\r\n\r\n      scope.current.activate();\r\n      mergedStrokes.forEach((stroke) => {\r\n        const self = drawState.hasStroke(stroke.uid);\r\n        const item = paintStroke(stroke, layer, !self);\r\n        if (self) tempGroup.push(item);\r\n      });\r\n      setGroup(tempGroup);\r\n\r\n      return () => void layer.removeChildren();\r\n    }, [mergedStrokes, drawState]);\r\n\r\n    const hitRef = useRef<paper.HitResult>();\r\n    const [selected, setSelected] = useState(false);\r\n    const paperMode = mode === \"select\" && selected ? \"selected\" : mode;\r\n    const [chosenIDs, setChosenIDs] = useState<string[]>([]);\r\n    const chosenItems = useMemo(() => {\r\n      const IDSet = new Set(chosenIDs);\r\n      return group.filter((item) => IDSet.has(item.name));\r\n    }, [group, chosenIDs]);\r\n\r\n    const resetSelect = useCallback(() => {\r\n      setSelected(false);\r\n      setPath(undefined);\r\n      setRect(undefined);\r\n      setRotateHandle(undefined);\r\n    }, [setPath, setRect, setRotateHandle]);\r\n\r\n    useEffect(() => {\r\n      if (mode === \"select\") return resetSelect;\r\n    }, [mode, resetSelect]);\r\n    useEffect(() => resetSelect, [lasso, resetSelect]);\r\n\r\n    useEffect(() => {\r\n      if (!selected) return;\r\n      return () => {\r\n        setChosenIDs([]);\r\n        setActiveTool(\"\");\r\n      };\r\n    }, [selected, setActiveTool]);\r\n\r\n    const downPath = () => setPath(startStroke(drawCtrl));\r\n    const downRect = (e: paper.MouseEvent) => setRect(startRect(e.point));\r\n\r\n    const handleDown = {\r\n      draw: downPath,\r\n      erase: downPath,\r\n      select: lasso ? downPath : downRect,\r\n      selected(e: paper.MouseEvent) {\r\n        if (lasso) {\r\n          // if the point is outside of selection, reset selection\r\n          if (path?.contains(e.point)) return;\r\n          downPath();\r\n          setSelected(false);\r\n        } else {\r\n          // check if the point hit the segment point.\r\n          let hitRes =\r\n            rect?.hitTest(e.point, { segments: true }) ??\r\n            rotateHandle?.hitTest(e.point, { segments: true, selected: true });\r\n          hitRef.current = hitRes;\r\n          if (hitRes) return;\r\n\r\n          // if the point is outside of selection, reset selection\r\n          if (rect?.contains(e.point)) return;\r\n          downRect(e);\r\n          setRotateHandle(undefined);\r\n          setSelected(false);\r\n        }\r\n      },\r\n      text(e: paper.MouseEvent) {\r\n        const layer = scope.current.project.layers[1];\r\n        if (!layer) return;\r\n        const t = getClickedText(layer, e.point) ?? startText(e.point);\r\n        setPointText(t);\r\n      },\r\n    }[paperMode];\r\n\r\n    const dragPath = (e: paper.MouseEvent) => {\r\n      path?.add(e.point);\r\n      path?.smooth();\r\n    };\r\n    const resizeRect = (e: paper.MouseEvent) => {\r\n      if (!rect) return;\r\n      const { x, y } = e.point;\r\n      const [, s1, s2, s3] = rect.segments;\r\n      if (!s1 || !s2 || !s3) return;\r\n      s1.point.x = x;\r\n      s2.point = e.point;\r\n      s3.point.y = y;\r\n      rect.selected = true;\r\n    };\r\n\r\n    const handleDrag = {\r\n      draw: dragPath,\r\n      erase: dragPath,\r\n      select: lasso ? dragPath : resizeRect,\r\n      selected(e: paper.MouseEvent) {\r\n        const hitRes = hitRef.current;\r\n        if (hitRes?.segment && rect && rotateHandle) {\r\n          const segment = hitRes.segment;\r\n          const rotating = segment.selected;\r\n          if (rotating) {\r\n            // rotate select items\r\n            const { center } = rect.bounds;\r\n            const axis = segment.point.subtract(center);\r\n            const line = e.point.subtract(center);\r\n            setCursor(getRotateCurcor(line.angle));\r\n            const angle = line.angle - axis.angle;\r\n            rect.rotate(angle, center);\r\n            rotateHandle.rotate(angle, center);\r\n            chosenItems.forEach((item) => item?.rotate(angle, center));\r\n          } else {\r\n            // resize selected items\r\n            const moveP = segment.point;\r\n            const baseP = segment.next.next.point;\r\n            const diagonal = moveP.subtract(baseP);\r\n            const projection = e.point.subtract(baseP).project(diagonal);\r\n            const scale = projection.x / diagonal.x;\r\n            if (scale < 0) return;\r\n\r\n            rect.scale(scale, baseP);\r\n            chosenItems.forEach((item) => {\r\n              item.scale(scale, baseP);\r\n              item.strokeWidth *= scale;\r\n            });\r\n            rotateHandle.scale(scale, baseP);\r\n            const rBaseP = rotateHandle.segments[0]?.point;\r\n            if (!rBaseP) return;\r\n            rotateHandle.scale(100 / rotateHandle.length, rBaseP);\r\n          }\r\n        } else {\r\n          // move selected items\r\n          chosenItems.forEach((item) => item.translate(e.delta));\r\n          path?.translate(e.delta);\r\n          rect?.translate(e.delta);\r\n          rotateHandle?.translate(e.delta);\r\n        }\r\n      },\r\n      text(e: paper.MouseEvent) {\r\n        if (!pointText || pointText.name) return;\r\n        const { topCenter, bottomRight } = pointText.bounds;\r\n        const diagonal = bottomRight.subtract(topCenter);\r\n        const projection = e.point.subtract(topCenter).project(diagonal);\r\n        const scale = projection.x / diagonal.x;\r\n        if (scale < 0) return;\r\n        pointText.scale(scale, topCenter);\r\n      },\r\n    }[paperMode];\r\n\r\n    useEffect(() => {\r\n      scope.current.tool.maxDistance = eraserWidth;\r\n    }, [eraserWidth]);\r\n    const erased = useRef(new Set<string>());\r\n    const replaced = useRef(new Map<string, paper.Item>());\r\n\r\n    const handelToolDrag = (e: paper.ToolEvent) => {\r\n      if (paperMode !== \"erase\") return;\r\n      const layer = scope.current.project.layers[1];\r\n      const hitRes = layer?.hitTestAll(e.point, {\r\n        class: paper.Path,\r\n        stroke: true,\r\n        tolerance: eraserWidth / 2,\r\n      });\r\n\r\n      hitRes?.forEach(({ item }) => {\r\n        if (!(item instanceof paper.Path)) return;\r\n        let topItem: paper.PathItem = item;\r\n        while (topItem.parent !== layer) {\r\n          if (!(topItem.parent instanceof paper.PathItem)) break;\r\n          topItem = topItem.parent;\r\n        }\r\n        const { name } = topItem;\r\n\r\n        if (drawCtrl.pixelEraser) {\r\n          const radius = (eraserWidth + item.strokeWidth) / 2;\r\n          const circle = new Path.Circle(e.point, radius);\r\n          circle.remove();\r\n\r\n          const sub = item.subtract(circle, { trace: false });\r\n          item.replaceWith(sub);\r\n          if (topItem === item) topItem = sub;\r\n          replaced.current.set(name, topItem);\r\n        } else {\r\n          topItem.opacity = 0.5;\r\n          topItem.guide = true;\r\n          erased.current.add(name);\r\n        }\r\n      });\r\n    };\r\n\r\n    const handleUp = {\r\n      draw() {\r\n        if (!path || path.isEmpty()) return;\r\n        path.simplify();\r\n        const pathData = path.exportJSON();\r\n        setPath(undefined);\r\n        onChange((prev) => DrawState.addStroke(prev, pathData));\r\n      },\r\n      erase() {\r\n        setPath(undefined);\r\n        if (drawCtrl.pixelEraser) {\r\n          const items = Array.from(replaced.current);\r\n          replaced.current.clear();\r\n          const splitters: Splitter[] = items.map(([uid, item]) => {\r\n            const paths = flattenCP(item);\r\n            return [uid, paths.map((i) => i.exportJSON())];\r\n          });\r\n          if (!splitters.length) return;\r\n          onChange((prev) => DrawState.splitStrokes(prev, splitters));\r\n        } else {\r\n          const erasedList = Array.from(erased.current);\r\n          erased.current.clear();\r\n          if (!erasedList.length) return;\r\n          onChange((prev) => DrawState.eraseStrokes(prev, erasedList));\r\n        }\r\n      },\r\n      select() {\r\n        let selection: string[];\r\n        if (lasso) {\r\n          if (!path || Math.abs(path.area) < 1_000) return setPath(undefined);\r\n          path.closePath();\r\n          path.simplify();\r\n          moveDash(path);\r\n          selection = checkLasso(group, path);\r\n        } else {\r\n          if (!rect || Math.abs(rect.area) < 1_000) return setRect(undefined);\r\n          selection = checkLasso(group, rect);\r\n          const link = new Path();\r\n          const { topCenter } = rect.bounds;\r\n          link.add(topCenter, topCenter.subtract(new Point(0, 100)));\r\n          link.lastSegment.selected = true;\r\n          setRotateHandle(link);\r\n        }\r\n        setSelected(true);\r\n        setChosenIDs(selection);\r\n        setActiveTool(\"select\");\r\n      },\r\n      selected(e: paper.MouseEvent) {\r\n        updateMutation();\r\n        handleSelectedCursor(e);\r\n      },\r\n      text() {\r\n        setActiveTool(\"text\");\r\n      },\r\n    }[paperMode];\r\n\r\n    const [cursor, setCursor] = useState(\"auto\");\r\n    useEffect(() => {\r\n      if (paperMode === \"text\" || paperMode === \"select\") {\r\n        setCursor(\"crosshair\");\r\n      } else if (paperMode === \"selected\") {\r\n        setCursor(lasso ? \"crosshair\" : \"nwse-resize\");\r\n      } else if (paperMode === \"draw\" || paperMode === \"erase\") {\r\n        setCursor(getCircleCursor(drawCtrl, ratio));\r\n      }\r\n    }, [paperMode, lasso, drawCtrl, ratio]);\r\n\r\n    const handleSelectedCursor = (e: paper.MouseEvent) => {\r\n      const hitRes =\r\n        rect?.hitTest(e.point, { segments: true }) ??\r\n        rotateHandle?.hitTest(e.point, { segments: true, selected: true });\r\n      if (hitRes?.segment) {\r\n        if (hitRes.segment.selected) {\r\n          const center = rect?.bounds.center;\r\n          if (!center) return;\r\n          const line = hitRes.segment.point.subtract(center);\r\n          return setCursor(getRotateCurcor(line.angle));\r\n        }\r\n        const moveP = hitRes.segment.point;\r\n        const baseP = hitRes.segment.next.next.point;\r\n        const diagonal = moveP.subtract(baseP);\r\n        const { x, y } = diagonal;\r\n        return setCursor(x * y < 0 ? \"nesw-resize\" : \"nwse-resize\");\r\n      }\r\n      if ((rect ?? path)?.contains(e.point)) return setCursor(\"move\");\r\n      setCursor(\"crosshair\");\r\n    };\r\n\r\n    const handleMove = {\r\n      selected: handleSelectedCursor,\r\n      text(e: paper.MouseEvent) {\r\n        const layer = scope.current.project.layers[1];\r\n        if (!layer) return;\r\n        if (getClickedText(layer, e.point)) setCursor(\"text\");\r\n        else setCursor(\"crosshair\");\r\n      },\r\n      ...{ select: null, draw: null, erase: null },\r\n    }[paperMode];\r\n\r\n    const handleViewEvent = () => {\r\n      if (readonly) return;\r\n\r\n      type Handler<E> = ((e: E) => boolean | void) | null;\r\n      const activate = <E,>(handler: Handler<E>): Handler<E> => {\r\n        return (e) => {\r\n          scope.current.activate();\r\n          if (handler) return handler(e);\r\n        };\r\n      };\r\n      const { view, tool } = scope.current;\r\n      view.onMouseDown = activate(handleDown);\r\n      view.onMouseDrag = activate(handleDrag);\r\n      view.onMouseUp = activate(handleUp);\r\n      view.onMouseMove = activate(handleMove);\r\n      tool.onMouseDrag = activate(handelToolDrag);\r\n    };\r\n    useEffect(handleViewEvent);\r\n\r\n    const updateMutation = () => {\r\n      if (!chosenItems?.length) return;\r\n      const mutations: Mutation[] = chosenItems.map((p) => [\r\n        p.name,\r\n        p.exportJSON(),\r\n      ]);\r\n      onChange((prev) => DrawState.mutateStrokes(prev, mutations));\r\n    };\r\n\r\n    const deleteSelected = () => {\r\n      resetSelect();\r\n      if (!chosenIDs.length) return;\r\n      onChange((prev) => DrawState.eraseStrokes(prev, chosenIDs));\r\n    };\r\n\r\n    const mutateStyle = (updated: Partial<DrawCtrl>) => {\r\n      scope.current.activate();\r\n      updateGroupStyle(chosenItems, updated);\r\n      updateMutation();\r\n    };\r\n\r\n    const duplicateSelected = () => {\r\n      scope.current.activate();\r\n      const size = (rect || path)?.bounds.size;\r\n      if (!size || !chosenItems.length) return;\r\n      const { width, height } = size;\r\n      const transP = new Point(width, height).divide(10);\r\n      const copies = chosenItems.map((item) => item.clone());\r\n      copies.forEach((item) => item.translate(transP));\r\n      rect?.translate(transP);\r\n      path?.translate(transP);\r\n      rotateHandle?.translate(transP);\r\n\r\n      const mutations: Mutation[] = copies.map((item) => [\r\n        DrawState.getUid(),\r\n        item.exportJSON(),\r\n      ]);\r\n      onChange((prev) => DrawState.mutateStrokes(prev, mutations));\r\n      setChosenIDs(mutations.map(([uid]) => uid));\r\n    };\r\n\r\n    const rasterize = () => {\r\n      const g = new Group(chosenItems);\r\n      const layer = scope.current.project.layers[1];\r\n      if (!layer) return \"\";\r\n      g.addTo(layer);\r\n      return g.rasterize({ insert: false }).toDataURL();\r\n    };\r\n\r\n    const [pointText, setPointText] = usePaperItem<paper.PointText>();\r\n    const cancelText = useCallback(() => {\r\n      setPointText(undefined);\r\n      setActiveTool(\"\");\r\n    }, [setPointText, setActiveTool]);\r\n\r\n    useEffect(() => {\r\n      if (mode === \"text\") return cancelText;\r\n    }, [mode, cancelText]);\r\n\r\n    const submitText = (\r\n      text: string,\r\n      color = \"#000\",\r\n      justification = \"center\"\r\n    ) => {\r\n      if (!pointText) return;\r\n      pointText.content = text;\r\n      pointText.fillColor = new Color(color);\r\n      pointText.justification = justification;\r\n      const pathData = pointText.exportJSON();\r\n      const { name } = pointText;\r\n      cancelText();\r\n      if (!name) return onChange((prev) => DrawState.addStroke(prev, pathData));\r\n      onChange((prev) => DrawState.mutateStrokes(prev, [[name, pathData]]));\r\n    };\r\n\r\n    useImperativeHandle(ref, () => ({\r\n      deleteSelected,\r\n      duplicateSelected,\r\n      cancelText,\r\n      submitText,\r\n      mutateStyle,\r\n      rasterize,\r\n      pointText,\r\n    }));\r\n\r\n    usePreventGesture();\r\n    usePinch(\r\n      ({ memo, offset: [scale], first, last, origin }) => {\r\n        scope.current.activate();\r\n        const { view } = scope.current;\r\n        const originRawP = new Point(origin);\r\n\r\n        let lastScale: number;\r\n        let lastOrigin, elPos: paper.Point;\r\n        if (first || !memo) {\r\n          const { x, y } = canvasEl.current!.getBoundingClientRect();\r\n          lastScale = 1;\r\n          elPos = new Point(x, y);\r\n          lastOrigin = originRawP.subtract(elPos);\r\n        } else {\r\n          [lastScale, lastOrigin, elPos] = memo;\r\n        }\r\n\r\n        const originViewP = originRawP.subtract(elPos);\r\n        const originPorjP = view.viewToProject(originViewP);\r\n\r\n        if (Math.abs(1 - scale) < 0.05) scale = 1;\r\n        let dScale = first ? 1 : scale / lastScale;\r\n        let aniCount = last ? 10 : 1;\r\n        dScale = Math.pow(dScale, 1 / aniCount);\r\n        const scaleView = () => {\r\n          view.scale(dScale, originPorjP);\r\n          scope.current.settings.hitTolerance /= dScale;\r\n          if (--aniCount > 0) requestAnimationFrame(scaleView);\r\n          else if (last) putCenterBack(view, new Size(width, height));\r\n        };\r\n        scaleView();\r\n\r\n        const deltaP = originViewP.subtract(lastOrigin);\r\n        const transP = deltaP.divide(view.zoom);\r\n        view.translate(transP);\r\n\r\n        if (!last) return [scale, originViewP, elPos];\r\n      },\r\n      {\r\n        scaleBounds: { max: 10, min: 0.3 },\r\n        rubberband: 0.5,\r\n        target: canvasEl,\r\n      }\r\n    );\r\n\r\n    const touchHandler = usePreventTouch(finger);\r\n    return (\r\n      <div\r\n        className=\"draw-wrapper\"\r\n        style={{ cursor }}\r\n        data-readonly={readonly}\r\n        {...touchHandler}\r\n      >\r\n        <canvas ref={canvasEl} className=\"draw-canvas\" />\r\n      </div>\r\n    );\r\n  }\r\n);\r\n\r\nDrawRaw.displayName = \"Draw\";\r\nexport const Draw = React.memo(DrawRaw);\r\n\r\nfunction usePaperItem<T extends paper.Item>() {\r\n  const tuple = useState<T | undefined>();\r\n  const [item] = tuple;\r\n  useDebugValue(item);\r\n  useEffect(\r\n    () => () => {\r\n      if (!item?.name) item?.remove();\r\n    },\r\n    [item]\r\n  );\r\n  return tuple;\r\n}\r\n\r\nconst paintStroke = (stroke: Stroke, layer: paper.Layer, readonly = false) => {\r\n  let { pathData, uid } = stroke;\r\n  try {\r\n    const item = layer.importJSON(pathData);\r\n    if (!item) return new paper.Item();\r\n    item.name = uid;\r\n    item.guide = readonly;\r\n    return item;\r\n  } catch (e) {\r\n    console.error(e);\r\n    return new paper.Item();\r\n  }\r\n};\r\n\r\nconst paintBackground = (\r\n  scope: paper.PaperScope,\r\n  width: number,\r\n  height: number\r\n) => {\r\n  scope.activate();\r\n  const bgRect = new Path.Rectangle(new Point(0, 0), new Point(width, height));\r\n  bgRect.fillColor = new Color(\"#fff\");\r\n  scope.project.layers[0]?.addChild(bgRect);\r\n  return bgRect;\r\n};\r\n\r\nconst startRect = (point: paper.Point) => {\r\n  const rect = new Path.Rectangle(point, new Size(0, 0));\r\n  rect.onFrame = () => {}; // the handle size bug\r\n  return rect;\r\n};\r\n\r\nconst startStroke = (drawCtrl: DrawCtrl) => {\r\n  let { mode, lineWidth, eraserWidth, color, highlight } = drawCtrl;\r\n  const path = new Path();\r\n  if (mode === \"erase\") {\r\n    color = \"#ccc\";\r\n    lineWidth = eraserWidth;\r\n  }\r\n  if (mode === \"select\") {\r\n    color = \"#1890ff\";\r\n    lineWidth = 5;\r\n  }\r\n  const strokeColor = new Color(color);\r\n  if (highlight || mode === \"erase\") {\r\n    strokeColor.alpha = 0.5;\r\n    path.blendMode = \"multiply\";\r\n  }\r\n  path.strokeColor = strokeColor;\r\n  path.strokeWidth = lineWidth;\r\n  path.strokeJoin = \"round\";\r\n  path.strokeCap = \"round\";\r\n  path.guide = true;\r\n  return path;\r\n};\r\n\r\nconst moveDash = (item: paper.Item) => {\r\n  item.dashOffset = 0;\r\n  item.dashArray = [30, 20];\r\n  item.onFrame = () => (item.dashOffset += 3);\r\n};\r\n\r\nconst getCenterTranslate = (\r\n  view: paper.View,\r\n  projSize: paper.Size\r\n): [number, number] => {\r\n  const { x, y } = view.center;\r\n  const { width: viewW, height: viewH } = view.size;\r\n  const { width: projW, height: projH } = projSize;\r\n\r\n  const [minX, minY] = [Math.min(viewW, projW) / 2, Math.min(viewH, projH) / 2];\r\n  const [maxX, maxY] = [projW - minX, projH - minY];\r\n\r\n  const deltaX = x < minX ? minX - x : x > maxX ? maxX - x : 0;\r\n  const deltaY = y < minY ? minY - y : y > maxY ? maxY - y : 0;\r\n\r\n  return [deltaX, deltaY];\r\n};\r\n\r\nconst putCenterBack = (view: paper.View, projSize: paper.Size) => {\r\n  const [deltaX, deltaY] = getCenterTranslate(view, projSize);\r\n  let aniCount = 10;\r\n  const dP = new Point(deltaX, deltaY).divide(-aniCount);\r\n  const move = () => {\r\n    view.translate(dP);\r\n    if (--aniCount > 0) requestAnimationFrame(move);\r\n  };\r\n  move();\r\n};\r\n\r\nconst checkLasso = (items: paper.Item[], selection: paper.Path) => {\r\n  const isInside = (p: paper.Path) => {\r\n    const res = p.subtract(selection, { insert: false, trace: false });\r\n    res.remove();\r\n    return !res.compare(p);\r\n  };\r\n  return items\r\n    .filter((item) => {\r\n      if (!item.name) return false;\r\n      if (!item.bounds.intersects(selection.bounds)) return false;\r\n      if (item instanceof paper.Path) {\r\n        return isInside(item);\r\n      } else {\r\n        const checkedP = new Path.Rectangle(item.bounds);\r\n        checkedP.remove();\r\n        return isInside(checkedP) || selection.isInside(item.bounds);\r\n      }\r\n    })\r\n    .map(({ name }) => name);\r\n};\r\n\r\nconst updateGroupStyle = (items: paper.Item[], updated: Partial<DrawCtrl>) => {\r\n  const { lineWidth, color, highlight } = updated;\r\n  items.forEach((item) => {\r\n    if (item instanceof paper.PointText && color) {\r\n      const newColor = new Color(color);\r\n      item.fillColor = newColor;\r\n    }\r\n\r\n    if (!(item instanceof paper.Path)) return;\r\n\r\n    if (color) {\r\n      const newColor = new Color(color);\r\n      if (item.blendMode === \"multiply\") newColor.alpha = 0.5;\r\n      item.strokeColor = newColor;\r\n    }\r\n\r\n    if (lineWidth) item.strokeWidth = lineWidth;\r\n\r\n    if (!item.strokeColor || highlight === undefined) return;\r\n    item.strokeColor.alpha = highlight ? 0.5 : 1;\r\n    item.blendMode = highlight ? \"multiply\" : \"normal\";\r\n  });\r\n};\r\n\r\nconst getClickedText = (layer: paper.Layer, point: paper.Point) => {\r\n  const hitRes = layer.hitTest(point, {\r\n    class: paper.PointText,\r\n    fill: true,\r\n  });\r\n  if (hitRes?.item instanceof paper.PointText) return hitRes?.item;\r\n};\r\n\r\nconst startText = (point: paper.Point) => {\r\n  return new paper.PointText({\r\n    point: point.add(new Point(0, 50)),\r\n    content: \"Insert text...\",\r\n    fontSize: 50,\r\n    justification: \"center\",\r\n    fillColor: \"#1890ff55\",\r\n  });\r\n};\r\n\r\nconst flattenCP = (cp: paper.Item): paper.Path[] => {\r\n  if (cp instanceof paper.Path) {\r\n    return cp.isEmpty() ? [] : [cp];\r\n  }\r\n  if (cp instanceof paper.CompoundPath) {\r\n    return cp.children.map(flattenCP).flat();\r\n  }\r\n  return [];\r\n};\r\n","import { FC, RefObject, useEffect, useState } from \"react\";\r\nimport {\r\n  CopyOutlined,\r\n  DeleteOutlined,\r\n  PictureOutlined,\r\n  BgColorsOutlined,\r\n  AlignLeftOutlined,\r\n  FontColorsOutlined,\r\n  AlignRightOutlined,\r\n  AlignCenterOutlined,\r\n} from \"@ant-design/icons\";\r\nimport { Button, ButtonProps, Modal, Popover, Radio } from \"antd\";\r\nimport { CSSTransition } from \"react-transition-group\";\r\nimport { DrawCtrl } from \"lib/draw/DrawCtrl\";\r\nimport { ColorSelect, PenPanel } from \"./PenPanel\";\r\nimport { useForceLight } from \"lib/Dark\";\r\nimport TextArea from \"antd/lib/input/TextArea\";\r\nimport { allColors } from \"lib/color\";\r\nimport { DrawRefType } from \"component/Draw\";\r\nimport { createPortal } from \"react-dom\";\r\nimport { saveAs } from \"file-saver\";\r\nimport \"./drawTools.sass\";\r\n\r\nexport const SelectTool: FC<{\r\n  drawRef: RefObject<DrawRefType>;\r\n  visible: boolean;\r\n}> = ({ drawRef, visible }) => (\r\n  <CSSTransition timeout={300} in={visible} unmountOnExit>\r\n    <SelectToolContent drawRef={drawRef} />\r\n  </CSSTransition>\r\n);\r\n\r\nexport const SelectToolContent: FC<{\r\n  drawRef: RefObject<DrawRefType>;\r\n}> = ({ drawRef }) => {\r\n  const btnProps: ButtonProps = {\r\n    type: \"text\",\r\n    shape: \"round\",\r\n    size: \"small\",\r\n  };\r\n\r\n  const [currDrawCtrl, setCurrDrawCtrl] = useState<Partial<DrawCtrl>>({});\r\n\r\n  const getRaster = () => {\r\n    if (!drawRef.current) return;\r\n    const imageData = drawRef.current.rasterize();\r\n    Modal.confirm({\r\n      title: \"Screenshot\",\r\n      content: <img className=\"raster\" src={imageData} alt=\"raster\" />,\r\n      className: \"raster-modal\",\r\n      icon: <PictureOutlined />,\r\n      okText: \"Save\",\r\n      onOk: () => saveAs(imageData, \"screenshot\"),\r\n    });\r\n  };\r\n\r\n  return createPortal(\r\n    <div className=\"select-tool\">\r\n      <Popover\r\n        trigger=\"click\"\r\n        placement=\"bottom\"\r\n        getPopupContainer={(e) => e.parentElement!}\r\n        destroyTooltipOnHide\r\n        content={\r\n          <PenPanel\r\n            updateDrawCtrl={(updated) => {\r\n              setCurrDrawCtrl((prev) => ({ ...prev, ...updated }));\r\n              drawRef.current?.mutateStyle(updated);\r\n            }}\r\n            drawCtrl={currDrawCtrl}\r\n          />\r\n        }\r\n      >\r\n        <Button icon={<BgColorsOutlined />} {...btnProps} />\r\n      </Popover>\r\n      <Button\r\n        icon={<CopyOutlined />}\r\n        onClick={() => drawRef.current?.duplicateSelected()}\r\n        {...btnProps}\r\n      />\r\n      <Button icon={<PictureOutlined />} onClick={getRaster} {...btnProps} />\r\n      <Button\r\n        danger\r\n        icon={<DeleteOutlined />}\r\n        onClick={() => drawRef.current?.deleteSelected()}\r\n        {...btnProps}\r\n      />\r\n    </div>,\r\n    document.querySelector(\".reader.container > header\")!\r\n  );\r\n};\r\n\r\nexport const TextTool: FC<{\r\n  drawRef: RefObject<DrawRefType>;\r\n  visible: boolean;\r\n}> = ({ visible, drawRef }) => {\r\n  const [text, setText] = useState(\"\");\r\n  const [color, setColor] = useState(allColors[0]!);\r\n  const [align, setAlign] = useState(\"center\");\r\n  const [forceLight] = useForceLight();\r\n\r\n  useEffect(() => {\r\n    const pointText = drawRef.current?.pointText;\r\n    if (!pointText || !visible) return;\r\n    const { name, content, justification, fillColor } = pointText;\r\n    setAlign(justification);\r\n    if (name) {\r\n      setText(content);\r\n      setColor(fillColor?.toCSS(true) ?? allColors[0]!);\r\n    } else {\r\n      setText(\"\");\r\n      setColor(allColors[0]!);\r\n    }\r\n  }, [visible, drawRef]);\r\n\r\n  const fontColorBtn = (\r\n    <Popover\r\n      content={<ColorSelect color={color} setColor={setColor} />}\r\n      overlayStyle={{ width: 200 }}\r\n      placement=\"bottom\"\r\n      getPopupContainer={(e) => e.parentElement!}\r\n    >\r\n      <Button\r\n        size=\"small\"\r\n        icon={<FontColorsOutlined className=\"font-icon\" style={{ color }} />}\r\n      />\r\n    </Popover>\r\n  );\r\n\r\n  const alignRadio = (\r\n    <Radio.Group\r\n      size=\"small\"\r\n      optionType=\"button\"\r\n      value={align}\r\n      buttonStyle=\"solid\"\r\n      onChange={(e) => setAlign(e.target.value)}\r\n      options={[\r\n        { label: <AlignLeftOutlined />, value: \"left\" },\r\n        { label: <AlignCenterOutlined />, value: \"center\" },\r\n        { label: <AlignRightOutlined />, value: \"right\" },\r\n      ]}\r\n    />\r\n  );\r\n\r\n  return (\r\n    <Modal\r\n      visible={visible}\r\n      title=\"Insert text\"\r\n      onCancel={() => drawRef.current?.cancelText()}\r\n      onOk={() => {\r\n        const content = text.trim();\r\n        if (!content) return drawRef.current?.cancelText();\r\n        drawRef.current?.submitText(content, color, align);\r\n      }}\r\n      bodyStyle={{ paddingTop: 0 }}\r\n      destroyOnClose\r\n    >\r\n      <div className=\"insert-option\" data-force-light={forceLight}>\r\n        {fontColorBtn}\r\n        {alignRadio}\r\n      </div>\r\n      <TextArea\r\n        size=\"large\"\r\n        rows={3}\r\n        autoFocus\r\n        value={text}\r\n        onChange={(e) => setText(e.target.value)}\r\n      />\r\n    </Modal>\r\n  );\r\n};\r\n","import React, {\r\n  FC,\r\n  useRef,\r\n  useMemo,\r\n  useState,\r\n  useEffect,\r\n  useCallback,\r\n} from \"react\";\r\nimport { useDrawCtrl } from \"lib/draw/DrawCtrl\";\r\nimport { useForceLight } from \"lib/Dark\";\r\nimport { useMemoizedFn as useEvent } from \"ahooks\";\r\nimport { Draw, ActiveToolKey, DrawRefType } from \"component/Draw\";\r\nimport { SelectTool, TextTool } from \"pages/reader/tools/DrawTools\";\r\nimport { once, range } from \"lodash-es\";\r\nimport { useInView } from \"react-intersection-observer\";\r\nimport { DrawState } from \"lib/draw/DrawState\";\r\nimport { Map, Set } from \"immutable\";\r\n\r\nconst PageWrapperRaw: FC<{\r\n  drawState: DrawState;\r\n  teamStateMap?: Map<string, DrawState>;\r\n  thumbnail?: string;\r\n  pdfIndex?: number;\r\n  noteID?: string;\r\n  updateState?: (ds: DrawState) => void;\r\n  onViewChange?: (ratio: number) => void;\r\n  preview?: boolean;\r\n  preload?: boolean;\r\n  ignores?: Set<string>;\r\n  skipInView?: boolean;\r\n}> = ({\r\n  thumbnail,\r\n  drawState,\r\n  teamStateMap,\r\n  updateState,\r\n  pdfIndex,\r\n  noteID = \"\",\r\n  preview = false,\r\n  onViewChange,\r\n  preload = false,\r\n  ignores = Set<string>(),\r\n  skipInView = false,\r\n}) => {\r\n  const threshold = onViewChange && range(0, 1.2, 0.2);\r\n  const [ref, visible, entry] = useInView({ threshold, skip: skipInView });\r\n  useEffect(() => {\r\n    if (!onViewChange) return;\r\n    if (!entry || !visible) return onViewChange(0);\r\n    onViewChange(entry.intersectionRatio);\r\n  }, [visible, entry, onViewChange]);\r\n\r\n  const [fullImg, setFullImg] = useState<string>();\r\n  // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  const loadImage = useCallback(\r\n    once(async () => {\r\n      if (!pdfIndex || !noteID) return;\r\n      const { getNotePageImage } = await import(\"lib/note/pdfImage\");\r\n      setFullImg(await getNotePageImage(noteID, pdfIndex));\r\n    }),\r\n    [pdfIndex, noteID]\r\n  );\r\n\r\n  const show = visible || preload;\r\n  useEffect(() => {\r\n    if (!preview && show) loadImage();\r\n  }, [show, preview, loadImage]);\r\n\r\n  const otherStates = useMemo(\r\n    () => teamStateMap?.deleteAll(ignores).toList().toArray(),\r\n    [teamStateMap, ignores]\r\n  );\r\n\r\n  const imageLoaded = Boolean(fullImg || !pdfIndex);\r\n  const drawShow = show && imageLoaded;\r\n\r\n  const { height, width } = drawState;\r\n  const ratio = height / width;\r\n  const [forceLight] = useForceLight();\r\n\r\n  return (\r\n    <div ref={ref} className=\"page-wrapper\" data-force-light={forceLight}>\r\n      <svg viewBox={`0 0 100 ${ratio * 100}`} />\r\n      {drawShow && (\r\n        <DrawWrapper\r\n          drawState={drawState}\r\n          otherStates={otherStates}\r\n          updateState={updateState}\r\n          imgSrc={fullImg || thumbnail}\r\n          preview={preview}\r\n        />\r\n      )}\r\n    </div>\r\n  );\r\n};\r\nPageWrapperRaw.displayName = \"PageWrapper\";\r\nexport const PageWrapper = React.memo(PageWrapperRaw);\r\n\r\nconst DrawWrapper: FC<{\r\n  drawState: DrawState;\r\n  otherStates?: DrawState[];\r\n  updateState?: (ds: DrawState) => void;\r\n  preview?: boolean;\r\n  imgSrc?: string;\r\n}> = ({ drawState, updateState, otherStates, preview = false, imgSrc }) => {\r\n  const drawCtrl = useDrawCtrl();\r\n  const [activeTool, setActiveTool] = useState<ActiveToolKey>(\"\");\r\n  const drawRef = useRef<DrawRefType>(null);\r\n\r\n  const handleChange = useEvent(\r\n    (arg: ((s: DrawState) => DrawState) | DrawState) => {\r\n      if (!updateState) return;\r\n      const newDS = arg instanceof DrawState ? arg : arg(drawState);\r\n      if (newDS === drawState) return;\r\n      updateState(newDS);\r\n    }\r\n  );\r\n\r\n  return preview ? (\r\n    <Draw\r\n      drawState={drawState}\r\n      otherStates={otherStates}\r\n      imgSrc={imgSrc}\r\n      readonly\r\n    />\r\n  ) : (\r\n    <>\r\n      <Draw\r\n        drawState={drawState}\r\n        otherStates={otherStates}\r\n        onChange={handleChange}\r\n        imgSrc={imgSrc}\r\n        drawCtrl={drawCtrl}\r\n        ref={drawRef}\r\n        setActiveTool={setActiveTool}\r\n      />\r\n      <SelectTool drawRef={drawRef} visible={activeTool === \"select\"} />\r\n      <TextTool drawRef={drawRef} visible={activeTool === \"text\"} />\r\n    </>\r\n  );\r\n};\r\nDrawWrapper.displayName = \"DrawWrapper\";\r\n","import { PageWrapper } from \"./PageWrapper\";\r\nimport \"./page-wrapper.sass\";\r\nexport default PageWrapper;\r\n","import localforage from \"localforage\";\r\nimport React, {\r\n  FC,\r\n  useContext,\r\n  useDebugValue,\r\n  useEffect,\r\n  useState,\r\n} from \"react\";\r\nexport interface DrawCtrl {\r\n  mode: \"draw\" | \"erase\" | \"select\" | \"text\";\r\n  finger: boolean;\r\n  lineWidth: number;\r\n  eraserWidth: number;\r\n  color: string;\r\n  highlight: boolean;\r\n  lasso: boolean;\r\n  pixelEraser: boolean;\r\n  widthList: number[];\r\n}\r\n\r\nexport const defaultWidthList = [10, 20, 30, 50];\r\nexport const defaultDrawCtrl: Readonly<DrawCtrl> = {\r\n  mode: \"draw\",\r\n  finger: true,\r\n  lineWidth: 10,\r\n  eraserWidth: 10,\r\n  color: \"#000000\",\r\n  highlight: false,\r\n  lasso: true,\r\n  pixelEraser: false,\r\n  widthList: defaultWidthList,\r\n};\r\n\r\nasync function getDrawCtrl() {\r\n  let drawCtrl = await localforage.getItem<DrawCtrl>(\"DRAW_CTRL\");\r\n  if (!drawCtrl) {\r\n    drawCtrl = defaultDrawCtrl;\r\n    await localforage.setItem(\"DRAW_CTRL\", drawCtrl);\r\n  }\r\n  return drawCtrl;\r\n}\r\n\r\nasync function saveDrawCtrl(drawCtrl: DrawCtrl) {\r\n  await localforage.setItem(\"DRAW_CTRL\", drawCtrl);\r\n}\r\n\r\nconst DrawCtrlContext = React.createContext({\r\n  drawCtrl: defaultDrawCtrl,\r\n  updateDrawCtrl: (() => {}) as (updated: Partial<DrawCtrl>) => void,\r\n});\r\n\r\nexport function useDrawCtrl() {\r\n  const { drawCtrl } = useContext(DrawCtrlContext);\r\n  useDebugValue(drawCtrl);\r\n  return drawCtrl;\r\n}\r\n\r\nexport function useUpdateDrawCtrl() {\r\n  const { updateDrawCtrl } = useContext(DrawCtrlContext);\r\n  return updateDrawCtrl;\r\n}\r\n\r\nexport const DrawCtrlProvider: FC = ({ children }) => {\r\n  const [drawCtrl, setDrawCtrl] = useState(defaultDrawCtrl);\r\n  useEffect(() => {\r\n    getDrawCtrl().then(setDrawCtrl);\r\n  }, []);\r\n\r\n  const updateDrawCtrl = (updated: Partial<DrawCtrl>) => {\r\n    setDrawCtrl((prev) => {\r\n      const newCtrl = { ...prev, ...updated };\r\n      saveDrawCtrl(newCtrl);\r\n      return newCtrl;\r\n    });\r\n  };\r\n  return (\r\n    <DrawCtrlContext.Provider value={{ drawCtrl, updateDrawCtrl }}>\r\n      {children}\r\n    </DrawCtrlContext.Provider>\r\n  );\r\n};\r\n","export function createVirtualCanvas(width: number, height: number) {\r\n  const canvas = document.createElement(\"canvas\");\r\n  const context = canvas.getContext(\"2d\");\r\n  if (!context) {\r\n    throw new Error(\"can't get virtual canvas context\");\r\n  }\r\n  canvas.width = width;\r\n  canvas.height = height;\r\n  return { canvas, context };\r\n}\r\n\r\nexport function releaseCanvas(canvas: HTMLCanvasElement) {\r\n  canvas.width = 1;\r\n  canvas.height = 1;\r\n  const ctx = canvas.getContext('2d');\r\n  ctx?.clearRect(0, 0, 1, 1);\r\n}\r\n","import { CSSProperties, FC, useEffect, useMemo, useState } from \"react\";\r\nimport { defaultWidthList, DrawCtrl } from \"lib/draw/DrawCtrl\";\r\nimport { ColorCirle } from \"component/ColorCircle\";\r\nimport { WIDTH } from \"lib/draw/DrawState\";\r\nimport { Popover, Segmented, Slider } from \"antd\";\r\nimport { allColors } from \"lib/color\";\r\nimport { Setter } from \"lib/hooks\";\r\nimport IconFont from \"component/IconFont\";\r\nimport { List } from \"immutable\";\r\nimport \"./penPanel.sass\";\r\nimport { useForceLight } from \"lib/Dark\";\r\n\r\nexport const PenPanel: FC<{\r\n  updateDrawCtrl: (updated: Partial<DrawCtrl>) => void;\r\n  drawCtrl: Partial<DrawCtrl>;\r\n}> = ({ updateDrawCtrl, drawCtrl }) => {\r\n  const { highlight, color } = drawCtrl;\r\n  const [panelBlur, setPanelBlur] = useState(false);\r\n\r\n  return (\r\n    <div className=\"pen-panel\" data-blur={panelBlur} data-hi={highlight}>\r\n      <div className=\"pen-status\">\r\n        <WidthSelect\r\n          updateDrawCtrl={updateDrawCtrl}\r\n          drawCtrl={drawCtrl}\r\n          setPanelBlur={setPanelBlur}\r\n        />\r\n        <HighlightSwitch checked={highlight} updateDrawCtrl={updateDrawCtrl} />\r\n      </div>\r\n      <ColorSelect\r\n        color={color || \"\"}\r\n        setColor={(c) => updateDrawCtrl({ color: c })}\r\n      />\r\n    </div>\r\n  );\r\n};\r\n\r\nexport const WidthSelect: FC<{\r\n  updateDrawCtrl: (updated: Partial<DrawCtrl>) => void;\r\n  drawCtrl: Partial<DrawCtrl>;\r\n  setPanelBlur?: Setter<boolean>;\r\n  field?: \"lineWidth\" | \"eraserWidth\";\r\n}> = ({\r\n  updateDrawCtrl,\r\n  drawCtrl,\r\n  setPanelBlur = () => {},\r\n  field = \"lineWidth\",\r\n}) => {\r\n  const currWidth = drawCtrl[field];\r\n  const widthList = drawCtrl.widthList ?? defaultWidthList;\r\n  const color = field === \"lineWidth\" ? drawCtrl.color ?? \"#aaa\" : \"#aaa\";\r\n\r\n  const chosen = useMemo(\r\n    () => widthList.indexOf(currWidth ?? -1),\r\n    [currWidth, widthList]\r\n  );\r\n\r\n  const [popShow, setPopShow] = useState(List([false, false, false, false]));\r\n  useEffect(() => {\r\n    if (popShow.includes(true)) setPanelBlur(true);\r\n    else setPanelBlur(false);\r\n  }, [popShow, setPanelBlur]);\r\n\r\n  const realSizeStyle = (width: number) =>\r\n    ({\r\n      \"--real-size\": `calc(${100 / WIDTH}vw * ${width})`,\r\n    } as CSSProperties);\r\n\r\n  const [forceLight] = useForceLight();\r\n\r\n  const options = [\r\n    { value: -1, label: null },\r\n    ...widthList.map((width, index) => ({\r\n      value: index,\r\n      label: (\r\n        <Popover\r\n          visible={popShow.get(index)}\r\n          onVisibleChange={(v) => setPopShow((prev) => prev.set(index, v))}\r\n          trigger={chosen === index ? [\"click\"] : []}\r\n          placement=\"bottom\"\r\n          destroyTooltipOnHide\r\n          content={\r\n            <Slider\r\n              min={5}\r\n              max={100}\r\n              className=\"ctrl-slider\"\r\n              defaultValue={width}\r\n              onAfterChange={(w) => {\r\n                if (widthList.includes(w)) {\r\n                  setPopShow((prev) => prev.set(index, false));\r\n                  return updateDrawCtrl({ [field]: w });\r\n                }\r\n                const newWL = widthList.slice();\r\n                newWL[index] = w;\r\n                updateDrawCtrl({ widthList: newWL, [field]: w });\r\n              }}\r\n            />\r\n          }\r\n        >\r\n          <div\r\n            className=\"circle-wrapper\"\r\n            data-force-light={forceLight}\r\n            style={realSizeStyle(width)}\r\n          >\r\n            <ColorCirle className={\"width-circle \" + field} color={color} />\r\n          </div>\r\n        </Popover>\r\n      ),\r\n    })),\r\n  ];\r\n\r\n  return (\r\n    <Segmented\r\n      className=\"width-seg\"\r\n      value={chosen}\r\n      options={options}\r\n      onChange={(i) => updateDrawCtrl({ [field]: widthList[+i] ?? 10 })}\r\n    />\r\n  );\r\n};\r\n\r\nconst HighlightSwitch: FC<{\r\n  checked?: boolean;\r\n  updateDrawCtrl: (updated: Partial<DrawCtrl>) => void;\r\n}> = ({ checked = false, updateDrawCtrl }) => {\r\n  return (\r\n    <label className=\"hi-wrapper\">\r\n      <input\r\n        type=\"checkbox\"\r\n        name=\"highlight\"\r\n        checked={checked}\r\n        onChange={(e) => updateDrawCtrl({ highlight: e.target.checked })}\r\n      />\r\n      <div className=\"hi-switch\">\r\n        <IconFont type=\"icon-Highlight\" />\r\n      </div>\r\n    </label>\r\n  );\r\n};\r\n\r\nexport const ColorSelect: FC<{\r\n  color: string;\r\n  setColor: (color: string) => void;\r\n}> = ({ setColor, color }) => {\r\n  const [forceLight] = useForceLight();\r\n  return (\r\n    <div className=\"color-select\" data-force-light={forceLight}>\r\n      {allColors.map((c) => (\r\n        <label key={c}>\r\n          <input\r\n            checked={color === c}\r\n            type=\"radio\"\r\n            name=\"color\"\r\n            onChange={(e) => e.target.checked && setColor(c)}\r\n          />\r\n          <div\r\n            data-color={c}\r\n            className=\"circle\"\r\n            style={{ backgroundColor: c, borderColor: c }}\r\n          />\r\n        </label>\r\n      ))}\r\n    </div>\r\n  );\r\n};\r\n"],"names":["createFromIconfontCN","scriptUrl","getRotateCursorImage","cache","Map","createVirtualCanvas","canvas","context","image","Image","src","rotateImg","angle","Math","round","cached","get","translate","rotate","PI","drawImage","data","toDataURL","clearRect","resetTransform","set","getRotateCurcor","usePreventTouch","allowFinger","isTouch","useRef","checkPoniter","e","isPrimary","current","pointerType","preventTouch","touch","touches","touchType","isApplePencil","length","isEventValid","stopPropagation","onPointerDownCapture","onPointerMoveCapture","onTouchStartCapture","onTouchMoveCapture","Path","paper","Size","Point","Group","Color","Raster","Layer","DrawRaw","React","ref","drawState","otherStates","onChange","drawCtrl","defaultDrawCtrl","readonly","imgSrc","setActiveTool","width","height","mode","finger","lasso","eraserWidth","canvasEl","scope","useState","group","setGroup","usePaperItem","path","setPath","rect","setRect","rotateHandle","setRotateHandle","useEffect","cvs","scp","setup","settings","handleSize","hitTolerance","forEach","project","addLayer","layers","l","visible","activate","Tool","remove","releaseCanvas","bgRect","paintBackground","useSize","ratio","zero","view","viewSize","multiply","scale","update","raster","addChild","sendToBack","onLoad","fitBounds","bringToFront","mergedStrokes","useMemo","DrawState","getStrokeList","tempGroup","layer","stroke","self","hasStroke","uid","item","paintStroke","push","removeChildren","hitRef","selected","setSelected","paperMode","chosenIDs","setChosenIDs","chosenItems","IDSet","Set","filter","has","name","resetSelect","useCallback","undefined","downPath","startStroke","downRect","startRect","point","handleDown","draw","erase","select","contains","hitRes","hitTest","segments","text","t","getClickedText","startText","setPointText","dragPath","add","smooth","handleDrag","x","y","s1","s2","s3","segment","center","bounds","axis","subtract","line","setCursor","moveP","baseP","next","diagonal","strokeWidth","rBaseP","delta","pointText","topCenter","bottomRight","tool","maxDistance","erased","replaced","handelToolDrag","hitTestAll","class","tolerance","topItem","parent","pixelEraser","radius","circle","Circle","sub","trace","replaceWith","opacity","guide","handleUp","isEmpty","simplify","pathData","exportJSON","prev","items","Array","from","clear","splitters","map","flattenCP","i","erasedList","selection","abs","area","closePath","moveDash","checkLasso","link","lastSegment","updateMutation","handleSelectedCursor","cursor","lineWidth","size","half","getCircleCursor","handleMove","handler","onMouseDown","onMouseDrag","onMouseUp","onMouseMove","mutations","p","deleteSelected","mutateStyle","updated","updateGroupStyle","duplicateSelected","transP","divide","copies","clone","rasterize","g","addTo","insert","cancelText","submitText","color","justification","content","fillColor","useImperativeHandle","preventDefault","document","addEventListener","removeEventListener","usePinch","memo","offset","first","last","origin","lastScale","lastOrigin","elPos","originRawP","getBoundingClientRect","originViewP","originPorjP","viewToProject","dScale","aniCount","pow","scaleView","requestAnimationFrame","putCenterBack","zoom","scaleBounds","max","min","rubberband","target","touchHandler","className","style","displayName","Draw","tuple","useDebugValue","importJSON","console","error","Rectangle","onFrame","highlight","strokeColor","alpha","blendMode","strokeJoin","strokeCap","dashOffset","dashArray","projSize","viewW","viewH","projW","projH","minX","minY","maxX","maxY","getCenterTranslate","deltaX","deltaY","dP","move","isInside","res","compare","intersects","checkedP","newColor","fill","fontSize","cp","children","flat","SelectTool","drawRef","CSSTransition","timeout","in","unmountOnExit","SelectToolContent","btnProps","type","shape","currDrawCtrl","setCurrDrawCtrl","createPortal","trigger","placement","getPopupContainer","parentElement","destroyTooltipOnHide","PenPanel","updateDrawCtrl","icon","BgColorsOutlined","CopyOutlined","onClick","PictureOutlined","imageData","Modal","title","alt","okText","onOk","saveAs","danger","DeleteOutlined","querySelector","TextTool","setText","allColors","setColor","align","setAlign","useForceLight","forceLight","toCSS","fontColorBtn","overlayStyle","FontColorsOutlined","alignRadio","optionType","value","buttonStyle","options","label","AlignLeftOutlined","AlignCenterOutlined","AlignRightOutlined","onCancel","trim","bodyStyle","paddingTop","destroyOnClose","TextArea","rows","autoFocus","PageWrapperRaw","thumbnail","teamStateMap","updateState","pdfIndex","noteID","preview","onViewChange","preload","ignores","skipInView","threshold","range","useInView","skip","entry","intersectionRatio","fullImg","setFullImg","loadImage","once","getNotePageImage","show","deleteAll","toList","toArray","imageLoaded","Boolean","drawShow","viewBox","DrawWrapper","PageWrapper","useDrawCtrl","activeTool","handleChange","useEvent","arg","newDS","defaultWidthList","widthList","getDrawCtrl","localforage","saveDrawCtrl","DrawCtrlContext","useContext","useUpdateDrawCtrl","DrawCtrlProvider","setDrawCtrl","then","Provider","newCtrl","createElement","getContext","Error","ctx","panelBlur","setPanelBlur","WidthSelect","HighlightSwitch","checked","ColorSelect","c","field","currWidth","chosen","indexOf","List","popShow","setPopShow","includes","realSizeStyle","WIDTH","index","onVisibleChange","v","defaultValue","onAfterChange","w","newWL","slice","IconFont","backgroundColor","borderColor"],"sourceRoot":""}