"use strict";(self.webpackChunkmultibility=self.webpackChunkmultibility||[]).push([[752,479],{37696:function(e,t,n){n.r(t),n.d(t,{ReaderMethodCtx:function(){return Qe},ReaderStateCtx:function(){return Je},default:function(){return $e}});var r=n(93433),a=n(1413),i=n(45987),o=n(29439),u=n(15861),s=n(87757),c=n.n(s),l=n(72791),d=n(92198),f=n(11886),v=n(81832),p=n(76807),x=n(95099),m=n(15671),g=n(43144),h=n(82670),Z=n(24124),j={states:(0,Z.D5)(),editStack:(0,Z.aV)(),undoStack:(0,Z.aV)()},k=(0,Z.WV)(j),y=function(){function e(t,n){(0,m.Z)(this,e),this.immutable=t,this.lastOp=n}return(0,g.Z)(e,[{key:"getImmutable",value:function(){return this.immutable}},{key:"getStates",value:function(){return this.getImmutable().get("states")}},{key:"getOneState",value:function(e){return this.getStates().get(e)}},{key:"getEditStack",value:function(){return this.getImmutable().get("editStack")}},{key:"getUndoStack",value:function(){return this.getImmutable().get("undoStack")}},{key:"setState",value:function(t,n){var r=this.getOneState(t);if(!r||r===n)return this;var i=this.getImmutable().update("states",(function(e){return e.set(t,n)})).update("editStack",(function(e){return e.push(t)})).delete("undoStack"),o=n.lastOp;return new e(i,o&&(0,a.Z)((0,a.Z)({},o),{},{pageID:t}))}},{key:"syncStrokeTime",value:function(e,t){var n=this.getOneState(e);return n&&h.Dw.syncStrokeTime(n,t),this}},{key:"addState",value:function(t,n){var r=n.state,a=n.ratio,i=h.Dw.loadFromFlat(r,a);return new e(this.getImmutable().update("states",(function(e){return e.set(t,i)})))}},{key:"deleteState",value:function(t){return new e(this.getImmutable().update("states",(function(e){return e.delete(t)})))}},{key:"isUndoable",value:function(){return this.getEditStack().size>0}},{key:"isRedoable",value:function(){return this.getUndoStack().size>0}},{key:"undo",value:function(){if(!this.isUndoable())return this;var t=this.getEditStack().last(),n=t&&this.getOneState(t);if(!n)return this;var r=h.Dw.undo(n),i=r.lastOp,o=i&&(0,a.Z)({pageID:t},i);return new e(this.getImmutable().update("editStack",(function(e){return e.pop()})).update("undoStack",(function(e){return e.push(t)})).update("states",(function(e){return e.set(t,r)})),o)}},{key:"redo",value:function(){if(!this.isRedoable())return this;var t=this.getUndoStack().last(),n=t&&this.getOneState(t);if(!n)return this;var r=h.Dw.redo(n),i=r.lastOp,o=i&&(0,a.Z)({pageID:t},i);return new e(this.getImmutable().update("undoStack",(function(e){return e.pop()})).update("editStack",(function(e){return e.push(t)})).update("states",(function(e){return e.set(t,r)})),o)}},{key:"getLastDS",value:function(){var e,t=null===(e=this.lastOp)||void 0===e?void 0:e.pageID,n=t&&this.getOneState(t);if(n)return[t,n]}}],[{key:"createFromPages",value:function(t){return new e(k().set("states",(0,Z.D5)(t).map((function(e){var t=e.state,n=e.ratio;return h.Dw.loadFromFlat(t,n)}))))}}]),e}(),S=n(75783),b=n(87309),w=n(50419),C=n(79286),I=n(80184),P=function(){var e=(0,l.useContext)(Qe).addFinalPage;return(0,I.jsx)("div",{className:"add-btn-wrapper",children:(0,I.jsx)(b.Z,{type:"dashed",icon:(0,I.jsx)(C.Z,{}),block:!0,onClick:e,children:"New page"})})},D=n(16871),N=n(96801),O=n(37762),R=n(61842),E=n.n(R)().createInstance({name:"scroll"});var T=function(e,t){var n,r="",a=0,i=(0,O.Z)(t);try{for(i.s();!(n=i.n()).done;){var o=n.value,u=e.get(o);if(u){if(1===u)return o;u>a&&(r=o,a=u)}}}catch(s){i.e(s)}finally{i.f()}return r},F=n(79930),M=n(82898);function L(e,t,n){var r=e.indexOf(t),a=e.slice();return-1===r||a.splice(r+1,0,n),a}var A=n(52242),U=n(65323),V=function(e){var t=e.saved,n=e.instantSave,r=(0,D.s0)();return(0,I.jsxs)("div",{className:"left",children:[(0,I.jsx)(b.Z,{type:"text",onClick:(0,u.Z)(c().mark((function e(){return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n();case 2:r("/");case 3:case"end":return e.stop()}}),e)}))),icon:(0,I.jsx)(A.Z,{style:{opacity:.8}})}),(0,I.jsx)(b.Z,{type:"text",className:"save",onClick:n,disabled:t,icon:(0,I.jsx)(U.Z,{})})]})},z=n(69228),W=n(78985),K=n(78030),X=n(50446),G=n(74006),B=n(52542),H=n(62),_=n(14965),q=n(22568),Y=n(48),J=function(e){var t=e.handleUndo,n=e.handleRedo,r=(0,l.useContext)(Je).stateSet,a=(0,f.gX)(),i=a.mode,u=a.finger,s=(0,f.F7)(),c=(0,v.iX)(),d=(0,o.Z)(c,2),p=d[0],x=d[1];return(0,I.jsxs)("div",{className:"middle",children:[(0,I.jsx)(b.Z,{type:"text",shape:"circle",icon:(0,I.jsx)(K.Z,{}),onClick:t,disabled:!(null!==r&&void 0!==r&&r.isUndoable())}),(0,I.jsx)(b.Z,{type:"text",shape:"circle",icon:(0,I.jsx)(X.Z,{}),onClick:n,disabled:!(null!==r&&void 0!==r&&r.isRedoable())}),(0,I.jsx)(b.Z,{type:u?"default":"text",shape:"circle",onClick:function(){s({finger:!u}),w.ZP.destroy("FINGER"),w.ZP.open({content:u?"Pencil only":"Draw with finger",key:"FINGER"})},icon:(0,I.jsx)(q.Z,{type:"icon-finger"})}),(0,I.jsx)(b.Z,{className:"force-light-btn",type:"text",shape:"circle",icon:p?(0,I.jsx)(G.Z,{}):(0,I.jsx)(B.Z,{}),onClick:function(){return x((function(e){return!e}))}}),(0,I.jsx)(Q,{}),(0,I.jsx)($,{}),(0,I.jsx)(b.Z,{type:"text"===i?"default":"text",shape:"circle",onClick:function(){return s({mode:"text"})},icon:(0,I.jsx)(q.Z,{type:"icon-text1"})}),(0,I.jsx)(ee,{})]})},Q=function(){var e=(0,f.gX)(),t=(0,f.F7)(),n={shape:"circle",icon:(0,I.jsx)(H.Z,{})};return"draw"===e.mode?(0,I.jsx)(z.Z,{content:(0,I.jsx)(Y.Uk,{updateDrawCtrl:t,drawCtrl:e}),trigger:"click",placement:"bottom",getPopupContainer:function(e){return e.parentElement},destroyTooltipOnHide:!0,children:(0,I.jsx)(b.Z,(0,a.Z)({type:"default"},n))}):(0,I.jsx)(b.Z,(0,a.Z)({type:"text",onClick:function(){return t({mode:"draw"})}},n))},$=function(){var e=(0,f.gX)(),t=e.mode,n=e.pixelEraser,r=(0,f.F7)(),i={shape:"circle",icon:(0,I.jsx)(q.Z,{type:"icon-eraser"})};return"erase"===t?(0,I.jsx)(z.Z,{content:(0,I.jsxs)("div",{className:"width-seg-wrapper",children:[(0,I.jsx)(W.Z,{block:!0,size:"small",className:"pixel-seg",options:["Pixel","Object"],value:n?"Pixel":"Object",onChange:function(e){r("Pixel"===e?{pixelEraser:!0}:{pixelEraser:!1})}}),(0,I.jsx)(Y.Db,{drawCtrl:e,updateDrawCtrl:r,field:"eraserWidth"})]}),trigger:"click",placement:"bottom",getPopupContainer:function(e){return e.parentElement},destroyTooltipOnHide:!0,children:(0,I.jsx)(b.Z,(0,a.Z)({type:"default"},i))}):(0,I.jsx)(b.Z,(0,a.Z)({type:"text",onClick:function(){return r({mode:"erase"})}},i))},ee=function(){var e=(0,f.gX)(),t=e.lasso,n=e.mode,r=(0,f.F7)(),a=t?(0,I.jsx)(q.Z,{type:"icon-lasso1"}):(0,I.jsx)(_.Z,{});return"select"===n?(0,I.jsx)(b.Z,{type:"default",shape:"circle",icon:a,onClick:function(){return r({lasso:!t})}}):(0,I.jsx)(b.Z,{type:"text",shape:"circle",icon:a,onClick:function(){return r({mode:"select"})}})},te=n(49142),ne=n(90785),re=n(91333),ae=n(75594),ie=n(89267),oe=n(95055),ue=n(67415),se=n(60559),ce=n(69951),le=n(23414),de=n(82622),fe=n(10711),ve=n(53621),pe=n(75797),xe=n(18780),me=n(52365),ge=n(76586),he=n(70140),Ze=n(87661),je=n(88894),ke=n(74115),ye=function(e){var t=e.userInfo,n=e.size,r=void 0===n?"default":n,a=e.onClick,i=void 0===a?function(){}:a,o=e.chosen,u=void 0!==o&&o,s=e.className,c=(0,l.useMemo)((function(){return(0,ke.bM)(t.userID)}),[t]);if(!t)return null;var d=t.userName;return(0,I.jsx)(ge.C,{className:s,"data-chosen":u,size:r,style:{backgroundColor:c},children:(0,I.jsx)("div",{className:"avatar-wrapper",onClick:i,children:null===d||void 0===d?void 0:d.slice(0,3)})})},Se=n(81694),be=n.n(Se),we=function(){var e=(0,l.useContext)(Je),t=e.pageOrder,n=e.currPageID,r=(0,l.useContext)(Qe),i=r.scrollPage,u=r.saveReorder,s=(0,v.iX)(),c=(0,o.Z)(s,1)[0],d=(0,me.zI)(),f=(0,o.Z)(d,1)[0],p=(0,l.useRef)({}),x={ALL:"All Pages",MARKED:"Bookmarks",WRITTEN:"Notes"}[f];return(0,l.useEffect)((function(){var e;return null===(e=p.current[n])||void 0===e?void 0:e.scrollIntoView()}),[]),(0,I.jsxs)("div",{className:"preview-container","data-force-light":c,children:[(0,I.jsx)(Ne,{}),(0,I.jsx)("h3",{children:x}),(0,I.jsx)(xe.Z5,{onDragEnd:function(e){var n=e.source,r=e.destination;if(r&&t){var a=n.index,s=r.index,c=t[a];if(a!==s&&c){var l=function(e,t,n){var r=e.slice(),a=r.splice(t,1),i=(0,o.Z)(a,1)[0];return i?(r.splice(n,0,i),r):e}(t,a,s);u(l,!0),requestAnimationFrame((function(){return i(c)}))}}},children:(0,I.jsx)(xe.bK,{droppableId:"preview-list",children:function(e){var n=e.droppableProps,r=e.innerRef,i=e.placeholder;return(0,I.jsxs)("div",(0,a.Z)((0,a.Z)({className:"page-list",ref:r},n),{},{children:[null===t||void 0===t?void 0:t.map((function(e,t){return(0,I.jsx)(Ce,{uid:e,pageIndex:t,refRec:p.current},e)})),i,"ALL"===f&&(0,I.jsx)(P,{})]}))}})})]})},Ce=function(e){var t=e.uid,n=e.pageIndex,r=e.refRec,i=(0,l.useContext)(Je),u=i.stateSet,s=i.pageRec,c=i.currPageID,d=(0,l.useContext)(se.TeamCtx),f=d.teamState,v=d.ignores,p=(0,l.useContext)(Qe).scrollPage,x=(0,me.zI)(),m=(0,o.Z)(x,1)[0],g=(0,l.useState)(""),h=(0,o.Z)(g,2),Z=h[0],j=h[1],k=null===s||void 0===s?void 0:s.get(t),y=null===u||void 0===u?void 0:u.getOneState(t),S=null===f||void 0===f?void 0:f.getOnePageStateMap(t);if(!k||!y)return null;var b=k.image,w=k.marked;if("WRITTEN"===m&&y.isEmpty()&&(!S||S.every((function(e){return e.isEmpty()}))))return null;if("MARKED"===m&&!w)return null;var C=c===t;return(0,I.jsx)(xe._l,{draggableId:t,index:n,isDragDisabled:"ALL"!==m,children:function(e,i){var o=e.innerRef,u=e.draggableProps,s=e.dragHandleProps,c=i.isDragging;return(0,I.jsxs)("div",(0,a.Z)((0,a.Z)((0,a.Z)({ref:function(e){o(e),e&&(r[t]=e)},className:"page","data-curr":C,"data-dragged":c,onClick:function(){return p(t)}},u),s),{},{children:[(0,I.jsx)(N.default,{drawState:(null===S||void 0===S?void 0:S.get(Z))||y,teamStateMap:Z?void 0:S,thumbnail:b,ignores:v,preview:!0}),(0,I.jsx)(Ie,{uid:t,index:n,chosen:Z,setChosen:j})]}))}})},Ie=function(e){var t=e.uid,n=e.index,r=e.chosen,a=e.setChosen,i=(0,l.useContext)(Qe).switchPageMarked,o=(0,l.useContext)(Je).pageRec,u=(0,l.useContext)(se.TeamCtx),s=u.ignores,c=u.teamState,d=(0,l.useMemo)((function(){return(null===c||void 0===c?void 0:c.getPageValidUsers(t).filter((function(e){return!s.has(e)})))||[]}),[c,s,t]),f=null===o||void 0===o?void 0:o.get(t);if(!f)return null;var v=f.marked;return(0,I.jsxs)("div",{className:"tools",onClick:function(e){return e.stopPropagation()},children:[(0,I.jsx)("div",{className:"bookmark","data-marked":v,onClick:function(){return i(t)}}),(0,I.jsx)("div",{className:"index",children:n+1}),(0,I.jsx)(De,{uid:t}),(0,I.jsx)(Pe,{userIDs:d,chosen:r,setChosen:a})]})},Pe=function(e){var t=e.userIDs,n=e.chosen,r=e.setChosen,a=(0,l.useContext)(se.TeamCtx).userRec;return(0,I.jsx)(ge.C.Group,{maxCount:2,size:"default",className:be()("team-group",{chosen:n}),maxPopoverPlacement:"bottom",children:t.map((function(e){var t=a[e];return t?(0,I.jsx)(ye,{size:"default",userInfo:t,className:"preview-avatar",chosen:n===e,onClick:function(){return r((function(t){return t===e?"":e}))}},e):null}))})},De=function(e){var t=e.uid,n=(0,l.useContext)(Qe),r=n.addPage,a=n.deletePage,i=(0,I.jsx)(he.Z,{onClick:function(e){var n=e.key;"ADD"===n?r(t):"COPY"===n?r(t,!0):"DELETE"===n&&a(t)},items:[{key:"ADD",icon:(0,I.jsx)(C.Z,{}),label:"Add page"},{key:"COPY",icon:(0,I.jsx)(le.Z,{}),label:"Duplicate"},{key:"DELETE",icon:(0,I.jsx)(de.Z,{}),label:"Delete",danger:!0}]});return(0,I.jsx)(z.Z,{content:i,trigger:"click",placement:"left",destroyTooltipOnHide:!0,children:(0,I.jsx)("div",{className:"option",children:(0,I.jsx)(fe.Z,{})})})},Ne=function(){var e=(0,me.zI)(),t=(0,o.Z)(e,2),n=t[0],r=t[1],a=Ze.Z.TabPane;return(0,I.jsxs)(Ze.Z,{className:"tabs",activeKey:n,onChange:r,tabBarGutter:10,size:"small",centered:!0,children:[(0,I.jsx)(a,{tab:(0,I.jsx)(q.Z,{type:"icon-uf_paper"})},"ALL"),(0,I.jsx)(a,{tab:(0,I.jsx)(q.Z,{type:"icon-bookmark2"})},"MARKED"),(0,I.jsx)(a,{tab:(0,I.jsx)(q.Z,{type:"icon-write"})},"WRITTEN")]})},Oe=function(){var e=(0,l.useState)(!1),t=(0,o.Z)(e,2),n=t[0],r=t[1];return(0,I.jsxs)(me.s2,{initKey:"ALL",children:[(0,I.jsx)(b.Z,{type:"text",icon:n?(0,I.jsx)(ve.Z,{}):(0,I.jsx)(pe.Z,{}),onClick:function(){return r((function(e){return!e}))}}),(0,I.jsx)(je.Z,{visible:n,onClose:function(){return r(!1)},width:200,closable:!1,zIndex:800,className:"preview-drawer",bodyStyle:{padding:0,overflow:"hidden"},headerStyle:{textAlign:"center"},destroyOnClose:!0,children:(0,I.jsx)(we,{})})]})},Re=n(67575),Ee=n(30501),Te=n(98272),Fe=n(24215),Me=n(17973),Le=n(19951),Ae=n(23605),Ue=n(56200),Ve=n(18301),ze=n(51570),We=n(1829),Ke=n.n(We),Xe=function(e){var t=e.instantSave,n=(0,l.useContext)(se.TeamCtx).teamOn;return(0,I.jsxs)("div",{className:"right",children:[n?(0,I.jsx)(Be,{}):(0,I.jsx)(He,{instantSave:t}),(0,I.jsx)(Oe,{})]})},Ge=function(e){var t=e.userID,n=(0,l.useState)(!1),r=(0,o.Z)(n,2),a=r[0],i=r[1],u=(0,l.useContext)(se.TeamCtx),s=u.ignores,c=u.setIgnores,d=u.resetIO,f=u.userRec[t];if((0,l.useEffect)((function(){return i(!1)}),[f]),!f)return null;var v=f.userName,p=f.online,x=t===(0,ce.VN)(),m=s.has(t)&&!x;return(0,I.jsxs)("div",{className:"user-item","data-online":p,children:[(0,I.jsx)(ye,{userInfo:f,size:"small",className:"room-avatar"}),a||(0,I.jsx)("span",{className:"user-name",children:v}),a&&(0,I.jsx)(oe.Z,{autoFocus:!0,className:"rename-input",defaultValue:v,onSearch:function(e){var t=e.trim();if(!t||t===v)return i(!1);(0,ce.lu)(t),d()},enterButton:(0,I.jsx)(b.Z,{icon:(0,I.jsx)(Re.Z,{})})}),x?a||(0,I.jsx)(b.Z,{type:"text",icon:(0,I.jsx)(Ee.Z,{}),onClick:function(){return i(!0)}}):(0,I.jsx)(b.Z,{type:"text",icon:m?(0,I.jsx)(Te.Z,{}):(0,I.jsx)(Fe.Z,{}),onClick:function(){c((function(e){return e.has(t)?e.delete(t):e.add(t)}))}})]})},Be=function(){var e=(0,l.useContext)(se.TeamCtx),t=e.code,n=e.userRec,a=e.connected,s=e.loadInfo,d=e.loadState,f=e.resetIO,v=(0,l.useContext)(Je).noteInfo,p=window.location.href,x=function(){var e=(0,u.Z)(c().mark((function e(){var t,r;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=null===(t=n[(0,ce.VN)()])||void 0===t?void 0:t.userName,e.prev=1,v){e.next=4;break}return e.abrupt("return");case 4:return e.next=6,Ke()("".concat(v.name," - ").concat(r," - Multibility\n").concat(p));case 6:w.ZP.destroy("copy"),w.ZP.success({content:"Link copied!",icon:(0,I.jsx)(le.Z,{}),key:"copy"}),e.next=13;break;case 10:e.prev=10,e.t0=e.catch(1),console.log(e.t0);case 13:case"end":return e.stop()}}),e,null,[[1,10]])})));return function(){return e.apply(this,arguments)}}(),m=(0,l.useMemo)((function(){var e=(0,ce.VN)(),t=n[e],a=(0,i.Z)(n,[e].map(te.Z)),o=t?[t]:[],u=Object.values(a);return o.push.apply(o,(0,r.Z)(u.filter((function(e){return e.online}))).concat((0,r.Z)(u.filter((function(e){return!e.online}))))),o}),[n]),g=(0,l.useMemo)((function(){return m.filter((function(e){return e.online})).length}),[m]),h=(0,I.jsxs)("div",{className:"team-popover",children:[a||(0,I.jsx)(ne.Z,{className:"disconn-alert",message:"Network failed.",icon:(0,I.jsx)(Me.Z,{}),type:"error",showIcon:!0,banner:!0}),(0,I.jsx)(ue.GD,{className:"code-display",value:String(t),length:4,plain:!0}),(0,I.jsx)(b.Z,{icon:(0,I.jsx)(Le.Z,{}),className:"share-btn",onClick:x,block:!0,children:"Share"}),(0,I.jsx)(re.Z,{}),(0,I.jsx)("div",{className:"user-list",children:m.map((function(e){return(0,I.jsx)(Ge,{userID:e.userID},e.userID)}))})]}),Z=(0,l.useState)(!1),j=(0,o.Z)(Z,2),k=j[0],y=j[1],S=(0,I.jsxs)("div",{className:"team-title",children:[(0,I.jsx)("span",{children:"Team info"}),(0,I.jsx)(b.Z,{shape:"circle",type:"text",size:"small",loading:k,icon:(0,I.jsx)(Ae.Z,{}),onClick:(0,u.Z)(c().mark((function e(){return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return y(!0),e.next=3,s();case 3:return e.next=5,d();case 5:y(!1),f();case 7:case"end":return e.stop()}}),e)})))})]});return(0,I.jsx)(z.Z,{content:h,trigger:"click",placement:"bottomRight",title:S,getPopupContainer:function(e){return e.parentElement},children:(0,I.jsx)(b.Z,{type:"text",icon:(0,I.jsx)(ae.Z,{status:a?"success":"error",count:a?g:"!",size:"small",children:(0,I.jsx)(Ue.Z,{})})})})},He=function(e){var t=e.instantSave,n=(0,l.useContext)(Je).noteID,r=(0,D.s0)(),a=function(){var e=(0,u.Z)(c().mark((function e(){return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t();case 2:return e.next=4,(0,ze.r8)(n);case 4:if(e.sent){e.next=7;break}return e.abrupt("return",w.ZP.error("Can't create room."));case 7:return e.next=9,(0,S.SP)(n,{team:!0});case 9:r("/team/"+n);case 10:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}();return(0,I.jsx)(b.Z,{type:"text",icon:(0,I.jsx)(Ve.Z,{}),onClick:function(){ie.Z.confirm({title:"Enable team editing",content:"This will make your note public to anyone with the link.",icon:(0,I.jsx)(Ue.Z,{style:{color:"#555"}}),onOk:a})}})},_e=function(e){var t=e.saved,n=e.handleUndo,r=e.handleRedo,a=e.instantSave;return(0,I.jsxs)("header",{children:[(0,I.jsx)(V,{saved:t,instantSave:a}),(0,I.jsx)(J,{handleUndo:n,handleRedo:r}),(0,I.jsx)(Xe,{instantSave:a})]})},qe=["pageRec","pdf","pageOrder"],Ye=["image","marked"],Je=l.createContext({noteID:"",currPageID:""}),Qe=l.createContext({scrollPage:function(e){},switchPageMarked:function(e){},addPage:function(e,t){},addFinalPage:function(){},deletePage:function(e){},saveReorder:function(){var e=(0,u.Z)(c().mark((function e(t,n){return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}()});function $e(){var e,t=null!==(e=(0,D.UO)().noteID)&&void 0!==e?e:"",n=(0,D.s0)(),s=(0,l.useState)(),m=(0,o.Z)(s,2),g=m[0],j=m[1],k=(0,l.useState)(),C=(0,o.Z)(k,2),N=C[0],O=C[1],R=(0,l.useState)(),A=(0,o.Z)(R,2),U=A[0],V=A[1],z=(0,l.useState)(),W=(0,o.Z)(z,2),K=W[0],X=W[1],G=(0,p.Z)(!0),B=(0,o.Z)(G,2),H=B[0],_=B[1],q=(0,l.useContext)(se.TeamCtx),Y=q.io,J=q.teamOn,Q=q.addTeamStatePage,$=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=(0,l.useState)((0,Z.D5)()),r=(0,o.Z)(n,2),a=r[0],i=r[1],s=(0,l.useRef)(!1),d=(0,l.useState)(""),f=(0,o.Z)(d,2),v=f[0],p=f[1],x=(0,l.useState)((0,Z.D5)()),m=(0,o.Z)(x,2),g=m[0],h=m[1],j=(0,l.useMemo)((function(){return T(g,t)}),[g,t]);return(0,l.useDebugValue)(j),(0,l.useEffect)((function(){(0,u.Z)(c().mark((function t(){var n;return c().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,E.getItem(e);case 2:if(n=t.sent){t.next=5;break}return t.abrupt("return",s.current=!0);case 5:p(n);case 6:case"end":return t.stop()}}),t)})))()}),[e]),(0,l.useEffect)((function(){!s.current&&a.has(v)&&requestAnimationFrame((function(){var e;null===(e=a.get(v))||void 0===e||e.scrollIntoView(),s.current=!0}))}),[v,a]),(0,l.useEffect)((function(){s.current&&E.setItem(e,j)}),[e,j]),{scrollPage:function(e){var t;null===(t=a.get(e))||void 0===t||t.scrollIntoView()},setInviewRatios:h,sectionRef:function(e){return function(t){t&&i((function(n){return n.set(e,t)}))}},currPageID:j}}(t,K),ee=$.setInviewRatios,te=$.scrollPage,ne=$.sectionRef,re=$.currPageID;(0,l.useEffect)((function(){(0,u.Z)(c().mark((function e(){var r,a,o,u;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,S.U9)(t);case 2:if(r=e.sent){e.next=6;break}return w.ZP.error("Note not found"),e.abrupt("return",n("/"));case 6:a=r.pageRec,r.pdf,o=r.pageOrder,u=(0,i.Z)(r,qe),j((0,Z.D5)(a)),X(o),O(u),V(y.createFromPages(a));case 11:case"end":return e.stop()}}),e)})))()}),[n,t,J]),(0,l.useEffect)((function(){N&&(document.title=N.name+" - Multibility")}),[N]);var ae=(0,x.Z)((0,u.Z)(c().mark((function e(){var n;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=null===g||void 0===g?void 0:g.toObject(),e.next=3,(0,S.SP)(t,{pageRec:n});case 3:_(!0);case 4:case"end":return e.stop()}}),e)})))),ie=(0,l.useCallback)((0,F.Z)(ae,2e3),[ae]),oe=ie.flush,ue=function(e,t){j((function(n){return null===n||void 0===n?void 0:n.update(e,d.BJ,t)})),_(!1),ie()},ce=function(){var e=(0,u.Z)(c().mark((function e(n){var r,a=arguments;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=a.length>1&&void 0!==a[1]&&a[1],X(n),e.next=4,(0,S.SP)(t,{pageOrder:n});case 4:return e.next=6,oe();case 6:r&&le(n);case 7:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),le=function(e){return null===Y||void 0===Y?void 0:Y.emit("reorder",{pageOrder:e})},de=(0,x.Z)((function(e){var t,n=e.deleted,r=e.pageOrder,a=e.prevOrder;(ce(r),n)&&(t=function(){return ce(a,!0)},w.ZP.warning({content:(0,I.jsxs)(I.Fragment,{children:["One page was deleted.",(0,I.jsx)(b.Z,{size:"small",type:"link",onClick:function(){w.ZP.destroy("DELETE"),t()},children:"Undo"})]}),key:"DELETE",duration:10}))})),fe=(0,x.Z)((function(e){var t=e.pageOrder,n=e.pageID,r=e.newPage;ce(t),ue(n,(function(){return r})),V((function(e){return null===e||void 0===e?void 0:e.addState(n,r)}))}));(0,l.useEffect)((function(){return null===Y||void 0===Y||Y.on("reorder",de),null===Y||void 0===Y||Y.on("newPage",fe),function(){null===Y||void 0===Y||Y.removeAllListeners()}}),[Y,de,fe]);var ve=function(e,t,n){n.image,n.marked;var r=(0,i.Z)(n,Ye);null===Y||void 0===Y||Y.emit("newPage",{pageOrder:e,pageID:t,newPage:r}),Q(t,n)},pe=function(e,t){var n=h.Dw.flaten(t);ue(e,(function(e){return(0,a.Z)((0,a.Z)({},e),{},{state:n})}))},xe=function(e){if(U){var t=e(U);if(t!==U){V(t);var n,a=t.getLastDS(),i=t.lastOp;if(a&&i)pe.apply(void 0,(0,r.Z)(a)),n=i,null===Y||void 0===Y||Y.emit("push",{operation:n},(function(e){var t=e.pageID,n=e.stroke;return V((function(e){return null===e||void 0===e?void 0:e.syncStrokeTime(t,n)}))}))}}},me=function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(K){var n=t?null===g||void 0===g?void 0:g.get(e):void 0,r=(0,d.D4)(n),a=(0,o.Z)(r,2),i=a[0],u=a[1],s=L(K,e,i);ve(s,i,u),ce(s),ue(i,(function(){return u})),V((function(e){return null===e||void 0===e?void 0:e.addState(i,u)}))}},ge=(0,I.jsxs)("div",{className:"reader container",children:[(0,I.jsx)(_e,{saved:H,instantSave:oe,handleUndo:function(){return xe((function(e){return e.undo()}))},handleRedo:function(){return xe((function(e){return e.redo()}))}}),(0,I.jsxs)("main",{children:[null===K||void 0===K?void 0:K.map((function(e){return(0,I.jsx)("section",{className:"note-page",ref:ne(e),children:(0,I.jsx)(et,{uid:e,updateStateSet:xe,setInviewRatios:ee})},e)})),(0,I.jsx)(P,{})]})]});return(0,I.jsx)(v.Wk,{children:(0,I.jsx)(Je.Provider,{value:{noteID:t,pageRec:g,noteInfo:N,stateSet:U,pageOrder:K,currPageID:re},children:(0,I.jsx)(Qe.Provider,{value:{addPage:me,scrollPage:te,deletePage:function(e){var t=null===K||void 0===K?void 0:K.filter((function(t){return t!==e}));(null===t||void 0===t?void 0:t.length)&&ce(t,!0)},saveReorder:ce,addFinalPage:function(){var e=(0,M.Z)(K);e&&me(e)},switchPageMarked:function(e){return ue(e,(function(e){return(0,a.Z)((0,a.Z)({},e),{},{marked:!e.marked})}))}},children:(0,I.jsx)(f.w3,{children:ge})})})})}var et=function(e){var t=e.uid,n=e.updateStateSet,r=e.setInviewRatios,a=(0,l.useContext)(Je),i=a.pageRec,o=a.stateSet,u=a.currPageID,s=a.pageOrder,c=a.noteID,d=(0,l.useContext)(se.TeamCtx),f=d.teamState,v=d.ignores,p=null===i||void 0===i?void 0:i.get(t),x=null===o||void 0===o?void 0:o.getOneState(t),m=null===f||void 0===f?void 0:f.getOnePageStateMap(t),g=(0,l.useMemo)((function(){if(!s)return!1;var e=s.indexOf(u),n=s.indexOf(t);return Math.abs(n-e)<=1}),[u,t,s]);return p&&x?(0,I.jsx)(N.default,{drawState:x,teamStateMap:m,updateState:function(e){n((function(n){return n.setState(t,e)}))},pdfIndex:p.pdfIndex,noteID:c,ignores:v,onViewChange:function(e,n){if(!e)return r((function(e){return e.delete(t)}));r((function(e){return e.set(t,n)}))},preload:g}):null}},60559:function(e,t,n){n.r(t),n.d(t,{TeamCtx:function(){return k},default:function(){return y}});var r=n(29439),a=n(15861),i=n(87757),o=n.n(i),u=n(72791),s=n(51570),c=n(56058),l=n(87962),d=n(78577),f=n(69951),v=function(e){return function(){return(0,d.io)(s._n,{query:{userID:(0,f.VN)(),userName:(0,f.vW)(),noteID:e}})}},p=n(16871),x=n(79856),m=n(91835),g=n(50419),h=n(24124),Z=n(37696),j=n(80184),k=u.createContext({io:void 0,code:0,teamOn:!1,connected:!1,ignores:(0,h.l4)(),userRec:{},teamState:void 0,resetIO:function(){},loadInfo:function(){var e=(0,a.Z)(o().mark((function e(){return o().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",!1);case 1:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),loadState:function(){var e=(0,a.Z)(o().mark((function e(){return o().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",!1);case 1:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),setIgnores:function(){},addTeamStatePage:function(e,t){}});function y(){var e,t=null!==(e=(0,p.UO)().noteID)&&void 0!==e?e:"",n=(0,u.useState)(),i=(0,r.Z)(n,2),c=i[0],l=i[1],d=(0,u.useState)(-2),y=(0,r.Z)(d,2),w=y[0],C=y[1],I=(0,u.useState)({}),P=(0,r.Z)(I,2),D=P[0],N=P[1],O=(0,u.useState)((0,h.l4)()),R=(0,r.Z)(O,2),E=R[0],T=R[1],F=(0,u.useState)(v(t)),M=(0,r.Z)(F,2),L=M[0],A=M[1],U=(0,u.useState)(!1),V=(0,r.Z)(U,2),z=V[0],W=V[1],K=(0,u.useState)(!1),X=(0,r.Z)(K,2),G=X[0],B=X[1],H=(0,p.s0)(),_=(0,u.useCallback)((0,a.Z)(o().mark((function e(){var n;return o().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,s.dn)(t);case 2:if(n=e.sent){e.next=6;break}return g.ZP.error("Failed loading the team note info"),e.abrupt("return",!1);case 6:return C(n.code),e.abrupt("return",!0);case 8:case"end":return e.stop()}}),e)}))),[t]),q=(0,u.useCallback)((0,a.Z)(o().mark((function e(){var n;return o().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,s.CD)(t);case 2:if(n=e.sent){e.next=6;break}return g.ZP.error("Failed loading the team note state"),e.abrupt("return",!1);case 6:return l(x.f.createFromTeamPages(n)),e.abrupt("return",!0);case 8:case"end":return e.stop()}}),e)}))),[t]),Y=(0,u.useCallback)((function(){(0,s.f1)(t)}),[t]);(0,u.useEffect)((function(){var e=function(){var e=(0,a.Z)(o().mark((function e(){var t,n;return o().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,_();case 2:return t=e.sent,e.next=5,q();case 5:if(n=e.sent,t&&n){e.next=8;break}return e.abrupt("return",H("/"));case 8:W(!0),Y();case 10:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}();return e(),Y}),[_,q,H,Y]),(0,u.useEffect)((function(){return L.on("push",(function(e){var t=e.operation,n=e.userID;l((function(e){return null===e||void 0===e?void 0:e.pushOperation(t,n)}))})),L.on("join",(function(e){var t=e.joined,n=e.members,r=t.userID,a=t.userName;N(n),r!==(0,f.VN)()&&S(r,a)})),L.on("leave",(function(e){var t=e.leaved,n=e.members,r=t.userID,a=t.userName;if(N(n),r===(0,f.VN)())return L.emit("join");b(r,a)})),L.on("newPage",(function(e){var t=e.pageID,n=e.newPage;l((function(e){return null===e||void 0===e?void 0:e.addPage(t,n)}))})),L.on("reset",(function(e){var t=e.userID,n=e.pageRec;t!==(0,f.VN)()&&l((function(e){return null===e||void 0===e?void 0:e.resetUser(t,n)}))})),L.on("connect_error",console.error),L.on("connect",(function(){return B(!0)})),L.on("disconnect",(function(){return B(!1)})),function(){L.removeAllListeners(),L.close()}}),[L]);return(0,j.jsx)(m.g,{loading:!z,children:(0,j.jsx)(k.Provider,{value:{io:L,code:w,teamOn:!0,ignores:E,userRec:D,connected:G,teamState:c,resetIO:function(){return A(v(t))},loadInfo:_,loadState:q,setIgnores:T,addTeamStatePage:function(e,t){l((function(n){return null===n||void 0===n?void 0:n.addPage(e,t)}))}},children:(0,j.jsx)(Z.default,{})})})}var S=function(e,t){g.ZP.destroy(e),g.ZP.success({content:"".concat(t," joined room"),icon:(0,j.jsx)(c.Z,{}),key:e})},b=function(e,t){g.ZP.destroy(e),g.ZP.warning({content:"".concat(t," leaved room"),icon:(0,j.jsx)(l.Z,{}),key:e})}}}]);
//# sourceMappingURL=752.4c3622cc.chunk.js.map