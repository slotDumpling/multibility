"use strict";(self.webpackChunkmultibility=self.webpackChunkmultibility||[]).push([[310,479],{24657:function(e,t,n){n.r(t),n.d(t,{ReaderMethodCtx:function(){return Qe},ReaderStateCtx:function(){return Je},default:function(){return $e}});var r=n(93433),a=n(1413),i=n(45987),o=n(29439),s=n(15861),u=n(87757),c=n.n(u),l=n(72791),d=n(92198),f=n(11886),p=n(81832),v=n(76807),x=n(95099),g=n(15671),m=n(43144),h=n(82670),Z=n(24124),j={states:(0,Z.D5)(),editStack:(0,Z.aV)(),undoStack:(0,Z.aV)()},k=(0,Z.WV)(j),b=function(){function e(t,n){(0,g.Z)(this,e),this.immutable=t,this.lastOp=n}return(0,m.Z)(e,[{key:"getImmutable",value:function(){return this.immutable}},{key:"getStates",value:function(){return this.getImmutable().get("states")}},{key:"getOneState",value:function(e){return this.getStates().get(e)}},{key:"getEditStack",value:function(){return this.getImmutable().get("editStack")}},{key:"getUndoStack",value:function(){return this.getImmutable().get("undoStack")}},{key:"setState",value:function(t,n){var r=this.getOneState(t);if(!r||r===n)return this;var i=this.getImmutable().update("states",(function(e){return e.set(t,n)})).update("editStack",(function(e){return e.push(t)})).delete("undoStack"),o=n.lastOp;return new e(i,o&&(0,a.Z)((0,a.Z)({},o),{},{pageID:t}))}},{key:"syncStrokeTime",value:function(e,t){var n=this.getOneState(e);return n&&h.Dw.syncStrokeTime(n,t),this}},{key:"addState",value:function(t,n){var r=n.state,a=n.ratio,i=h.Dw.loadFromFlat(r,a);return new e(this.getImmutable().update("states",(function(e){return e.set(t,i)})))}},{key:"deleteState",value:function(t){return new e(this.getImmutable().update("states",(function(e){return e.delete(t)})))}},{key:"isUndoable",value:function(){return this.getEditStack().size>0}},{key:"isRedoable",value:function(){return this.getUndoStack().size>0}},{key:"undo",value:function(){if(!this.isUndoable())return this;var t=this.getEditStack().last(),n=t&&this.getOneState(t);if(!n)return this;var r=h.Dw.undo(n),i=r.lastOp,o=i&&(0,a.Z)({pageID:t},i);return new e(this.getImmutable().update("editStack",(function(e){return e.pop()})).update("undoStack",(function(e){return e.push(t)})).update("states",(function(e){return e.set(t,r)})),o)}},{key:"redo",value:function(){if(!this.isRedoable())return this;var t=this.getUndoStack().last(),n=t&&this.getOneState(t);if(!n)return this;var r=h.Dw.redo(n),i=r.lastOp,o=i&&(0,a.Z)({pageID:t},i);return new e(this.getImmutable().update("undoStack",(function(e){return e.pop()})).update("editStack",(function(e){return e.push(t)})).update("states",(function(e){return e.set(t,r)})),o)}},{key:"getLastDS",value:function(){var e,t=null===(e=this.lastOp)||void 0===e?void 0:e.pageID,n=t&&this.getOneState(t);if(n)return[t,n]}}],[{key:"createFromPages",value:function(t){return new e(k().set("states",(0,Z.D5)(t).map((function(e){var t=e.state,n=e.ratio;return h.Dw.loadFromFlat(t,n)}))))}}]),e}(),S=n(75783),y=n(87309),w=n(50419),C=n(79286),I=n(80184),P=function(){var e=(0,l.useContext)(Qe).addFinalPage;return(0,I.jsx)("div",{className:"add-btn-wrapper",children:(0,I.jsx)(y.Z,{type:"dashed",icon:(0,I.jsx)(C.Z,{}),block:!0,onClick:e,children:"New page"})})},D=n(16871),N=n(96801),O=n(37762),R=n(61842),E=n.n(R)().createInstance({name:"scroll"});var T=function(e,t){var n,r="",a=0,i=(0,O.Z)(t);try{for(i.s();!(n=i.n()).done;){var o=n.value,s=e.get(o);if(s){if(1===s)return o;s>a&&(r=o,a=s)}}}catch(u){i.e(u)}finally{i.f()}return r},F=n(79930),L=n(82898);function M(e,t,n){var r=e.indexOf(t),a=e.slice();return-1===r||a.splice(r+1,0,n),a}var A=n(23414),V=n(82622),z=n(10711),U=n(96324),H=n(18780),K=n(2491),W=n(70140),X=n(69228),_=n(87661),G=n(52365),B=n(74115),q=function(e){var t=e.userInfo,n=e.size,r=void 0===n?"default":n,a=e.onClick,i=void 0===a?function(){}:a,o=e.chosen,s=void 0!==o&&o,u=e.className,c=(0,l.useMemo)((function(){return(0,B.bM)(t.userID)}),[t]);if(!t)return null;var d=t.userName;return(0,I.jsx)(K.C,{className:u,"data-chosen":s,size:r,style:{backgroundColor:c},children:(0,I.jsx)("div",{className:"avatar-wrapper",onClick:i,children:null===d||void 0===d?void 0:d.slice(0,3)})})},Y=n(22568),J=n(81694),Q=n.n(J),$=n(60559),ee=function(e){var t=e.left,n=(0,p.iX)(),r=(0,o.Z)(n,1)[0],i=(0,G.zI)(),s={ALL:"All Pages",MARKED:"Bookmarks",WRITTEN:"Notes"}[(0,o.Z)(i,1)[0]];return(0,I.jsx)(H._l,{draggableId:"CARD",index:t?0:1,children:function(e){var t=e.innerRef,n=e.draggableProps,i=e.dragHandleProps;return(0,I.jsxs)("div",(0,a.Z)((0,a.Z)({className:"preview-card",ref:t,"data-force-light":r},n),{},{children:[(0,I.jsx)("div",(0,a.Z)({className:"drag-handle"},i)),(0,I.jsx)("h3",{children:s}),(0,I.jsx)(oe,{}),(0,I.jsx)(te,{})]}))}})},te=function(){var e=(0,l.useContext)(Je),t=e.pageOrder,n=e.currPageID,r=(0,l.useContext)(Qe),i=r.scrollPage,s=r.saveReorder,u=(0,l.useRef)({}),c=(0,G.zI)(),d=(0,o.Z)(c,1)[0],f=(0,G.LH)(),p=(0,o.Z)(f,1)[0];return(0,l.useEffect)((function(){var e;p||null===(e=u.current[n])||void 0===e||e.scrollIntoView()}),[p,n]),(0,I.jsx)(H.Z5,{onDragEnd:function(e){var n=e.source,r=e.destination;if(r&&t){var a=n.index,u=r.index,c=t[a];if(a!==u&&c){var l=function(e,t,n){var r=e.slice(),a=r.splice(t,1),i=(0,o.Z)(a,1)[0];return i?(r.splice(n,0,i),r):e}(t,a,u);s(l,!0),requestAnimationFrame((function(){return i(c)}))}}},children:(0,I.jsx)(H.bK,{droppableId:"preview-list",children:function(e){var n=e.droppableProps,r=e.innerRef,i=e.placeholder;return(0,I.jsxs)("div",(0,a.Z)((0,a.Z)({className:"page-list",ref:r},n),{},{children:[null===t||void 0===t?void 0:t.map((function(e,t){return(0,I.jsx)(ne,{uid:e,pageIndex:t,refRec:u.current},e)})),i,"ALL"===d&&(0,I.jsx)(P,{})]}))}})})},ne=function(e){var t=e.uid,n=e.pageIndex,r=e.refRec,i=(0,l.useContext)(Je),s=i.stateSet,u=i.pageRec,c=i.currPageID,d=(0,l.useContext)($.TeamCtx),f=d.teamState,p=d.ignores,v=(0,l.useContext)(Qe).scrollPage,x=(0,G.zI)(),g=(0,o.Z)(x,1)[0],m=(0,l.useState)(""),h=(0,o.Z)(m,2),Z=h[0],j=h[1],k=null===u||void 0===u?void 0:u.get(t),b=null===s||void 0===s?void 0:s.getOneState(t),S=null===f||void 0===f?void 0:f.getOnePageStateMap(t);if(!k||!b)return null;var y=k.image,w=k.marked;if("WRITTEN"===g&&b.isEmpty()&&(!S||S.every((function(e){return e.isEmpty()}))))return null;if("MARKED"===g&&!w)return null;var C=c===t;return(0,I.jsx)(H._l,{draggableId:t,index:n,isDragDisabled:"ALL"!==g,children:function(e,i){var o=e.innerRef,s=e.draggableProps,u=e.dragHandleProps,c=i.isDragging;return(0,I.jsxs)("div",(0,a.Z)((0,a.Z)((0,a.Z)({ref:function(e){o(e),e&&(r[t]=e)},className:"page","data-curr":C,"data-dragged":c,onClick:function(){return v(t)}},s),u),{},{children:[(0,I.jsx)(N.default,{drawState:(null===S||void 0===S?void 0:S.get(Z))||b,teamStateMap:Z?void 0:S,thumbnail:y,ignores:p,preview:!0}),(0,I.jsx)(re,{uid:t,index:n,chosen:Z,setChosen:j})]}))}})},re=function(e){var t=e.uid,n=e.index,r=e.chosen,a=e.setChosen,i=(0,l.useContext)(Qe).switchPageMarked,o=(0,l.useContext)(Je).pageRec,s=(0,l.useContext)($.TeamCtx),u=s.ignores,c=s.teamState,d=(0,l.useMemo)((function(){return(null===c||void 0===c?void 0:c.getPageValidUsers(t).filter((function(e){return!u.has(e)})))||[]}),[c,u,t]),f=null===o||void 0===o?void 0:o.get(t);if(!f)return null;var p=f.marked;return(0,I.jsxs)("div",{className:"tools",onClick:function(e){return e.stopPropagation()},children:[(0,I.jsx)("div",{className:"bookmark","data-marked":p,onClick:function(){return i(t)}}),(0,I.jsx)("div",{className:"index",children:n+1}),(0,I.jsx)(ie,{uid:t}),(0,I.jsx)(ae,{userIDs:d,chosen:r,setChosen:a})]})},ae=function(e){var t=e.userIDs,n=e.chosen,r=e.setChosen,a=(0,l.useContext)($.TeamCtx).userRec;return(0,I.jsx)(K.C.Group,{maxCount:2,size:"default",className:Q()("team-group",{chosen:n}),maxPopoverPlacement:"bottom",children:t.map((function(e){var t=a[e];return t?(0,I.jsx)(q,{size:"default",userInfo:t,className:"preview-avatar",chosen:n===e,onClick:function(){return r((function(t){return t===e?"":e}))}},e):null}))})},ie=function(e){var t=e.uid,n=(0,l.useContext)(Qe),r=n.addPage,a=n.deletePage,i=(0,I.jsx)(W.Z,{onClick:function(e){var n=e.key;"ADD"===n?r(t):"COPY"===n?r(t,!0):"DELETE"===n&&a(t)},items:[{key:"ADD",icon:(0,I.jsx)(C.Z,{}),label:"Add page"},{key:"COPY",icon:(0,I.jsx)(A.Z,{}),label:"Duplicate"},{key:"DELETE",icon:(0,I.jsx)(V.Z,{}),label:"Delete",danger:!0}]});return(0,I.jsx)(X.Z,{content:i,trigger:"click",placement:"left",destroyTooltipOnHide:!0,children:(0,I.jsx)("div",{className:"option",children:(0,I.jsx)(z.Z,{})})})},oe=function(){var e=(0,G.zI)(),t=(0,o.Z)(e,2),n=t[0],r=t[1],a=_.Z.TabPane;return(0,I.jsxs)(_.Z,{className:"tabs",activeKey:n,onChange:r,tabBarGutter:0,size:"small",centered:!0,children:[(0,I.jsx)(a,{tab:(0,I.jsx)(Y.Z,{type:"icon-uf_paper"})},"ALL"),(0,I.jsx)(a,{tab:(0,I.jsx)(Y.Z,{type:"icon-bookmark2"})},"MARKED"),(0,I.jsx)(a,{tab:(0,I.jsx)(Y.Z,{type:"icon-write"})},"WRITTEN")]})},se=function(){var e=(0,l.useState)(!1),t=(0,o.Z)(e,2),n=t[0],r=t[1],i=(0,G.LH)(),s=(0,o.Z)(i,1)[0],u=(0,I.jsx)(ee,{left:n},"preview-drag"),c=(0,I.jsx)(H._l,{draggableId:"opposite",index:n?1:0,children:function(e){var t=e.innerRef,n=e.draggableProps,r=e.dragHandleProps;return(0,I.jsx)("div",(0,a.Z)((0,a.Z)({className:"opposite",ref:t},n),r))}},"opposite");return(0,I.jsx)(G.s2,{initKey:"ALL",children:(0,I.jsx)(H.Z5,{onDragEnd:function(e){var t=e.draggableId,n=e.destination;"CARD"===t&&(0===(null===n||void 0===n?void 0:n.index)&&r(!0),1===(null===n||void 0===n?void 0:n.index)&&r(!1))},children:(0,I.jsx)(H.bK,{droppableId:"preview-drop",direction:"horizontal",children:function(e){var t=e.droppableProps,r=e.innerRef,i=e.placeholder;return(0,I.jsxs)("div",(0,a.Z)((0,a.Z)({className:"preview-drop","data-left":n,"data-open":s,ref:r},t),{},{children:[n?[u,c]:[c,u],i]}))}})})})},ue=function(){var e=(0,G.LH)(),t=(0,o.Z)(e,2)[1];return(0,I.jsx)(y.Z,{type:"text",icon:(0,I.jsx)(U.Z,{}),onClick:function(){return t((function(e){return!e}))}})},ce=n(52242),le=n(65323),de=function(e){var t=e.saved,n=e.instantSave,r=(0,D.s0)();return(0,I.jsxs)("div",{className:"left",children:[(0,I.jsx)(y.Z,{type:"text",onClick:(0,s.Z)(c().mark((function e(){return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n();case 2:r("/");case 3:case"end":return e.stop()}}),e)}))),icon:(0,I.jsx)(ce.Z,{style:{opacity:.8}})}),(0,I.jsx)(y.Z,{type:"text",className:"save",onClick:n,disabled:t,icon:(0,I.jsx)(le.Z,{})})]})},fe=n(78985),pe=n(78030),ve=n(50446),xe=n(74006),ge=n(52542),me=n(62),he=n(14965),Ze=n(48),je=function(e){var t=e.handleUndo,n=e.handleRedo,r=(0,l.useContext)(Je).stateSet,a=(0,f.gX)(),i=a.mode,s=a.finger,u=(0,f.F7)(),c=(0,p.iX)(),d=(0,o.Z)(c,2),v=d[0],x=d[1];return(0,I.jsxs)("div",{className:"middle",children:[(0,I.jsx)(y.Z,{type:"text",shape:"circle",icon:(0,I.jsx)(pe.Z,{}),onClick:t,disabled:!(null!==r&&void 0!==r&&r.isUndoable())}),(0,I.jsx)(y.Z,{type:"text",shape:"circle",icon:(0,I.jsx)(ve.Z,{}),onClick:n,disabled:!(null!==r&&void 0!==r&&r.isRedoable())}),(0,I.jsx)(y.Z,{type:s?"default":"text",shape:"circle",onClick:function(){u({finger:!s}),w.ZP.destroy("FINGER"),w.ZP.open({content:s?"Pencil only":"Draw with finger",key:"FINGER"})},icon:(0,I.jsx)(Y.Z,{type:"icon-finger"})}),(0,I.jsx)(y.Z,{className:"force-light-btn",type:"text",shape:"circle",icon:v?(0,I.jsx)(xe.Z,{}):(0,I.jsx)(ge.Z,{}),onClick:function(){return x((function(e){return!e}))}}),(0,I.jsx)(ke,{}),(0,I.jsx)(be,{}),(0,I.jsx)(y.Z,{type:"text"===i?"default":"text",shape:"circle",onClick:function(){return u({mode:"text"})},icon:(0,I.jsx)(Y.Z,{type:"icon-text1"})}),(0,I.jsx)(Se,{})]})},ke=function(){var e=(0,f.gX)(),t=(0,f.F7)(),n={shape:"circle",icon:(0,I.jsx)(me.Z,{})};return"draw"===e.mode?(0,I.jsx)(X.Z,{content:(0,I.jsx)(Ze.Uk,{updateDrawCtrl:t,drawCtrl:e}),trigger:"click",placement:"bottom",getPopupContainer:function(e){return e.parentElement},destroyTooltipOnHide:!0,children:(0,I.jsx)(y.Z,(0,a.Z)({type:"default"},n))}):(0,I.jsx)(y.Z,(0,a.Z)({type:"text",onClick:function(){return t({mode:"draw"})}},n))},be=function(){var e=(0,f.gX)(),t=e.mode,n=e.pixelEraser,r=(0,f.F7)(),i={shape:"circle",icon:(0,I.jsx)(Y.Z,{type:"icon-eraser"})};return"erase"===t?(0,I.jsx)(X.Z,{content:(0,I.jsxs)("div",{className:"width-seg-wrapper",children:[(0,I.jsx)(fe.Z,{block:!0,size:"small",className:"pixel-seg",options:["Pixel","Object"],value:n?"Pixel":"Object",onChange:function(e){r("Pixel"===e?{pixelEraser:!0}:{pixelEraser:!1})}}),(0,I.jsx)(Ze.Db,{drawCtrl:e,updateDrawCtrl:r,field:"eraserWidth"})]}),trigger:"click",placement:"bottom",getPopupContainer:function(e){return e.parentElement},destroyTooltipOnHide:!0,children:(0,I.jsx)(y.Z,(0,a.Z)({type:"default"},i))}):(0,I.jsx)(y.Z,(0,a.Z)({type:"text",onClick:function(){return r({mode:"erase"})}},i))},Se=function(){var e=(0,f.gX)(),t=e.lasso,n=e.mode,r=(0,f.F7)(),a=t?(0,I.jsx)(Y.Z,{type:"icon-lasso1"}):(0,I.jsx)(he.Z,{});return"select"===n?(0,I.jsx)(y.Z,{type:"default",shape:"circle",icon:a,onClick:function(){return r({lasso:!t})}}):(0,I.jsx)(y.Z,{type:"text",shape:"circle",icon:a,onClick:function(){return r({mode:"select"})}})},ye=n(49142),we=n(90785),Ce=n(91333),Ie=n(75594),Pe=n(461),De=n(95055),Ne=n(67415),Oe=n(69951),Re=n(67575),Ee=n(30501),Te=n(98272),Fe=n(24215),Le=n(17973),Me=n(19951),Ae=n(23605),Ve=n(56200),ze=n(18301),Ue=n(51570),He=n(1829),Ke=n.n(He),We=function(e){var t=e.instantSave,n=(0,l.useContext)($.TeamCtx).teamOn;return(0,I.jsxs)("div",{className:"right",children:[n?(0,I.jsx)(_e,{}):(0,I.jsx)(Ge,{instantSave:t}),(0,I.jsx)(ue,{})]})},Xe=function(e){var t=e.userID,n=(0,l.useState)(!1),r=(0,o.Z)(n,2),a=r[0],i=r[1],s=(0,l.useContext)($.TeamCtx),u=s.ignores,c=s.setIgnores,d=s.resetIO,f=s.userRec[t];if((0,l.useEffect)((function(){return i(!1)}),[f]),!f)return null;var p=f.userName,v=f.online,x=t===(0,Oe.VN)(),g=u.has(t)&&!x;return(0,I.jsxs)("div",{className:"user-item","data-online":v,children:[(0,I.jsx)(q,{userInfo:f,size:"small",className:"room-avatar"}),a||(0,I.jsx)("span",{className:"user-name",children:p}),a&&(0,I.jsx)(De.Z,{autoFocus:!0,className:"rename-input",defaultValue:p,onSearch:function(e){var t=e.trim();if(!t||t===p)return i(!1);(0,Oe.lu)(t),d()},enterButton:(0,I.jsx)(y.Z,{icon:(0,I.jsx)(Re.Z,{})})}),x?a||(0,I.jsx)(y.Z,{type:"text",icon:(0,I.jsx)(Ee.Z,{}),onClick:function(){return i(!0)}}):(0,I.jsx)(y.Z,{type:"text",icon:g?(0,I.jsx)(Te.Z,{}):(0,I.jsx)(Fe.Z,{}),onClick:function(){c((function(e){return e.has(t)?e.delete(t):e.add(t)}))}})]})},_e=function(){var e=(0,l.useContext)($.TeamCtx),t=e.code,n=e.userRec,a=e.connected,u=e.loadInfo,d=e.loadState,f=e.resetIO,p=(0,l.useContext)(Je).noteInfo,v=window.location.href,x=function(){var e=(0,s.Z)(c().mark((function e(){var t,r;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=null===(t=n[(0,Oe.VN)()])||void 0===t?void 0:t.userName,e.prev=1,p){e.next=4;break}return e.abrupt("return");case 4:return e.next=6,Ke()("".concat(p.name," - ").concat(r," - Multibility\n").concat(v));case 6:w.ZP.destroy("copy"),w.ZP.success({content:"Link copied!",icon:(0,I.jsx)(A.Z,{}),key:"copy"}),e.next=13;break;case 10:e.prev=10,e.t0=e.catch(1),console.log(e.t0);case 13:case"end":return e.stop()}}),e,null,[[1,10]])})));return function(){return e.apply(this,arguments)}}(),g=(0,l.useMemo)((function(){var e=(0,Oe.VN)(),t=n[e],a=(0,i.Z)(n,[e].map(ye.Z)),o=t?[t]:[],s=Object.values(a);return o.push.apply(o,(0,r.Z)(s.filter((function(e){return e.online}))).concat((0,r.Z)(s.filter((function(e){return!e.online}))))),o}),[n]),m=(0,l.useMemo)((function(){return g.filter((function(e){return e.online})).length}),[g]),h=(0,I.jsxs)("div",{className:"team-popover",children:[a||(0,I.jsx)(we.Z,{className:"disconn-alert",message:"Network failed.",icon:(0,I.jsx)(Le.Z,{}),type:"error",showIcon:!0,banner:!0}),(0,I.jsx)(Ne.GD,{className:"code-display",value:String(t),length:4,plain:!0}),(0,I.jsx)(y.Z,{icon:(0,I.jsx)(Me.Z,{}),className:"share-btn",onClick:x,block:!0,children:"Share"}),(0,I.jsx)(Ce.Z,{}),(0,I.jsx)("div",{className:"user-list",children:g.map((function(e){return(0,I.jsx)(Xe,{userID:e.userID},e.userID)}))})]}),Z=(0,l.useState)(!1),j=(0,o.Z)(Z,2),k=j[0],b=j[1],S=(0,I.jsxs)("div",{className:"team-title",children:[(0,I.jsx)("span",{children:"Team info"}),(0,I.jsx)(y.Z,{shape:"circle",type:"text",size:"small",loading:k,icon:(0,I.jsx)(Ae.Z,{}),onClick:(0,s.Z)(c().mark((function e(){return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return b(!0),e.next=3,u();case 3:return e.next=5,d();case 5:b(!1),f();case 7:case"end":return e.stop()}}),e)})))})]});return(0,I.jsx)(X.Z,{content:h,trigger:"click",placement:"bottomRight",title:S,getPopupContainer:function(e){return e.parentElement},children:(0,I.jsx)(y.Z,{type:"text",icon:(0,I.jsx)(Ie.Z,{status:a?"success":"error",count:a?m:"!",size:"small",children:(0,I.jsx)(Ve.Z,{})})})})},Ge=function(e){var t=e.instantSave,n=(0,l.useContext)(Je).noteID,r=(0,D.s0)(),a=function(){var e=(0,s.Z)(c().mark((function e(){return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t();case 2:return e.next=4,(0,Ue.r8)(n);case 4:if(e.sent){e.next=7;break}return e.abrupt("return",w.ZP.error("Can't create room."));case 7:return e.next=9,(0,S.SP)(n,{team:!0});case 9:r("/team/"+n);case 10:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}();return(0,I.jsx)(y.Z,{type:"text",icon:(0,I.jsx)(ze.Z,{}),onClick:function(){Pe.Z.confirm({title:"Enable team editing",content:"This will make your note public to anyone with the link.",icon:(0,I.jsx)(Ve.Z,{style:{color:"#555"}}),onOk:a})}})},Be=function(e){var t=e.saved,n=e.handleUndo,r=e.handleRedo,a=e.instantSave;return(0,I.jsxs)("header",{children:[(0,I.jsx)(de,{saved:t,instantSave:a}),(0,I.jsx)(je,{handleUndo:n,handleRedo:r}),(0,I.jsx)(We,{instantSave:a})]})},qe=["pageRec","pdf","pageOrder"],Ye=["image","marked"],Je=l.createContext({noteID:"",currPageID:""}),Qe=l.createContext({scrollPage:function(e){},switchPageMarked:function(e){},addPage:function(e,t){},addFinalPage:function(){},deletePage:function(e){},saveReorder:function(){var e=(0,s.Z)(c().mark((function e(t,n){return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}()});function $e(){var e,t=null!==(e=(0,D.UO)().noteID)&&void 0!==e?e:"",n=(0,D.s0)(),u=(0,l.useState)(),g=(0,o.Z)(u,2),m=g[0],j=g[1],k=(0,l.useState)(),C=(0,o.Z)(k,2),N=C[0],O=C[1],R=(0,l.useState)(),A=(0,o.Z)(R,2),V=A[0],z=A[1],U=(0,l.useState)(),H=(0,o.Z)(U,2),K=H[0],W=H[1],X=(0,v.Z)(!0),_=(0,o.Z)(X,2),B=_[0],q=_[1],Y=(0,l.useContext)($.TeamCtx),J=Y.io,Q=Y.teamOn,ee=Y.addTeamStatePage,te=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=(0,l.useState)((0,Z.D5)()),r=(0,o.Z)(n,2),a=r[0],i=r[1],u=(0,l.useRef)(!1),d=(0,l.useState)(""),f=(0,o.Z)(d,2),p=f[0],v=f[1],x=(0,l.useState)((0,Z.D5)()),g=(0,o.Z)(x,2),m=g[0],h=g[1],j=(0,l.useMemo)((function(){return T(m,t)}),[m,t]);return(0,l.useDebugValue)(j),(0,l.useEffect)((function(){(0,s.Z)(c().mark((function t(){var n;return c().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,E.getItem(e);case 2:if(n=t.sent){t.next=5;break}return t.abrupt("return",u.current=!0);case 5:v(n);case 6:case"end":return t.stop()}}),t)})))()}),[e]),(0,l.useEffect)((function(){!u.current&&a.has(p)&&requestAnimationFrame((function(){var e;null===(e=a.get(p))||void 0===e||e.scrollIntoView(),u.current=!0}))}),[p,a]),(0,l.useEffect)((function(){u.current&&E.setItem(e,j)}),[e,j]),{scrollPage:function(e){var t;null===(t=a.get(e))||void 0===t||t.scrollIntoView()},setInviewRatios:h,sectionRef:function(e){return function(t){t&&i((function(n){return n.set(e,t)}))}},currPageID:j}}(t,K),ne=te.setInviewRatios,re=te.scrollPage,ae=te.sectionRef,ie=te.currPageID;(0,l.useEffect)((function(){(0,s.Z)(c().mark((function e(){var r,a,o,s;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,S.U9)(t);case 2:if(r=e.sent){e.next=6;break}return w.ZP.error("Note not found"),e.abrupt("return",n("/"));case 6:a=r.pageRec,r.pdf,o=r.pageOrder,s=(0,i.Z)(r,qe),j((0,Z.D5)(a)),W(o),O(s),z(b.createFromPages(a));case 11:case"end":return e.stop()}}),e)})))()}),[n,t,Q]),(0,l.useEffect)((function(){N&&(document.title=N.name+" - Multibility")}),[N]);var oe=(0,x.Z)((0,s.Z)(c().mark((function e(){var n;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=null===m||void 0===m?void 0:m.toObject(),e.next=3,(0,S.SP)(t,{pageRec:n});case 3:q(!0);case 4:case"end":return e.stop()}}),e)})))),ue=(0,l.useCallback)((0,F.Z)(oe,2e3),[oe]),ce=ue.flush,le=function(e,t){j((function(n){return null===n||void 0===n?void 0:n.update(e,d.BJ,t)})),q(!1),ue()},de=function(){var e=(0,s.Z)(c().mark((function e(n){var r,a=arguments;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=a.length>1&&void 0!==a[1]&&a[1],W(n),e.next=4,(0,S.SP)(t,{pageOrder:n});case 4:return e.next=6,ce();case 6:r&&fe(n);case 7:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),fe=function(e){return null===J||void 0===J?void 0:J.emit("reorder",{pageOrder:e})},pe=(0,x.Z)((function(e){var t,n=e.deleted,r=e.pageOrder,a=e.prevOrder;(de(r),n)&&(t=function(){return de(a,!0)},w.ZP.warning({content:(0,I.jsxs)(I.Fragment,{children:["One page was deleted.",(0,I.jsx)(y.Z,{size:"small",type:"link",onClick:function(){w.ZP.destroy("DELETE"),t()},children:"Undo"})]}),key:"DELETE",duration:10}))})),ve=(0,x.Z)((function(e){var t=e.pageOrder,n=e.pageID,r=e.newPage;de(t),le(n,(function(){return r})),z((function(e){return null===e||void 0===e?void 0:e.addState(n,r)}))}));(0,l.useEffect)((function(){return null===J||void 0===J||J.on("reorder",pe),null===J||void 0===J||J.on("newPage",ve),function(){null===J||void 0===J||J.removeAllListeners()}}),[J,pe,ve]);var xe=function(e,t,n){n.image,n.marked;var r=(0,i.Z)(n,Ye);null===J||void 0===J||J.emit("newPage",{pageOrder:e,pageID:t,newPage:r}),ee(t,n)},ge=function(e,t){var n=h.Dw.flaten(t);le(e,(function(e){return(0,a.Z)((0,a.Z)({},e),{},{state:n})}))},me=function(e){if(V){var t=e(V);if(t!==V){z(t);var n,a=t.getLastDS(),i=t.lastOp;if(a&&i)ge.apply(void 0,(0,r.Z)(a)),n=i,null===J||void 0===J||J.emit("push",{operation:n},(function(e){var t=e.pageID,n=e.stroke;return z((function(e){return null===e||void 0===e?void 0:e.syncStrokeTime(t,n)}))}))}}},he=function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(K){var n=t?null===m||void 0===m?void 0:m.get(e):void 0,r=(0,d.D4)(n),a=(0,o.Z)(r,2),i=a[0],s=a[1],u=M(K,e,i);xe(u,i,s),de(u),le(i,(function(){return s})),z((function(e){return null===e||void 0===e?void 0:e.addState(i,s)}))}},Ze=(0,I.jsxs)("div",{className:"reader container",children:[(0,I.jsx)(Be,{saved:B,instantSave:ce,handleUndo:function(){return me((function(e){return e.undo()}))},handleRedo:function(){return me((function(e){return e.redo()}))}}),(0,I.jsxs)("main",{children:[null===K||void 0===K?void 0:K.map((function(e){return(0,I.jsx)("section",{className:"note-page",ref:ae(e),children:(0,I.jsx)(et,{uid:e,updateStateSet:me,setInviewRatios:ne})},e)})),(0,I.jsx)(P,{})]}),(0,I.jsx)(se,{})]});return(0,I.jsx)(p.Wk,{children:(0,I.jsx)(Je.Provider,{value:{noteID:t,pageRec:m,noteInfo:N,stateSet:V,pageOrder:K,currPageID:ie},children:(0,I.jsx)(Qe.Provider,{value:{addPage:he,scrollPage:re,deletePage:function(e){var t=null===K||void 0===K?void 0:K.filter((function(t){return t!==e}));(null===t||void 0===t?void 0:t.length)&&de(t,!0)},saveReorder:de,addFinalPage:function(){var e=(0,L.Z)(K);e&&he(e)},switchPageMarked:function(e){return le(e,(function(e){return(0,a.Z)((0,a.Z)({},e),{},{marked:!e.marked})}))}},children:(0,I.jsx)(f.w3,{children:(0,I.jsx)(G.kV,{children:Ze})})})})})}var et=function(e){var t=e.uid,n=e.updateStateSet,r=e.setInviewRatios,a=(0,l.useContext)(Je),i=a.pageRec,o=a.stateSet,s=a.currPageID,u=a.pageOrder,c=a.noteID,d=(0,l.useContext)($.TeamCtx),f=d.teamState,p=d.ignores,v=null===i||void 0===i?void 0:i.get(t),x=null===o||void 0===o?void 0:o.getOneState(t),g=null===f||void 0===f?void 0:f.getOnePageStateMap(t),m=(0,l.useMemo)((function(){if(!u)return!1;var e=u.indexOf(s),n=u.indexOf(t);return Math.abs(n-e)<=1}),[s,t,u]);return v&&x?(0,I.jsx)(N.default,{drawState:x,teamStateMap:g,updateState:function(e){n((function(n){return n.setState(t,e)}))},pdfIndex:v.pdfIndex,noteID:c,ignores:p,onViewChange:function(e,n){if(!e)return r((function(e){return e.delete(t)}));r((function(e){return e.set(t,n)}))},preload:m}):null}},60559:function(e,t,n){n.r(t),n.d(t,{TeamCtx:function(){return k},default:function(){return b}});var r=n(29439),a=n(15861),i=n(87757),o=n.n(i),s=n(72791),u=n(51570),c=n(56058),l=n(87962),d=n(78577),f=n(69951),p=function(e){return function(){return(0,d.io)(u._n,{query:{userID:(0,f.VN)(),userName:(0,f.vW)(),noteID:e}})}},v=n(16871),x=n(79856),g=n(91835),m=n(50419),h=n(24124),Z=n(24657),j=n(80184),k=s.createContext({io:void 0,code:0,teamOn:!1,connected:!1,ignores:(0,h.l4)(),userRec:{},teamState:void 0,resetIO:function(){},loadInfo:function(){var e=(0,a.Z)(o().mark((function e(){return o().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",!1);case 1:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),loadState:function(){var e=(0,a.Z)(o().mark((function e(){return o().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",!1);case 1:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),setIgnores:function(){},addTeamStatePage:function(e,t){}});function b(){var e,t=null!==(e=(0,v.UO)().noteID)&&void 0!==e?e:"",n=(0,s.useState)(),i=(0,r.Z)(n,2),c=i[0],l=i[1],d=(0,s.useState)(-2),b=(0,r.Z)(d,2),w=b[0],C=b[1],I=(0,s.useState)({}),P=(0,r.Z)(I,2),D=P[0],N=P[1],O=(0,s.useState)((0,h.l4)()),R=(0,r.Z)(O,2),E=R[0],T=R[1],F=(0,s.useState)(p(t)),L=(0,r.Z)(F,2),M=L[0],A=L[1],V=(0,s.useState)(!1),z=(0,r.Z)(V,2),U=z[0],H=z[1],K=(0,s.useState)(!1),W=(0,r.Z)(K,2),X=W[0],_=W[1],G=(0,v.s0)(),B=(0,s.useCallback)((0,a.Z)(o().mark((function e(){var n;return o().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,u.dn)(t);case 2:if(n=e.sent){e.next=6;break}return m.ZP.error("Failed loading the team note info"),e.abrupt("return",!1);case 6:return C(n.code),e.abrupt("return",!0);case 8:case"end":return e.stop()}}),e)}))),[t]),q=(0,s.useCallback)((0,a.Z)(o().mark((function e(){var n;return o().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,u.CD)(t);case 2:if(n=e.sent){e.next=6;break}return m.ZP.error("Failed loading the team note state"),e.abrupt("return",!1);case 6:return l(x.f.createFromTeamPages(n)),e.abrupt("return",!0);case 8:case"end":return e.stop()}}),e)}))),[t]),Y=(0,s.useCallback)((function(){(0,u.f1)(t)}),[t]);(0,s.useEffect)((function(){var e=function(){var e=(0,a.Z)(o().mark((function e(){var t,n;return o().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,B();case 2:return t=e.sent,e.next=5,q();case 5:if(n=e.sent,t&&n){e.next=8;break}return e.abrupt("return",G("/"));case 8:H(!0),Y();case 10:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}();return e(),Y}),[B,q,G,Y]),(0,s.useEffect)((function(){return M.on("push",(function(e){var t=e.operation,n=e.userID;l((function(e){return null===e||void 0===e?void 0:e.pushOperation(t,n)}))})),M.on("join",(function(e){var t=e.joined,n=e.members,r=t.userID,a=t.userName;N(n),r!==(0,f.VN)()&&S(r,a)})),M.on("leave",(function(e){var t=e.leaved,n=e.members,r=t.userID,a=t.userName;if(N(n),r===(0,f.VN)())return M.emit("join");y(r,a)})),M.on("newPage",(function(e){var t=e.pageID,n=e.newPage;l((function(e){return null===e||void 0===e?void 0:e.addPage(t,n)}))})),M.on("reset",(function(e){var t=e.userID,n=e.pageRec;t!==(0,f.VN)()&&l((function(e){return null===e||void 0===e?void 0:e.resetUser(t,n)}))})),M.on("connect_error",console.error),M.on("connect",(function(){return _(!0)})),M.on("disconnect",(function(){return _(!1)})),function(){M.removeAllListeners(),M.close()}}),[M]);return(0,j.jsx)(g.g,{loading:!U,children:(0,j.jsx)(k.Provider,{value:{io:M,code:w,teamOn:!0,ignores:E,userRec:D,connected:X,teamState:c,resetIO:function(){return A(p(t))},loadInfo:B,loadState:q,setIgnores:T,addTeamStatePage:function(e,t){l((function(n){return null===n||void 0===n?void 0:n.addPage(e,t)}))}},children:(0,j.jsx)(Z.default,{})})})}var S=function(e,t){m.ZP.destroy(e),m.ZP.success({content:"".concat(t," joined room"),icon:(0,j.jsx)(c.Z,{}),key:e})},y=function(e,t){m.ZP.destroy(e),m.ZP.warning({content:"".concat(t," leaved room"),icon:(0,j.jsx)(l.Z,{}),key:e})}}}]);
//# sourceMappingURL=310.46a72751.chunk.js.map