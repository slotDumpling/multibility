"use strict";(self.webpackChunkmultibility=self.webpackChunkmultibility||[]).push([[310,479],{24657:function(e,t,n){n.r(t),n.d(t,{ReaderMethodCtx:function(){return tt},ReaderStateCtx:function(){return et},default:function(){return nt}});var r=n(93433),a=n(1413),i=n(45987),o=n(29439),u=n(15861),s=n(87757),c=n.n(s),l=n(72791),d=n(92198),f=n(11886),p=n(81832),v=n(76807),x=n(95099),g=n(15671),m=n(43144),h=n(82670),Z=n(24124),j={states:(0,Z.D5)(),editStack:(0,Z.aV)(),undoStack:(0,Z.aV)()},k=(0,Z.WV)(j),b=function(){function e(t,n){(0,g.Z)(this,e),this.immutable=t,this.lastOp=n}return(0,m.Z)(e,[{key:"getImmutable",value:function(){return this.immutable}},{key:"getStates",value:function(){return this.getImmutable().get("states")}},{key:"getOneState",value:function(e){return this.getStates().get(e)}},{key:"getEditStack",value:function(){return this.getImmutable().get("editStack")}},{key:"getUndoStack",value:function(){return this.getImmutable().get("undoStack")}},{key:"setState",value:function(t,n){var r=this.getOneState(t);if(!r||r===n)return this;var i=this.getImmutable().update("states",(function(e){return e.set(t,n)})).update("editStack",(function(e){return e.push(t)})).delete("undoStack"),o=n.lastOp;return new e(i,o&&(0,a.Z)((0,a.Z)({},o),{},{pageID:t}))}},{key:"syncStrokeTime",value:function(e,t){var n=this.getOneState(e);return n&&h.Dw.syncStrokeTime(n,t),this}},{key:"addState",value:function(t,n){var r=n.state,a=n.ratio,i=h.Dw.loadFromFlat(r,a);return new e(this.getImmutable().update("states",(function(e){return e.set(t,i)})))}},{key:"deleteState",value:function(t){return new e(this.getImmutable().update("states",(function(e){return e.delete(t)})))}},{key:"isUndoable",value:function(){return this.getEditStack().size>0}},{key:"isRedoable",value:function(){return this.getUndoStack().size>0}},{key:"undo",value:function(){if(!this.isUndoable())return this;var t=this.getEditStack().last(),n=t&&this.getOneState(t);if(!n)return this;var r=h.Dw.undo(n),i=r.lastOp,o=i&&(0,a.Z)({pageID:t},i);return new e(this.getImmutable().update("editStack",(function(e){return e.pop()})).update("undoStack",(function(e){return e.push(t)})).update("states",(function(e){return e.set(t,r)})),o)}},{key:"redo",value:function(){if(!this.isRedoable())return this;var t=this.getUndoStack().last(),n=t&&this.getOneState(t);if(!n)return this;var r=h.Dw.redo(n),i=r.lastOp,o=i&&(0,a.Z)({pageID:t},i);return new e(this.getImmutable().update("undoStack",(function(e){return e.pop()})).update("editStack",(function(e){return e.push(t)})).update("states",(function(e){return e.set(t,r)})),o)}},{key:"getLastDS",value:function(){var e,t=null===(e=this.lastOp)||void 0===e?void 0:e.pageID,n=t&&this.getOneState(t);if(n)return[t,n]}}],[{key:"createFromPages",value:function(t){return new e(k().set("states",(0,Z.D5)(t).map((function(e){var t=e.state,n=e.ratio;return h.Dw.loadFromFlat(t,n)}))))}}]),e}(),S=n(75783),w=n(87309),y=n(50419),C=n(79286),I=n(80184),P=function(){var e=(0,l.useContext)(tt).addFinalPage;return(0,I.jsx)("div",{className:"add-btn-wrapper",children:(0,I.jsx)(w.Z,{type:"dashed",icon:(0,I.jsx)(C.Z,{}),block:!0,onClick:e,children:"New page"})})},D=n(16871),N=n(96801),R=n(37762),O=n(61842),E=n.n(O)().createInstance({name:"scroll"});var T=function(e,t){var n,r="",a=0,i=(0,R.Z)(t);try{for(i.s();!(n=i.n()).done;){var o=n.value,u=e.get(o);if(u){if(1===u)return o;u>a&&(r=o,a=u)}}}catch(s){i.e(s)}finally{i.f()}return r},L=n(79930),F=n(82898);function M(e,t,n){var r=e.indexOf(t),a=e.slice();return-1===r||a.splice(r+1,0,n),a}var A=n(23414),V=n(82622),z=n(10711),U=n(18780),H=n(2491),K=n(70140),W=n(69228),X=n(87661),_=n(52365),G=n(74115),B=function(e){var t=e.userInfo,n=e.size,r=void 0===n?"default":n,a=e.onClick,i=void 0===a?function(){}:a,o=e.chosen,u=void 0!==o&&o,s=e.className,c=(0,l.useMemo)((function(){return(0,G.bM)(t.userID)}),[t]);if(!t)return null;var d=t.userName;return(0,I.jsx)(H.C,{className:s,"data-chosen":u,size:r,style:{backgroundColor:c},children:(0,I.jsx)("div",{className:"avatar-wrapper",onClick:i,children:null===d||void 0===d?void 0:d.slice(0,3)})})},q=n(22568),J=n(81694),Q=n.n(J),Y=n(60559),$=n(13892),ee=["ref"],te=function(e){var t=e.left,n=(0,_.zI)(),r=(0,o.Z)(n,1)[0],u=(0,_.LH)(),s=(0,o.Z)(u,2),c=s[0],l=s[1],d={ALL:"All Pages",MARKED:"Bookmarks",WRITTEN:"Notes"}[r],f=(0,$.QS)({onSwipedLeft:function(){t&&l(!1)},onSwipedRight:function(){t||l(!1)},swipeDuration:200}),p=f.ref,v=(0,i.Z)(f,ee);return(0,I.jsx)(U._l,{draggableId:"CARD",index:t?0:1,children:function(e,t){var n=e.innerRef,r=e.draggableProps,i=e.dragHandleProps,o=t.isDragging,u=t.isDropAnimating;return(0,I.jsxs)("div",(0,a.Z)((0,a.Z)((0,a.Z)({className:"preview-card",ref:function(e){n(e),p(e)},"data-open":c,"data-dragged":o,"data-animating":u},r),v),{},{children:[(0,I.jsx)("div",(0,a.Z)({className:"drag-handle"},i)),(0,I.jsx)("h3",{children:d}),(0,I.jsx)(ue,{}),(0,I.jsx)(ne,{dragged:o})]}))}})},ne=l.memo((function(e){var t=e.dragged,n=(0,l.useContext)(et),r=n.pageOrder,i=n.currPageID,u=(0,l.useContext)(tt),s=u.scrollPage,c=u.saveReorder,d=(0,l.useRef)({}),f=(0,_.zI)(),p=(0,o.Z)(f,1)[0],v=(0,_.LH)(),g=(0,o.Z)(v,1)[0],m=(0,x.Z)((function(){var e;null===(e=d.current[i])||void 0===e||e.scrollIntoView()}));(0,l.useLayoutEffect)((function(){g&&m()}),[g,m]);var h=(0,l.useRef)(),Z=(0,l.useRef)(0);return(0,l.useLayoutEffect)((function(){h.current&&(t?Z.current=h.current.scrollTop:h.current.scrollTop=Z.current)}),[t]),(0,I.jsx)(U.Z5,{onDragEnd:function(e){var t=e.source,n=e.destination;if(n&&r){var a=t.index,i=n.index,u=r[a];if(a!==i&&u){var l=function(e,t,n){var r=e.slice(),a=r.splice(t,1),i=(0,o.Z)(a,1)[0];return i?(r.splice(n,0,i),r):e}(r,a,i);c(l,!0),requestAnimationFrame((function(){return s(u)}))}}},children:(0,I.jsx)(U.bK,{droppableId:"preview-list",children:function(e){var t=e.droppableProps,n=e.innerRef,i=e.placeholder;return(0,I.jsxs)("div",(0,a.Z)((0,a.Z)({className:"page-list",ref:function(e){e&&(h.current=e),n(e)}},t),{},{children:[null===r||void 0===r?void 0:r.map((function(e,t){return(0,I.jsx)(re,{uid:e,pageIndex:t,refRec:d.current},e)})),i,"ALL"===p&&(0,I.jsx)(P,{})]}))}})})})),re=function(e){var t=e.uid,n=e.pageIndex,r=e.refRec,i=(0,l.useContext)(et),u=i.stateSet,s=i.pageRec,c=i.currPageID,d=(0,l.useContext)(Y.TeamCtx),f=d.teamState,p=d.ignores,v=(0,l.useContext)(tt).scrollPage,x=(0,_.zI)(),g=(0,o.Z)(x,1)[0],m=(0,l.useState)(""),h=(0,o.Z)(m,2),Z=h[0],j=h[1],k=null===s||void 0===s?void 0:s.get(t),b=null===u||void 0===u?void 0:u.getOneState(t),S=null===f||void 0===f?void 0:f.getOnePageStateMap(t);if(!k||!b)return null;var w=k.image,y=k.marked;if("WRITTEN"===g&&b.isEmpty()&&(!S||S.every((function(e){return e.isEmpty()}))))return null;if("MARKED"===g&&!y)return null;var C=c===t;return(0,I.jsx)(U._l,{draggableId:t,index:n,isDragDisabled:"ALL"!==g,children:function(e,i){var o=e.innerRef,u=e.draggableProps,s=e.dragHandleProps,c=i.isDragging,l=i.isDropAnimating;return(0,I.jsxs)("div",(0,a.Z)((0,a.Z)((0,a.Z)({ref:function(e){o(e),e&&(r[t]=e)},className:"page","data-curr":C,"data-dragged":c,"data-animating":l,onClick:function(){return v(t)}},u),s),{},{children:[(0,I.jsx)(N.default,{drawState:(null===S||void 0===S?void 0:S.get(Z))||b,teamStateMap:Z?void 0:S,thumbnail:w,ignores:p,preview:!0}),(0,I.jsx)(ae,{uid:t,index:n,chosen:Z,setChosen:j})]}))}})},ae=function(e){var t=e.uid,n=e.index,r=e.chosen,a=e.setChosen,i=(0,l.useContext)(tt).switchPageMarked,o=(0,l.useContext)(et).pageRec,u=(0,l.useContext)(Y.TeamCtx),s=u.ignores,c=u.teamState,d=(0,l.useMemo)((function(){return(null===c||void 0===c?void 0:c.getPageValidUsers(t).filter((function(e){return!s.has(e)})))||[]}),[c,s,t]),f=null===o||void 0===o?void 0:o.get(t);if(!f)return null;var p=f.marked;return(0,I.jsxs)("div",{className:"tools",onClick:function(e){return e.stopPropagation()},children:[(0,I.jsx)("div",{className:"bookmark","data-marked":p,onClick:function(){return i(t)}}),(0,I.jsx)("div",{className:"index",children:n+1}),(0,I.jsx)(oe,{uid:t}),(0,I.jsx)(ie,{userIDs:d,chosen:r,setChosen:a})]})},ie=function(e){var t=e.userIDs,n=e.chosen,r=e.setChosen,a=(0,l.useContext)(Y.TeamCtx).userRec;return(0,I.jsx)(H.C.Group,{maxCount:2,size:"default",className:Q()("team-group",{chosen:n}),maxPopoverPlacement:"bottom",children:t.map((function(e){var t=a[e];return t?(0,I.jsx)(B,{size:"default",userInfo:t,className:"preview-avatar",chosen:n===e,onClick:function(){return r((function(t){return t===e?"":e}))}},e):null}))})},oe=function(e){var t=e.uid,n=(0,l.useContext)(tt),r=n.addPage,a=n.deletePage,i=(0,I.jsx)(K.Z,{items:[{key:"ADD",icon:(0,I.jsx)(C.Z,{}),label:"Add page",onClick:function(){return r(t)}},{key:"COPY",icon:(0,I.jsx)(A.Z,{}),label:"Duplicate",onClick:function(){return r(t,!0)}},{key:"DELETE",icon:(0,I.jsx)(V.Z,{}),label:"Delete",danger:!0,onClick:function(){return a(t)}}]});return(0,I.jsx)(W.Z,{content:i,trigger:"click",placement:"left",destroyTooltipOnHide:!0,getPopupContainer:function(e){var t,n;return null===(t=e.parentElement)||void 0===t||null===(n=t.parentElement)||void 0===n?void 0:n.parentElement},children:(0,I.jsx)("div",{className:"option",children:(0,I.jsx)(z.Z,{})})})},ue=function(){var e=(0,_.zI)(),t=(0,o.Z)(e,2),n=t[0],r=t[1],a=X.Z.TabPane;return(0,I.jsxs)(X.Z,{className:"tabs",activeKey:n,onChange:r,tabBarGutter:0,size:"small",centered:!0,children:[(0,I.jsx)(a,{tab:(0,I.jsx)(q.Z,{type:"icon-uf_paper"})},"ALL"),(0,I.jsx)(a,{tab:(0,I.jsx)(q.Z,{type:"icon-bookmark2"})},"MARKED"),(0,I.jsx)(a,{tab:(0,I.jsx)(q.Z,{type:"icon-write"})},"WRITTEN")]})},se=function(){var e=(0,l.useState)(!1),t=(0,o.Z)(e,2),n=t[0],r=t[1],i=(0,_.LH)(),u=(0,o.Z)(i,1)[0],s=(0,I.jsx)(te,{left:n},"preview-drag"),c=(0,I.jsx)(U._l,{draggableId:"opposite",index:n?1:0,children:function(e){var t=e.innerRef,n=e.draggableProps,r=e.dragHandleProps;return(0,I.jsx)("div",(0,a.Z)((0,a.Z)({className:"opposite",ref:t},n),r))}},"opposite");return(0,I.jsx)(_.s2,{initKey:"ALL",children:(0,I.jsx)(U.Z5,{onDragEnd:function(e){var t=e.draggableId,n=e.destination;"CARD"===t&&(0===(null===n||void 0===n?void 0:n.index)&&r(!0),1===(null===n||void 0===n?void 0:n.index)&&r(!1))},children:(0,I.jsx)(U.bK,{droppableId:"preview-drop",direction:"horizontal",children:function(e){var t=e.droppableProps,r=e.innerRef,i=e.placeholder;return(0,I.jsxs)("div",(0,a.Z)((0,a.Z)({className:"preview-drop","data-left":n,"data-open":u,ref:r},t),{},{children:[n?[s,c]:[c,s],i]}))}})})})},ce=n(52242),le=n(65323),de=function(e){var t=e.saved,n=e.instantSave,r=(0,D.s0)();return(0,I.jsxs)("div",{className:"left",children:[(0,I.jsx)(w.Z,{type:"text",onClick:(0,u.Z)(c().mark((function e(){return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n();case 2:r("/");case 3:case"end":return e.stop()}}),e)}))),icon:(0,I.jsx)(ce.Z,{style:{opacity:.8}})}),(0,I.jsx)(w.Z,{type:"text",className:"save",onClick:n,disabled:t,icon:(0,I.jsx)(le.Z,{})})]})},fe=n(78985),pe=n(78030),ve=n(50446),xe=n(74006),ge=n(52542),me=n(76849),he=n(62),Ze=n(14965),je=n(48),ke=function(e){var t=e.handleUndo,n=e.handleRedo,r=(0,l.useContext)(et).stateSet,a=(0,f.gX)(),i=a.mode,u=a.finger,s=(0,f.F7)(),c=(0,p.iX)(),d=(0,o.Z)(c,2),v=d[0],x=d[1];return(0,I.jsxs)("div",{className:"middle",children:[(0,I.jsx)(w.Z,{type:"text",icon:(0,I.jsx)(pe.Z,{}),onClick:t,disabled:!(null!==r&&void 0!==r&&r.isUndoable())}),(0,I.jsx)(w.Z,{type:"text",icon:(0,I.jsx)(ve.Z,{}),onClick:n,disabled:!(null!==r&&void 0!==r&&r.isRedoable())}),(0,I.jsx)(w.Z,{type:u?"link":"text",onClick:function(){s({finger:!u}),y.ZP.destroy("FINGER"),y.ZP.open({content:u?"Pencil only":"Draw with finger",key:"FINGER"})},icon:(0,I.jsx)(q.Z,{type:"icon-finger"})}),(0,I.jsx)(w.Z,{className:"force-light-btn",type:"text",icon:v?(0,I.jsx)(xe.Z,{}):(0,I.jsx)(ge.Z,{}),onClick:function(){return x((function(e){return!e}))}}),(0,I.jsx)(be,{}),(0,I.jsx)(Se,{}),(0,I.jsx)(w.Z,{type:"text"===i?"link":"text",onClick:function(){return s({mode:"text"})},icon:(0,I.jsx)(q.Z,{type:"icon-text1"})}),(0,I.jsx)(we,{})]})},be=function(){var e=(0,f.gX)(),t=e.mode,n=e.color,r=(0,f.F7)();return"draw"===t?(0,I.jsx)(W.Z,{content:(0,I.jsx)(je.Uk,{updateDrawCtrl:r,drawCtrl:e}),trigger:"click",placement:"bottom",getPopupContainer:function(e){return e.parentElement},destroyTooltipOnHide:!0,children:(0,I.jsx)(w.Z,{type:"link",icon:(0,I.jsx)(me.Z,{twoToneColor:n,className:"pen-icon"})})}):(0,I.jsx)(w.Z,{type:"text",onClick:function(){return r({mode:"draw"})},icon:(0,I.jsx)(he.Z,{})})},Se=function(){var e=(0,f.gX)(),t=e.mode,n=e.pixelEraser,r=(0,f.F7)(),i={shape:"circle",icon:(0,I.jsx)(q.Z,{type:"icon-eraser"})};return"erase"===t?(0,I.jsx)(W.Z,{content:(0,I.jsxs)("div",{className:"width-seg-wrapper",children:[(0,I.jsx)(fe.Z,{block:!0,size:"small",className:"pixel-seg",options:["Pixel","Object"],value:n?"Pixel":"Object",onChange:function(e){r("Pixel"===e?{pixelEraser:!0}:{pixelEraser:!1})}}),(0,I.jsx)(je.Db,{drawCtrl:e,updateDrawCtrl:r,field:"eraserWidth"})]}),trigger:"click",placement:"bottom",getPopupContainer:function(e){return e.parentElement},destroyTooltipOnHide:!0,children:(0,I.jsx)(w.Z,(0,a.Z)({type:"link"},i))}):(0,I.jsx)(w.Z,(0,a.Z)({type:"text",onClick:function(){return r({mode:"erase"})}},i))},we=function(){var e=(0,f.gX)(),t=e.lasso,n=e.mode,r=(0,f.F7)(),a=t?(0,I.jsx)(q.Z,{type:"icon-lasso1"}):(0,I.jsx)(Ze.Z,{});return"select"===n?(0,I.jsx)(w.Z,{type:"link",icon:a,onClick:function(){return r({lasso:!t})}}):(0,I.jsx)(w.Z,{type:"text",icon:a,onClick:function(){return r({mode:"select"})}})},ye=n(49142),Ce=n(90785),Ie=n(91333),Pe=n(75594),De=n(461),Ne=n(95055),Re=n(67415),Oe=n(69951),Ee=n(96324),Te=n(67575),Le=n(30501),Fe=n(98272),Me=n(24215),Ae=n(17973),Ve=n(19951),ze=n(23605),Ue=n(56200),He=n(18301),Ke=n(51570),We=n(1829),Xe=n.n(We),_e=function(e){var t=e.instantSave,n=(0,l.useContext)(Y.TeamCtx).teamOn;return(0,I.jsxs)("div",{className:"right",children:[n?(0,I.jsx)(qe,{}):(0,I.jsx)(Je,{instantSave:t}),(0,I.jsx)(Ge,{})]})},Ge=function(){var e=(0,_.LH)(),t=(0,o.Z)(e,2),n=t[0],r=t[1];return(0,I.jsx)(w.Z,{type:n?"link":"text",icon:(0,I.jsx)(Ee.Z,{}),onClick:function(){return r((function(e){return!e}))}})},Be=function(e){var t=e.userID,n=(0,l.useState)(!1),r=(0,o.Z)(n,2),a=r[0],i=r[1],u=(0,l.useContext)(Y.TeamCtx),s=u.ignores,c=u.setIgnores,d=u.resetIO,f=u.userRec[t];if((0,l.useEffect)((function(){return i(!1)}),[f]),!f)return null;var p=f.userName,v=f.online,x=t===(0,Oe.VN)(),g=s.has(t)&&!x;return(0,I.jsxs)("div",{className:"user-item","data-online":v,children:[(0,I.jsx)(B,{userInfo:f,size:"small",className:"room-avatar"}),a||(0,I.jsx)("span",{className:"user-name",children:p}),a&&(0,I.jsx)(Ne.Z,{autoFocus:!0,className:"rename-input",defaultValue:p,onSearch:function(e){var t=e.trim();if(!t||t===p)return i(!1);(0,Oe.lu)(t),d()},enterButton:(0,I.jsx)(w.Z,{icon:(0,I.jsx)(Te.Z,{})})}),x?a||(0,I.jsx)(w.Z,{type:"text",icon:(0,I.jsx)(Le.Z,{}),onClick:function(){return i(!0)}}):(0,I.jsx)(w.Z,{type:"text",icon:g?(0,I.jsx)(Fe.Z,{}):(0,I.jsx)(Me.Z,{}),onClick:function(){c((function(e){return e.has(t)?e.delete(t):e.add(t)}))}})]})},qe=function(){var e=(0,l.useContext)(Y.TeamCtx),t=e.code,n=e.userRec,a=e.connected,s=e.loadInfo,d=e.loadState,f=e.resetIO,p=(0,l.useContext)(et).noteInfo,v=window.location.href,x=function(){var e=(0,u.Z)(c().mark((function e(){var t,r;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=null===(t=n[(0,Oe.VN)()])||void 0===t?void 0:t.userName,e.prev=1,p){e.next=4;break}return e.abrupt("return");case 4:return e.next=6,Xe()("".concat(p.name," - ").concat(r," - Multibility\n").concat(v));case 6:y.ZP.destroy("copy"),y.ZP.success({content:"Link copied!",icon:(0,I.jsx)(A.Z,{}),key:"copy"}),e.next=13;break;case 10:e.prev=10,e.t0=e.catch(1),console.log(e.t0);case 13:case"end":return e.stop()}}),e,null,[[1,10]])})));return function(){return e.apply(this,arguments)}}(),g=(0,l.useMemo)((function(){var e=(0,Oe.VN)(),t=n[e],a=(0,i.Z)(n,[e].map(ye.Z)),o=t?[t]:[],u=Object.values(a);return o.push.apply(o,(0,r.Z)(u.filter((function(e){return e.online}))).concat((0,r.Z)(u.filter((function(e){return!e.online}))))),o}),[n]),m=(0,l.useMemo)((function(){return g.filter((function(e){return e.online})).length}),[g]),h=(0,I.jsxs)("div",{className:"team-popover",children:[a||(0,I.jsx)(Ce.Z,{className:"disconn-alert",message:"Network failed.",icon:(0,I.jsx)(Ae.Z,{}),type:"error",showIcon:!0,banner:!0}),(0,I.jsx)(Re.GD,{className:"code-display",value:String(t),length:4,plain:!0}),(0,I.jsx)(w.Z,{icon:(0,I.jsx)(Ve.Z,{}),className:"share-btn",onClick:x,block:!0,children:"Share"}),(0,I.jsx)(Ie.Z,{}),(0,I.jsx)("div",{className:"user-list",children:g.map((function(e){return(0,I.jsx)(Be,{userID:e.userID},e.userID)}))})]}),Z=(0,l.useState)(!1),j=(0,o.Z)(Z,2),k=j[0],b=j[1],S=(0,I.jsxs)("div",{className:"team-title",children:[(0,I.jsx)("span",{children:"Team info"}),(0,I.jsx)(w.Z,{shape:"circle",type:"text",size:"small",loading:k,icon:(0,I.jsx)(ze.Z,{}),onClick:(0,u.Z)(c().mark((function e(){return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return b(!0),e.next=3,s();case 3:return e.next=5,d();case 5:b(!1),f();case 7:case"end":return e.stop()}}),e)})))})]});return(0,I.jsx)(W.Z,{content:h,trigger:"click",placement:"bottomRight",title:S,getPopupContainer:function(e){return e.parentElement},children:(0,I.jsx)(w.Z,{type:"text",icon:(0,I.jsx)(Pe.Z,{status:a?"success":"error",count:a?m:"!",size:"small",children:(0,I.jsx)(Ue.Z,{})})})})},Je=function(e){var t=e.instantSave,n=(0,l.useContext)(et).noteID,r=(0,D.s0)(),a=function(){var e=(0,u.Z)(c().mark((function e(){return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t();case 2:return e.next=4,(0,Ke.r8)(n);case 4:if(e.sent){e.next=7;break}return e.abrupt("return",y.ZP.error("Can't create room."));case 7:return e.next=9,(0,S.SP)(n,{team:!0});case 9:r("/team/"+n);case 10:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}();return(0,I.jsx)(w.Z,{type:"text",icon:(0,I.jsx)(He.Z,{}),onClick:function(){De.Z.confirm({title:"Enable team editing",content:"This will make your note public to anyone with the link.",icon:(0,I.jsx)(Ue.Z,{style:{color:"#555"}}),onOk:a})}})},Qe=function(e){var t=e.saved,n=e.handleUndo,r=e.handleRedo,a=e.instantSave,i=(0,p.iX)(),u=(0,o.Z)(i,1)[0];return(0,I.jsxs)("header",{"data-force-light":u,children:[(0,I.jsx)(de,{saved:t,instantSave:a}),(0,I.jsx)(ke,{handleUndo:n,handleRedo:r}),(0,I.jsx)(_e,{instantSave:a})]})},Ye=["pageRec","pdf","pageOrder"],$e=["image","marked"],et=l.createContext({noteID:"",currPageID:""}),tt=l.createContext({scrollPage:function(e){},switchPageMarked:function(e){},addPage:function(e,t){},addFinalPage:function(){},deletePage:function(e){},saveReorder:function(){var e=(0,u.Z)(c().mark((function e(t,n){return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}()});function nt(){var e,t=null!==(e=(0,D.UO)().noteID)&&void 0!==e?e:"",n=(0,D.s0)(),s=(0,l.useState)(),g=(0,o.Z)(s,2),m=g[0],j=g[1],k=(0,l.useState)(),C=(0,o.Z)(k,2),N=C[0],R=C[1],O=(0,l.useState)(),A=(0,o.Z)(O,2),V=A[0],z=A[1],U=(0,l.useState)(),H=(0,o.Z)(U,2),K=H[0],W=H[1],X=(0,v.Z)(!0),G=(0,o.Z)(X,2),B=G[0],q=G[1],J=(0,l.useContext)(Y.TeamCtx),Q=J.io,$=J.teamOn,ee=J.addTeamStatePage,te=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=(0,l.useState)((0,Z.D5)()),r=(0,o.Z)(n,2),a=r[0],i=r[1],s=(0,l.useRef)(!1),d=(0,l.useState)(""),f=(0,o.Z)(d,2),p=f[0],v=f[1],x=(0,l.useState)((0,Z.D5)()),g=(0,o.Z)(x,2),m=g[0],h=g[1],j=(0,l.useMemo)((function(){return T(m,t)}),[m,t]);return(0,l.useDebugValue)(j),(0,l.useEffect)((function(){(0,u.Z)(c().mark((function t(){var n;return c().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,E.getItem(e);case 2:if(n=t.sent){t.next=5;break}return t.abrupt("return",s.current=!0);case 5:v(n);case 6:case"end":return t.stop()}}),t)})))()}),[e]),(0,l.useEffect)((function(){!s.current&&a.has(p)&&requestAnimationFrame((function(){var e;null===(e=a.get(p))||void 0===e||e.scrollIntoView(),s.current=!0}))}),[p,a]),(0,l.useEffect)((function(){s.current&&E.setItem(e,j)}),[e,j]),{scrollPage:function(e){var t;null===(t=a.get(e))||void 0===t||t.scrollIntoView()},setInviewRatios:h,sectionRef:function(e){return function(t){t&&i((function(n){return n.set(e,t)}))}},currPageID:j}}(t,K),ne=te.setInviewRatios,re=te.scrollPage,ae=te.sectionRef,ie=te.currPageID;(0,l.useEffect)((function(){(0,u.Z)(c().mark((function e(){var r,a,o,u;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,S.U9)(t);case 2:if(r=e.sent){e.next=6;break}return y.ZP.error("Note not found"),e.abrupt("return",n("/"));case 6:a=r.pageRec,r.pdf,o=r.pageOrder,u=(0,i.Z)(r,Ye),j((0,Z.D5)(a)),W(o),R(u),z(b.createFromPages(a));case 11:case"end":return e.stop()}}),e)})))()}),[n,t,$]),(0,l.useEffect)((function(){N&&(document.title=N.name+" - Multibility")}),[N]);var oe=(0,x.Z)((0,u.Z)(c().mark((function e(){var n;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=null===m||void 0===m?void 0:m.toObject(),e.next=3,(0,S.SP)(t,{pageRec:n});case 3:q(!0);case 4:case"end":return e.stop()}}),e)})))),ue=(0,l.useCallback)((0,L.Z)(oe,2e3),[oe]),ce=ue.flush,le=function(e,t){j((function(n){return null===n||void 0===n?void 0:n.update(e,d.BJ,t)})),q(!1),ue()},de=function(){var e=(0,u.Z)(c().mark((function e(n){var r,a=arguments;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=a.length>1&&void 0!==a[1]&&a[1],W(n),e.next=4,(0,S.SP)(t,{pageOrder:n});case 4:return e.next=6,ce();case 6:r&&fe(n);case 7:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),fe=function(e){return null===Q||void 0===Q?void 0:Q.emit("reorder",{pageOrder:e})},pe=(0,x.Z)((function(e){var t,n=e.deleted,r=e.pageOrder,a=e.prevOrder;(de(r),n)&&(t=function(){return de(a,!0)},y.ZP.warning({content:(0,I.jsxs)(I.Fragment,{children:["One page was deleted.",(0,I.jsx)(w.Z,{size:"small",type:"link",onClick:function(){y.ZP.destroy("DELETE"),t()},children:"Undo"})]}),key:"DELETE",duration:10}))})),ve=(0,x.Z)((function(e){var t=e.pageOrder,n=e.pageID,r=e.newPage;de(t),le(n,(function(){return r})),z((function(e){return null===e||void 0===e?void 0:e.addState(n,r)}))}));(0,l.useEffect)((function(){return null===Q||void 0===Q||Q.on("reorder",pe),null===Q||void 0===Q||Q.on("newPage",ve),function(){null===Q||void 0===Q||Q.removeAllListeners()}}),[Q,pe,ve]);var xe=function(e,t,n){n.image,n.marked;var r=(0,i.Z)(n,$e);null===Q||void 0===Q||Q.emit("newPage",{pageOrder:e,pageID:t,newPage:r}),ee(t,n)},ge=function(e,t){var n=h.Dw.flaten(t);le(e,(function(e){return(0,a.Z)((0,a.Z)({},e),{},{state:n})}))},me=function(e){if(V){var t=e(V);if(t!==V){z(t);var n,a=t.getLastDS(),i=t.lastOp;if(a&&i)ge.apply(void 0,(0,r.Z)(a)),n=i,null===Q||void 0===Q||Q.emit("push",{operation:n},(function(e){var t=e.pageID,n=e.stroke;return z((function(e){return null===e||void 0===e?void 0:e.syncStrokeTime(t,n)}))}))}}},he=function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(K){var n=t?null===m||void 0===m?void 0:m.get(e):void 0,r=(0,d.D4)(n),a=(0,o.Z)(r,2),i=a[0],u=a[1],s=M(K,e,i);xe(s,i,u),de(s),le(i,(function(){return u})),z((function(e){return null===e||void 0===e?void 0:e.addState(i,u)}))}},Ze=(0,I.jsxs)("div",{className:"reader container",children:[(0,I.jsx)(Qe,{saved:B,instantSave:ce,handleUndo:function(){return me((function(e){return e.undo()}))},handleRedo:function(){return me((function(e){return e.redo()}))}}),(0,I.jsxs)("main",{children:[null===K||void 0===K?void 0:K.map((function(e){return(0,I.jsx)("section",{className:"note-page",ref:ae(e),children:(0,I.jsx)(rt,{uid:e,updateStateSet:me,setInviewRatios:ne})},e)})),(0,I.jsx)(P,{})]}),(0,I.jsx)(se,{})]});return(0,I.jsx)(p.Wk,{children:(0,I.jsx)(et.Provider,{value:{noteID:t,pageRec:m,noteInfo:N,stateSet:V,pageOrder:K,currPageID:ie},children:(0,I.jsx)(tt.Provider,{value:{addPage:he,scrollPage:re,deletePage:function(e){var t=null===K||void 0===K?void 0:K.filter((function(t){return t!==e}));(null===t||void 0===t?void 0:t.length)&&de(t,!0)},saveReorder:de,addFinalPage:function(){var e=(0,F.Z)(K);e&&he(e)},switchPageMarked:function(e){return le(e,(function(e){return(0,a.Z)((0,a.Z)({},e),{},{marked:!e.marked})}))}},children:(0,I.jsx)(f.w3,{children:(0,I.jsx)(_.kV,{children:Ze})})})})})}var rt=function(e){var t=e.uid,n=e.updateStateSet,r=e.setInviewRatios,a=(0,l.useContext)(et),i=a.pageRec,o=a.stateSet,u=a.currPageID,s=a.pageOrder,c=a.noteID,d=(0,l.useContext)(Y.TeamCtx),f=d.teamState,p=d.ignores,v=null===i||void 0===i?void 0:i.get(t),x=null===o||void 0===o?void 0:o.getOneState(t),g=null===f||void 0===f?void 0:f.getOnePageStateMap(t),m=(0,l.useMemo)((function(){if(!s)return!1;var e=s.indexOf(u),n=s.indexOf(t);return Math.abs(n-e)<=1}),[u,t,s]);return v&&x?(0,I.jsx)(N.default,{drawState:x,teamStateMap:g,updateState:function(e){n((function(n){return n.setState(t,e)}))},pdfIndex:v.pdfIndex,noteID:c,ignores:p,onViewChange:function(e,n){if(!e)return r((function(e){return e.delete(t)}));r((function(e){return e.set(t,n)}))},preload:m}):null}},60559:function(e,t,n){n.r(t),n.d(t,{TeamCtx:function(){return k},default:function(){return b}});var r=n(29439),a=n(15861),i=n(87757),o=n.n(i),u=n(72791),s=n(51570),c=n(56058),l=n(87962),d=n(78577),f=n(69951),p=function(e){return function(){return(0,d.io)(s._n,{query:{userID:(0,f.VN)(),userName:(0,f.vW)(),noteID:e}})}},v=n(16871),x=n(79856),g=n(91835),m=n(50419),h=n(24124),Z=n(24657),j=n(80184),k=u.createContext({io:void 0,code:0,teamOn:!1,connected:!1,ignores:(0,h.l4)(),userRec:{},teamState:void 0,resetIO:function(){},loadInfo:function(){var e=(0,a.Z)(o().mark((function e(){return o().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",!1);case 1:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),loadState:function(){var e=(0,a.Z)(o().mark((function e(){return o().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",!1);case 1:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),setIgnores:function(){},addTeamStatePage:function(e,t){}});function b(){var e,t=null!==(e=(0,v.UO)().noteID)&&void 0!==e?e:"",n=(0,u.useState)(),i=(0,r.Z)(n,2),c=i[0],l=i[1],d=(0,u.useState)(-2),b=(0,r.Z)(d,2),y=b[0],C=b[1],I=(0,u.useState)({}),P=(0,r.Z)(I,2),D=P[0],N=P[1],R=(0,u.useState)((0,h.l4)()),O=(0,r.Z)(R,2),E=O[0],T=O[1],L=(0,u.useState)(p(t)),F=(0,r.Z)(L,2),M=F[0],A=F[1],V=(0,u.useState)(!1),z=(0,r.Z)(V,2),U=z[0],H=z[1],K=(0,u.useState)(!1),W=(0,r.Z)(K,2),X=W[0],_=W[1],G=(0,v.s0)(),B=(0,u.useCallback)((0,a.Z)(o().mark((function e(){var n;return o().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,s.dn)(t);case 2:if(n=e.sent){e.next=6;break}return m.ZP.error("Failed loading the team note info"),e.abrupt("return",!1);case 6:return C(n.code),e.abrupt("return",!0);case 8:case"end":return e.stop()}}),e)}))),[t]),q=(0,u.useCallback)((0,a.Z)(o().mark((function e(){var n;return o().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,s.CD)(t);case 2:if(n=e.sent){e.next=6;break}return m.ZP.error("Failed loading the team note state"),e.abrupt("return",!1);case 6:return l(x.f.createFromTeamPages(n)),e.abrupt("return",!0);case 8:case"end":return e.stop()}}),e)}))),[t]),J=(0,u.useCallback)((function(){(0,s.f1)(t)}),[t]);(0,u.useEffect)((function(){var e=function(){var e=(0,a.Z)(o().mark((function e(){var t,n;return o().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,B();case 2:return t=e.sent,e.next=5,q();case 5:if(n=e.sent,t&&n){e.next=8;break}return e.abrupt("return",G("/"));case 8:H(!0),J();case 10:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}();return e(),J}),[B,q,G,J]),(0,u.useEffect)((function(){return M.on("push",(function(e){var t=e.operation,n=e.userID;l((function(e){return null===e||void 0===e?void 0:e.pushOperation(t,n)}))})),M.on("join",(function(e){var t=e.joined,n=e.members,r=t.userID,a=t.userName;N(n),r!==(0,f.VN)()&&S(r,a)})),M.on("leave",(function(e){var t=e.leaved,n=e.members,r=t.userID,a=t.userName;if(N(n),r===(0,f.VN)())return M.emit("join");w(r,a)})),M.on("newPage",(function(e){var t=e.pageID,n=e.newPage;l((function(e){return null===e||void 0===e?void 0:e.addPage(t,n)}))})),M.on("reset",(function(e){var t=e.userID,n=e.pageRec;t!==(0,f.VN)()&&l((function(e){return null===e||void 0===e?void 0:e.resetUser(t,n)}))})),M.on("connect_error",console.error),M.on("connect",(function(){return _(!0)})),M.on("disconnect",(function(){return _(!1)})),function(){M.removeAllListeners(),M.close()}}),[M]);return(0,j.jsx)(g.g,{loading:!U,children:(0,j.jsx)(k.Provider,{value:{io:M,code:y,teamOn:!0,ignores:E,userRec:D,connected:X,teamState:c,resetIO:function(){return A(p(t))},loadInfo:B,loadState:q,setIgnores:T,addTeamStatePage:function(e,t){l((function(n){return null===n||void 0===n?void 0:n.addPage(e,t)}))}},children:(0,j.jsx)(Z.default,{})})})}var S=function(e,t){m.ZP.destroy(e),m.ZP.success({content:"".concat(t," joined room"),icon:(0,j.jsx)(c.Z,{}),key:e})},w=function(e,t){m.ZP.destroy(e),m.ZP.warning({content:"".concat(t," leaved room"),icon:(0,j.jsx)(l.Z,{}),key:e})}}}]);
//# sourceMappingURL=310.87b72147.chunk.js.map