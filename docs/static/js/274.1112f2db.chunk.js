(self.webpackChunkmultibility=self.webpackChunkmultibility||[]).push([[274],{84341:function(e,t,n){"use strict";n.r(t),n.d(t,{PageWrapper:function(){return wt},ReaderMethodCtx:function(){return mt},ReaderStateCtx:function(){return ht},default:function(){return gt}});var r=n(93433),a=n(4942),i=n(1413),u=n(45987),o=n(29439),s=n(15861),c=n(87757),l=n.n(c),d=n(72791),f=n(61842),v=n.n(f),p={mode:"draw",finger:!0,lineWidth:10,eraserWidth:10,color:"#000000",highlight:!1};function h(){return m.apply(this,arguments)}function m(){return(m=(0,s.Z)(l().mark((function e(){var t;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,v().getItem("DRAW_CTRL");case 2:if(t=e.sent){e.next=7;break}return t=p,e.next=7,v().setItem("DRAW_CTRL",t);case 7:return e.abrupt("return",t);case 8:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function g(){return(g=(0,s.Z)(l().mark((function e(t){return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,v().setItem("DRAW_CTRL",t);case 2:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var x=n(92198),w=n(75783),Z=n(87309),k=n(49496),S=n(79286),j=n(80184),y=function(){var e=(0,d.useContext)(mt).addFinalPage;return(0,j.jsx)("div",{className:"add-btn-wrapper",children:(0,j.jsx)(Z.Z,{type:"dashed",icon:(0,j.jsx)(S.Z,{}),block:!0,onClick:e,children:"New page"})})},C=n(16871),b=n(58105),D=n(51570),P=n(97725),I=n(82670);var O=n(15671),N=n(43144),E=n(24124),R={states:(0,E.D5)(),editStack:(0,E.aV)(),undoStack:(0,E.aV)()},T=(0,E.WV)(R),A=function(){function e(t,n){(0,O.Z)(this,e),this.immutable=t,this.lastOp=n}return(0,N.Z)(e,[{key:"getImmutable",value:function(){return this.immutable}},{key:"getStates",value:function(){return this.getImmutable().get("states")}},{key:"getOneState",value:function(e){return this.getStates().get(e)}},{key:"getEditStack",value:function(){return this.getImmutable().get("editStack")}},{key:"getUndoStack",value:function(){return this.getImmutable().get("undoStack")}},{key:"setState",value:function(t,n){var r=this.getOneState(t);if(!r||r===n)return this;var a=this.getImmutable().update("states",(function(e){return e.set(t,n)})).update("editStack",(function(e){return e.push(t)})).delete("undoStack"),u=n.lastOp;return new e(a,u&&(0,i.Z)((0,i.Z)({},u),{},{pageID:t}))}},{key:"updateState",value:function(t,n){var r=this.getOneState(t);if(!r)return this;var a=n(r);return new e(this.getImmutable().update("states",(function(e){return e.set(t,a)})))}},{key:"addState",value:function(t,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:I.mF,a=n.state,i=n.ratio,u=I.Dw.loadFromFlat(a,r,r*i),o=this.getImmutable().update("states",(function(e){return e.set(t,u)}));return new e(o)}},{key:"deleteState",value:function(t){return new e(this.getImmutable().update("states",(function(e){return e.delete(t)})))}},{key:"isUndoable",value:function(){return this.getEditStack().size>0}},{key:"isRedoable",value:function(){return this.getUndoStack().size>0}},{key:"undo",value:function(){if(!this.isUndoable())return this;var t=this.getEditStack().last(),n=t&&this.getOneState(t);if(!n)return this;var r=I.Dw.undo(n),a=r.lastOp,u=a&&(0,i.Z)({pageID:t},a);return new e(this.getImmutable().update("editStack",(function(e){return e.pop()})).update("undoStack",(function(e){return e.push(t)})).update("states",(function(e){return e.set(t,r)})),u)}},{key:"redo",value:function(){if(!this.isRedoable())return this;var t=this.getUndoStack().last(),n=t&&this.getOneState(t);if(!n)return this;var r=I.Dw.redo(n),a=r.lastOp,u=a&&(0,i.Z)({pageID:t},a);return new e(this.getImmutable().update("undoStack",(function(e){return e.pop()})).update("editStack",(function(e){return e.push(t)})).update("states",(function(e){return e.set(t,r)})),u)}},{key:"getLastDS",value:function(){var e,t=null===(e=this.lastOp)||void 0===e?void 0:e.pageID,n=t&&this.getOneState(t);return n?[t,n]:void 0}}],[{key:"createFromList",value:function(t){return new e(T().set("states",(0,E.D5)(t)))}},{key:"createFromPages",value:function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:I.mF,r=Object.entries(t);return e.createFromList(r.map((function(e){var t=(0,o.Z)(e,2),r=t[0],a=t[1],i=a.state,u=a.ratio;return[r,I.Dw.loadFromFlat(i,n,n*u)]})))}}]),e}();function L(e,t,n){var r=e.indexOf(t),a=e.slice();return-1===r||a.splice(r+1,0,n),a}var M=n(61507),W=n(79784),F=n(23414),U=n(82622),z=n(69228),V=n(96272),_=n(76586),B=n(90785),K=n(91333),G=n(75594),H=n(4240),q=n(95055),J=n(91511),Y=n(81694),X=n.n(Y);function Q(e){var t=e.value,n=(0,d.useState)(9999),r=(0,o.Z)(n,2),a=r[0],i=r[1],u=String(t>=0?t:a).padStart(4,"0").split("").map((function(e){return Number(e)}));function s(){i(Math.floor(1e4*Math.random()))}return(0,d.useEffect)((function(){if(-1!==t)return i(9999);var e=setTimeout(s,100);return function(){return clearTimeout(e)}}),[t]),(0,j.jsx)("div",{className:X()("digit-display",{disabled:-2===t}),children:u.map((function(e,t){return(0,j.jsx)($,{digit:e},t)}))})}function $(e){var t=e.digit;return t<=9&&t>=0?(0,j.jsx)("div",{className:"digit",children:t}):(0,j.jsx)("div",{className:"digit",children:"*"})}var ee=n(74115),te=n(69951),ne=n(70140),re=n(87661),ae=n(67629),ie=n(10711),ue=n(53621),oe=n(75797),se=(0,n(92721).Z)({scriptUrl:"//at.alicdn.com/t/font_3181679_eb02zt96p4p.js"}),ce=n(29798),le=function(e){var t=e.activeKey,n=e.setActiveKey,r=(0,d.useContext)(ht),a=r.pageOrder,u=r.inviewPages,s=(0,d.useContext)(mt),c=s.scrollPage,l=s.saveReorder,f=(0,d.useRef)({}),v=(0,d.useRef)(),p=(0,d.useMemo)((function(){return(null===a||void 0===a?void 0:a.find((function(e){return u.has(e)})))||""}),[a,u]);return(0,d.useEffect)((function(){var e,t,n,r;null===(e=f.current[p])||void 0===e||e.scrollIntoView();var a=(null===(t=f.current[p])||void 0===t?void 0:t.clientHeight)||0,i=(null===(n=v.current)||void 0===n?void 0:n.clientHeight)||0;null===(r=v.current)||void 0===r||r.scrollBy(0,-i/2+a/2)}),[]),(0,j.jsxs)("div",{className:"preview-container",children:[(0,j.jsx)(pe,{activeKey:t,setActiveKey:n}),(0,j.jsx)(ce.Z5,{onDragEnd:function(e){var t=e.source,n=e.destination;if(n&&a){var r=t.index,i=n.index;if(r!==i){var u=a[r],s=function(e,t,n){var r=e.slice(),a=r.splice(t,1),i=(0,o.Z)(a,1)[0];return r.splice(n,0,i),r}(a,r,i);l(s,!0),requestAnimationFrame((function(){return c(u)}))}}},children:(0,j.jsx)(ce.bK,{droppableId:"droppable",children:function(e){var n=e.droppableProps,r=e.innerRef,u=e.placeholder;return(0,j.jsxs)("div",(0,i.Z)((0,i.Z)({className:"page-list",ref:function(e){r(e),e&&(v.current=e)}},n),{},{children:[null===a||void 0===a?void 0:a.map((function(e,n){return(0,j.jsx)(de,{uid:e,mode:t,pageIndex:n,currpageID:p,refRec:f.current},e)})),u,"ALL"===t&&(0,j.jsx)(y,{})]}))}})})]})},de=function(e){var t=e.uid,n=e.pageIndex,r=e.mode,a=e.currpageID,u=e.refRec,s=(0,d.useContext)(ht),c=s.stateSet,l=s.teamState,f=s.pageRec,v=(0,d.useContext)(mt),p=v.scrollPage,h=v.switchPageMarked,m=(0,d.useContext)(J.TeamCtx).ignores,g=(0,d.useState)(""),x=(0,o.Z)(g,2),w=x[0],Z=x[1],k=f&&f[t],S=null===c||void 0===c?void 0:c.getOneState(t),y=null===l||void 0===l?void 0:l.getOnePageState(t),C=(0,d.useMemo)((function(){return null===l||void 0===l?void 0:l.getOnePageValidUser(t).filter((function(e){return!m.has(e)}))}),[l,m,t]);if(!k||!S)return null;if("WRITTEN"===r&&S.isEmpty()&&(!y||y.every((function(e){return e.isEmpty()}))))return null;if("MARKED"===r&&!k.marked)return null;var b=function(e){h(t),e.stopPropagation()},D=a===t,P="ALL"!==r;return(0,j.jsx)(ce._l,{draggableId:t,index:n,isDragDisabled:P,children:function(e,r){var a=e.innerRef,o=e.draggableProps,s=e.dragHandleProps,c=r.isDragging,l=k.image,d=k.marked;return(0,j.jsxs)("div",(0,i.Z)((0,i.Z)((0,i.Z)({ref:function(e){a(e),e&&(u[t]=e)},className:X()("page",{curr:D,drag:c}),onClick:function(){return p(t)}},o),s),{},{children:[(0,j.jsx)(wt,{uid:t,drawState:(null===y||void 0===y?void 0:y.get(w))||S,teamStateMap:w?void 0:y,thumbnail:l,preview:!0}),(0,j.jsx)("span",{className:X()("bookmark",{marked:d}),onClickCapture:b}),(0,j.jsx)("span",{className:"index",children:n+1}),(0,j.jsx)(fe,{userIDs:C,chosen:w,setChosen:Z}),(0,j.jsx)(ve,{uid:t})]}))}})},fe=function(e){var t=e.userIDs,n=e.chosen,r=e.setChosen;return(0,j.jsx)(_.C.Group,{maxCount:2,size:"default",className:X()("team-group",{chosen:n}),children:null===t||void 0===t?void 0:t.map((function(e){return(0,j.jsx)(Fe,{size:"default",userID:e,className:"preview-avatar",chosen:n===e,onClick:function(){return r((function(t){return t===e?"":e}))}},e)}))})},ve=function(e){var t=e.uid,n=(0,d.useState)(!1),r=(0,o.Z)(n,2),a=r[0],i=r[1],u=(0,d.useContext)(mt),s=u.addPage,c=u.deletePage,l=(0,j.jsx)(ne.Z,{onClick:function(e){var n=e.key,r=e.domEvent;"ADD"===n?s(t):"COPY"===n?s(t,!0):"DELETE"===n&&c(t),r.stopPropagation(),i(!1)},items:[{key:"ADD",icon:(0,j.jsx)(S.Z,{}),label:"Add page"},{key:"COPY",icon:(0,j.jsx)(F.Z,{}),label:"Duplicate"},{key:"DELETE",icon:(0,j.jsx)(U.Z,{}),label:"Delete",danger:!0}]});return(0,j.jsx)(z.Z,{content:l,trigger:"click",placement:"left",visible:a,onVisibleChange:i,destroyTooltipOnHide:!0,children:(0,j.jsx)("span",{className:"option",onClickCapture:function(e){i((function(e){return!e})),e.stopPropagation()},children:(0,j.jsx)(ie.Z,{})})})},pe=function(e){var t=e.activeKey,n=e.setActiveKey,r=re.Z.TabPane;return(0,j.jsxs)(re.Z,{className:"tabs",activeKey:t,onChange:n,tabBarGutter:10,size:"small",centered:!0,children:[(0,j.jsx)(r,{tab:(0,j.jsx)(se,{type:"icon-uf_paper"})},"ALL"),(0,j.jsx)(r,{tab:(0,j.jsx)(se,{type:"icon-bookmark2"})},"MARKED"),(0,j.jsx)(r,{tab:(0,j.jsx)(se,{type:"icon-write"})},"WRITTEN")]})};function he(){var e=(0,d.useState)(!1),t=(0,o.Z)(e,2),n=t[0],r=t[1],a=(0,d.useState)("ALL"),i=(0,o.Z)(a,2),u=i[0],s=i[1],c={ALL:"All Pages",MARKED:"Bookmarks",WRITTEN:"Notes"}[u];return(0,j.jsxs)(j.Fragment,{children:[(0,j.jsx)(Z.Z,{type:"text",icon:n?(0,j.jsx)(ue.Z,{}):(0,j.jsx)(oe.Z,{}),onClick:function(){return r((function(e){return!e}))}}),(0,j.jsx)(ae.Z,{visible:n,onClose:function(){return r(!1)},width:200,title:c,closable:!1,className:"preview-drawer",contentWrapperStyle:{boxShadow:"none"},bodyStyle:{padding:0,overflow:"hidden"},headerStyle:{textAlign:"center",borderTop:"1px solid #eee"},destroyOnClose:!0,children:(0,j.jsx)(le,{activeKey:u,setActiveKey:s})})]})}var me=n(52242),ge=n(65323),xe=n(78030),we=n(50446),Ze=n(14988),ke=n(62),Se=n(67575),je=n(30501),ye=n(98272),Ce=n(24215),be=n(17973),De=n(19951),Pe=n(23605),Ie=n(56200),Oe=n(18301),Ne=n(1829),Ee=n.n(Ne);function Re(e){var t=e.handleUndo,n=e.handleRedo,r=e.instantSave,a=(0,d.useContext)(ht),u=a.saved,o=a.stateSet,c=a.teamOn,f=a.drawCtrl,v=f.mode,p=(0,d.useContext)(mt).setDrawCtrl,h=f.finger,m=(0,C.s0)(),x=function(e){p((function(t){var n=(0,i.Z)((0,i.Z)({},t),e);return function(e){g.apply(this,arguments)}(n),n}))};return(0,j.jsxs)("header",{children:[(0,j.jsxs)("div",{className:"left",children:[(0,j.jsx)(Z.Z,{type:"text",onClick:(0,s.Z)(l().mark((function e(){return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r();case 2:m("/");case 3:case"end":return e.stop()}}),e)}))),icon:(0,j.jsx)(me.Z,{style:{opacity:.8}})}),(0,j.jsx)("br",{}),(0,j.jsx)(Z.Z,{type:"text",className:"save",onClick:r,disabled:u,icon:(0,j.jsx)(ge.Z,{})})]}),(0,j.jsxs)("div",{className:"middle",children:[(0,j.jsx)(Z.Z,{type:"text",shape:"circle",icon:(0,j.jsx)(xe.Z,{}),onClick:t,disabled:!(null!==o&&void 0!==o&&o.isUndoable())}),(0,j.jsx)(Z.Z,{className:"redo",type:"text",shape:"circle",icon:(0,j.jsx)(we.Z,{}),onClick:n,disabled:!(null!==o&&void 0!==o&&o.isRedoable())}),(0,j.jsx)("br",{}),(0,j.jsx)(Te,{updateDrawCtrl:x}),(0,j.jsx)(Me,{updateDrawCtrl:x}),(0,j.jsx)(Z.Z,{type:["select","selected"].includes(v)?"default":"text",shape:"circle",onClick:function(){return x({mode:"select"})},icon:(0,j.jsx)(Ze.Z,{})}),(0,j.jsx)(Z.Z,{className:"finger",type:h?"primary":"text",ghost:h,shape:"circle",onClick:function(){return x({finger:!h})},icon:(0,j.jsx)(se,{type:"icon-finger"})})]}),(0,j.jsxs)("div",{className:"right",children:[c&&(0,j.jsx)(Ue,{}),c||(0,j.jsx)(ze,{instantSave:r}),(0,j.jsx)("br",{}),(0,j.jsx)(he,{})]})]})}var Te=function(e){var t=e.updateDrawCtrl,n=(0,d.useContext)(ht).drawCtrl;return"draw"===n.mode?(0,j.jsx)(z.Z,{content:(0,j.jsx)(Ae,{updateDrawCtrl:t,drawCtrl:n}),trigger:"click",placement:"bottom",getPopupContainer:function(e){return e},destroyTooltipOnHide:!0,children:(0,j.jsx)(Z.Z,{type:"default",shape:"circle",icon:(0,j.jsx)(ke.Z,{})})}):(0,j.jsx)(Z.Z,{type:"text",shape:"circle",onClick:function(){return t({mode:"draw"})},icon:(0,j.jsx)(ke.Z,{})})},Ae=function(e){var t=e.updateDrawCtrl,n=e.drawCtrl,r=n.lineWidth,a=n.highlight,i=n.color,u=(0,d.useState)(r),s=(0,o.Z)(u,2),c=s[0],l=s[1];return(0,j.jsxs)("div",{className:"pen-panel",children:[(0,j.jsxs)("div",{className:"pen-status",children:[(0,j.jsx)(V.Z,{min:5,max:100,defaultValue:c,onChange:l,onAfterChange:function(e){return t({lineWidth:e})}}),(0,j.jsx)(Z.Z,{type:a?"primary":"text",ghost:a,shape:"circle",icon:(0,j.jsx)(se,{type:"icon-Highlight"}),onClick:function(){return t({highlight:!a})}})]}),(0,j.jsx)(Le,{updateDrawCtrl:t,color:i})]})},Le=function(e){var t=e.updateDrawCtrl,n=e.color;return(0,j.jsx)("div",{className:"color-select",children:ee.O9.map((function(e){return(0,j.jsxs)("label",{children:[(0,j.jsx)("input",{checked:n===e,type:"radio",name:"color",onChange:function(){return t({color:e})}}),(0,j.jsx)("div",{className:"circle",style:{"--circle-color":e}})]},e)}))})},Me=function(e){var t=e.updateDrawCtrl,n=(0,d.useContext)(ht).drawCtrl,r=n.eraserWidth,a=n.mode,i=(0,d.useState)(r),u=(0,o.Z)(i,2),s=u[0],c=u[1],l=(0,j.jsx)("div",{className:"pen-panel",children:(0,j.jsx)(V.Z,{min:5,max:100,defaultValue:s,onChange:c,onAfterChange:function(e){return t({eraserWidth:e})}})});return"erase"===a?(0,j.jsx)(z.Z,{content:l,trigger:"click",placement:"bottom",getPopupContainer:function(e){return e},destroyTooltipOnHide:!0,children:(0,j.jsx)(Z.Z,{type:"default",shape:"circle",icon:(0,j.jsx)(se,{type:"icon-eraser"})})}):(0,j.jsx)(Z.Z,{type:"text",shape:"circle",onClick:function(){return t({mode:"erase"})},icon:(0,j.jsx)(se,{type:"icon-eraser"})})},We=function(e){var t=e.userID,n=(0,d.useState)(!1),r=(0,o.Z)(n,2),a=r[0],i=r[1],u=(0,d.useContext)(J.TeamCtx),s=u.ignores,c=u.setIgnores,l=u.resetIO,f=u.userRec[t];if((0,d.useEffect)((function(){return i(!1)}),[f]),!f)return null;var v=f.userName,p=f.online,h=t===(0,te.VN)(),m=s.has(t)&&!h;return(0,j.jsxs)("div",{className:X()("user-item",{online:p}),children:[(0,j.jsx)(Fe,{userID:t,size:"small",className:"room-avatar"}),a||(0,j.jsx)("span",{className:"user-name",children:v}),a&&(0,j.jsx)(q.Z,{autoFocus:!0,className:"rename-input",defaultValue:v,onSearch:function(e){var t=e.trim();if(!t||t===v)return i(!1);(0,te.lu)(t),l()},enterButton:(0,j.jsx)(Z.Z,{icon:(0,j.jsx)(Se.Z,{})})}),h?a||(0,j.jsx)(Z.Z,{type:"text",icon:(0,j.jsx)(je.Z,{}),onClick:function(){return i(!0)}}):(0,j.jsx)(Z.Z,{type:"text",icon:m?(0,j.jsx)(ye.Z,{}):(0,j.jsx)(Ce.Z,{}),onClick:function(){c((function(e){return e.has(t)?e.delete(t):e.add(t)}))}})]})},Fe=function(e){var t=e.userID,n=e.size,r=void 0===n?"default":n,a=e.onClick,i=void 0===a?function(){}:a,u=e.chosen,o=void 0!==u&&u,s=e.className,c=(0,d.useContext)(J.TeamCtx).userRec,l=(0,d.useMemo)((function(){return(0,ee.bM)(t)}),[t]),f=c[t];if(!f)return null;var v=f.userName;return(0,j.jsx)(_.C,{className:X()(s,{chosen:o}),size:r,style:{backgroundColor:l},children:(0,j.jsx)("div",{className:"avatar-wrapper",onClickCapture:function(e){e.stopPropagation(),i()},children:null===v||void 0===v?void 0:v.slice(0,3)})})},Ue=function(){var e=(0,d.useContext)(J.TeamCtx),t=e.code,n=e.userRec,a=e.connected,i=e.loadInfo,u=e.resetIO,o=window.location.href,c=function(){var e=(0,s.Z)(l().mark((function e(){var t,r;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=null===(t=n[(0,te.VN)()])||void 0===t?void 0:t.userName,e.prev=1,e.next=4,Ee()("".concat(r," shared a note with you at \ud835\udc0c\ud835\udc2e\ud835\udc25\ud835\udc2d\ud835\udc22\ud835\udc1b\ud835\udc22\ud835\udc25\ud835\udc22\ud835\udc2d\ud835\udc32.\n").concat(o));case 4:k.ZP.destroy("copy"),k.ZP.success({content:"Share link copied!",icon:(0,j.jsx)(F.Z,{}),key:"copy"}),e.next=11;break;case 8:e.prev=8,e.t0=e.catch(1),console.log(e.t0);case 11:case"end":return e.stop()}}),e,null,[[1,8]])})));return function(){return e.apply(this,arguments)}}(),f=(0,d.useMemo)((function(){var e=Object.values(n),t=(0,te.VN)(),a=n[t],i=a?[a]:[];return i.push.apply(i,(0,r.Z)(e.filter((function(e){var n=e.online,r=e.userID;return n&&r!==t}))).concat((0,r.Z)(e.filter((function(e){var n=e.online,r=e.userID;return!n&&r!==t}))))),i}),[n]),v=f.filter((function(e){return e.online})).length,p=(0,j.jsxs)("div",{className:"team-popover",children:[a||(0,j.jsx)(B.Z,{className:"disconn-alert",message:"Network failed.",icon:(0,j.jsx)(be.Z,{}),type:"error",showIcon:!0,banner:!0}),(0,j.jsx)(Q,{value:t}),(0,j.jsx)(Z.Z,{icon:(0,j.jsx)(De.Z,{}),className:"share-btn",onClick:c,block:!0,children:"Share"}),(0,j.jsx)(K.Z,{}),(0,j.jsx)("div",{className:"user-list",children:f.map((function(e){return(0,j.jsx)(We,{userID:e.userID},e.userID)}))})]}),h=(0,j.jsxs)("div",{className:"team-title",children:[(0,j.jsx)("span",{children:"Team info"}),(0,j.jsx)(Z.Z,{shape:"circle",type:"text",size:"small",icon:(0,j.jsx)(Pe.Z,{}),onClick:function(){i(),u()}})]});return(0,j.jsx)(z.Z,{content:p,trigger:"click",placement:"bottomRight",title:h,defaultVisible:!0,getPopupContainer:function(e){return e},children:(0,j.jsx)(Z.Z,{type:"text",icon:(0,j.jsx)(G.Z,{status:a?"success":"error",count:a?v:"!",size:"small",children:(0,j.jsx)(Ie.Z,{})})})})},ze=function(e){var t=e.instantSave,n=(0,d.useContext)(ht).noteID,r=(0,C.s0)(),a=function(){var e=(0,s.Z)(l().mark((function e(){return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t();case 2:return e.next=4,(0,D.r8)(n);case 4:if(e.sent){e.next=8;break}return k.ZP.error("Can't create room."),e.abrupt("return");case 8:return e.next=10,(0,w.SP)(n,{team:!0});case 10:r("/team/"+n);case 11:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}();return(0,j.jsx)(H.Z,{placement:"bottomRight",title:"Enable team editing?",onConfirm:a,okText:"Yes",cancelText:"No",children:(0,j.jsx)(Z.Z,{type:"text",icon:(0,j.jsx)(Oe.Z,{})})})},Ve=n(85955),_e=(n(22144),function(e){var t=e.onDelete,n=e.onRotate,r=e.onDuplicate,a=e.mutateStyle,u=e.currDrawCtrl,s={type:"text",shape:"round",size:"small"},c=(0,d.useRef)(null),l=(0,d.useState)(!1),f=(0,o.Z)(l,2),v=f[0],p=f[1],h=(0,d.useState)(0),m=(0,o.Z)(h,2),g=m[0],x=m[1],w=v?{transform:"translateX(".concat(g,"px)")}:void 0,k=(0,d.useState)(0),S=(0,o.Z)(k,2),y=S[0],C=S[1],b=y&&y%4===0?"animate__animated animate__headShake":void 0;return(0,Ve.useDrag)((function(e){var t=e.first,r=e.last,a=e.offset,i=e.delta;x(a[0]),n(i[0]/2),t&&p(!0),r&&p(!1)}),{target:c,filterTaps:!0,bounds:{left:-90,right:90}}),(0,j.jsxs)("div",{className:"select-tool",children:[(0,j.jsx)(z.Z,{trigger:"click",placement:"bottom",getPopupContainer:function(e){return e},destroyTooltipOnHide:!0,content:(0,j.jsx)(Ae,{updateDrawCtrl:a,drawCtrl:u}),children:(0,j.jsx)(Z.Z,(0,i.Z)({icon:(0,j.jsx)(M.Z,{})},s))}),(0,j.jsxs)("div",{className:X()("rotate-wrapper",{dragged:v}),ref:c,children:[(0,j.jsx)(Z.Z,(0,i.Z)({className:b,icon:(0,j.jsx)(W.Z,{}),onClick:function(){C((function(e){return e+1})),n(90,!0)}},s)),(0,j.jsx)("div",{className:"gear",style:w})]}),(0,j.jsx)(Z.Z,(0,i.Z)({icon:(0,j.jsx)(F.Z,{}),onClick:r},s)),(0,j.jsx)(Z.Z,(0,i.Z)({danger:!0,icon:(0,j.jsx)(U.Z,{}),onClick:t},s))]})}),Be=n(763),Ke=n(64309);var Ge=n(24610),He=n(12262),qe=n.n(He),Je=qe().Point,Ye=qe().Path,Xe=qe().Group,Qe=qe().Shape.Rectangle,$e=qe().Color,et=qe().Size,tt=qe().Raster,nt=function(e){var t=e.drawState,n=e.onChange,a=void 0===n?function(){}:n,u=e.otherStates,s=e.drawCtrl,c=void 0===s?p:s,l=e.readonly,f=void 0!==l&&l,v=e.preview,h=void 0!==v&&v,m=e.imgSrc,g=e.SelectTool,x=t.width,w=t.height,Z=c.mode,k=c.color,S=c.finger,y=c.lineWidth,C=c.highlight,b=c.eraserWidth,D=(0,d.useRef)(null),P=(0,d.useRef)(new(qe().PaperScope)),O=(0,d.useRef)(),N=(0,d.useRef)(),R=(0,d.useState)((0,E.l4)()),T=(0,o.Z)(R,2),A=T[0],L=T[1],M=(0,d.useRef)(1),W=(0,d.useState)(p),F=(0,o.Z)(W,2),U=F[0],z=F[1],V=(0,d.useState)(),_=(0,o.Z)(V,2),B=_[0],K=_[1];(0,d.useEffect)((function(){if(B){var e=0;return function t(){B.dashOffset+=3,e=requestAnimationFrame(t)}(),function(){B.remove(),cancelAnimationFrame(e)}}}),[B]);var G=(0,d.useState)(),H=(0,o.Z)(G,2),q=H[0],J=H[1];(0,d.useEffect)((function(){var e=q;return function(){null===e||void 0===e||e.removeChildren()}}),[q]);var Y=(0,d.useState)(!1),X=(0,o.Z)(Y,2),Q=X[0],$=X[1],ee="select"===Z&&Q?"selected":Z;(0,d.useEffect)((function(){"select"!==Z&&($(!1),K(void 0))}),[Z]),(0,d.useEffect)((function(){if(Q){if(null===B||void 0===B||!B.strokeColor)return;B.strokeColor.alpha/=2}else ce(),J(void 0),z(p)}),[Q]);var te=function(e){return function(e){return function(e){var t=e.touches[0];return"stylus"===(null===t||void 0===t?void 0:t.touchType)}(e)||S&&1===e.touches.length}(e)||e.stopPropagation()},ne=function(){var e,t=null===(e=D.current)||void 0===e?void 0:e.clientWidth;t&&(M.current=x/t)},re=function(e){P.current.activate();var t=P.current.view,n=t.center,r=t.zoom,a=P.current.view.projectToView(e).multiply(M.current),i=new Je(x,w).divide(2).subtract(n.multiply(r));return a.subtract(i).divide(r)},ae=function(e){ne(),P.current.activate();var t=re(e.point),n=st(t);K(n)},ie={draw:function(){ne(),P.current.activate(),N.current=ct(k,y,C)},erase:function(){ne(),P.current.activate(),N.current=ct("#0003",b)},select:function(e){ae(e)},selected:function(e){var t=re(e.point);B&&!t.isInside(B.strokeBounds)&&(ae(e),$(!1))}}[ee],ue={draw:function(e){if(N.current){P.current.activate();var t=re(e.point);N.current.add(t),N.current.smooth()}},erase:function(e){var t,n=N.current;if(n){P.current.activate();var r=re(e.point);n.add(r),n.smooth();var a=null===(t=O.current)||void 0===t?void 0:t.filter((function(e){return!A.has(e.name)})).filter((function(e){return ut(e,n)})).map((function(e){return e.name}));a&&L((function(e){return e.concat(a)}))}},select:function(e){if(B){P.current.activate();var t=e.delta.multiply(M.current);B.size=B.size.add(new et(t.x,t.y)),B.translate(t.divide(2))}},selected:function(e){if(B&&q){P.current.activate();var t=e.delta.multiply(M.current);B.translate(t),q.translate(t)}}}[ee],oe={erase:function(){N.current&&(P.current.activate(),N.current.remove(),a((function(e){return I.Dw.eraseStrokes(e,A.toArray())})),L((0,E.l4)()))},draw:function(){if(N.current&&0!==N.current.segments.length){P.current.activate(),N.current.simplify();var e=N.current.exportJSON();N.current.remove(),a((function(t){return I.Dw.addStroke(t,e)}))}},select:function(){if(B){var e=B.size.abs(),t=e.width,n=e.height;if(t<10||n<10)return K(void 0);P.current.activate();var r=O.current;if(r){var a=new Xe(ft(B,r));J(a);var u=dt(a);z((function(e){return(0,i.Z)((0,i.Z)({},e),u)})),$(!0)}}},selected:function(){}}[ee];(0,d.useEffect)((function(){!function(){if(D.current){P.current.setup(D.current);var e=h?200/x:1;P.current.view.viewSize=new et(x,w).multiply(e),P.current.view.scale(e,new Je(0,0)),ot(x,w)}}(),P.current.activate();var e=D.current;return function(){e&&(0,Ke.j)(e)}}),[]);(0,d.useEffect)((function(){f||(P.current.view.onMouseDown=ie,P.current.view.onMouseDrag=ue,P.current.view.onMouseUp=oe)})),(0,d.useEffect)((function(){if(m){var e,t=new Image;return t.src=m,t.onload=function(){var n;P.current.activate(),(e=new tt(t)).position=P.current.view.center;var r=x/t.width;e.scale(r),e.sendToBack(),null===(n=e.parent.getItem({name:"BGRECT"}))||void 0===n||n.sendToBack()},function(){var t;null===(t=e)||void 0===t||t.remove()}}}),[m]);var se=(0,d.useMemo)((function(){return u?I.Dw.mergeStates([t].concat((0,r.Z)(u))):t.getStrokeList()}),[t,u]);(0,d.useEffect)((function(){P.current.activate(),O.current=[];var e=[];return se.forEach((function(n){var r=t.hasStroke(n.uid)?O.current:e;at(n,r,A)})),function(){var t;null===(t=O.current)||void 0===t||t.forEach((function(e){return e.remove()})),e.forEach((function(e){return e.remove()}))}}),[se,A]);var ce=function(){var e=null===q||void 0===q?void 0:q.children;if(null!==e&&void 0!==e&&e.length){var t=e.map((function(e){return[e.name,e.exportJSON()]}));a((function(e){return I.Dw.mutateStrokes(e,t)}))}};return(0,d.useEffect)((function(){var e=function(e){return e.preventDefault()};return document.addEventListener("gesturestart",e),document.addEventListener("gesturechange",e),document.addEventListener("gestureend",e),function(){document.removeEventListener("gesturestart",e),document.removeEventListener("gesturechange",e),document.removeEventListener("gestureend",e)}}),[]),(0,Ve.usePinch)((function(e){var t=e.memo,n=e.offset,r=e.last,a=e.first,i=e.origin;if(D.current){var u,s,c,l,d;if(a||!t){ne(),P.current.activate();var f=D.current.getBoundingClientRect(),v=f.x,p=f.y;u=1,s=i[0]-v,c=i[1]-p,l=v,d=p}else{var h=(0,o.Z)(t,3);u=h[0];var m=(0,o.Z)(h[1],2);s=m[0],c=m[1];var g=(0,o.Z)(h[2],2);l=g[0],d=g[1]}var x=P.current.view,w=a?1:n[0]/u,Z=M.current,k=i[0]-l,S=i[1]-d,j=new Je(k,S).multiply(Z),y=x.viewToProject(j);x.scale(w,y);var C=new Je(k-s,S-c).multiply(Z/n[0]);if(x.translate(C),!r)return[n[0],[k,S],[l,d]];lt(x)}}),{scaleBounds:{max:5,min:.3},target:D}),(0,j.jsxs)("div",{className:"draw-wrapper",children:[(0,j.jsx)("canvas",{ref:D,className:"draw-canvas","data-paper-hidpi":!1,onTouchStartCapture:te,onTouchMoveCapture:te}),g&&"selected"===ee&&(0,j.jsx)(g,{onDelete:function(){var e=null===q||void 0===q?void 0:q.children;if(console.log(q),null!==e&&void 0!==e&&e.length){var t=e.map((function(e){return e.name}));a((function(e){return I.Dw.eraseStrokes(e,t)})),K(void 0),J(void 0),$(!1)}},onRotate:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(q){var n=t?10:1,r=e/n,a=function e(){q.rotate(r,null===B||void 0===B?void 0:B.position),null===B||void 0===B||B.rotate(r,B.position),--n>0&&requestAnimationFrame(e)};a()}},onDuplicate:function(){P.current.activate();var e=null===q||void 0===q?void 0:q.clone();ce(),J(e),null===e||void 0===e||e.children.forEach((function(e){return e.name=(0,Ge.v4)()}))},mutateStyle:function(e){q&&(P.current.activate(),vt(q,e,U.highlight),z((function(t){return(0,i.Z)((0,i.Z)({},t),e)})))},currDrawCtrl:U})]})},rt=d.memo(nt),at=function(e,t,n){var r=e.pathData,a=e.uid;try{var i=new Ye;i.importJSON(r),i.name=a,null!==n&&void 0!==n&&n.has(a)&&(i.opacity/=2),null===t||void 0===t||t.push(i)}catch(u){console.error(u)}},it=function(){var e=new WeakMap;return function(t,n){var r,a=e.get(t);if(a)return a;var i=t.point,u=null===(r=t.previous)||void 0===r?void 0:r.point;if(!u)return[];for(var o=i.subtract(u),s=o.length/n*2,c=[],l=0;l<s;l+=1)c.push(i.subtract(o.multiply(l/s)));return e.set(t,c),c}}(),ut=function(e,t){var n,r=null===(n=t.lastSegment.curve)||void 0===n?void 0:n.strokeBounds;if(!(e instanceof qe().Path)||null===r||void 0===r||!r.intersects(e.strokeBounds))return!1;if(t.intersects(e))return!0;var a=t.strokeWidth,i=t.lastSegment;return it(i,a).some((function(t){var n,r=null===(n=e.getNearestPoint(t))||void 0===n?void 0:n.getDistance(t);return r&&r<(e.strokeWidth+a)/2}))},ot=function(e,t){var n=new Qe(new Je(0,0),new Je(e,t));return n.fillColor=new $e("#fff"),n.name="BGRECT",n.sendToBack(),n},st=function(e){var t=new Qe(e,new et(0,0));return t.strokeColor=new $e("#1890ff"),t.strokeWidth=3,t.dashOffset=0,t.dashArray=[30,20],t},ct=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=new Ye,a=new $e(e);return n&&(a.alpha/=2,r.blendMode="multiply"),r.strokeColor=a,r.strokeWidth=t,r.strokeJoin="round",r.strokeCap="round",r},lt=function(e){var t=function(e){var t=e.center,n=e.zoom,r=e.viewSize,a=r.height,i=r.width,u=t.x,o=t.y;if(n<=1)return[i/2-u,a/2-o];var s=i*(n-1)/n/2,c=a*(n-1)/n/2,l=i/2-s,d=i/2+s,f=a/2-c,v=a/2+c;return[u<l?l-u:u>d?d-u:0,o<f?f-o:o>v?v-o:0]}(e),n=(0,o.Z)(t,2),r=n[0],a=n[1],i=10,u=new Je(r,a).divide(-i);!function t(){e.translate(u),--i>0&&requestAnimationFrame(t)}()},dt=function(e){var t={};return e.strokeColor&&(t.color=e.strokeColor.toCSS(!0)),e.strokeWidth&&(t.lineWidth=e.strokeWidth),e.children.every((function(e){var t;return.5===(null===(t=e.strokeColor)||void 0===t?void 0:t.alpha)}))&&(t.highlight=!0),t},ft=function(e,t){var n=e.strokeBounds;return t.filter((function(t){return t.isInside(n)||t.intersects(e)}))},vt=function(e,t,n){var r=t.lineWidth,a=t.color,i=t.highlight;a&&(e.strokeColor=new $e(a)),r&&(e.strokeWidth=r),!0!==i&&!0!==n||e.children.forEach((function(e){var t=e.strokeColor;t&&(1===t.alpha&&(t.alpha/=2),e.blendMode="multiply")})),!1===i&&e.children.forEach((function(e){var t=e.strokeColor;t&&(t.alpha=1,e.blendMode="normal")}))},pt=["pageRec","pdf","pageOrder"],ht=(0,d.createContext)({noteID:"",noteInfo:void 0,stateSet:void 0,teamState:void 0,pageRec:void 0,pageOrder:void 0,saved:!0,teamOn:!1,inviewPages:(0,E.l4)(),refRec:{},drawCtrl:p}),mt=(0,d.createContext)({scrollPage:function(e){},switchPageMarked:function(e){},setPageState:function(e,t){},addPage:function(e,t){},addFinalPage:function(){},deletePage:function(e){},saveReorder:function(){var e=(0,s.Z)(l().mark((function e(t,n){return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}(),setInviewPages:function(){},setDrawCtrl:function(){}});function gt(e){var t,n=e.teamOn,c=null!==(t=(0,C.UO)().noteID)&&void 0!==t?t:"",f=(0,C.s0)(),v=(0,d.useState)(),m=(0,o.Z)(v,2),g=m[0],S=m[1],b=(0,d.useState)(),O=(0,o.Z)(b,2),N=O[0],R=O[1],T=(0,d.useState)(),M=(0,o.Z)(T,2),W=M[0],F=M[1],U=(0,d.useState)(p),z=(0,o.Z)(U,2),V=z[0],_=z[1],B=(0,d.useState)(!0),K=(0,o.Z)(B,2),G=K[0],H=K[1],q=(0,d.useState)((0,E.l4)()),Y=(0,o.Z)(q,2),X=Y[0],Q=Y[1],$=(0,d.useState)(),ee=(0,o.Z)($,2),te=ee[0],ne=ee[1],re=(0,d.useRef)({}),ae=function(){var e=(0,d.useRef)(!1);return(0,d.useEffect)((function(){return e.current=!0,function(){e.current=!1}}),[]),e}(),ie=(0,d.useContext)(J.TeamCtx),ue=ie.teamState,oe=ie.teamUpdate,se=ie.pushOperation,ce=ie.pushNewPage,le=ie.pushReorder,de=function(){var e=(0,s.Z)(l().mark((function e(){var t,r,a,i;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,w.U9)(c);case 2:if(t=e.sent){e.next=6;break}return k.ZP.error("Note not found"),e.abrupt("return",f("/"));case 6:return r=t.pageRec,t.pdf,a=t.pageOrder,i=(0,u.Z)(t,pt),S(r),ne(a),R(i),F(A.createFromPages(r)),e.t0=_,e.next=14,h();case 14:e.t1=e.sent,(0,e.t0)(e.t1),n&&(0,D.f1)(c);case 17:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}();(0,d.useEffect)((function(){de()}),[c,n]);var fe=(0,d.useCallback)((0,Be.debounce)(function(){var e=(0,s.Z)(l().mark((function e(t){var n,r;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=document.querySelector("canvas"),r=null===n||void 0===n?void 0:n.toDataURL(),e.next=4,(0,w.SP)(c,{pageRec:t,thumbnail:r});case 4:ae.current&&H(!0);case 5:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),2e3),[]),ve=fe.flush;(0,d.useLayoutEffect)((function(){return function(){ve()}}),[]),(0,P.x)(ve),(0,d.useEffect)((function(){N&&(document.title=N.name+" - Multibility")}),[N]),(0,d.useEffect)((function(){if(oe){var e,t=oe.type;if("reorder"===t){var n=oe.pageOrder,r=oe.deleted,a=oe.prevOrder;if(ge(n),!r)return;e=function(){ge(a,!0)},k.ZP.warning({content:(0,j.jsxs)(j.Fragment,{children:["One page was deleted.",(0,j.jsx)(Z.Z,{size:"small",type:"link",onClick:function(){k.ZP.destroy("DELETE"),e()},children:"Undo"})]}),key:"DELETE",duration:10})}else if("newPage"===t){var i=oe.pageOrder,u=oe.pageID,o=oe.newPage;ge(i),pe(u,(function(){return o})),F((function(e){return null===e||void 0===e?void 0:e.addState(u,o)}))}else if("sync"===t){var s=oe.pageID,c=oe.stroke;F((function(e){return null===e||void 0===e?void 0:e.updateState(s,(function(e){return I.Dw.updateStroke(e,c)}))}))}}}),[oe]);var pe=function(e,t){S((function(n){if(n){var r=n[e],u=t(r);if(u){var o=(0,i.Z)((0,i.Z)({},n),{},(0,a.Z)({},e,u));return fe(o),o}}})),H(!1)},he=function(e,t){var n=I.Dw.flaten(t);pe(e,(function(e){return e&&(0,i.Z)((0,i.Z)({},e),{},{state:n})}))},me=(0,d.useCallback)((function(e,t){F((function(n){if(n){var r=n.getOneState(e);if(!r)return n;var a=t(r),i=n.setState(e,a);return i.lastOp&&se(i.lastOp),he(e,a),i}}))}),[]),ge=function(){var e=(0,s.Z)(l().mark((function e(t){var n,r=arguments;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.length>1&&void 0!==r[1]&&r[1],ne(t),e.next=4,(0,w.SP)(c,{pageOrder:t});case 4:return e.next=6,ve();case 6:n&&le(t);case 7:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),xe=function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(te){var n=t?g&&g[e]:void 0,r=(0,x.D)(n),a=(0,o.Z)(r,2),i=a[0],u=a[1],s=L(te,e,i);ce(s,i,u),ge(s),pe(i,(function(){return u})),F((function(e){return null===e||void 0===e?void 0:e.addState(i,u)}))}},we=(0,j.jsxs)("div",{className:"reader container",children:[(0,j.jsx)(Re,{handleUndo:function(){F((function(e){if(e){var t=e.undo(),n=t.getLastDS();return n&&he.apply(void 0,(0,r.Z)(n)),t.lastOp&&se(t.lastOp),t}}))},handleRedo:function(){F((function(e){if(e){var t=e.redo(),n=t.getLastDS();return n&&he.apply(void 0,(0,r.Z)(n)),t.lastOp&&se(t.lastOp),t}}))},instantSave:ve}),(0,j.jsxs)("main",{children:[null===te||void 0===te?void 0:te.map((function(e){return(0,j.jsx)(xt,{uid:e},e)})),(0,j.jsx)(y,{})]})]});return(0,j.jsx)(ht.Provider,{value:{noteID:c,noteInfo:N,stateSet:W,teamState:ue,saved:G,teamOn:n,pageRec:g,pageOrder:te,inviewPages:X,refRec:re.current,drawCtrl:V},children:(0,j.jsx)(mt.Provider,{value:{scrollPage:function(e){var t;null===(t=re.current[e])||void 0===t||t.scrollIntoView()},setInviewPages:Q,switchPageMarked:function(e){pe(e,(function(e){return e&&(0,i.Z)((0,i.Z)({},e),{},{marked:!e.marked})}))},setPageState:me,addPage:xe,addFinalPage:function(){var e=(0,Be.last)(te);e&&xe(e)},deletePage:function(e){var t=null===te||void 0===te?void 0:te.filter((function(t){return t!==e}));(null===t||void 0===t?void 0:t.length)&&ge(t,!0)},setDrawCtrl:_,saveReorder:ge},children:we})})}var xt=function(e){var t=e.uid,n=(0,d.useContext)(ht),r=n.pageRec,a=n.stateSet,i=n.teamState,u=(0,d.useContext)(mt).setPageState,o=r&&r[t],s=null===a||void 0===a?void 0:a.getOneState(t),c=null===i||void 0===i?void 0:i.getOnePageState(t),l=(0,d.useCallback)((function(e){return u(t,e)}),[t,u]);return o&&s?(0,j.jsx)(wt,{drawState:s,teamStateMap:c,updateState:l,pdfIndex:o.pdfIndex,uid:t}):null},wt=function(e){var t=e.thumbnail,r=e.drawState,a=e.teamStateMap,i=e.updateState,u=e.pdfIndex,c=e.preview,f=void 0!==c&&c,v=e.uid,p=(0,d.useContext)(mt).setInviewPages,h=(0,d.useContext)(ht),m=h.refRec,g=h.noteID,x=(0,d.useState)(),w=(0,o.Z)(x,2),Z=w[0],k=w[1],S=(0,b.YD)({delay:100}),y=(0,o.Z)(S,2),C=y[0],D=y[1],P=r.height/r.width,I=(0,d.useCallback)((function(e){e&&(C(e),!f&&m&&(m[v]=e))}),[m]),O=(0,d.useCallback)(function(){var e=!1;return(0,s.Z)(l().mark((function t(){var r,a;return l().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!f&&u&&!e){t.next=2;break}return t.abrupt("return");case 2:return e=!0,t.next=5,Promise.all([n.e(643),n.e(701)]).then(n.bind(n,21176));case 5:return r=t.sent,a=r.getOnePageImage,t.t0=k,t.next=10,a(g,u);case 10:t.t1=t.sent,(0,t.t0)(t.t1);case 12:case"end":return t.stop()}}),t)})))}(),[f,u]);(0,d.useEffect)((function(){f||(D?(O(),p((function(e){return e.add(v)}))):p((function(e){return e.delete(v)})))}),[D,O,f]);var N=(0,d.useContext)(J.TeamCtx).ignores,E=(0,d.useMemo)((function(){return a&&Array.from(a.deleteAll(N).values())}),[a,N]),R=Z||!u,T=D&&R,A=Boolean(f||!R);return(0,j.jsxs)("section",{ref:I,className:"note-page",style:{paddingTop:"".concat(100*P,"%")},children:[T&&(0,j.jsx)(Zt,{drawState:r,otherStates:E,updateState:i,imgSrc:Z||t,preview:f}),A&&(0,j.jsx)("div",{className:"mask"})]})};wt.displayName="PageWrapper";var Zt=function(e){var t=e.drawState,n=e.updateState,r=e.otherStates,a=e.preview,i=void 0!==a&&a,u=e.imgSrc,o=(0,d.useContext)(ht).drawCtrl,s=(0,d.useCallback)((function(e){if(n){var t=e instanceof I.Dw?function(){return e}:e;n(t)}}),[n]);return i?(0,j.jsx)(rt,{drawState:t,otherStates:r,imgSrc:u,readonly:!0,preview:!0}):(0,j.jsx)(rt,{drawState:t,otherStates:r,onChange:s,imgSrc:u,drawCtrl:o,SelectTool:_e})};Zt.displayName="DrawWrapper"},91511:function(e,t,n){"use strict";n.r(t),n.d(t,{TeamCtx:function(){return I},default:function(){return O}});var r=n(45987),a=n(1413),i=n(29439),u=n(15861),o=n(87757),s=n.n(o),c=n(49496),l=n(72791),d=n(51570),f=n(56058),v=n(87962),p=n(16871),h=n(15671),m=n(43144),g=n(24124),x=n(82670),w=["pageID"],Z={pageStates:(0,g.D5)(),pageInfos:(0,g.D5)()},k=(0,g.WV)(Z),S=function(){function e(t){(0,h.Z)(this,e),this.immutable=t}return(0,m.Z)(e,[{key:"getImmutable",value:function(){return this.immutable}},{key:"getPageStates",value:function(){return this.getImmutable().get("pageStates")}},{key:"getPageInfos",value:function(){return this.getImmutable().get("pageInfos")}},{key:"getOneState",value:function(e,t){var n;return null===(n=this.getPageStates().get(e))||void 0===n?void 0:n.get(t)}},{key:"getOnePageState",value:function(e){return this.getPageStates().get(e)}},{key:"getOnePageValidUser",value:function(e){var t=this.getOnePageState(e);return t?Array.from(null===t||void 0===t?void 0:t.filter((function(e){return!e.isEmpty()})).keys()):[]}},{key:"getPageRatio",value:function(e){var t;return null===(t=this.getPageInfos().get(e))||void 0===t?void 0:t.ratio}},{key:"includesPage",value:function(e){return this.getPageStates().has(e)}},{key:"setState",value:function(t,n,r){var a=this.getPageStates().get(t);return a?new e(this.getImmutable().update("pageStates",(function(e){return e.set(t,a.set(n,r))}))):this}},{key:"addPage",value:function(t,n){var r=n.ratio;return new e(this.getImmutable().update("pageStates",(function(e){return e.set(t,(0,g.D5)())})).update("pageInfos",(function(e){return e.set(t,{ratio:r})})))}},{key:"pushOperation",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:x.mF,a=e.pageID,i=(0,r.Z)(e,w),u=this.getPageRatio(a);if(!this.includesPage(a)||!u)return this;var o=this.getOneState(a,t)||x.Dw.createEmpty(n,n*u),s=x.Dw.pushOperation(o,i);return this.setState(a,t,s)}},{key:"resetUser",value:function(e,t){for(var n=this,r=0,a=Object.entries(t);r<a.length;r++){var u=(0,i.Z)(a[r],2),o=u[0],s=u[1],c=s.state,l=s.ratio,d=n.getOneState(o,e);if(d){var f=d.width;n=n.setState(o,e,x.Dw.loadFromFlat(c,f,f*l))}}return n}}],[{key:"createFromTeamPages",value:function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:x.mF,r=k();return Object.entries(t).forEach((function(e){var t=(0,i.Z)(e,2),a=t[0],u=t[1],o=u.states,s=u.ratio,c=(0,g.D5)(Object.entries(o).map((function(e){var t=(0,i.Z)(e,2),r=t[0],a=t[1];return[r,x.Dw.loadFromFlat(a,n,n*s)]})));r=r.update("pageStates",(function(e){return e.set(a,c)})).update("pageInfos",(function(e){return e.set(a,{ratio:s})}))})),new e(r)}}]),e}(),j=n(69951),y=n(29609),C=function(e){return function(){return(0,y.io)(d._n,{query:{userID:(0,j.VN)(),userName:(0,j.vW)(),noteID:e}})}},b=n(84341),D=n(80184),P=["image","marked"],I=(0,l.createContext)({code:-2,connected:!1,ignores:(0,g.l4)(),userRec:{},teamState:void 0,teamUpdate:void 0,resetIO:function(){},loadInfo:function(){var e=(0,u.Z)(s().mark((function e(){return s().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",!1);case 1:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),setIgnores:function(){},pushReorder:function(e){},pushNewPage:function(e,t,n){},pushOperation:function(e){}});function O(){var e,t=null!==(e=(0,p.UO)().noteID)&&void 0!==e?e:"",n=(0,l.useState)(),o=(0,i.Z)(n,2),h=o[0],m=o[1],x=(0,l.useState)(-2),w=(0,i.Z)(x,2),Z=w[0],k=w[1],y=(0,l.useState)({}),O=(0,i.Z)(y,2),N=O[0],E=O[1],R=(0,l.useState)((0,g.l4)()),T=(0,i.Z)(R,2),A=T[0],L=T[1],M=(0,l.useState)(C(t)),W=(0,i.Z)(M,2),F=W[0],U=W[1],z=(0,l.useState)(),V=(0,i.Z)(z,2),_=V[0],B=V[1],K=(0,l.useState)(!1),G=(0,i.Z)(K,2),H=G[0],q=G[1],J=(0,l.useState)(!1),Y=(0,i.Z)(J,2),X=Y[0],Q=Y[1],$=(0,p.s0)(),ee=function(){var e=(0,u.Z)(s().mark((function e(){var n;return s().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,d.CD)(t);case 2:if(n=e.sent){e.next=6;break}return c.ZP.error("Failed loading the team note state"),e.abrupt("return",!1);case 6:return m(S.createFromTeamPages(n)),e.abrupt("return",!0);case 8:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),te=function(){var e=(0,u.Z)(s().mark((function e(){var n;return s().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,d.dn)(t);case 2:if(n=e.sent){e.next=6;break}return c.ZP.error("Failed loading the team note info"),e.abrupt("return",!1);case 6:return k(n.code),e.abrupt("return",!0);case 8:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),ne=function(){var e=(0,u.Z)(s().mark((function e(){return s().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return c.ZP.loading({content:"Loading team note...",key:"TEAM_LOADING",duration:0}),e.next=3,te();case 3:if(e.t0=e.sent,!e.t0){e.next=8;break}return e.next=7,ee();case 7:e.t0=e.sent;case 8:if(e.t0){e.next=11;break}return c.ZP.destroy("TEAM_LOADING"),e.abrupt("return",$("/"));case 11:c.ZP.destroy("TEAM_LOADING"),q(!0);case 13:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}();(0,l.useEffect)((function(){return F.on("push",(function(e){var t=e.operation,n=e.userID;m((function(e){return null===e||void 0===e?void 0:e.pushOperation(t,n)}))})),F.on("join",(function(e){var t=e.joined,n=e.members,r=t.userID,a=t.userName;E(n),r!==(0,j.VN)()&&(c.ZP.destroy(r),c.ZP.success({content:"".concat(a," joined room"),icon:(0,D.jsx)(f.Z,{}),key:r}))})),F.on("leave",(function(e){var t=e.leaved,n=e.members,r=t.userID,a=t.userName;if(E(n),r===(0,j.VN)())return F.emit("join");c.ZP.destroy(r),c.ZP.warning({content:"".concat(a," leaved room"),icon:(0,D.jsx)(v.Z,{}),key:r})})),F.on("reorder",(function(e){B((0,a.Z)({type:"reorder"},e))})),F.on("newPage",(function(e){var t=e.pageID,n=e.newPage;m((function(e){return null===e||void 0===e?void 0:e.addPage(t,n)})),B((0,a.Z)({type:"newPage"},e))})),F.on("reset",(function(e){var t=e.userID,n=e.pageRec;t!==(0,j.VN)()&&m((function(e){return null===e||void 0===e?void 0:e.resetUser(t,n)}))})),F.on("connect_error",console.error),F.on("connect",(function(){return Q(!0)})),F.on("disconnect",(function(){return Q(!1)})),function(){F.removeAllListeners(),F.close()}}),[F]);var re=function(){c.ZP.destroy("TEAM_LOADING")};(0,l.useEffect)((function(){return ne(),re}),[t]);return H?(0,D.jsx)(I.Provider,{value:{code:Z,ignores:A,userRec:N,connected:X,teamState:h,teamUpdate:_,resetIO:function(){return U(C(t))},loadInfo:te,setIgnores:L,pushReorder:function(e){F.emit("reorder",{pageOrder:e})},pushNewPage:function(e,t,n){m((function(e){return null===e||void 0===e?void 0:e.addPage(t,n)}));n.image,n.marked;var a=(0,r.Z)(n,P);F.emit("newPage",{pageOrder:e,pageID:t,newPage:a})},pushOperation:function(e){F.emit("push",{operation:e},(function(e){var t=e.stroke,n=e.pageID;B({type:"sync",stroke:t,pageID:n})}))}},children:(0,D.jsx)(b.default,{teamOn:!0})}):null}},64309:function(e,t,n){"use strict";function r(e,t){var n=document.createElement("canvas"),r=n.getContext("2d");if(!r)throw new Error("can't get virtual canvas context");return n.width=e,n.height=t,{canvas:n,context:r}}function a(e){e.width=1,e.height=1;var t=e.getContext("2d");null===t||void 0===t||t.clearRect(0,0,1,1)}n.d(t,{j:function(){return a},v:function(){return r}})},90858:function(){},64158:function(){}}]);
//# sourceMappingURL=274.1112f2db.chunk.js.map