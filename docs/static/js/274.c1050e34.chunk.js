(self.webpackChunkmultibility=self.webpackChunkmultibility||[]).push([[274],{84341:function(e,t,n){"use strict";n.r(t),n.d(t,{PageWrapper:function(){return wt},ReaderMethodCtx:function(){return mt},ReaderStateCtx:function(){return ht},default:function(){return gt}});var r=n(93433),a=n(1413),i=n(45987),u=n(29439),o=n(15861),s=n(87757),c=n.n(s),l=n(72791),d=n(61842),f=n.n(d),v={mode:"draw",finger:!0,lineWidth:10,eraserWidth:10,color:"#000000",highlight:!1};function p(){return h.apply(this,arguments)}function h(){return(h=(0,o.Z)(c().mark((function e(){var t;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,f().getItem("DRAW_CTRL");case 2:if(t=e.sent){e.next=7;break}return t=v,e.next=7,f().setItem("DRAW_CTRL",t);case 7:return e.abrupt("return",t);case 8:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function m(){return(m=(0,o.Z)(c().mark((function e(t){return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,f().setItem("DRAW_CTRL",t);case 2:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var g=n(92198),x=n(15671),w=n(43144),k=n(24124),Z=n(82670),S={states:(0,k.D5)(),editStack:(0,k.aV)(),undoStack:(0,k.aV)()},j=(0,k.WV)(S),y=function(){function e(t,n){(0,x.Z)(this,e),this.immutable=t,this.lastOp=n}return(0,w.Z)(e,[{key:"getImmutable",value:function(){return this.immutable}},{key:"getStates",value:function(){return this.getImmutable().get("states")}},{key:"getOneState",value:function(e){return this.getStates().get(e)}},{key:"getEditStack",value:function(){return this.getImmutable().get("editStack")}},{key:"getUndoStack",value:function(){return this.getImmutable().get("undoStack")}},{key:"setState",value:function(t,n){var r=this.getOneState(t);if(!r||r===n)return this;var i=this.getImmutable().update("states",(function(e){return e.set(t,n)})).update("editStack",(function(e){return e.push(t)})).delete("undoStack"),u=n.lastOp;return new e(i,u&&(0,a.Z)((0,a.Z)({},u),{},{pageID:t}))}},{key:"updateState",value:function(t,n){var r=this.getOneState(t);if(!r)return this;var a=n(r);return new e(this.getImmutable().update("states",(function(e){return e.set(t,a)})))}},{key:"addState",value:function(t,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Z.mF,a=n.state,i=n.ratio,u=Z.Dw.loadFromFlat(a,r,r*i),o=this.getImmutable().update("states",(function(e){return e.set(t,u)}));return new e(o)}},{key:"deleteState",value:function(t){return new e(this.getImmutable().update("states",(function(e){return e.delete(t)})))}},{key:"isUndoable",value:function(){return this.getEditStack().size>0}},{key:"isRedoable",value:function(){return this.getUndoStack().size>0}},{key:"undo",value:function(){if(!this.isUndoable())return this;var t=this.getEditStack().last(),n=t&&this.getOneState(t);if(!n)return this;var r=Z.Dw.undo(n),i=r.lastOp,u=i&&(0,a.Z)({pageID:t},i);return new e(this.getImmutable().update("editStack",(function(e){return e.pop()})).update("undoStack",(function(e){return e.push(t)})).update("states",(function(e){return e.set(t,r)})),u)}},{key:"redo",value:function(){if(!this.isRedoable())return this;var t=this.getUndoStack().last(),n=t&&this.getOneState(t);if(!n)return this;var r=Z.Dw.redo(n),i=r.lastOp,u=i&&(0,a.Z)({pageID:t},i);return new e(this.getImmutable().update("undoStack",(function(e){return e.pop()})).update("editStack",(function(e){return e.push(t)})).update("states",(function(e){return e.set(t,r)})),u)}},{key:"getLastDS",value:function(){var e,t=null===(e=this.lastOp)||void 0===e?void 0:e.pageID,n=t&&this.getOneState(t);return n?[t,n]:void 0}}],[{key:"createFromList",value:function(t){return new e(j().set("states",(0,k.D5)(t)))}},{key:"createFromPages",value:function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Z.mF,r=Object.entries(t);return e.createFromList(r.map((function(e){var t=(0,u.Z)(e,2),r=t[0],a=t[1],i=a.state,o=a.ratio;return[r,Z.Dw.loadFromFlat(i,n,n*o)]})))}}]),e}(),C=n(19458),b=n(87309),D=n(49496),P=n(79286),I=n(80184),N=function(){var e=(0,l.useContext)(mt).addFinalPage;return(0,I.jsx)("div",{className:"add-btn-wrapper",children:(0,I.jsx)(b.Z,{type:"dashed",icon:(0,I.jsx)(P.Z,{}),block:!0,onClick:e,children:"New page"})})},O=n(16871),E=n(58105),R=n(51570),T=n(97725);function A(e,t,n){var r=e.indexOf(t),a=e.slice();return-1===r||a.splice(r+1,0,n),a}var L=n(763),M=n(61507),W=n(79784),F=n(23414),z=n(82622),V=n(69228),U=n(96272),B=n(76586),_=n(90785),K=n(91333),G=n(75594),H=n(4240),q=n(95055),J=n(91511),Y=n(81694),X=n.n(Y);function Q(e){var t=e.value,n=(0,l.useState)(9999),r=(0,u.Z)(n,2),a=r[0],i=r[1],o=String(t>=0?t:a).padStart(4,"0").split("").map((function(e){return Number(e)}));function s(){i(Math.floor(1e4*Math.random()))}return(0,l.useEffect)((function(){if(-1!==t)return i(9999);var e=setTimeout(s,100);return function(){return clearTimeout(e)}}),[t]),(0,I.jsx)("div",{className:X()("digit-display",{disabled:-2===t}),children:o.map((function(e,t){return(0,I.jsx)($,{digit:e},t)}))})}function $(e){var t=e.digit;return t<=9&&t>=0?(0,I.jsx)("div",{className:"digit",children:t}):(0,I.jsx)("div",{className:"digit",children:"*"})}var ee=n(74115),te=n(69951),ne=n(10711),re=n(53621),ae=n(75797),ie=n(29798),ue=n(70140),oe=n(87661),se=n(67629),ce=(0,n(92721).Z)({scriptUrl:"//at.alicdn.com/t/font_3181679_eb02zt96p4p.js"}),le=function(e){var t=e.activeKey,n=e.setActiveKey,r=(0,l.useContext)(ht),i=r.pageOrder,o=r.inviewPages,s=(0,l.useContext)(mt),c=s.scrollPage,d=s.saveReorder,f=(0,l.useRef)({}),v=(0,l.useRef)(),p=(0,l.useMemo)((function(){return(null===i||void 0===i?void 0:i.find((function(e){return o.has(e)})))||""}),[i,o]);return(0,l.useEffect)((function(){var e,t,n,r;null===(e=f.current[p])||void 0===e||e.scrollIntoView();var a=(null===(t=f.current[p])||void 0===t?void 0:t.clientHeight)||0,i=(null===(n=v.current)||void 0===n?void 0:n.clientHeight)||0;null===(r=v.current)||void 0===r||r.scrollBy(0,-i/2+a/2)}),[]),(0,I.jsxs)("div",{className:"preview-container",children:[(0,I.jsx)(pe,{activeKey:t,setActiveKey:n}),(0,I.jsx)(ie.Z5,{onDragEnd:function(e){var t=e.source,n=e.destination;if(n&&i){var r=t.index,a=n.index;if(r!==a){var o=i[r],s=function(e,t,n){var r=e.slice(),a=r.splice(t,1),i=(0,u.Z)(a,1)[0];return r.splice(n,0,i),r}(i,r,a);d(s,!0),requestAnimationFrame((function(){return c(o)}))}}},children:(0,I.jsx)(ie.bK,{droppableId:"droppable",children:function(e){var n=e.droppableProps,r=e.innerRef,u=e.placeholder;return(0,I.jsxs)("div",(0,a.Z)((0,a.Z)({className:"page-list",ref:function(e){r(e),e&&(v.current=e)}},n),{},{children:[null===i||void 0===i?void 0:i.map((function(e,n){return(0,I.jsx)(de,{uid:e,mode:t,pageIndex:n,currpageID:p,refRec:f.current},e)})),u,"ALL"===t&&(0,I.jsx)(N,{})]}))}})})]})},de=function(e){var t=e.uid,n=e.pageIndex,r=e.mode,i=e.currpageID,o=e.refRec,s=(0,l.useContext)(ht),c=s.stateSet,d=s.teamState,f=s.pageRec,v=(0,l.useContext)(mt),p=v.scrollPage,h=v.switchPageMarked,m=(0,l.useContext)(J.TeamCtx).ignores,g=(0,l.useState)(""),x=(0,u.Z)(g,2),w=x[0],k=x[1],Z=null===f||void 0===f?void 0:f.get(t),S=null===c||void 0===c?void 0:c.getOneState(t),j=null===d||void 0===d?void 0:d.getOnePageStateMap(t),y=(0,l.useMemo)((function(){return null===d||void 0===d?void 0:d.getPageValidUsers(t).filter((function(e){return!m.has(e)}))}),[d,m,t]);if(!Z||!S)return null;if("WRITTEN"===r&&S.isEmpty()&&(!j||j.every((function(e){return e.isEmpty()}))))return null;if("MARKED"===r&&!Z.marked)return null;var C=function(e){h(t),e.stopPropagation()},b=i===t;return(0,I.jsx)(ie._l,{draggableId:t,index:n,isDragDisabled:"ALL"!==r,children:function(e,r){var i=e.innerRef,u=e.draggableProps,s=e.dragHandleProps,c=r.isDragging,l=Z.image,d=Z.marked;return(0,I.jsxs)("div",(0,a.Z)((0,a.Z)((0,a.Z)({ref:function(e){i(e),e&&(o[t]=e)},className:X()("page",{curr:b,drag:c}),onClick:function(){return p(t)}},u),s),{},{children:[(0,I.jsx)(wt,{uid:t,drawState:(null===j||void 0===j?void 0:j.get(w))||S,teamStateMap:w?void 0:j,thumbnail:l,preview:!0}),(0,I.jsx)("span",{className:X()("bookmark",{marked:d}),onClickCapture:C}),(0,I.jsx)("span",{className:"index",children:n+1}),(0,I.jsx)(fe,{userIDs:y,chosen:w,setChosen:k}),(0,I.jsx)(ve,{uid:t})]}))}})},fe=function(e){var t=e.userIDs,n=e.chosen,r=e.setChosen;return(0,I.jsx)(B.C.Group,{maxCount:2,size:"default",className:X()("team-group",{chosen:n}),children:null===t||void 0===t?void 0:t.map((function(e){return(0,I.jsx)(Fe,{size:"default",userID:e,className:"preview-avatar",chosen:n===e,onClick:function(){return r((function(t){return t===e?"":e}))}},e)}))})},ve=function(e){var t=e.uid,n=(0,l.useState)(!1),r=(0,u.Z)(n,2),a=r[0],i=r[1],o=(0,l.useContext)(mt),s=o.addPage,c=o.deletePage,d=(0,I.jsx)(ue.Z,{onClick:function(e){var n=e.key,r=e.domEvent;"ADD"===n?s(t):"COPY"===n?s(t,!0):"DELETE"===n&&c(t),r.stopPropagation(),i(!1)},items:[{key:"ADD",icon:(0,I.jsx)(P.Z,{}),label:"Add page"},{key:"COPY",icon:(0,I.jsx)(F.Z,{}),label:"Duplicate"},{key:"DELETE",icon:(0,I.jsx)(z.Z,{}),label:"Delete",danger:!0}]});return(0,I.jsx)(V.Z,{content:d,trigger:"click",placement:"left",visible:a,onVisibleChange:i,destroyTooltipOnHide:!0,children:(0,I.jsx)("span",{className:"option",onClickCapture:function(e){i((function(e){return!e})),e.stopPropagation()},children:(0,I.jsx)(ne.Z,{})})})},pe=function(e){var t=e.activeKey,n=e.setActiveKey,r=oe.Z.TabPane;return(0,I.jsxs)(oe.Z,{className:"tabs",activeKey:t,onChange:n,tabBarGutter:10,size:"small",centered:!0,children:[(0,I.jsx)(r,{tab:(0,I.jsx)(ce,{type:"icon-uf_paper"})},"ALL"),(0,I.jsx)(r,{tab:(0,I.jsx)(ce,{type:"icon-bookmark2"})},"MARKED"),(0,I.jsx)(r,{tab:(0,I.jsx)(ce,{type:"icon-write"})},"WRITTEN")]})};function he(){var e=(0,l.useState)(!1),t=(0,u.Z)(e,2),n=t[0],r=t[1],a=(0,l.useState)("ALL"),i=(0,u.Z)(a,2),o=i[0],s=i[1],c={ALL:"All Pages",MARKED:"Bookmarks",WRITTEN:"Notes"}[o];return(0,I.jsxs)(I.Fragment,{children:[(0,I.jsx)(b.Z,{type:"text",icon:n?(0,I.jsx)(re.Z,{}):(0,I.jsx)(ae.Z,{}),onClick:function(){return r((function(e){return!e}))}}),(0,I.jsx)(se.Z,{visible:n,onClose:function(){return r(!1)},width:200,title:c,closable:!1,className:"preview-drawer",contentWrapperStyle:{boxShadow:"none"},bodyStyle:{padding:0,overflow:"hidden"},headerStyle:{textAlign:"center",borderTop:"1px solid #eee"},destroyOnClose:!0,children:(0,I.jsx)(le,{activeKey:o,setActiveKey:s})})]})}var me=n(52242),ge=n(65323),xe=n(78030),we=n(50446),ke=n(14988),Ze=n(62),Se=n(67575),je=n(30501),ye=n(98272),Ce=n(24215),be=n(17973),De=n(19951),Pe=n(23605),Ie=n(56200),Ne=n(18301),Oe=n(1829),Ee=n.n(Oe);function Re(e){var t=e.handleUndo,n=e.handleRedo,r=e.instantSave,i=(0,l.useContext)(ht),u=i.saved,s=i.stateSet,d=i.teamOn,f=i.drawCtrl,v=f.mode,p=(0,l.useContext)(mt).setDrawCtrl,h=f.finger,g=(0,O.s0)(),x=function(e){p((function(t){var n=(0,a.Z)((0,a.Z)({},t),e);return function(e){m.apply(this,arguments)}(n),n}))};return(0,I.jsxs)("header",{children:[(0,I.jsxs)("div",{className:"left",children:[(0,I.jsx)(b.Z,{type:"text",onClick:(0,o.Z)(c().mark((function e(){return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r();case 2:g("/");case 3:case"end":return e.stop()}}),e)}))),icon:(0,I.jsx)(me.Z,{style:{opacity:.8}})}),(0,I.jsx)("br",{}),(0,I.jsx)(b.Z,{type:"text",className:"save",onClick:r,disabled:u,icon:(0,I.jsx)(ge.Z,{})})]}),(0,I.jsxs)("div",{className:"middle",children:[(0,I.jsx)(b.Z,{type:"text",shape:"circle",icon:(0,I.jsx)(xe.Z,{}),onClick:t,disabled:!(null!==s&&void 0!==s&&s.isUndoable())}),(0,I.jsx)(b.Z,{className:"redo",type:"text",shape:"circle",icon:(0,I.jsx)(we.Z,{}),onClick:n,disabled:!(null!==s&&void 0!==s&&s.isRedoable())}),(0,I.jsx)("br",{}),(0,I.jsx)(Te,{updateDrawCtrl:x}),(0,I.jsx)(Me,{updateDrawCtrl:x}),(0,I.jsx)(b.Z,{type:["select","selected"].includes(v)?"default":"text",shape:"circle",onClick:function(){return x({mode:"select"})},icon:(0,I.jsx)(ke.Z,{})}),(0,I.jsx)(b.Z,{className:"finger",type:h?"primary":"text",ghost:h,shape:"circle",onClick:function(){return x({finger:!h})},icon:(0,I.jsx)(ce,{type:"icon-finger"})})]}),(0,I.jsxs)("div",{className:"right",children:[d&&(0,I.jsx)(ze,{}),d||(0,I.jsx)(Ve,{instantSave:r}),(0,I.jsx)("br",{}),(0,I.jsx)(he,{})]})]})}var Te=function(e){var t=e.updateDrawCtrl,n=(0,l.useContext)(ht).drawCtrl;return"draw"===n.mode?(0,I.jsx)(V.Z,{content:(0,I.jsx)(Ae,{updateDrawCtrl:t,drawCtrl:n}),trigger:"click",placement:"bottom",getPopupContainer:function(e){return e},destroyTooltipOnHide:!0,children:(0,I.jsx)(b.Z,{type:"default",shape:"circle",icon:(0,I.jsx)(Ze.Z,{})})}):(0,I.jsx)(b.Z,{type:"text",shape:"circle",onClick:function(){return t({mode:"draw"})},icon:(0,I.jsx)(Ze.Z,{})})},Ae=function(e){var t=e.updateDrawCtrl,n=e.drawCtrl,r=n.lineWidth,a=n.highlight,i=n.color,o=(0,l.useState)(r),s=(0,u.Z)(o,2),c=s[0],d=s[1];return(0,I.jsxs)("div",{className:"pen-panel",children:[(0,I.jsxs)("div",{className:"pen-status",children:[(0,I.jsx)(U.Z,{min:5,max:100,defaultValue:c,onChange:d,onAfterChange:function(e){return t({lineWidth:e})}}),(0,I.jsx)(b.Z,{type:a?"primary":"text",ghost:a,shape:"circle",icon:(0,I.jsx)(ce,{type:"icon-Highlight"}),onClick:function(){return t({highlight:!a})}})]}),(0,I.jsx)(Le,{updateDrawCtrl:t,color:i})]})},Le=function(e){var t=e.updateDrawCtrl,n=e.color;return(0,I.jsx)("div",{className:"color-select",children:ee.O9.map((function(e){return(0,I.jsxs)("label",{children:[(0,I.jsx)("input",{checked:n===e,type:"radio",name:"color",onChange:function(){return t({color:e})}}),(0,I.jsx)("div",{className:"circle",style:{"--circle-color":e}})]},e)}))})},Me=function(e){var t=e.updateDrawCtrl,n=(0,l.useContext)(ht).drawCtrl,r=n.eraserWidth,a=n.mode,i=(0,l.useState)(r),o=(0,u.Z)(i,2),s=o[0],c=o[1],d=(0,I.jsx)("div",{className:"pen-panel",children:(0,I.jsx)(U.Z,{min:5,max:100,defaultValue:s,onChange:c,onAfterChange:function(e){return t({eraserWidth:e})}})});return"erase"===a?(0,I.jsx)(V.Z,{content:d,trigger:"click",placement:"bottom",getPopupContainer:function(e){return e},destroyTooltipOnHide:!0,children:(0,I.jsx)(b.Z,{type:"default",shape:"circle",icon:(0,I.jsx)(ce,{type:"icon-eraser"})})}):(0,I.jsx)(b.Z,{type:"text",shape:"circle",onClick:function(){return t({mode:"erase"})},icon:(0,I.jsx)(ce,{type:"icon-eraser"})})},We=function(e){var t=e.userID,n=(0,l.useState)(!1),r=(0,u.Z)(n,2),a=r[0],i=r[1],o=(0,l.useContext)(J.TeamCtx),s=o.ignores,c=o.setIgnores,d=o.resetIO,f=o.userRec[t];if((0,l.useEffect)((function(){return i(!1)}),[f]),!f)return null;var v=f.userName,p=f.online,h=t===(0,te.VN)(),m=s.has(t)&&!h;return(0,I.jsxs)("div",{className:X()("user-item",{online:p}),children:[(0,I.jsx)(Fe,{userID:t,size:"small",className:"room-avatar"}),a||(0,I.jsx)("span",{className:"user-name",children:v}),a&&(0,I.jsx)(q.Z,{autoFocus:!0,className:"rename-input",defaultValue:v,onSearch:function(e){var t=e.trim();if(!t||t===v)return i(!1);(0,te.lu)(t),d()},enterButton:(0,I.jsx)(b.Z,{icon:(0,I.jsx)(Se.Z,{})})}),h?a||(0,I.jsx)(b.Z,{type:"text",icon:(0,I.jsx)(je.Z,{}),onClick:function(){return i(!0)}}):(0,I.jsx)(b.Z,{type:"text",icon:m?(0,I.jsx)(ye.Z,{}):(0,I.jsx)(Ce.Z,{}),onClick:function(){c((function(e){return e.has(t)?e.delete(t):e.add(t)}))}})]})},Fe=function(e){var t=e.userID,n=e.size,r=void 0===n?"default":n,a=e.onClick,i=void 0===a?function(){}:a,u=e.chosen,o=void 0!==u&&u,s=e.className,c=(0,l.useContext)(J.TeamCtx).userRec,d=(0,l.useMemo)((function(){return(0,ee.bM)(t)}),[t]),f=c[t];if(!f)return null;var v=f.userName;return(0,I.jsx)(B.C,{className:X()(s,{chosen:o}),size:r,style:{backgroundColor:d},children:(0,I.jsx)("div",{className:"avatar-wrapper",onClickCapture:function(e){e.stopPropagation(),i()},children:null===v||void 0===v?void 0:v.slice(0,3)})})},ze=function(){var e=(0,l.useContext)(J.TeamCtx),t=e.code,n=e.userRec,a=e.connected,i=e.loadInfo,u=e.resetIO,s=window.location.href,d=function(){var e=(0,o.Z)(c().mark((function e(){var t,r;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=null===(t=n[(0,te.VN)()])||void 0===t?void 0:t.userName,e.prev=1,e.next=4,Ee()("".concat(r," shared a note with you at \ud835\udc0c\ud835\udc2e\ud835\udc25\ud835\udc2d\ud835\udc22\ud835\udc1b\ud835\udc22\ud835\udc25\ud835\udc22\ud835\udc2d\ud835\udc32.\n").concat(s));case 4:D.ZP.destroy("copy"),D.ZP.success({content:"Share link copied!",icon:(0,I.jsx)(F.Z,{}),key:"copy"}),e.next=11;break;case 8:e.prev=8,e.t0=e.catch(1),console.log(e.t0);case 11:case"end":return e.stop()}}),e,null,[[1,8]])})));return function(){return e.apply(this,arguments)}}(),f=(0,l.useMemo)((function(){var e=Object.values(n),t=(0,te.VN)(),a=n[t],i=a?[a]:[];return i.push.apply(i,(0,r.Z)(e.filter((function(e){var n=e.online,r=e.userID;return n&&r!==t}))).concat((0,r.Z)(e.filter((function(e){var n=e.online,r=e.userID;return!n&&r!==t}))))),i}),[n]),v=f.filter((function(e){return e.online})).length,p=(0,I.jsxs)("div",{className:"team-popover",children:[a||(0,I.jsx)(_.Z,{className:"disconn-alert",message:"Network failed.",icon:(0,I.jsx)(be.Z,{}),type:"error",showIcon:!0,banner:!0}),(0,I.jsx)(Q,{value:t}),(0,I.jsx)(b.Z,{icon:(0,I.jsx)(De.Z,{}),className:"share-btn",onClick:d,block:!0,children:"Share"}),(0,I.jsx)(K.Z,{}),(0,I.jsx)("div",{className:"user-list",children:f.map((function(e){return(0,I.jsx)(We,{userID:e.userID},e.userID)}))})]}),h=(0,I.jsxs)("div",{className:"team-title",children:[(0,I.jsx)("span",{children:"Team info"}),(0,I.jsx)(b.Z,{shape:"circle",type:"text",size:"small",icon:(0,I.jsx)(Pe.Z,{}),onClick:function(){i(),u()}})]});return(0,I.jsx)(V.Z,{content:p,trigger:"click",placement:"bottomRight",title:h,defaultVisible:!0,getPopupContainer:function(e){return e},children:(0,I.jsx)(b.Z,{type:"text",icon:(0,I.jsx)(G.Z,{status:a?"success":"error",count:a?v:"!",size:"small",children:(0,I.jsx)(Ie.Z,{})})})})},Ve=function(e){var t=e.instantSave,n=(0,l.useContext)(ht).noteID,r=(0,O.s0)(),a=function(){var e=(0,o.Z)(c().mark((function e(){return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t();case 2:return e.next=4,(0,R.r8)(n);case 4:if(e.sent){e.next=8;break}return D.ZP.error("Can't create room."),e.abrupt("return");case 8:return e.next=10,(0,C.SP)(n,{team:!0});case 10:r("/team/"+n);case 11:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}();return(0,I.jsx)(H.Z,{placement:"bottomRight",title:"Enable team editing?",onConfirm:a,okText:"Yes",cancelText:"No",children:(0,I.jsx)(b.Z,{type:"text",icon:(0,I.jsx)(Ne.Z,{})})})},Ue=n(85955),Be=(n(22144),function(e){var t=e.onDelete,n=e.onRotate,r=e.onDuplicate,i=e.mutateStyle,o=e.currDrawCtrl,s={type:"text",shape:"round",size:"small"},c=(0,l.useRef)(null),d=(0,l.useState)(!1),f=(0,u.Z)(d,2),v=f[0],p=f[1],h=(0,l.useState)(0),m=(0,u.Z)(h,2),g=m[0],x=m[1],w={transform:"translateX(".concat(g,"px)")},k=(0,l.useState)(0),Z=(0,u.Z)(k,2),S=Z[0],j=Z[1],y=S%4===1?"animate__animated animate__headShake":void 0;return(0,Ue.useDrag)((function(e){var t=e.first,r=e.last,a=e.offset,i=e.delta;x(a[0]),n(i[0]/2,r),t&&p(!0),r&&p(!1)}),{target:c,filterTaps:!0,rubberband:.05,bounds:{left:-90,right:90}}),(0,I.jsxs)("div",{className:"select-tool",children:[(0,I.jsx)(V.Z,{trigger:"click",placement:"bottom",getPopupContainer:function(e){return e},destroyTooltipOnHide:!0,content:(0,I.jsx)(Ae,{updateDrawCtrl:i,drawCtrl:o}),children:(0,I.jsx)(b.Z,(0,a.Z)({icon:(0,I.jsx)(M.Z,{})},s))}),(0,I.jsxs)("div",{className:X()("rotate-wrapper",{dragged:v}),ref:c,children:[(0,I.jsx)(b.Z,(0,a.Z)({className:y,icon:(0,I.jsx)(W.Z,{}),onClick:function(){j((function(e){return e+1})),n(90,!0)}},s)),(0,I.jsx)("div",{className:"gear",style:w})]}),(0,I.jsx)(b.Z,(0,a.Z)({icon:(0,I.jsx)(F.Z,{}),onClick:r},s)),(0,I.jsx)(b.Z,(0,a.Z)({danger:!0,icon:(0,I.jsx)(z.Z,{}),onClick:t},s))]})}),_e=n(96153);var Ke=n(24610),Ge=n(12262),He=n.n(Ge),qe=He().Point,Je=He().Path,Ye=He().Group,Xe=He().Shape.Rectangle,Qe=He().Color,$e=He().Size,et=He().Raster,tt=function(e){var t=e.drawState,n=e.onChange,i=void 0===n?function(){}:n,o=e.otherStates,s=e.drawCtrl,c=void 0===s?v:s,d=e.preview,f=void 0!==d&&d,p=e.readonly,h=void 0===p?f:p,m=e.imgSrc,g=e.SelectTool,x=t.width,w=t.height,S=c.mode,j=c.color,y=c.finger,C=c.lineWidth,b=c.highlight,D=c.eraserWidth,P=(0,l.useRef)(null),N=(0,l.useRef)(new(He().PaperScope)),O=(0,l.useRef)([]),E=(0,l.useRef)(),R=(0,l.useState)((0,k.l4)()),T=(0,u.Z)(R,2),A=T[0],L=T[1],M=(0,l.useState)(v),W=(0,u.Z)(M,2),F=W[0],z=W[1],V=(0,l.useState)(),U=(0,u.Z)(V,2),B=U[0],_=U[1];(0,l.useEffect)((function(){if(B)return B.onFrame=function(){return B.dashOffset+=3},function(){B.remove()}}),[B]);var K=(0,l.useState)(),G=(0,u.Z)(K,2),H=G[0],q=G[1];(0,l.useEffect)((function(){return function(){null===H||void 0===H||H.remove()}}),[H]);var J=(0,l.useState)(!1),Y=(0,u.Z)(J,2),X=Y[0],Q=Y[1],$="select"===S&&X?"selected":S;(0,l.useEffect)((function(){"select"!==S&&(Q(!1),_(void 0))}),[S]),(0,l.useEffect)((function(){if(X){if(null===B||void 0===B||!B.strokeColor)return;B.strokeColor.alpha/=2}else se(),q(void 0),z(v)}),[X]);var ee=(0,l.useRef)(1),te=function(){var e,t=null===(e=P.current)||void 0===e?void 0:e.clientWidth;t&&(ee.current=x/t)},ne=function(e){N.current.activate();var t=N.current.view,n=t.center,r=t.zoom,a=N.current.view.projectToView(e).multiply(ee.current),i=new qe(x,w).divide(2).subtract(n.multiply(r));return a.subtract(i).divide(r)};(0,l.useEffect)((function(){!function(){if(P.current){N.current.setup(P.current);var e=f?200/x:1;N.current.view.viewSize=new $e(x,w).multiply(e),N.current.view.scale(e,new qe(0,0)),ut(x,w)}}(),N.current.activate();var e=P.current;return function(){e&&(0,_e.j)(e)}}),[w,x,f]);var re=function(e){te(),N.current.activate();var t=ne(e.point),n=ot(t);_(n)},ae={draw:function(){te(),N.current.activate(),E.current=st(j,C,b)},erase:function(){te(),N.current.activate(),E.current=st("#0003",D)},select:function(e){re(e)},selected:function(e){var t=ne(e.point);B&&t.isInside(B.strokeBounds)||(re(e),Q(!1))}}[$],ie={draw:function(e){if(E.current){N.current.activate();var t=ne(e.point);E.current.add(t),E.current.smooth()}},erase:function(e){var t=E.current;if(t){N.current.activate();var n=ne(e.point);t.add(n),t.smooth();var r=O.current.filter((function(e){return!A.has(e.name)})).filter((function(e){return it(e,t)})).map((function(e){return e.name}));L((function(e){return e.concat(r)}))}},select:function(e){if(B){N.current.activate();var t=e.delta.multiply(ee.current);B.size=B.size.add(new $e(t.x,t.y)),B.translate(t.divide(2))}},selected:function(e){if(B&&H){N.current.activate();var t=e.delta.multiply(ee.current);B.translate(t),H.translate(t)}}}[$],ue={draw:function(){if(E.current&&0!==E.current.segments.length){N.current.activate(),E.current.simplify();var e=E.current.exportJSON();E.current.remove(),i((function(t){return Z.Dw.addStroke(t,e)}))}},erase:function(){E.current&&(N.current.activate(),E.current.remove(),i((function(e){return Z.Dw.eraseStrokes(e,A.toArray())})),L((0,k.l4)()))},select:function(){if(B){var e=B.size.abs(),t=e.width,n=e.height;if(t<10||n<10)return _(void 0);N.current.activate();var r=O.current,i=new Ye(dt(B,r));q(i);var u=lt(i);z((function(e){return(0,a.Z)((0,a.Z)({},e),u)})),Q(!0)}},selected:function(){}}[$];(0,l.useEffect)((function(){h||(N.current.view.onMouseDown=ae,N.current.view.onMouseDrag=ie,N.current.view.onMouseUp=ue)})),(0,l.useEffect)((function(){if(m){var e,t=new Image;return t.src=m,t.onload=function(){var n;N.current.activate(),(e=new et(t)).position=N.current.view.center;var r=x/t.width;e.scale(r),e.sendToBack(),null===(n=e.parent.getItem({name:"BGRECT"}))||void 0===n||n.sendToBack()},function(){var t;null===(t=e)||void 0===t||t.remove()}}}),[m,x]);var oe=(0,l.useMemo)((function(){return o?Z.Dw.mergeStates([t].concat((0,r.Z)(o))):t.getStrokeList()}),[t,o]);(0,l.useEffect)((function(){N.current.activate(),O.current=[];var e=[];return oe.forEach((function(n){return rt(n,t.hasStroke(n.uid)?O.current:e,A.has(n.uid))})),function(){O.current.forEach((function(e){return e.remove()})),e.forEach((function(e){return e.remove()}))}}),[oe,A,t]);var se=function(){var e=null===H||void 0===H?void 0:H.children;if(null!==e&&void 0!==e&&e.length){var t=e.map((function(e){return[e.name,e.exportJSON()]}));i((function(e){return Z.Dw.mutateStrokes(e,t)}))}};(0,l.useEffect)((function(){var e=function(e){return e.preventDefault()};return document.addEventListener("gesturestart",e),document.addEventListener("gesturechange",e),document.addEventListener("gestureend",e),function(){document.removeEventListener("gesturestart",e),document.removeEventListener("gesturechange",e),document.removeEventListener("gestureend",e)}}),[]),(0,Ue.usePinch)((function(e){var t=e.memo,n=e.offset,r=e.last,a=e.first,i=e.origin;if(P.current){var o,s,c,l,d;if(a||!t){te(),N.current.activate();var f=P.current.getBoundingClientRect(),v=f.x,p=f.y;o=1,s=i[0]-v,c=i[1]-p,l=v,d=p}else{var h=(0,u.Z)(t,3);o=h[0];var m=(0,u.Z)(h[1],2);s=m[0],c=m[1];var g=(0,u.Z)(h[2],2);l=g[0],d=g[1]}var x=N.current.view;Math.abs(1-n[0])<.05&&(n[0]=1);var w=a?1:n[0]/o,k=ee.current,Z=i[0]-l,S=i[1]-d,j=new qe(Z,S).multiply(k),y=x.viewToProject(j),C=r?10:1;w=Math.pow(w,1/C);!function e(){x.scale(w,y),--C>0&&requestAnimationFrame(e)}();var b=new qe(Z-s,S-c).multiply(k/n[0]);if(x.translate(b),!r)return[n[0],[Z,S],[l,d]];ct(x)}}),{scaleBounds:{max:5,min:.3},rubberband:.5,target:P});var ce=function(e){return function(e){return function(e){var t=e.touches[0];return"stylus"===(null===t||void 0===t?void 0:t.touchType)}(e)||y&&1===e.touches.length}(e)||e.stopPropagation()};return(0,I.jsxs)("div",{className:"draw-wrapper",children:[(0,I.jsx)("canvas",{ref:P,className:"draw-canvas","data-paper-hidpi":!1,onTouchStartCapture:ce,onTouchMoveCapture:ce}),g&&"selected"===$&&(0,I.jsx)(g,{onDelete:function(){var e=null===H||void 0===H?void 0:H.children;if(null!==e&&void 0!==e&&e.length){var t=e.map((function(e){return e.name}));i((function(e){return Z.Dw.eraseStrokes(e,t)})),_(void 0),q(void 0),Q(!1)}},onRotate:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(H){var n=t?10:1,r=e/n,a=function e(){H.rotate(r,null===B||void 0===B?void 0:B.position),null===B||void 0===B||B.rotate(r,B.position),--n>0&&requestAnimationFrame(e)};a()}},onDuplicate:function(){if(N.current.activate(),B&&H){var e=H.clone();se(),q(e);var t=B.size,n=t.width,r=t.height,a=new qe(n,r).divide(10);e.translate(a),B.translate(a),e.children.forEach((function(e){return e.name=(0,Ke.v4)()}))}},mutateStyle:function(e){H&&(N.current.activate(),ft(H,e,F.highlight),z((function(t){return(0,a.Z)((0,a.Z)({},t),e)})))},currDrawCtrl:F})]})},nt=l.memo(tt),rt=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=e.pathData,a=e.uid;try{var i=new Je;i.importJSON(r),i.name=a,n&&(i.opacity/=2),null===t||void 0===t||t.push(i)}catch(u){console.error(u)}},at=function(){var e=new WeakMap;return function(t,n){var r,a=e.get(t);if(a)return a;var i=t.point,u=null===(r=t.previous)||void 0===r?void 0:r.point;if(!u)return[];for(var o=i.subtract(u),s=o.length/n*2,c=[],l=0;l<s;l+=1)c.push(i.subtract(o.multiply(l/s)));return e.set(t,c),c}}(),it=function(e,t){var n,r=null===(n=t.lastSegment.curve)||void 0===n?void 0:n.strokeBounds;if(!(e instanceof He().Path)||null===r||void 0===r||!r.intersects(e.strokeBounds))return!1;if(t.intersects(e))return!0;var a=t.strokeWidth,i=t.lastSegment;return at(i,a).some((function(t){var n,r=null===(n=e.getNearestPoint(t))||void 0===n?void 0:n.getDistance(t);return r&&r<(e.strokeWidth+a)/2}))},ut=function(e,t){var n=new Xe(new qe(0,0),new qe(e,t));return n.fillColor=new Qe("#fff"),n.name="BGRECT",n.sendToBack(),n},ot=function(e){var t=new Xe(e,new $e(0,0));return t.strokeColor=new Qe("#1890ff"),t.strokeWidth=3,t.dashOffset=0,t.dashArray=[30,20],t},st=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=new Je,a=new Qe(e);return n&&(a.alpha/=2,r.blendMode="multiply"),r.strokeColor=a,r.strokeWidth=t,r.strokeJoin="round",r.strokeCap="round",r},ct=function(e){var t=function(e){var t=e.center,n=e.zoom,r=e.viewSize,a=r.height,i=r.width,u=t.x,o=t.y;if(n<=1)return[i/2-u,a/2-o];var s=i*(n-1)/n/2,c=a*(n-1)/n/2,l=i/2-s,d=i/2+s,f=a/2-c,v=a/2+c;return[u<l?l-u:u>d?d-u:0,o<f?f-o:o>v?v-o:0]}(e),n=(0,u.Z)(t,2),r=n[0],a=n[1],i=10,o=new qe(r,a).divide(-i);!function t(){e.translate(o),--i>0&&requestAnimationFrame(t)}()},lt=function(e){var t={};return e.strokeColor&&(t.color=e.strokeColor.toCSS(!0)),e.strokeWidth&&(t.lineWidth=e.strokeWidth),e.children.every((function(e){var t;return.5===(null===(t=e.strokeColor)||void 0===t?void 0:t.alpha)}))&&(t.highlight=!0),t},dt=function(e,t){var n=e.strokeBounds;return t.filter((function(t){return t.isInside(n)||t.intersects(e)}))},ft=function(e,t,n){var r=t.lineWidth,a=t.color,i=t.highlight;a&&(e.strokeColor=new Qe(a)),r&&(e.strokeWidth=r),!0!==i&&!0!==n||e.children.forEach((function(e){var t=e.strokeColor;t&&(1===t.alpha&&(t.alpha/=2),e.blendMode="multiply")})),!1===i&&e.children.forEach((function(e){var t=e.strokeColor;t&&(t.alpha=1,e.blendMode="normal")}))},vt=["pageRec","pdf","pageOrder"],pt=["image","marked"],ht=(0,l.createContext)({noteID:"",noteInfo:void 0,stateSet:void 0,teamState:void 0,pageRec:void 0,pageOrder:void 0,saved:!0,teamOn:!1,inviewPages:(0,k.l4)(),drawCtrl:v}),mt=(0,l.createContext)({scrollPage:function(e){},switchPageMarked:function(e){},updateStateSet:function(e){},addPage:function(e,t){},addFinalPage:function(){},deletePage:function(e){},saveReorder:function(){var e=(0,o.Z)(c().mark((function e(t,n){return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}(),setInviewPages:function(){},setDrawCtrl:function(){}});function gt(e){var t,n=e.teamOn,s=null!==(t=(0,O.UO)().noteID)&&void 0!==t?t:"",d=(0,O.s0)(),f=(0,l.useState)(),h=(0,u.Z)(f,2),m=h[0],x=h[1],w=(0,l.useState)(),S=(0,u.Z)(w,2),j=S[0],P=S[1],E=(0,l.useState)(),M=(0,u.Z)(E,2),W=M[0],F=M[1],z=(0,l.useState)(v),V=(0,u.Z)(z,2),U=V[0],B=V[1],_=(0,l.useState)((0,k.l4)()),K=(0,u.Z)(_,2),G=K[0],H=K[1],q=(0,l.useState)(),Y=(0,u.Z)(q,2),X=Y[0],Q=Y[1],$=(0,l.useState)(!0),ee=(0,u.Z)($,2),te=ee[0],ne=ee[1],re=(0,l.useRef)({}),ae=function(){var e=(0,l.useRef)(!1);return(0,l.useEffect)((function(){return e.current=!0,function(){e.current=!1}}),[]),e}(),ie=(0,l.useContext)(J.TeamCtx),ue=ie.io,oe=ie.teamState,se=ie.addTeamStatePage;(0,l.useEffect)((function(){var e=function(){var e=(0,o.Z)(c().mark((function e(){var t,r,a,u;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,C.U9)(s);case 2:if(t=e.sent){e.next=6;break}return D.ZP.error("Note not found"),e.abrupt("return",d("/"));case 6:return r=t.pageRec,t.pdf,a=t.pageOrder,u=(0,i.Z)(t,vt),x((0,k.D5)(r)),Q(a),P(u),F(y.createFromPages(r)),e.t0=B,e.next=14,p();case 14:e.t1=e.sent,(0,e.t0)(e.t1),n&&(0,R.f1)(s);case 17:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}();e()}),[d,s,n]);var ce=(0,l.useRef)((0,o.Z)(c().mark((function e(){return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}}),e)}))));ce.current=(0,o.Z)(c().mark((function e(){var t,n,r;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=null===m||void 0===m?void 0:m.toObject(),n=document.querySelector("canvas"),r=null===n||void 0===n?void 0:n.toDataURL(),e.next=5,(0,C.SP)(s,{pageRec:t,thumbnail:r});case 5:ae.current&&ne(!0);case 6:case"end":return e.stop()}}),e)}))),(0,l.useLayoutEffect)((function(){return function(){ce.current()}}),[]),(0,T.x)((function(){return ce.current()}));var le=(0,l.useCallback)((0,L.debounce)((function(){return ce.current()}),2e3),[]),de=(0,l.useCallback)((function(e,t){x((function(n){return null===n||void 0===n?void 0:n.update(e,g.BJ,t)})),ne(!1),le()}),[le]),fe=(0,l.useCallback)((function(e){return null===ue||void 0===ue?void 0:ue.emit("reorder",{pageOrder:e})}),[ue]),ve=(0,l.useCallback)(function(){var e=(0,o.Z)(c().mark((function e(t){var n,r=arguments;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.length>1&&void 0!==r[1]&&r[1],Q(t),e.next=4,(0,C.SP)(s,{pageOrder:t});case 4:return e.next=6,ce.current();case 6:n&&fe(t);case 7:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),[s,fe]);(0,l.useEffect)((function(){j&&(document.title=j.name+" - Multibility")}),[j]),(0,l.useEffect)((function(){if(ue)return ue.on("reorder",(function(e){var t,n=e.deleted,r=e.pageOrder,a=e.prevOrder;ve(r),n&&(t=function(){return ve(a,!0)},D.ZP.warning({content:(0,I.jsxs)(I.Fragment,{children:["One page was deleted.",(0,I.jsx)(b.Z,{size:"small",type:"link",onClick:function(){D.ZP.destroy("DELETE"),t()},children:"Undo"})]}),key:"DELETE",duration:10}))})),ue.on("newPage",(function(e){var t=e.pageOrder,n=e.pageID,r=e.newPage;ve(t),de(n,(function(){return r})),F((function(e){return null===e||void 0===e?void 0:e.addState(n,r)}))})),function(){ue.removeAllListeners()}}),[ue,de,ve]);var pe=(0,l.useCallback)((function(e){null===ue||void 0===ue||ue.emit("push",{operation:e},(function(e){var t=e.stroke,n=e.pageID;return F((function(e){return null===e||void 0===e?void 0:e.updateState(n,(function(e){return Z.Dw.updateStroke(e,t)}))}))}))}),[ue]),he=function(e,t,n){n.image,n.marked;var r=(0,i.Z)(n,pt);null===ue||void 0===ue||ue.emit("newPage",{pageOrder:e,pageID:t,newPage:r}),se(t,n)},me=(0,l.useCallback)((function(e,t){var n=Z.Dw.flaten(t);de(e,(function(e){return(0,a.Z)((0,a.Z)({},e),{},{state:n})}))}),[de]),ge=(0,l.useRef)(W);ge.current=W;var xe=(0,l.useCallback)((function(e){if(ge.current){var t=e(ge.current);F(t);var n=t.getLastDS(),a=t.lastOp;n&&a&&(me.apply(void 0,(0,r.Z)(n)),pe(a))}}),[me,pe]),we=function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(X){var n=t?null===m||void 0===m?void 0:m.get(e):void 0,r=(0,g.D4)(n),a=(0,u.Z)(r,2),i=a[0],o=a[1],s=A(X,e,i);he(s,i,o),ve(s),de(i,(function(){return o})),F((function(e){return null===e||void 0===e?void 0:e.addState(i,o)}))}},ke=(0,I.jsxs)("div",{className:"reader container",children:[(0,I.jsx)(Re,{handleUndo:function(){return xe((function(e){return e.undo()}))},handleRedo:function(){return xe((function(e){return e.redo()}))},instantSave:ce.current}),(0,I.jsxs)("main",{children:[null===X||void 0===X?void 0:X.map((function(e){return(0,I.jsx)("section",{className:"note-page",ref:function(t){return t&&(re.current[e]=t)},children:(0,I.jsx)(xt,{uid:e})},e)})),(0,I.jsx)(N,{})]})]});return(0,I.jsx)(ht.Provider,{value:{saved:te,teamOn:n,noteID:s,pageRec:m,drawCtrl:U,noteInfo:j,stateSet:W,teamState:oe,pageOrder:X,inviewPages:G},children:(0,I.jsx)(mt.Provider,{value:{addPage:we,scrollPage:function(e){var t;null===(t=re.current[e])||void 0===t||t.scrollIntoView()},deletePage:function(e){var t=null===X||void 0===X?void 0:X.filter((function(t){return t!==e}));(null===t||void 0===t?void 0:t.length)&&ve(t,!0)},setDrawCtrl:B,saveReorder:ve,addFinalPage:function(){var e=(0,L.last)(X);e&&we(e)},updateStateSet:xe,setInviewPages:H,switchPageMarked:function(e){de(e,(function(e){return(0,a.Z)((0,a.Z)({},e),{},{marked:!e.marked})}))}},children:ke})})}var xt=function(e){var t=e.uid,n=(0,l.useContext)(ht),r=n.pageRec,a=n.stateSet,i=n.teamState,u=(0,l.useContext)(mt).updateStateSet,o=null===r||void 0===r?void 0:r.get(t),s=null===a||void 0===a?void 0:a.getOneState(t),c=null===i||void 0===i?void 0:i.getOnePageStateMap(t),d=(0,l.useCallback)((function(e){return u((function(n){return n.setState(t,e)}))}),[t,u]);return o&&s?(0,I.jsx)(wt,{drawState:s,teamStateMap:c,updateState:d,pdfIndex:o.pdfIndex,uid:t}):null},wt=function(e){var t=e.thumbnail,r=e.drawState,a=e.teamStateMap,i=e.updateState,s=e.pdfIndex,d=e.preview,f=void 0!==d&&d,v=e.uid,p=(0,l.useContext)(mt).setInviewPages,h=(0,l.useContext)(ht).noteID,m=(0,l.useState)(),g=(0,u.Z)(m,2),x=g[0],w=g[1],k=(0,E.YD)({delay:100}),Z=(0,u.Z)(k,2),S=Z[0],j=Z[1],y=r.height/r.width,C=(0,l.useCallback)((0,L.once)((0,o.Z)(c().mark((function e(){var t,r;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(s){e.next=2;break}return e.abrupt("return");case 2:return e.next=4,Promise.all([n.e(643),n.e(138)]).then(n.bind(n,21176));case 4:return t=e.sent,r=t.getOnePageImage,e.t0=w,e.next=9,r(h,s);case 9:e.t1=e.sent,(0,e.t0)(e.t1);case 11:case"end":return e.stop()}}),e)})))),[s,h]);(0,l.useEffect)((function(){f||(j?(C(),p((function(e){return e.add(v)}))):p((function(e){return e.delete(v)})))}),[j,f,v,C,p]);var b=(0,l.useContext)(J.TeamCtx).ignores,D=(0,l.useMemo)((function(){return null===a||void 0===a?void 0:a.deleteAll(b).toList().toArray()}),[a,b]),P=j&&(x||!s),N=Boolean(f||!P);return(0,I.jsxs)("div",{ref:S,style:{paddingTop:"".concat(100*y,"%")},children:[P&&(0,I.jsx)(kt,{drawState:r,otherStates:D,updateState:i,imgSrc:x||t,preview:f}),N&&(0,I.jsx)("div",{className:"mask"})]})};wt.displayName="PageWrapper";var kt=function(e){var t=e.drawState,n=e.updateState,r=e.otherStates,a=e.preview,i=void 0!==a&&a,u=e.imgSrc,o=(0,l.useContext)(ht).drawCtrl,s=(0,l.useRef)(t);s.current=t;var c=(0,l.useCallback)((function(e){if(n){var t=e instanceof Z.Dw?e:e(s.current);n(t)}}),[n]);return i?(0,I.jsx)(nt,{drawState:t,otherStates:r,imgSrc:u,readonly:!0,preview:!0}):(0,I.jsx)(nt,{drawState:t,otherStates:r,onChange:c,imgSrc:u,drawCtrl:o,SelectTool:Be})};kt.displayName="DrawWrapper"},91511:function(e,t,n){"use strict";n.r(t),n.d(t,{TeamCtx:function(){return D},default:function(){return P}});var r=n(29439),a=n(15861),i=n(87757),u=n.n(i),o=n(51570),s=n(72791),c=n(56058),l=n(87962),d=n(29609),f=n(69951),v=function(e){return function(){return(0,d.io)(o._n,{query:{userID:(0,f.VN)(),userName:(0,f.vW)(),noteID:e}})}},p=n(16871),h=n(45987),m=n(15671),g=n(43144),x=n(82670),w=n(24124),k=["pageID"],Z={pageStates:(0,w.D5)(),pageInfos:(0,w.D5)()},S=(0,w.WV)(Z),j=function(){function e(t){(0,m.Z)(this,e),this.immutable=t}return(0,g.Z)(e,[{key:"getImmutable",value:function(){return this.immutable}},{key:"getPageStates",value:function(){return this.getImmutable().get("pageStates")}},{key:"getPageInfos",value:function(){return this.getImmutable().get("pageInfos")}},{key:"getOneState",value:function(e,t){var n;return null===(n=this.getPageStates().get(e))||void 0===n?void 0:n.get(t)}},{key:"getOnePageStateMap",value:function(e){return this.getPageStates().get(e)}},{key:"getPageValidUsers",value:function(e){var t=this.getOnePageStateMap(e);return t?Array.from(null===t||void 0===t?void 0:t.filter((function(e){return!e.isEmpty()})).keys()):[]}},{key:"getPageRatio",value:function(e){var t;return null===(t=this.getPageInfos().get(e))||void 0===t?void 0:t.ratio}},{key:"includesPage",value:function(e){return this.getPageStates().has(e)}},{key:"setState",value:function(t,n,r){var a=this.getPageStates().get(t);return a?new e(this.getImmutable().update("pageStates",(function(e){return e.set(t,a.set(n,r))}))):this}},{key:"addPage",value:function(t,n){var r=n.ratio;return new e(this.getImmutable().update("pageStates",(function(e){return e.set(t,(0,w.D5)())})).update("pageInfos",(function(e){return e.set(t,{ratio:r})})))}},{key:"pushOperation",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:x.mF,r=e.pageID,a=(0,h.Z)(e,k),i=this.getPageRatio(r);if(!this.includesPage(r)||!i)return this;var u=this.getOneState(r,t)||x.Dw.createEmpty(n,n*i),o=x.Dw.pushOperation(u,a);return this.setState(r,t,o)}},{key:"resetUser",value:function(e,t){for(var n=this,a=0,i=Object.entries(t);a<i.length;a++){var u=(0,r.Z)(i[a],2),o=u[0],s=u[1],c=s.state,l=s.ratio,d=n.getOneState(o,e);if(d){var f=d.width;n=n.setState(o,e,x.Dw.loadFromFlat(c,f,f*l))}}return n}}],[{key:"createFromTeamPages",value:function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:x.mF,a=S();return Object.entries(t).forEach((function(e){var t=(0,r.Z)(e,2),i=t[0],u=t[1],o=u.states,s=u.ratio,c=(0,w.D5)(Object.entries(o).map((function(e){var t=(0,r.Z)(e,2),a=t[0],i=t[1];return[a,x.Dw.loadFromFlat(i,n,n*s)]})));a=a.update("pageStates",(function(e){return e.set(i,c)})).update("pageInfos",(function(e){return e.set(i,{ratio:s})}))})),new e(a)}}]),e}(),y=n(49496),C=n(84341),b=n(80184),D=(0,s.createContext)({io:void 0,code:-2,connected:!1,ignores:(0,w.l4)(),userRec:{},teamState:void 0,resetIO:function(){},loadInfo:function(){var e=(0,a.Z)(u().mark((function e(){return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",!1);case 1:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),setIgnores:function(){},addTeamStatePage:function(e,t){}});function P(){var e,t=null!==(e=(0,p.UO)().noteID)&&void 0!==e?e:"",n=(0,s.useState)(),i=(0,r.Z)(n,2),d=i[0],h=i[1],m=(0,s.useState)(-2),g=(0,r.Z)(m,2),x=g[0],k=g[1],Z=(0,s.useState)({}),S=(0,r.Z)(Z,2),P=S[0],I=S[1],N=(0,s.useState)((0,w.l4)()),O=(0,r.Z)(N,2),E=O[0],R=O[1],T=(0,s.useState)(v(t)),A=(0,r.Z)(T,2),L=A[0],M=A[1],W=(0,s.useState)(!1),F=(0,r.Z)(W,2),z=F[0],V=F[1],U=(0,s.useState)(!1),B=(0,r.Z)(U,2),_=B[0],K=B[1],G=(0,p.s0)(),H=(0,s.useCallback)((0,a.Z)(u().mark((function e(){var n;return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,o.CD)(t);case 2:if(n=e.sent){e.next=6;break}return y.ZP.error("Failed loading the team note state"),e.abrupt("return",!1);case 6:return h(j.createFromTeamPages(n)),e.abrupt("return",!0);case 8:case"end":return e.stop()}}),e)}))),[t]),q=(0,s.useCallback)((0,a.Z)(u().mark((function e(){var n;return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,o.dn)(t);case 2:if(n=e.sent){e.next=6;break}return y.ZP.error("Failed loading the team note info"),e.abrupt("return",!1);case 6:return k(n.code),e.abrupt("return",!0);case 8:case"end":return e.stop()}}),e)}))),[t]);(0,s.useEffect)((function(){var e=function(){var e=(0,a.Z)(u().mark((function e(){return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return y.ZP.loading({content:"Loading team note...",key:"TEAM_LOADING",duration:0}),e.next=3,q();case 3:if(e.t0=e.sent,!e.t0){e.next=8;break}return e.next=7,H();case 7:e.t0=e.sent;case 8:if(e.t0){e.next=11;break}return y.ZP.destroy("TEAM_LOADING"),e.abrupt("return",G("/"));case 11:y.ZP.destroy("TEAM_LOADING"),V(!0);case 13:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}();return e(),function(){return y.ZP.destroy("TEAM_LOADING")}}),[q,H,G]),(0,s.useEffect)((function(){return L.on("push",(function(e){var t=e.operation,n=e.userID;h((function(e){return null===e||void 0===e?void 0:e.pushOperation(t,n)}))})),L.on("join",(function(e){var t=e.joined,n=e.members,r=t.userID,a=t.userName;I(n),r!==(0,f.VN)()&&(y.ZP.destroy(r),y.ZP.success({content:"".concat(a," joined room"),icon:(0,b.jsx)(c.Z,{}),key:r}))})),L.on("leave",(function(e){var t=e.leaved,n=e.members,r=t.userID,a=t.userName;if(I(n),r===(0,f.VN)())return L.emit("join");y.ZP.destroy(r),y.ZP.warning({content:"".concat(a," leaved room"),icon:(0,b.jsx)(l.Z,{}),key:r})})),L.on("newPage",(function(e){var t=e.pageID,n=e.newPage;h((function(e){return null===e||void 0===e?void 0:e.addPage(t,n)}))})),L.on("reset",(function(e){var t=e.userID,n=e.pageRec;t!==(0,f.VN)()&&h((function(e){return null===e||void 0===e?void 0:e.resetUser(t,n)}))})),L.on("connect_error",console.error),L.on("connect",(function(){return K(!0)})),L.on("disconnect",(function(){return K(!1)})),function(){L.removeAllListeners(),L.close()}}),[L]);return z?(0,b.jsx)(D.Provider,{value:{io:L,code:x,ignores:E,userRec:P,connected:_,teamState:d,resetIO:function(){return M(v(t))},loadInfo:q,setIgnores:R,addTeamStatePage:function(e,t){h((function(n){return null===n||void 0===n?void 0:n.addPage(e,t)}))}},children:(0,b.jsx)(C.default,{teamOn:!0})}):null}},96153:function(e,t,n){"use strict";function r(e,t){var n=document.createElement("canvas"),r=n.getContext("2d");if(!r)throw new Error("can't get virtual canvas context");return n.width=e,n.height=t,{canvas:n,context:r}}function a(e){e.width=1,e.height=1;var t=e.getContext("2d");null===t||void 0===t||t.clearRect(0,0,1,1)}n.d(t,{j:function(){return a},v:function(){return r}})},90858:function(){},64158:function(){}}]);
//# sourceMappingURL=274.c1050e34.chunk.js.map