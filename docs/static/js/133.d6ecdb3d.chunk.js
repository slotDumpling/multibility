(self.webpackChunkmultibility=self.webpackChunkmultibility||[]).push([[133,467],{29952:function(e,t,n){"use strict";n.r(t),n.d(t,{PageWrapper:function(){return zt},ReaderMethodCtx:function(){return Mt},ReaderStateCtx:function(){return Lt},default:function(){return At}});var r=n(93433),a=n(1413),i=n(45987),o=n(29439),u=n(15861),s=n(87757),c=n.n(s),l=n(72791),d=n(61842),f=n.n(d),v=[10,20,30,50],p={mode:"draw",finger:!0,lineWidth:10,eraserWidth:10,color:"#000000",highlight:!1,lasso:!0,widthList:v};function m(){return h.apply(this,arguments)}function h(){return(h=(0,u.Z)(c().mark((function e(){var t;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,f().getItem("DRAW_CTRL");case 2:if(t=e.sent){e.next=7;break}return t=p,e.next=7,f().setItem("DRAW_CTRL",t);case 7:return e.abrupt("return",t);case 8:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function g(){return(g=(0,u.Z)(c().mark((function e(t){return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,f().setItem("DRAW_CTRL",t);case 2:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var x=n(92198),w=n(76807),Z=n(95099),j=n(33638),S=n(15671),k=n(43144),y=n(82670),C=n(24124),b={states:(0,C.D5)(),editStack:(0,C.aV)(),undoStack:(0,C.aV)()},D=(0,C.WV)(b),P=function(){function e(t,n){(0,S.Z)(this,e),this.immutable=t,this.lastOp=n}return(0,k.Z)(e,[{key:"getImmutable",value:function(){return this.immutable}},{key:"getStates",value:function(){return this.getImmutable().get("states")}},{key:"getOneState",value:function(e){return this.getStates().get(e)}},{key:"getEditStack",value:function(){return this.getImmutable().get("editStack")}},{key:"getUndoStack",value:function(){return this.getImmutable().get("undoStack")}},{key:"setState",value:function(t,n){var r=this.getOneState(t);if(!r||r===n)return this;var i=this.getImmutable().update("states",(function(e){return e.set(t,n)})).update("editStack",(function(e){return e.push(t)})).delete("undoStack"),o=n.lastOp;return new e(i,o&&(0,a.Z)((0,a.Z)({},o),{},{pageID:t}))}},{key:"syncStrokeTime",value:function(e,t){var n=this.getOneState(e);return n&&y.Dw.syncStrokeTime(n,t),this}},{key:"addState",value:function(t,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:y.mF,a=n.state,i=n.ratio,o=y.Dw.loadFromFlat(a,r,r*i),u=this.getImmutable().update("states",(function(e){return e.set(t,o)}));return new e(u)}},{key:"deleteState",value:function(t){return new e(this.getImmutable().update("states",(function(e){return e.delete(t)})))}},{key:"isUndoable",value:function(){return this.getEditStack().size>0}},{key:"isRedoable",value:function(){return this.getUndoStack().size>0}},{key:"undo",value:function(){if(!this.isUndoable())return this;var t=this.getEditStack().last(),n=t&&this.getOneState(t);if(!n)return this;var r=y.Dw.undo(n),i=r.lastOp,o=i&&(0,a.Z)({pageID:t},i);return new e(this.getImmutable().update("editStack",(function(e){return e.pop()})).update("undoStack",(function(e){return e.push(t)})).update("states",(function(e){return e.set(t,r)})),o)}},{key:"redo",value:function(){if(!this.isRedoable())return this;var t=this.getUndoStack().last(),n=t&&this.getOneState(t);if(!n)return this;var r=y.Dw.redo(n),i=r.lastOp,o=i&&(0,a.Z)({pageID:t},i);return new e(this.getImmutable().update("undoStack",(function(e){return e.pop()})).update("editStack",(function(e){return e.push(t)})).update("states",(function(e){return e.set(t,r)})),o)}},{key:"getLastDS",value:function(){var e,t=null===(e=this.lastOp)||void 0===e?void 0:e.pageID,n=t&&this.getOneState(t);if(n)return[t,n]}}],[{key:"createFromPages",value:function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:y.mF;return new e(D().set("states",(0,C.D5)(t).map((function(e){var t=e.state,r=e.ratio;return y.Dw.loadFromFlat(t,n,n*r)}))))}}]),e}(),I=n(75783),N=n(87309),O=n(50419),R=n(79286),E=n(80184),T=function(){var e=(0,l.useContext)(Mt).addFinalPage;return(0,E.jsx)("div",{className:"add-btn-wrapper",children:(0,E.jsx)(N.Z,{type:"dashed",icon:(0,E.jsx)(R.Z,{}),block:!0,onClick:e,children:"New page"})})},L=n(16871),M=n(51570),A=n(61507),F=n(79784),z=n(99984),W=n(20938),V=n(23414),U=n(82622),K=n(60541),B=n(72785),_=n(89267),H=n(69228),q=n(38243),J=n(49142),G=n(96272),Y=n(78985),X=n(76586),Q=n(33441),$=n(91333),ee=n(75594),te=n(95055),ne=n(67415),re=n(91511),ae=n(74115),ie=n(69951),oe=n(10711),ue=n(53621),se=n(75797),ce=n(20866),le=n(70140),de=n(87661),fe=n(88894);function ve(e,t,n){var r=e.indexOf(t),a=e.slice();return-1===r||a.splice(r+1,0,n),a}var pe=(0,n(92721).Z)({scriptUrl:"//at.alicdn.com/t/font_3181679_yo844n7qgns.js"}),me=n(81694),he=n.n(me),ge=function(e){var t=e.activeKey,n=e.setActiveKey,r=(0,l.useContext)(Lt),i=r.pageOrder,u=r.inviewPages,s=(0,l.useContext)(Mt),c=s.scrollPage,d=s.saveReorder,f=(0,l.useRef)({}),v=(0,l.useRef)(),p=(0,l.useMemo)((function(){return(null===i||void 0===i?void 0:i.find((function(e){return u.has(e)})))||""}),[i,u]);return(0,l.useEffect)((function(){var e,t,n,r;null===(e=f.current[p])||void 0===e||e.scrollIntoView();var a=(null===(t=f.current[p])||void 0===t?void 0:t.clientHeight)||0,i=(null===(n=v.current)||void 0===n?void 0:n.clientHeight)||0;null===(r=v.current)||void 0===r||r.scrollBy(0,-i/2+a/2)}),[]),(0,E.jsxs)("div",{className:"preview-container",children:[(0,E.jsx)(je,{activeKey:t,setActiveKey:n}),(0,E.jsx)(ce.Z5,{onDragEnd:function(e){var t=e.source,n=e.destination;if(n&&i){var r=t.index,a=n.index;if(r!==a){var u=i[r],s=function(e,t,n){var r=e.slice(),a=r.splice(t,1),i=(0,o.Z)(a,1)[0];return r.splice(n,0,i),r}(i,r,a);d(s,!0),requestAnimationFrame((function(){return c(u)}))}}},children:(0,E.jsx)(ce.bK,{droppableId:"preview-list",children:function(e){var n=e.droppableProps,r=e.innerRef,o=e.placeholder;return(0,E.jsxs)("div",(0,a.Z)((0,a.Z)({className:"page-list",ref:function(e){r(e),e&&(v.current=e)}},n),{},{children:[null===i||void 0===i?void 0:i.map((function(e,n){return(0,E.jsx)(xe,{uid:e,mode:t,pageIndex:n,currpageID:p,refRec:f.current},e)})),o,"ALL"===t&&(0,E.jsx)(T,{})]}))}})})]})},xe=function(e){var t=e.uid,n=e.pageIndex,r=e.mode,i=e.currpageID,u=e.refRec,s=(0,l.useContext)(Lt),c=s.stateSet,d=s.teamState,f=s.pageRec,v=(0,l.useContext)(Mt),p=v.scrollPage,m=v.switchPageMarked,h=(0,l.useContext)(re.TeamCtx).ignores,g=(0,l.useState)(""),x=(0,o.Z)(g,2),w=x[0],Z=x[1],j=null===f||void 0===f?void 0:f.get(t),S=null===c||void 0===c?void 0:c.getOneState(t),k=null===d||void 0===d?void 0:d.getOnePageStateMap(t),y=(0,l.useMemo)((function(){return(null===d||void 0===d?void 0:d.getPageValidUsers(t).filter((function(e){return!h.has(e)})))||[]}),[d,h,t]);if(!j||!S)return null;var C=j.image,b=j.marked;if("WRITTEN"===r&&S.isEmpty()&&(!k||k.every((function(e){return e.isEmpty()}))))return null;if("MARKED"===r&&!b)return null;var D=i===t;return(0,E.jsx)(ce._l,{draggableId:t,index:n,isDragDisabled:"ALL"!==r,children:function(e,r){var i=e.innerRef,o=e.draggableProps,s=e.dragHandleProps,c=r.isDragging;return(0,E.jsxs)("div",(0,a.Z)((0,a.Z)((0,a.Z)({ref:function(e){i(e),e&&(u[t]=e)},className:he()("page",{curr:D,drag:c}),onClick:function(){return p(t)}},o),s),{},{children:[(0,E.jsx)(zt,{uid:t,drawState:(null===k||void 0===k?void 0:k.get(w))||S,teamStateMap:w?void 0:k,thumbnail:C,preview:!0}),(0,E.jsxs)("div",{className:"cover",onClick:function(e){return e.stopPropagation()},children:[(0,E.jsx)("span",{className:he()("bookmark",{marked:b}),onClick:function(){return m(t)}}),(0,E.jsx)("span",{className:"index",children:n+1}),(0,E.jsx)(Ze,{uid:t}),(0,E.jsx)(we,{userIDs:y,chosen:w,setChosen:Z})]})]}))}})},we=function(e){var t=e.userIDs,n=e.chosen,r=e.setChosen;return(0,E.jsx)(X.C.Group,{maxCount:2,size:"default",className:he()("team-group",{chosen:n}),children:t.map((function(e){return(0,E.jsx)(Ge,{size:"default",userID:e,className:"preview-avatar",chosen:n===e,onClick:function(){return r((function(t){return t===e?"":e}))}},e)}))})},Ze=function(e){var t=e.uid,n=(0,l.useContext)(Mt),r=n.addPage,a=n.deletePage,i=(0,E.jsx)(le.Z,{onClick:function(e){var n=e.key;"ADD"===n?r(t):"COPY"===n?r(t,!0):"DELETE"===n&&a(t)},items:[{key:"ADD",icon:(0,E.jsx)(R.Z,{}),label:"Add page"},{key:"COPY",icon:(0,E.jsx)(V.Z,{}),label:"Duplicate"},{key:"DELETE",icon:(0,E.jsx)(U.Z,{}),label:"Delete",danger:!0}]});return(0,E.jsx)(H.Z,{content:i,trigger:"click",placement:"left",destroyTooltipOnHide:!0,children:(0,E.jsx)("span",{className:"option",children:(0,E.jsx)(oe.Z,{})})})},je=function(e){var t=e.activeKey,n=e.setActiveKey,r=de.Z.TabPane;return(0,E.jsxs)(de.Z,{className:"tabs",activeKey:t,onChange:n,tabBarGutter:10,size:"small",centered:!0,children:[(0,E.jsx)(r,{tab:(0,E.jsx)(pe,{type:"icon-uf_paper"})},"ALL"),(0,E.jsx)(r,{tab:(0,E.jsx)(pe,{type:"icon-bookmark2"})},"MARKED"),(0,E.jsx)(r,{tab:(0,E.jsx)(pe,{type:"icon-write"})},"WRITTEN")]})};function Se(){var e=(0,l.useState)(!1),t=(0,o.Z)(e,2),n=t[0],r=t[1],a=(0,l.useState)("ALL"),i=(0,o.Z)(a,2),u=i[0],s=i[1],c={ALL:"All Pages",MARKED:"Bookmarks",WRITTEN:"Notes"}[u];return(0,E.jsxs)(E.Fragment,{children:[(0,E.jsx)(N.Z,{type:"text",icon:n?(0,E.jsx)(ue.Z,{}):(0,E.jsx)(se.Z,{}),onClick:function(){return r((function(e){return!e}))}}),(0,E.jsx)(fe.Z,{visible:n,onClose:function(){return r(!1)},width:200,title:c,closable:!1,className:"preview-drawer",contentWrapperStyle:{boxShadow:"none"},bodyStyle:{padding:0,overflow:"hidden"},headerStyle:{textAlign:"center",borderTop:"1px solid #eee"},destroyOnClose:!0,children:(0,E.jsx)(ge,{activeKey:u,setActiveKey:s})})]})}var ke=n(52242),ye=n(65323),Ce=n(78030),be=n(50446),De=n(62),Pe=n(14965),Ie=n(67575),Ne=n(30501),Oe=n(98272),Re=n(24215),Ee=n(17973),Te=n(19951),Le=n(23605),Me=n(56200),Ae=n(18301),Fe=n(1829),ze=n.n(Fe),We=n(88405);function Ve(e){var t=e.handleUndo,n=e.handleRedo,r=e.instantSave,i=(0,l.useContext)(Lt),o=i.saved,s=i.stateSet,d=i.drawCtrl,f=(0,l.useContext)(Mt).setDrawCtrl,v=(0,l.useContext)(re.TeamCtx).teamOn,p=d.mode,m=d.finger,h=(0,L.s0)(),x=function(e){f((function(t){var n=(0,a.Z)((0,a.Z)({},t),e);return function(e){g.apply(this,arguments)}(n),n}))};return(0,E.jsxs)("header",{children:[(0,E.jsxs)("div",{className:"left",children:[(0,E.jsx)(N.Z,{type:"text",onClick:(0,u.Z)(c().mark((function e(){return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r();case 2:h("/");case 3:case"end":return e.stop()}}),e)}))),icon:(0,E.jsx)(ke.Z,{style:{opacity:.8}})}),(0,E.jsx)("div",{className:"br"}),(0,E.jsx)(N.Z,{type:"text",className:"save",onClick:r,disabled:o,icon:(0,E.jsx)(ye.Z,{})})]}),(0,E.jsxs)("div",{className:"middle",children:[(0,E.jsx)(N.Z,{type:"text",shape:"circle",icon:(0,E.jsx)(Ce.Z,{}),onClick:t,disabled:!(null!==s&&void 0!==s&&s.isUndoable())}),(0,E.jsx)(N.Z,{type:"text",shape:"circle",icon:(0,E.jsx)(be.Z,{}),onClick:n,disabled:!(null!==s&&void 0!==s&&s.isRedoable())}),(0,E.jsx)(N.Z,{type:m?"default":"text",shape:"circle",onClick:function(){x({finger:!m}),O.ZP.destroy("FINGER"),O.ZP.open({content:m?"Pencil only":"Draw with finger",key:"FINGER"})},icon:(0,E.jsx)(pe,{type:"icon-finger"})}),(0,E.jsx)("div",{className:"br"}),(0,E.jsx)(Ue,{updateDrawCtrl:x}),(0,E.jsx)(He,{updateDrawCtrl:x}),(0,E.jsx)(N.Z,{type:"text"===p?"default":"text",shape:"circle",onClick:function(){return x({mode:"text"})},icon:(0,E.jsx)(pe,{type:"icon-text1"})}),(0,E.jsx)(qe,{updateDrawCtrl:x})]}),(0,E.jsxs)("div",{className:"right",children:[v&&(0,E.jsx)(Ye,{}),v||(0,E.jsx)(Xe,{instantSave:r}),(0,E.jsx)("div",{className:"br"}),(0,E.jsx)(Se,{})]})]})}var Ue=function(e){var t=e.updateDrawCtrl,n=(0,l.useContext)(Lt).drawCtrl,r=n.mode,i={className:"pen",shape:"circle",icon:(0,E.jsx)(De.Z,{})};return"draw"===r?(0,E.jsx)(H.Z,{content:(0,E.jsx)(Ke,{updateDrawCtrl:t,drawCtrl:n}),trigger:"click",placement:"bottom",getPopupContainer:function(e){return e},destroyTooltipOnHide:!0,children:(0,E.jsx)(N.Z,(0,a.Z)({type:"default"},i))}):(0,E.jsx)(N.Z,(0,a.Z)({type:"text",onClick:function(){return t({mode:"draw"})}},i))},Ke=function(e){var t=e.updateDrawCtrl,n=e.drawCtrl,r=n.highlight,a=n.color,i=(0,l.useState)(!1),u=(0,o.Z)(i,2),s=u[0],c=u[1];return(0,E.jsxs)("div",{className:he()("pen-panel",{blur:s}),children:[(0,E.jsxs)("div",{className:"pen-status",children:[(0,E.jsx)(Be,{updateDrawCtrl:t,drawCtrl:n,setPanelBlur:c}),(0,E.jsx)(N.Z,{type:"primary",ghost:!0,shape:"circle",className:he()("hi-btn",{checked:r}),icon:(0,E.jsx)(pe,{type:"icon-Highlight"}),onClick:function(){return t({highlight:!r})}})]}),(0,E.jsx)(_e,{color:a||"",setColor:function(e){return t({color:e})}})]})},Be=function(e){var t,n,r=e.updateDrawCtrl,a=e.drawCtrl,i=e.setPanelBlur,o=a.lineWidth,u=null!==(t=a.widthList)&&void 0!==t?t:v,s=null!==(n=a.color)&&void 0!==n?n:"#000000",c=(0,l.useMemo)((function(){return Math.max(0,u.indexOf(null!==o&&void 0!==o?o:0))}),[o,u]),d=u.map((function(e,t){return{value:t,label:(0,E.jsx)(H.Z,{onVisibleChange:i,trigger:c===t?["click"]:[],placement:"bottom",content:(0,E.jsx)(G.Z,{min:5,max:100,className:"ctrl-slider",defaultValue:e,onAfterChange:function(e){if(u.includes(e))return r({lineWidth:e});var n=u.slice();n[t]=e,r({widthList:n,lineWidth:e})}}),children:(0,E.jsx)("div",{className:"circle-wrapper",style:{"--real-size":"calc(0.05vw * ".concat(e,")")},children:(0,E.jsx)(We.Y,{color:s})})})}}));return(0,E.jsx)(Y.Z,{className:"width-seg",value:c,onChange:function(e){var t;return r({lineWidth:null!==(t=u[e])&&void 0!==t?t:5})},options:d})},_e=function(e){var t=e.setColor,n=e.color;return(0,E.jsx)("div",{className:"color-select",children:ae.O9.map((function(e){return(0,E.jsxs)("label",{children:[(0,E.jsx)("input",{checked:n===e,type:"radio",name:"color",onChange:function(){return t(e)}}),(0,E.jsx)("div",{className:"circle",style:{"--circle-color":e}})]},e)}))})},He=function(e){var t=e.updateDrawCtrl,n=(0,l.useContext)(Lt).drawCtrl,r=n.eraserWidth,i=n.mode,u=(0,l.useState)(r),s=(0,o.Z)(u,2),c=s[0],d=s[1],f=(0,E.jsx)(G.Z,{className:"ctrl-slider",min:5,max:100,defaultValue:c,onChange:d,onAfterChange:function(e){return t({eraserWidth:e})}}),v={shape:"circle",icon:(0,E.jsx)(pe,{type:"icon-eraser"})};return"erase"===i?(0,E.jsx)(H.Z,{content:f,trigger:"click",placement:"bottom",getPopupContainer:function(e){return e},destroyTooltipOnHide:!0,children:(0,E.jsx)(N.Z,(0,a.Z)({type:"default"},v))}):(0,E.jsx)(N.Z,(0,a.Z)({type:"text",onClick:function(){return t({mode:"erase"})}},v))},qe=function(e){var t=e.updateDrawCtrl,n=(0,l.useContext)(Lt).drawCtrl,r=n.lasso,a=n.mode,i=r?(0,E.jsx)(pe,{type:"icon-lasso1"}):(0,E.jsx)(Pe.Z,{});return"select"===a?(0,E.jsx)(N.Z,{type:"default",shape:"circle",icon:i,onClick:function(){return t({lasso:!r})}}):(0,E.jsx)(N.Z,{type:"text",shape:"circle",icon:i,onClick:function(){return t({mode:"select"})}})},Je=function(e){var t=e.userID,n=(0,l.useState)(!1),r=(0,o.Z)(n,2),a=r[0],i=r[1],u=(0,l.useContext)(re.TeamCtx),s=u.ignores,c=u.setIgnores,d=u.resetIO,f=u.userRec[t];if((0,l.useEffect)((function(){return i(!1)}),[f]),!f)return null;var v=f.userName,p=f.online,m=t===(0,ie.VN)(),h=s.has(t)&&!m;return(0,E.jsxs)("div",{className:he()("user-item",{online:p}),children:[(0,E.jsx)(Ge,{userID:t,size:"small",className:"room-avatar"}),a||(0,E.jsx)("span",{className:"user-name",children:v}),a&&(0,E.jsx)(te.Z,{autoFocus:!0,className:"rename-input",defaultValue:v,onSearch:function(e){var t=e.trim();if(!t||t===v)return i(!1);(0,ie.lu)(t),d()},enterButton:(0,E.jsx)(N.Z,{icon:(0,E.jsx)(Ie.Z,{})})}),m?a||(0,E.jsx)(N.Z,{type:"text",icon:(0,E.jsx)(Ne.Z,{}),onClick:function(){return i(!0)}}):(0,E.jsx)(N.Z,{type:"text",icon:h?(0,E.jsx)(Oe.Z,{}):(0,E.jsx)(Re.Z,{}),onClick:function(){c((function(e){return e.has(t)?e.delete(t):e.add(t)}))}})]})},Ge=function(e){var t=e.userID,n=e.size,r=void 0===n?"default":n,a=e.onClick,i=void 0===a?function(){}:a,o=e.chosen,u=void 0!==o&&o,s=e.className,c=(0,l.useContext)(re.TeamCtx).userRec,d=(0,l.useMemo)((function(){return(0,ae.bM)(t)}),[t]),f=c[t];if(!f)return null;var v=f.userName;return(0,E.jsx)(X.C,{className:he()(s,{chosen:u}),size:r,style:{backgroundColor:d},children:(0,E.jsx)("div",{className:"avatar-wrapper",onClick:i,children:null===v||void 0===v?void 0:v.slice(0,3)})})},Ye=function(){var e=(0,l.useContext)(re.TeamCtx),t=e.code,n=e.userRec,a=e.connected,s=e.loadInfo,d=e.loadState,f=e.resetIO,v=(0,l.useContext)(Lt).noteInfo,p=window.location.href,m=function(){var e=(0,u.Z)(c().mark((function e(){var t,r;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=null===(t=n[(0,ie.VN)()])||void 0===t?void 0:t.userName,e.prev=1,v){e.next=4;break}return e.abrupt("return");case 4:return e.next=6,ze()("".concat(v.name," - ").concat(r," - Multibility\n").concat(p));case 6:O.ZP.destroy("copy"),O.ZP.success({content:"Link copied!",icon:(0,E.jsx)(V.Z,{}),key:"copy"}),e.next=13;break;case 10:e.prev=10,e.t0=e.catch(1),console.log(e.t0);case 13:case"end":return e.stop()}}),e,null,[[1,10]])})));return function(){return e.apply(this,arguments)}}(),h=(0,l.useMemo)((function(){var e=(0,ie.VN)(),t=n[e],a=(0,i.Z)(n,[e].map(J.Z)),o=t?[t]:[],u=Object.values(a);return o.push.apply(o,(0,r.Z)(u.filter((function(e){return e.online}))).concat((0,r.Z)(u.filter((function(e){return!e.online}))))),o}),[n]),g=(0,l.useMemo)((function(){return h.filter((function(e){return e.online})).length}),[h]),x=(0,E.jsxs)("div",{className:"team-popover",children:[a||(0,E.jsx)(Q.Z,{className:"disconn-alert",message:"Network failed.",icon:(0,E.jsx)(Ee.Z,{}),type:"error",showIcon:!0,banner:!0}),(0,E.jsx)(ne.GD,{className:"code-display",value:String(t),length:4,plain:!0}),(0,E.jsx)(N.Z,{icon:(0,E.jsx)(Te.Z,{}),className:"share-btn",onClick:m,block:!0,children:"Share"}),(0,E.jsx)($.Z,{}),(0,E.jsx)("div",{className:"user-list",children:h.map((function(e){return(0,E.jsx)(Je,{userID:e.userID},e.userID)}))})]}),w=(0,l.useState)(!1),Z=(0,o.Z)(w,2),j=Z[0],S=Z[1],k=(0,E.jsxs)("div",{className:"team-title",children:[(0,E.jsx)("span",{children:"Team info"}),(0,E.jsx)(N.Z,{shape:"circle",type:"text",size:"small",loading:j,icon:(0,E.jsx)(Le.Z,{}),onClick:(0,u.Z)(c().mark((function e(){return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return S(!0),e.next=3,s();case 3:return e.next=5,d();case 5:S(!1),f();case 7:case"end":return e.stop()}}),e)})))})]});return(0,E.jsx)(H.Z,{content:x,trigger:"click",placement:"bottomRight",title:k,getPopupContainer:function(e){return e},children:(0,E.jsx)(N.Z,{type:"text",icon:(0,E.jsx)(ee.Z,{status:a?"success":"error",count:a?g:"!",size:"small",children:(0,E.jsx)(Me.Z,{})})})})},Xe=function(e){var t=e.instantSave,n=(0,l.useContext)(Lt).noteID,r=(0,L.s0)(),a=function(){var e=(0,u.Z)(c().mark((function e(){return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t();case 2:return e.next=4,(0,M.r8)(n);case 4:if(e.sent){e.next=7;break}return e.abrupt("return",O.ZP.error("Can't create room."));case 7:return e.next=9,(0,I.SP)(n,{team:!0});case 9:r("/team/"+n);case 10:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}();return(0,E.jsx)(N.Z,{type:"text",icon:(0,E.jsx)(Ae.Z,{}),onClick:function(){_.Z.confirm({title:"Enable team editing",content:"This will make your note public.",icon:(0,E.jsx)(Me.Z,{style:{color:"#555"}}),onOk:a})}})},Qe=n(31362),$e=n(66023),et=n(53557),tt=n(54164),nt=function(){var e;return(0,u.Z)(c().mark((function t(){return c().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!e){t.next=2;break}return t.abrupt("return",e);case 2:return e=(0,Qe.createWorker)({logger:console.log}),t.next=5,e.load();case 5:return t.next=7,e.loadLanguage("eng+chi_sim");case 7:return t.next=9,e.initialize("eng+chi_sim");case 9:return t.abrupt("return",e);case 10:case"end":return t.stop()}}),t)})))}(),rt=function(e){var t=e.drawRef,n=e.visible,r={type:"text",shape:"round",size:"small"},i=(0,l.useState)({}),s=(0,o.Z)(i,2),d=s[0],f=s[1];(0,l.useEffect)((function(){return f({})}),[n]);var v=(0,l.useRef)(null),p=(0,l.useState)(!1),m=(0,o.Z)(p,2),h=m[0],g=m[1],x=(0,l.useState)(0),w=(0,o.Z)(x,2),Z=w[0],j=w[1],S={transform:"translateX(".concat(Z,"px)")};(0,et.useDrag)((function(e){var n,r=e.first,a=e.last,i=e.offset,o=e.delta;j(i[0]),null===(n=t.current)||void 0===n||n.rotateSelected(o[0]/2,a),r&&g(!0),a&&g(!1)}),{target:v,filterTaps:!0,rubberband:.05,bounds:{left:-90,right:90}});var k=(0,l.useState)(!1),y=(0,o.Z)(k,2),C=y[0],b=y[1],D=function(){var e=(0,u.Z)(c().mark((function e(){var n,r,a;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(b(!0),t.current){e.next=3;break}return e.abrupt("return");case 3:return n=t.current.rasterize(),e.prev=4,e.next=7,nt();case 7:return r=e.sent,e.next=10,r.recognize(n);case 10:a=e.sent.data.text,_.Z.confirm({title:"OCR Result",content:(0,E.jsx)($e.Z,{defaultValue:a}),icon:(0,E.jsx)(pe,{type:"icon-OCR"}),okText:"Copy",onOk:function(){return ze()(a)}}),e.next=17;break;case 14:e.prev=14,e.t0=e.catch(4),console.error(e.t0);case 17:return e.prev=17,b(!1),e.finish(17);case 20:case"end":return e.stop()}}),e,null,[[4,14,17,20]])})));return function(){return e.apply(this,arguments)}}();return(0,tt.createPortal)((0,E.jsxs)("div",{className:he()("select-tool",{visible:n}),children:[(0,E.jsx)(H.Z,{trigger:"click",placement:"bottom",getPopupContainer:function(e){return e},destroyTooltipOnHide:!0,content:(0,E.jsx)(Ke,{updateDrawCtrl:function(e){var n;f((function(t){return(0,a.Z)((0,a.Z)({},t),e)})),null===(n=t.current)||void 0===n||n.mutateStyle(e)},drawCtrl:d}),children:(0,E.jsx)(N.Z,(0,a.Z)({icon:(0,E.jsx)(A.Z,{})},r))}),(0,E.jsxs)("div",{className:he()("rotate-wrapper",{dragged:h}),ref:v,children:[(0,E.jsx)(N.Z,(0,a.Z)({icon:(0,E.jsx)(F.Z,{}),onClick:function(){var e;return null===(e=t.current)||void 0===e?void 0:e.rotateSelected(90,!0)}},r)),(0,E.jsx)(z.Z,{className:"arrow left"}),(0,E.jsx)(W.Z,{className:"arrow right"}),(0,E.jsx)("div",{className:"gear",style:S})]}),(0,E.jsx)(N.Z,(0,a.Z)({icon:(0,E.jsx)(V.Z,{}),onClick:function(){var e;return null===(e=t.current)||void 0===e?void 0:e.duplicateSelected()}},r)),(0,E.jsx)(N.Z,(0,a.Z)({icon:(0,E.jsx)(pe,{type:"icon-OCR"}),loading:C,onClick:D},r)),(0,E.jsx)(N.Z,(0,a.Z)({danger:!0,icon:(0,E.jsx)(U.Z,{}),onClick:function(){var e;return null===(e=t.current)||void 0===e?void 0:e.deleteSelected()}},r))]}),document.body)},at=function(e){var t=e.visible,n=e.drawRef,r=(0,l.useState)(""),a=(0,o.Z)(r,2),i=a[0],u=a[1],s=(0,l.useState)(5),c=(0,o.Z)(s,2),d=c[0],f=c[1],v=(0,l.useState)(ae.O9[0]),p=(0,o.Z)(v,2),m=p[0],h=p[1];return(0,E.jsxs)(_.Z,{visible:t,title:"Insert text",onCancel:function(){var e;return null===(e=n.current)||void 0===e?void 0:e.cancelText()},onOk:function(){var e,t,r=i.trim();if(!r)return null===(e=n.current)||void 0===e?void 0:e.cancelText();null===(t=n.current)||void 0===t||t.submitText(r,d,m)},bodyStyle:{paddingTop:0},destroyOnClose:!0,children:[(0,E.jsxs)("div",{className:"insert-option",children:[(0,E.jsxs)("span",{className:"font-size",children:[(0,E.jsx)(K.Z,{}),(0,E.jsx)("span",{children:"Font size: "}),(0,E.jsx)(q.Z,{min:1,size:"small",value:d,onChange:f})]}),(0,E.jsx)(H.Z,{content:(0,E.jsx)(_e,{color:m,setColor:h}),overlayStyle:{width:200},placement:"bottom",children:(0,E.jsx)(N.Z,{className:"tag-btn",size:"small",icon:(0,E.jsx)(B.Z,{style:{color:m}}),children:"Font color"})})]}),(0,E.jsx)($e.Z,{autoFocus:!0,value:i,onChange:function(e){return u(e.target.value)}})]})},it=n(79930),ot=n(78381);function ut(e){var t=(0,l.useRef)(!1),n=function(e){return e.isPrimary&&(t.current="touch"===e.pointerType)},r=function(n){return function(n){return!t.current||function(e){var t=e.touches[0];return"stylus"===(null===t||void 0===t?void 0:t.touchType)}(n)||e&&1===n.touches.length}(n)||n.stopPropagation()};return{onPointerDownCapture:n,onPointerMoveCapture:n,onTouchStartCapture:r,onTouchMoveCapture:r}}var st=n(96153),ct=n(24610),lt=n(12262),dt=n.n(lt),ft=dt().Path,vt=dt().Size,pt=dt().Point,mt=dt().Group,ht=dt().Color,gt=dt().Raster,xt=dt().Shape.Rectangle,wt=l.forwardRef((function(e,t){var n=e.drawState,i=e.otherStates,u=e.onChange,s=void 0===u?function(){}:u,c=e.drawCtrl,d=void 0===c?p:c,f=e.preview,v=void 0!==f&&f,m=e.readonly,h=void 0===m?v:m,g=e.imgSrc,x=e.setActiveTool,w=n.width,Z=n.height,j=d.mode,S=d.color,k=d.finger,b=d.lineWidth,D=d.highlight,P=d.eraserWidth,I=d.lasso,N=(0,l.useRef)(null),O=(0,l.useRef)(new(dt().PaperScope)),R=(0,l.useState)([]),T=(0,o.Z)(R,2),L=T[0],M=T[1],A=(0,l.useState)((0,C.l4)()),F=(0,o.Z)(A,2),z=F[0],W=F[1],V=jt(),U=(0,o.Z)(V,2),K=U[0],B=U[1],_=jt(),H=(0,o.Z)(_,2),q=H[0],J=H[1];(0,l.useEffect)((function(){!function(){if(N.current){O.current.setup(N.current);var e=v?200/w:1;O.current.view.viewSize=new vt(w,Z).multiply(e),O.current.view.scale(e,new pt(0,0)),Ct(O.current,w,Z)}}();var e=N.current;return function(){e&&(0,st.j)(e)}}),[w,Z,v]),(0,l.useEffect)((function(){if(g){var e,t=new Image;return t.src=g,t.onload=function(){O.current.activate(),e=new gt(t),O.current.project.layers[0].addChild(e),e.position=O.current.view.center;var n=w/t.width;e.scale(n)},function(){var t;null===(t=e)||void 0===t||t.remove()}}}),[g,w]);var G=(0,l.useMemo)((function(){return i?y.Dw.mergeStates.apply(y.Dw,[n].concat((0,r.Z)(i))):n.getStrokeList()}),[n,i]);(0,l.useEffect)((function(){var e=[],t=[];return G.forEach((function(r){return St(r,O.current,n.hasStroke(r.uid)?e:t,z.has(r.uid))})),M(e),function(){e.forEach((function(e){return e.remove()})),t.forEach((function(e){return e.remove()}))}}),[G,z,n]);var Y=(0,l.useState)(!1),X=(0,o.Z)(Y,2),Q=X[0],$=X[1],ee="select"===j&&Q?"selected":j,te=(0,l.useState)([]),ne=(0,o.Z)(te,2),re=ne[0],ae=ne[1],ie=(0,l.useMemo)((function(){var e=(0,C.l4)(re);return L.filter((function(t){return e.has(t.name)}))}),[L,re]),oe=(0,l.useCallback)((function(){$(!1),B(void 0),J(void 0)}),[B,J]);(0,l.useEffect)((function(){if("select"===j)return oe}),[j,oe]),(0,l.useEffect)((function(){if(Q)return function(){ae([])}}),[Q]),(0,l.useEffect)(oe,[I,oe]);var ue=(0,l.useRef)(1),se=function(){var e,t=null===(e=N.current)||void 0===e?void 0:e.clientWidth;t&&(ue.current=w/t),O.current.activate()},ce=function(e){var t=le(e.point),n=bt(t);J(n)},le=function(e){O.current.activate();var t=O.current.view,n=t.center,r=t.zoom,a=O.current.view.projectToView(e).multiply(ue.current),i=new pt(w,Z).divide(2).subtract(n.multiply(r));return a.subtract(i).divide(r)},de={draw:function(){se(),B(Dt(S,b,D))},erase:function(){se(),B(Dt("#0003",P))},select:function(e){se(),I?B(Dt("#1890ff",5)):ce(e)},selected:function(e){se();var t=le(e.point);if(I){if(null!==K&&void 0!==K&&K.contains(t))return;B(Dt("#1890ff",5))}else{if(null!==q&&void 0!==q&&q.bounds.contains(t))return;ce(e)}$(!1)},text:function(e){se();var t=le(e.point),n=new(dt().PointText)(t);ke(n)}}[ee],fe={draw:function(e){K&&(O.current.activate(),K.add(le(e.point)),K.smooth())},erase:function(e){if(K){O.current.activate(),K.add(le(e.point)),K.smooth();var t=L.filter((function(e){return!z.has(e.name)})).filter((function(e){return yt(e,K)})).map((function(e){return e.name}));W((function(e){return e.concat(t)}))}},select:function(e){if(O.current.activate(),I){if(!K)return;K.add(le(e.point)),K.smooth()}else{if(!q)return;var t=e.delta.multiply(ue.current);q.size=q.size.add(new vt(t.x,t.y)),q.translate(t.divide(2))}},selected:function(e){O.current.activate();var t=e.delta.multiply(ue.current);ie.forEach((function(e){return e.translate(t)})),null===K||void 0===K||K.translate(t),null===q||void 0===q||q.translate(t)},text:null}[ee],ve={draw:function(){if(K&&0!==K.segments.length){O.current.activate(),K.simplify();var e=K.exportJSON();B(void 0),s((function(t){return y.Dw.addStroke(t,e)}))}},erase:function(){K&&(O.current.activate(),B(void 0),s((function(e){return y.Dw.eraseStrokes(e,z.toArray())})),W((0,C.l4)()))},select:function(){var e;if(O.current.activate(),I){if(!K||K.length<50)return B(void 0);K.closePath(),K.simplify(),Pt(K),e=Ot(K,L)}else{if(!q)return;var t=q.size.abs();if(t.width*t.height<100)return J(void 0);Pt(q),e=Nt(q,L)}ae(e.map((function(e){return e.name}))),$(!0)},selected:function(){pe()},text:null}[ee];(0,l.useEffect)((function(){h||(O.current.view.onMouseDown=de,O.current.view.onMouseDrag=fe,O.current.view.onMouseUp=ve)}));var pe=function(){if(null!==ie&&void 0!==ie&&ie.length){var e=ie.map((function(e){return[e.name,e.exportJSON()]}));s((function(t){return y.Dw.mutateStrokes(t,e)}))}},me=function(){re.length&&(s((function(e){return y.Dw.eraseStrokes(e,re)})),ae([]),oe())},he=function(e){var t,n=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=n?10:1,a=e/r,i=null===(t=q||K)||void 0===t?void 0:t.position,o=function e(){ie.forEach((function(e){return e.rotate(a,i)})),null===q||void 0===q||q.rotate(a,i),null===K||void 0===K||K.rotate(a,i),--r>0?requestAnimationFrame(e):n&&pe()};o()},ge=function(e){O.current.activate(),Rt(ie,e),pe()},xe=function(){var e;O.current.activate();var t=null===(e=q||K)||void 0===e?void 0:e.bounds.size;if(t){var n=t.width,r=t.height,a=new pt(n,r).divide(10),i=new mt(ie).clone({insert:!1});i.translate(a),null===q||void 0===q||q.translate(a),null===K||void 0===K||K.translate(a);var o=i.children.map((function(e){return[(0,ct.v4)(),e.exportJSON()]}));s((function(e){return y.Dw.mutateStrokes(e,o)})),ae(o.map((function(e){return e[0]})))}},we=function(){return new mt(ie).rasterize({insert:!1}).toDataURL()},Ze=jt(),je=(0,o.Z)(Ze,2),Se=je[0],ke=je[1],ye=(0,l.useCallback)((function(){return ke(void 0)}),[ke]);(0,l.useEffect)((function(){if("text"===j)return ye}),[j,ye]);var Ce=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"#000";if(Se){Se.content=e,Se.fontSize=10*t,Se.fillColor=new ht(n);var r=Se.exportJSON();s((function(e){return y.Dw.addStroke(e,r)})),ye()}};(0,l.useImperativeHandle)(t,(function(){return{deleteSelected:me,duplicateSelected:xe,cancelText:ye,rotateSelected:he,submitText:Ce,mutateStyle:ge,rasterize:we}})),(0,l.useEffect)((function(){x&&x("selected"===ee?"select":"text"===ee&&Se?"text":"")}),[ee,Se,x]),(0,l.useEffect)((function(){var e=function(e){return e.preventDefault()};return document.addEventListener("gesturestart",e),document.addEventListener("gesturechange",e),document.addEventListener("gestureend",e),function(){document.removeEventListener("gesturestart",e),document.removeEventListener("gesturechange",e),document.removeEventListener("gestureend",e)}}),[]),(0,et.usePinch)((function(e){var t,n,r,a,i,u=e.memo,s=(0,o.Z)(e.offset,1)[0],c=e.first,l=e.last,d=e.origin,f=O.current.view;if(c||!u){if(se(),!N.current)return;var v=N.current.getBoundingClientRect(),p=v.x,m=v.y;t=1,n=d[0]-p,r=d[1]-m,a=p,i=m}else{var h=(0,o.Z)(u,3);t=h[0];var g=(0,o.Z)(h[1],2);n=g[0],r=g[1];var x=(0,o.Z)(h[2],2);a=x[0],i=x[1]}var w=ue.current,Z=d[0]-a,j=d[1]-i,S=new pt(Z,j).multiply(w),k=f.viewToProject(S);Math.abs(1-s)<.05&&(s=1);var y=c?1:s/t,C=l?10:1;y=Math.pow(y,1/C);!function e(){f.scale(y,k),--C>0?requestAnimationFrame(e):l&&It(f)}();var b=new pt(Z-n,j-r).multiply(w/s);if(f.translate(b),!l)return[s,[Z,j],[a,i]]}),{scaleBounds:{max:10,min:.3},rubberband:.5,target:N});var be=ut(k);return(0,E.jsx)("div",{className:"draw-wrapper",children:(0,E.jsx)("canvas",(0,a.Z)({ref:N,className:"draw-canvas","data-paper-hidpi":!1},be))})}));wt.displayName="Draw";var Zt=l.memo(wt);function jt(e){var t=(0,l.useState)(e),n=(0,o.Z)(t,1)[0];return(0,l.useDebugValue)(n),(0,l.useEffect)((function(){return function(){null===n||void 0===n||n.remove()}}),[n]),t}var St=function(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]&&arguments[3],a=e.pathData,i=e.uid;try{t.activate();var o=t.project.activeLayer.importJSON(a);if(!o)return;o.name=i,r&&(o.opacity=.5),null===n||void 0===n||n.push(o)}catch(u){console.error(u)}},kt=function(){var e=new WeakMap;return function(t,n){var r,a=e.get(t);if(a)return a;var i=t.point,o=null===(r=t.previous)||void 0===r?void 0:r.point;if(!o)return[];for(var u=i.subtract(o),s=u.length/n*2,c=[],l=0;l<s;l+=1)c.push(i.subtract(u.multiply(l/s)));return e.set(t,c),c}}(),yt=function(e,t){var n,r=null===(n=t.lastSegment.curve)||void 0===n?void 0:n.strokeBounds;if(!(e instanceof dt().Path))return!1;if(null===r||void 0===r||!r.intersects(e.strokeBounds))return!1;if(t.intersects(e))return!0;var a=t.strokeWidth,i=t.lastSegment;return kt(i,a).some((function(t){var n,r=null===(n=e.getNearestPoint(t))||void 0===n?void 0:n.getDistance(t);return r&&2*r<e.strokeWidth+a}))},Ct=function(e,t,n){e.activate();var r=new xt(new pt(0,0),new pt(t,n));r.fillColor=new ht("#fff");var a=new(dt().Layer)(r);return e.project.insertLayer(0,a),r},bt=function(e){var t=new xt(e,new vt(0,0));return t.strokeColor=new ht("#1890ff"),t.strokeWidth=5,t},Dt=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=new ft,a=new ht(e);return n&&(a.alpha=.5,r.blendMode="multiply"),r.strokeColor=a,r.strokeWidth=t,r.strokeJoin="round",r.strokeCap="round",r},Pt=function(e){e.strokeColor&&(e.strokeColor.alpha=.5),e.dashOffset=0,e.dashArray=[30,20],e.onFrame=function(){return e.dashOffset+=3}},It=function(e){var t=function(e){var t=e.center,n=e.zoom,r=e.viewSize,a=r.height,i=r.width,o=t.x,u=t.y;if(n<=1)return[i/2-o,a/2-u];var s=i*(n-1)/n/2,c=a*(n-1)/n/2,l=i/2-s,d=i/2+s,f=a/2-c,v=a/2+c;return[o<l?l-o:o>d?d-o:0,u<f?f-u:u>v?v-u:0]}(e),n=(0,o.Z)(t,2),r=n[0],a=n[1],i=10,u=new pt(r,a).divide(-i);!function t(){e.translate(u),--i>0&&requestAnimationFrame(t)}()},Nt=function(e,t){return t.filter((function(t){return t instanceof dt().Path?t.intersects(e)||t.isInside(e.bounds):t.bounds.intersects(e.bounds)}))},Ot=function(e,t){return t.filter((function(t){return!!t.bounds.intersects(e.bounds)&&(t instanceof dt().Path?n=t:(n=new ft.Rectangle(t.bounds)).remove(),n.intersects(e)||function(t){var n=t.subtract(e,{insert:!1,trace:!1});return n.remove(),n.isEmpty()}(n));var n}))},Rt=function(e,t){var n=t.lineWidth,r=t.color,a=t.highlight;e.forEach((function(e){if(e instanceof dt().PointText&&r){var t=new ht(r);e.fillColor=t}if(e instanceof dt().Path){if(r){var i=new ht(r);"multiply"===e.blendMode&&(i.alpha=.5),e.strokeColor=i}n&&(e.strokeWidth=n),e.strokeColor&&void 0!==a&&(e.strokeColor.alpha=a?.5:1,e.blendMode=a?"multiply":"normal")}}))},Et=["pageRec","pdf","pageOrder"],Tt=["image","marked"],Lt=(0,l.createContext)({noteID:"",noteInfo:void 0,stateSet:void 0,teamState:void 0,pageRec:void 0,pageOrder:void 0,saved:!0,inviewPages:(0,C.l4)(),drawCtrl:p}),Mt=(0,l.createContext)({scrollPage:function(e){},switchPageMarked:function(e){},updateStateSet:function(e){},addPage:function(e,t){},addFinalPage:function(){},deletePage:function(e){},saveReorder:function(){var e=(0,u.Z)(c().mark((function e(t,n){return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}(),setInviewPages:function(){},setDrawCtrl:function(){}});function At(){var e,t=null!==(e=(0,L.UO)().noteID)&&void 0!==e?e:"",n=(0,L.s0)(),s=(0,l.useState)(),d=(0,o.Z)(s,2),f=d[0],v=d[1],h=(0,l.useState)(),g=(0,o.Z)(h,2),j=g[0],S=g[1],k=(0,l.useState)(),b=(0,o.Z)(k,2),D=b[0],R=b[1],A=(0,l.useState)(p),F=(0,o.Z)(A,2),z=F[0],W=F[1],V=(0,l.useState)((0,C.l4)()),U=(0,o.Z)(V,2),K=U[0],B=U[1],_=(0,l.useState)(),H=(0,o.Z)(_,2),q=H[0],J=H[1],G=(0,w.Z)(!0),Y=(0,o.Z)(G,2),X=Y[0],Q=Y[1],$=(0,l.useRef)({}),ee=(0,l.useContext)(re.TeamCtx),te=ee.io,ne=ee.teamOn,ae=ee.teamState,ie=ee.addTeamStatePage;(0,l.useEffect)((function(){var e=function(){var e=(0,u.Z)(c().mark((function e(){var r,a,o,u;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,I.U9)(t);case 2:if(r=e.sent){e.next=6;break}return O.ZP.error("Note not found"),e.abrupt("return",n("/"));case 6:return a=r.pageRec,r.pdf,o=r.pageOrder,u=(0,i.Z)(r,Et),v((0,C.D5)(a)),J(o),S(u),R(P.createFromPages(a)),e.t0=W,e.next=14,m();case 14:e.t1=e.sent,(0,e.t0)(e.t1),ne&&(0,M.f1)(t);case 17:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}();e()}),[n,t,ne]),(0,l.useEffect)((function(){j&&(document.title=j.name+" - Multibility")}),[j]);var oe=(0,Z.Z)((0,u.Z)(c().mark((function e(){var n,r,a;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=null===f||void 0===f?void 0:f.toObject(),r=document.querySelector("canvas"),a=null===r||void 0===r?void 0:r.toDataURL(),e.next=5,(0,I.SP)(t,{pageRec:n,thumbnail:a});case 5:Q(!0);case 6:case"end":return e.stop()}}),e)})))),ue=(0,l.useCallback)((0,it.Z)(oe,2e3),[oe]),se=ue.flush,ce=function(e,t){v((function(n){return null===n||void 0===n?void 0:n.update(e,x.BJ,t)})),Q(!1),ue()},le=function(){var e=(0,u.Z)(c().mark((function e(n){var r,a=arguments;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=a.length>1&&void 0!==a[1]&&a[1],J(n),e.next=4,(0,I.SP)(t,{pageOrder:n});case 4:return e.next=6,se();case 6:r&&de(n);case 7:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),de=function(e){null===te||void 0===te||te.emit("reorder",{pageOrder:e})},fe=(0,Z.Z)((function(e){var t,n=e.deleted,r=e.pageOrder,a=e.prevOrder;(le(r),n)&&(t=function(){return le(a,!0)},O.ZP.warning({content:(0,E.jsxs)(E.Fragment,{children:["One page was deleted.",(0,E.jsx)(N.Z,{size:"small",type:"link",onClick:function(){O.ZP.destroy("DELETE"),t()},children:"Undo"})]}),key:"DELETE",duration:10}))})),pe=(0,Z.Z)((function(e){var t=e.pageOrder,n=e.pageID,r=e.newPage;le(t),ce(n,(function(){return r})),R((function(e){return null===e||void 0===e?void 0:e.addState(n,r)}))}));(0,l.useEffect)((function(){return null===te||void 0===te||te.on("reorder",fe),null===te||void 0===te||te.on("newPage",pe),function(){null===te||void 0===te||te.removeAllListeners()}}),[te,fe,pe]);var me=function(e,t,n){n.image,n.marked;var r=(0,i.Z)(n,Tt);null===te||void 0===te||te.emit("newPage",{pageOrder:e,pageID:t,newPage:r}),ie(t,n)},he=function(e,t){var n=y.Dw.flaten(t);ce(e,(function(e){return(0,a.Z)((0,a.Z)({},e),{},{state:n})}))},ge=function(e){if(D){var t=e(D);R(t);var n,a=t.getLastDS(),i=t.lastOp;if(a&&i)he.apply(void 0,(0,r.Z)(a)),n=i,null===te||void 0===te||te.emit("push",{operation:n},(function(e){var t=e.pageID,n=e.stroke;return R((function(e){return null===e||void 0===e?void 0:e.syncStrokeTime(t,n)}))}))}},xe=function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(q){var n=t?null===f||void 0===f?void 0:f.get(e):void 0,r=(0,x.D4)(n),a=(0,o.Z)(r,2),i=a[0],u=a[1],s=ve(q,e,i);me(s,i,u),le(s),ce(i,(function(){return u})),R((function(e){return null===e||void 0===e?void 0:e.addState(i,u)}))}},we=(0,E.jsxs)("div",{className:"reader container",children:[(0,E.jsx)(Ve,{handleUndo:function(){return ge((function(e){return e.undo()}))},handleRedo:function(){return ge((function(e){return e.redo()}))},instantSave:se}),(0,E.jsxs)("main",{children:[null===q||void 0===q?void 0:q.map((function(e){return(0,E.jsx)("section",{className:"note-page",ref:function(t){return t&&($.current[e]=t)},children:(0,E.jsx)(Ft,{uid:e})},e)})),(0,E.jsx)(T,{})]})]});return(0,E.jsx)(Lt.Provider,{value:{saved:X,noteID:t,pageRec:f,drawCtrl:z,noteInfo:j,stateSet:D,teamState:ae,pageOrder:q,inviewPages:K},children:(0,E.jsx)(Mt.Provider,{value:{addPage:xe,scrollPage:function(e){var t;null===(t=$.current[e])||void 0===t||t.scrollIntoView()},deletePage:function(e){var t=null===q||void 0===q?void 0:q.filter((function(t){return t!==e}));(null===t||void 0===t?void 0:t.length)&&le(t,!0)},setDrawCtrl:W,saveReorder:le,addFinalPage:function(){var e=null===q||void 0===q?void 0:q.at(-1);e&&xe(e)},updateStateSet:ge,setInviewPages:B,switchPageMarked:function(e){ce(e,(function(e){return(0,a.Z)((0,a.Z)({},e),{},{marked:!e.marked})}))}},children:we})})}var Ft=function(e){var t=e.uid,n=(0,l.useContext)(Lt),r=n.pageRec,a=n.stateSet,i=n.teamState,o=(0,l.useContext)(Mt).updateStateSet,u=null===r||void 0===r?void 0:r.get(t),s=null===a||void 0===a?void 0:a.getOneState(t),c=null===i||void 0===i?void 0:i.getOnePageStateMap(t);return u&&s?(0,E.jsx)(zt,{drawState:s,teamStateMap:c,updateState:function(e){o((function(n){return n.setState(t,e)}))},pdfIndex:u.pdfIndex,uid:t}):null},zt=function(e){var t=e.thumbnail,r=e.drawState,a=e.teamStateMap,i=e.updateState,s=e.pdfIndex,d=e.preview,f=void 0!==d&&d,v=e.uid,p=(0,l.useContext)(Mt).setInviewPages,m=(0,l.useContext)(Lt).noteID,h=(0,l.useState)(),g=(0,o.Z)(h,2),x=g[0],w=g[1],Z=(0,l.useRef)(null),S=(0,j.Z)(Z),k=(0,o.Z)(S,1)[0],y=r.height/r.width,C=(0,l.useCallback)((0,ot.Z)((0,u.Z)(c().mark((function e(){var t,r;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(s){e.next=2;break}return e.abrupt("return");case 2:return e.next=4,Promise.all([n.e(643),n.e(138)]).then(n.bind(n,21176));case 4:return t=e.sent,r=t.getOnePageImage,e.t0=w,e.next=9,r(m,s);case 9:e.t1=e.sent,(0,e.t0)(e.t1);case 11:case"end":return e.stop()}}),e)})))),[s,m]);(0,l.useEffect)((function(){f||(k?(C(),p((function(e){return e.add(v)}))):p((function(e){return e.delete(v)})))}),[k,f,v,C,p]);var b=(0,l.useContext)(re.TeamCtx).ignores,D=(0,l.useMemo)((function(){return null===a||void 0===a?void 0:a.deleteAll(b).toList().toArray()}),[a,b]),P=k&&(x||!s),I=Boolean(f||!P);return(0,E.jsxs)("div",{ref:Z,className:"page-wrapper",style:{paddingTop:"".concat(100*y,"%")},children:[P&&(0,E.jsx)(Wt,{drawState:r,otherStates:D,updateState:i,imgSrc:x||t,preview:f}),I&&(0,E.jsx)("div",{className:"mask"})]})},Wt=function(e){var t=e.drawState,n=e.updateState,r=e.otherStates,a=e.preview,i=void 0!==a&&a,u=e.imgSrc,s=(0,l.useContext)(Lt).drawCtrl,c=(0,l.useState)(""),d=(0,o.Z)(c,2),f=d[0],v=d[1],p=(0,l.useRef)(null),m=(0,Z.Z)((function(e){if(n){var r=e instanceof y.Dw?e:e(t);n(r)}}));return i?(0,E.jsx)(Zt,{drawState:t,otherStates:r,imgSrc:u,readonly:!0,preview:!0}):(0,E.jsxs)(E.Fragment,{children:[(0,E.jsx)(Zt,{drawState:t,otherStates:r,onChange:m,imgSrc:u,drawCtrl:s,ref:p,setActiveTool:v}),(0,E.jsx)(rt,{drawRef:p,visible:"select"===f}),(0,E.jsx)(at,{drawRef:p,visible:"text"===f})]})};Wt.displayName="DrawWrapper"},91511:function(e,t,n){"use strict";n.r(t),n.d(t,{TeamCtx:function(){return P},default:function(){return I}});var r=n(29439),a=n(15861),i=n(87757),o=n.n(i),u=n(72791),s=n(51570),c=n(56058),l=n(87962),d=n(78577),f=n(69951),v=function(e){return function(){return(0,d.io)(s._n,{query:{userID:(0,f.VN)(),userName:(0,f.vW)(),noteID:e}})}},p=n(16871),m=n(45987),h=n(15671),g=n(43144),x=n(82670),w=n(24124),Z=["pageID"],j={pageStates:(0,w.D5)(),pageInfos:(0,w.D5)()},S=(0,w.WV)(j),k=function(){function e(t){(0,h.Z)(this,e),this.immutable=t}return(0,g.Z)(e,[{key:"getImmutable",value:function(){return this.immutable}},{key:"getPageStates",value:function(){return this.getImmutable().get("pageStates")}},{key:"getPageInfos",value:function(){return this.getImmutable().get("pageInfos")}},{key:"getOneState",value:function(e,t){var n;return null===(n=this.getPageStates().get(e))||void 0===n?void 0:n.get(t)}},{key:"getOnePageStateMap",value:function(e){return this.getPageStates().get(e)}},{key:"getPageValidUsers",value:function(e){var t=this.getOnePageStateMap(e);return t?Array.from(null===t||void 0===t?void 0:t.filter((function(e){return!e.isEmpty()})).keys()):[]}},{key:"getPageRatio",value:function(e){var t;return null===(t=this.getPageInfos().get(e))||void 0===t?void 0:t.ratio}},{key:"includesPage",value:function(e){return this.getPageStates().has(e)}},{key:"setState",value:function(t,n,r){var a=this.getPageStates().get(t);return a?new e(this.getImmutable().update("pageStates",(function(e){return e.set(t,a.set(n,r))}))):this}},{key:"addPage",value:function(t,n){var r=n.ratio;return new e(this.getImmutable().update("pageStates",(function(e){return e.set(t,(0,w.D5)())})).update("pageInfos",(function(e){return e.set(t,{ratio:r})})))}},{key:"pushOperation",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:x.mF,r=e.pageID,a=(0,m.Z)(e,Z),i=this.getPageRatio(r);if(!this.includesPage(r)||!i)return this;var o=this.getOneState(r,t)||x.Dw.createEmpty(n,n*i),u=x.Dw.pushOperation(o,a);return this.setState(r,t,u)}},{key:"resetUser",value:function(e,t){for(var n=this,a=0,i=Object.entries(t);a<i.length;a++){var o=(0,r.Z)(i[a],2),u=o[0],s=o[1],c=s.state,l=s.ratio,d=n.getOneState(u,e);if(d){var f=d.width;n=n.setState(u,e,x.Dw.loadFromFlat(c,f,f*l))}}return n}}],[{key:"createFromTeamPages",value:function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:x.mF,a=S();return Object.entries(t).forEach((function(e){var t=(0,r.Z)(e,2),i=t[0],o=t[1],u=o.states,s=o.ratio,c=(0,w.D5)(Object.entries(u).map((function(e){var t=(0,r.Z)(e,2),a=t[0],i=t[1];return[a,x.Dw.loadFromFlat(i,n,n*s)]})));a=a.update("pageStates",(function(e){return e.set(i,c)})).update("pageInfos",(function(e){return e.set(i,{ratio:s})}))})),new e(a)}}]),e}(),y=n(65099),C=n(50419),b=n(29952),D=n(80184),P=(0,u.createContext)({io:void 0,code:0,teamOn:!1,connected:!1,ignores:(0,w.l4)(),userRec:{},teamState:void 0,resetIO:function(){},loadInfo:function(){var e=(0,a.Z)(o().mark((function e(){return o().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",!1);case 1:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),loadState:function(){var e=(0,a.Z)(o().mark((function e(){return o().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",!1);case 1:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),setIgnores:function(){},addTeamStatePage:function(e,t){}});function I(){var e,t=null!==(e=(0,p.UO)().noteID)&&void 0!==e?e:"",n=(0,u.useState)(),i=(0,r.Z)(n,2),c=i[0],l=i[1],d=(0,u.useState)(-2),m=(0,r.Z)(d,2),h=m[0],g=m[1],x=(0,u.useState)({}),Z=(0,r.Z)(x,2),j=Z[0],S=Z[1],I=(0,u.useState)((0,w.l4)()),R=(0,r.Z)(I,2),E=R[0],T=R[1],L=(0,u.useState)(v(t)),M=(0,r.Z)(L,2),A=M[0],F=M[1],z=(0,u.useState)(!1),W=(0,r.Z)(z,2),V=W[0],U=W[1],K=(0,u.useState)(!1),B=(0,r.Z)(K,2),_=B[0],H=B[1],q=(0,p.s0)(),J=(0,u.useCallback)((0,a.Z)(o().mark((function e(){var n;return o().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,s.dn)(t);case 2:if(n=e.sent){e.next=6;break}return C.ZP.error("Failed loading the team note info"),e.abrupt("return",!1);case 6:return g(n.code),e.abrupt("return",!0);case 8:case"end":return e.stop()}}),e)}))),[t]),G=(0,u.useCallback)((0,a.Z)(o().mark((function e(){var n;return o().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,s.CD)(t);case 2:if(n=e.sent){e.next=6;break}return C.ZP.error("Failed loading the team note state"),e.abrupt("return",!1);case 6:return l(k.createFromTeamPages(n)),e.abrupt("return",!0);case 8:case"end":return e.stop()}}),e)}))),[t]);(0,u.useEffect)((function(){var e=function(){var e=(0,a.Z)(o().mark((function e(){var t,n;return o().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,J();case 2:return t=e.sent,e.next=5,G();case 5:if(n=e.sent,!t||!n){e.next=8;break}return e.abrupt("return",U(!0));case 8:q("/");case 9:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}();e()}),[J,G,q]),(0,u.useEffect)((function(){return A.on("push",(function(e){var t=e.operation,n=e.userID;l((function(e){return null===e||void 0===e?void 0:e.pushOperation(t,n)}))})),A.on("join",(function(e){var t=e.joined,n=e.members,r=t.userID,a=t.userName;S(n),r!==(0,f.VN)()&&N(r,a)})),A.on("leave",(function(e){var t=e.leaved,n=e.members,r=t.userID,a=t.userName;if(S(n),r===(0,f.VN)())return A.emit("join");O(r,a)})),A.on("newPage",(function(e){var t=e.pageID,n=e.newPage;l((function(e){return null===e||void 0===e?void 0:e.addPage(t,n)}))})),A.on("reset",(function(e){var t=e.userID,n=e.pageRec;t!==(0,f.VN)()&&l((function(e){return null===e||void 0===e?void 0:e.resetUser(t,n)}))})),A.on("connect_error",console.error),A.on("connect",(function(){return H(!0)})),A.on("disconnect",(function(){return H(!1)})),function(){A.removeAllListeners(),A.close()}}),[A]);return(0,D.jsx)(y.g,{loading:!V,children:(0,D.jsx)(P.Provider,{value:{io:A,code:h,teamOn:!0,ignores:E,userRec:j,connected:_,teamState:c,resetIO:function(){return F(v(t))},loadInfo:J,loadState:G,setIgnores:T,addTeamStatePage:function(e,t){l((function(n){return null===n||void 0===n?void 0:n.addPage(e,t)}))}},children:(0,D.jsx)(b.default,{})})})}var N=function(e,t){C.ZP.destroy(e),C.ZP.success({content:"".concat(t," joined room"),icon:(0,D.jsx)(c.Z,{}),key:e})},O=function(e,t){C.ZP.destroy(e),C.ZP.warning({content:"".concat(t," leaved room"),icon:(0,D.jsx)(l.Z,{}),key:e})}},96153:function(e,t,n){"use strict";function r(e,t){var n=document.createElement("canvas"),r=n.getContext("2d");if(!r)throw new Error("can't get virtual canvas context");return n.width=e,n.height=t,{canvas:n,context:r}}function a(e){e.width=1,e.height=1;var t=e.getContext("2d");null===t||void 0===t||t.clearRect(0,0,1,1)}n.d(t,{j:function(){return a},v:function(){return r}})},90858:function(){},64158:function(){}}]);
//# sourceMappingURL=133.d6ecdb3d.chunk.js.map